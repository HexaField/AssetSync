import*as a from"https://cdn.skypack.dev/pin/three@v0.117.1-NetLzdTnw9ga3y6o633U/min/three.js";import M from"./Feature.js";import{Water as y}from"./Water2.js";import{Sky as f}from"../../../../../web_modules/three/examples/jsm/objects/Sky.js";import T from"../Platform.js";export default class j extends M{constructor(e){super(e);this.swordTriggerEventProtocol="lookingglass.eventtrigger",this.triggerSwordEvent=this.triggerSwordEvent.bind(this),this.realm.addNetworkProtocolCallback(this.swordTriggerEventProtocol,this.triggerSwordEvent),this.tweens=[],this.vec3=new a.Vector3,this.realmData=e.getData(),this.spawnPosition=this.realmData.worldData.spawnPosition}async preload(){let e=11,t=`


Now playing | New Order - Bizarre Love Triangle`;this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (1/`+e+")"+t),await this.realm.conjure.getAudioManager().load("chiptune","assets/sounds/chiptune.mp3"),this.chiptune=this.realm.conjure.getAudioManager().play("chiptune",{loop:!0,volume:.25}),this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (2/`+e+")"+t),await this.realm.conjure.getAudioManager().load("jumanji","assets/sounds/jumanji.wav"),this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (3/`+e+")"+t),await this.realm.conjure.load.preload("lookingglass","assets/models/lookingglass.glb"),this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (4/`+e+")"+t),await this.realm.conjure.load.preload("grass1","assets/textures/grass1.jpg"),this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (5/`+e+")"+t),await this.realm.conjure.load.preload("granite1","assets/textures/granite1.jpg"),this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (6/`+e+")"+t),await this.realm.conjure.load.preload("granite2","assets/textures/granite2.jpg"),this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (7/`+e+")"+t),await this.realm.conjure.load.preload("granite3","assets/textures/granite3.jpg"),this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (8/`+e+")"+t),await this.realm.conjure.load.preload("rock1","assets/textures/rock1.jpg"),this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (9/`+e+")"+t),await this.realm.conjure.load.preload("emerald1","assets/textures/emerald1.jpg"),this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (10/`+e+")"+t),await this.realm.conjure.load.preload("mountains","assets/models/mountainring.glb"),this.realm.conjure.getLoadingScreen().setText(`Loading Realm Assets
 (11/`+e+")"+t),await this.realm.conjure.getAudioManager().load("sword","assets/sounds/sword.mp3"),this.realm.conjure.getLoadingScreen().setText(`
THE ETHEREAL REALM
WETWARE INC.

'THE ENTS MARCH TO WAR'

Written by
Ponderjaunt

Produced by
Free Markets & Liberty

REALMS CREATED WITH CONJURE ENGINE

COPYWRONG /\xA9/ 1984 ALL RIGHTS CANCELLED. BY PONDERJAUNT & THE FOREST.
THIS PROGRAM IS PROTECTED UNDER THE LAWS OF THE INCORPORATED UNITED STATES
AND OTHER BANKS. ILLEGAL DISTROBUTION MAY RESULT IN INCREDIBLE CIVIL VALUE
AND ECONOMIC EPOCHAL SHIFTS.`),await this.loadScene()}async unload(){this.platform.destroy()}async loadScene(){this.platform=new T(this.realm.conjure,this.realm.group,{size:1024,pos:new a.Vector3(0,1,0)}),this.platform.floor.visible=!1,this.platform.worldNameText.group.visible=!1,this.sky=new f,this.sky.scale.setScalar(45e4),this.realm.group.add(this.sky);var e=this.sky.material.uniforms;e.turbidity.value=.2,e.rayleigh.value=.01,e.mieCoefficient.value=.005,e.mieDirectionalG.value=.8,e.sunPosition.value.copy(this.realm.conjure.sunPos),this.waterGeometry=new a.PlaneBufferGeometry(4096,4096),this.water=new y(this.waterGeometry,{color:7253247,scale:256,reflectivity:.9,flowDirection:new a.Vector2(.25,.25),textureWidth:1024,textureHeight:1024}),this.water.position.y=2,this.water.rotation.x=Math.PI*-.5,this.realm.group.add(this.water),this.mountains=await this.realm.conjure.load.gltf("mountains"),this.mountains.scene.position.setY(-60),this.realm.group.add(this.mountains.scene),this.sceneModel=await this.realm.conjure.load.gltf("lookingglass"),console.log(this.sceneModel);for(let s of this.sceneModel.scene.children){if(!s.geometry)continue;s.geometry.computeVertexNormals(),console.log(s),this.realm.conjure.physics.add.existing(s,{shape:"concaveMesh",mass:0})}this.realm.group.add(this.sceneModel.scene);let t=await this.realm.conjure.load.texture("grass1");t.wrapS=a.MirroredRepeatWrapping,t.wrapT=a.MirroredRepeatWrapping,t.repeat.set(64,64);let i=new a.MeshStandardMaterial({map:t});this.sceneModel.scene.children[0].material=i;let r=await this.realm.conjure.load.texture("granite1");r.wrapS=a.MirroredRepeatWrapping,r.wrapT=a.MirroredRepeatWrapping,r.repeat.set(4,4);let c=new a.MeshStandardMaterial({map:r});this.sceneModel.scene.children[5].material=c,this.sceneModel.scene.children[7].material=c;let l=await this.realm.conjure.load.texture("granite2");l.wrapS=a.MirroredRepeatWrapping,l.wrapT=a.MirroredRepeatWrapping,l.repeat.set(4,4);let m=new a.MeshStandardMaterial({map:l});this.sceneModel.scene.children[4].material=m,this.sceneModel.scene.children[6].material=m,this.sceneModel.scene.children[8].material=m;let h=await this.realm.conjure.load.texture("granite3");h.wrapS=a.MirroredRepeatWrapping,h.wrapT=a.MirroredRepeatWrapping,h.repeat.set(4,4);let g=new a.MeshStandardMaterial({map:h});this.sceneModel.scene.children[9].material=g,this.sceneModel.scene.children[10].material=g;let u=await this.realm.conjure.load.texture("rock1");u.wrapS=a.MirroredRepeatWrapping,u.wrapT=a.MirroredRepeatWrapping,u.repeat.set(64,64);let n=new a.MeshStandardMaterial({map:u});this.mountains.scene.children[0].material=n,this.sceneModel.scene.children[1].material=n,this.sceneModel.scene.children[2].material=n,this.sceneModel.scene.children[3].material=n,this.sceneModel.scene.children[9].material=n;let d=await this.realm.conjure.load.texture("emerald1");d.wrapS=a.MirroredRepeatWrapping,d.wrapT=a.MirroredRepeatWrapping,d.repeat.set(1,1);let p=new a.MeshPhysicalMaterial({map:d,color:65280,metalness:0,roughness:0,opacity:.8,transparent:!0,side:a.DoubleSide,premultipliedAlpha:!0,envmap:t});this.sceneModel.scene.children[7].material=p,this.flyingLights=[];for(let s=0;s<100;s++){let w=new a.PointLight(12582787,1,20,2),o=new a.Mesh(new a.SphereBufferGeometry(.05),new a.MeshBasicMaterial({color:12582787}));o.add(w),o.position.set(50-Math.random()*100,Math.random()*50,50-Math.random()*100),this.realm.group.add(o),o.userData.velocity=new a.Vector3,this.flyingLights.push(o)}}async load(){this.chiptune.stop(),this.realm.conjure.getAudioManager().play("jumanji",{loop:!0})}async getTokens(){let e="r4sYcbdi4oE18FhVYWEhXa1AEe21XGR39z",t=await(await fetch("https://data.ripple.com/api/v2/address/"+e)).json();console.log(t)}update(e){e.input.isDown("X",!0,!0)&&e.input.isDown("Y",!0,!0)&&e.input.isDown("Z",!0,!0)&&(this.realm.sendData(this.swordTriggerEventProtocol),this.triggerSwordEvent());for(let t of this.flyingLights)t.userData.velocity.x+=(Math.random()-.5)*.005,t.userData.velocity.y+=(Math.random()-.5)*.005,t.userData.velocity.z+=(Math.random()-.5)*.005,t.position.add(t.userData.velocity),t.getWorldPosition(this.vec3).distanceTo(new a.Vector3)>50&&t.position.set(50-Math.random()*100,Math.random()*50,50-Math.random()*100);for(let t of this.tweens)t.update()}triggerSwordEvent(){if(this.realm.world.user.hasSword)return;this.realm.world.user.swordMesh.material.visible=!0,this.realm.world.user.hasSword=!0;for(let r of Object.values(this.realm.world.remoteUsers))r.swordMesh.material.visible=!0,r.hasSword=!0;this.realm.world.user.setAction("unsheath",.1,!0),this.realm.conjure.getAudioManager().play("sword");var e=this.sky.material.uniforms;e.turbidity.value=20,e.rayleigh.value=4,e.mieCoefficient.value=.02,e.mieDirectionalG.value=.4;var t=Math.PI*(.45-.5),i=2*Math.PI*(.2-.5);this.realm.conjure.sunPos.x=Math.cos(i),this.realm.conjure.sunPos.y=Math.sin(i)*Math.sin(t),this.realm.conjure.sunPos.z=Math.sin(i)*Math.cos(t),this.realm.conjure.dirLight.intensity=1.2,this.realm.conjure.dirLight.position.copy(this.realm.conjure.sunPos),e.sunPosition.value.copy(this.realm.conjure.sunPos)}}
