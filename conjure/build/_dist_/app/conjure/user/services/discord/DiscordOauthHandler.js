import"https://cdn.skypack.dev/pin/three@v0.117.1-NetLzdTnw9ga3y6o633U/min/three.js";import*as o from"../../../../../../web_modules/discord-oauth2.js";export default class a{constructor(e){this.serviceHandler=e,this.userData=void 0,this.loggedIn=!1}async initialise(){this.clientId="719132345483132948",this.oauth=new o({clientId:this.clientId,redirectUri:window.location.origin+"/success.html"}),this.url=this.oauth.generateAuthUrl({scope:"identify guilds",responseType:"token",state:crypto.randomBytes(16).toString("hex")});const e=self.basicStorage.getItem("discordAccessToken");return e?await this.getUser(e):!0}logOut(){if(!this.loggedIn)return;self.basicStorage.removeItem("discordAccessToken"),this.userData=void 0,this.setLoggedIn(!1)}logInToDiscord(){this.loggedIn?this.logOut():(window.addEventListener("message",function(e){if(e.data.message==="deliverResult"){let t=e.data.result.substr(1).split("&").map(s=>s.split("=")).reduce((s,[i,r])=>({...s,[i]:r}),{});this.getUser(t.access_token),e.source.close()}}.bind(this)),window.open(this.url,"Login"))}async getUser(e){if(!e)return!1;try{const t=await this.oauth.getUser(e);return console.log("Successfully logged into discord!"),self.basicStorage.setItem("discordAccessToken",e),this.setLoggedIn(!0),console.log(t),this.userData=t,this.serviceHandler.setData({discordName:this.userData.username,discordID:this.userData.id}),!0}catch(t){console.log("Sorry, could not log you in. Your session may have expired."),self.basicStorage.removeItem("discordAccessToken"),this.userData=void 0,this.setLoggedIn(!1)}}async getUserGuilds(){return await new Promise((e,t)=>{try{const s=self.basicStorage.getItem("discordAccessToken");this.oauth.getUserGuilds(s).then(i=>{e(i)})}catch(s){t(s)}})}setLoggedIn(e){this.loggedIn=e,this.serviceHandler.setAuthenticated(e)}}
