import{e as ie,V as ee,f as De,g as Me,h as Be,F as ot,i as lt,j as Ue,k as _e,T as Ge,l as Se,m as ut,n as q,s as ve,E as ct,o as O,G as je,B as ze,p as me,O as Ee,q as ht,r as ft,t as Ve,u as Z,v as pt,w as vt,x as mt,b as dt,y as gt,z as yt,A as wt,H as bt,I as de,J as se,U as Tt,K as At,N as Ft,Q as xt,W as ge,X as le,Y as Bt,Z as St,_ as Et}from"../../../../common/three.module-36fff313.js";/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */var Ke={},V=void 0,Pt=Ke;function Pe(l,c){var u=l.split("."),h=Pt;!(u[0]in h)&&h.execScript&&h.execScript("var "+u[0]);for(var f;u.length&&(f=u.shift());)!u.length&&c!==V?h[f]=c:h=h[f]?h[f]:h[f]={}}var C=typeof Uint8Array!="undefined"&&typeof Uint16Array!="undefined"&&typeof Uint32Array!="undefined"&&typeof DataView!="undefined";function te(l){var c=l.length,u=0,h=Number.POSITIVE_INFINITY,f,d,m,y,T,F,x,w,S,B;for(w=0;w<c;++w)l[w]>u&&(u=l[w]),l[w]<h&&(h=l[w]);for(f=1<<u,d=new(C?Uint32Array:Array)(f),m=1,y=0,T=2;m<=u;){for(w=0;w<c;++w)if(l[w]===m){for(F=0,x=y,S=0;S<m;++S)F=F<<1|x&1,x>>=1;for(B=m<<16|w,S=F;S<f;S+=T)d[S]=B;++y}++m,y<<=1,T<<=1}return[d,u,h]}function J(l,c){this.g=[],this.h=32768,this.d=this.f=this.a=this.l=0,this.input=C?new Uint8Array(l):l,this.m=!1,this.i=ye,this.r=!1,(c||!(c={}))&&(c.index&&(this.a=c.index),c.bufferSize&&(this.h=c.bufferSize),c.bufferType&&(this.i=c.bufferType),c.resize&&(this.r=c.resize));switch(this.i){case Oe:this.b=32768,this.c=new(C?Uint8Array:Array)(32768+this.h+258);break;case ye:this.b=0,this.c=new(C?Uint8Array:Array)(this.h),this.e=this.z,this.n=this.v,this.j=this.w;break;default:throw Error("invalid inflate mode")}}var Oe=0,ye=1,He={t:Oe,s:ye};J.prototype.k=function(){for(;!this.m;){var l=H(this,3);l&1&&(this.m=!0),l>>>=1;switch(l){case 0:var c=this.input,u=this.a,h=this.c,f=this.b,d=c.length,m=V,y=V,T=h.length,F=V;if(this.d=this.f=0,u+1>=d)throw Error("invalid uncompressed block header: LEN");if(m=c[u++]|c[u++]<<8,u+1>=d)throw Error("invalid uncompressed block header: NLEN");if(y=c[u++]|c[u++]<<8,m===~y)throw Error("invalid uncompressed block header: length verify");if(u+m>c.length)throw Error("input buffer is broken");switch(this.i){case Oe:for(;f+m>h.length;){if(F=T-f,m-=F,C)h.set(c.subarray(u,u+F),f),f+=F,u+=F;else for(;F--;)h[f++]=c[u++];this.b=f,h=this.e(),f=this.b}break;case ye:for(;f+m>h.length;)h=this.e({p:2});break;default:throw Error("invalid inflate mode")}if(C)h.set(c.subarray(u,u+m),f),f+=m,u+=m;else for(;m--;)h[f++]=c[u++];this.a=u,this.b=f,this.c=h;break;case 1:this.j(Ot,It);break;case 2:for(var x=H(this,5)+257,w=H(this,5)+1,S=H(this,4)+4,B=new(C?Uint8Array:Array)(Ie.length),_=V,z=V,M=V,E=V,k=V,R=V,G=V,I=V,j=V,I=0;I<S;++I)B[Ie[I]]=H(this,3);if(!C)for(I=S,S=B.length;I<S;++I)B[Ie[I]]=0;for(_=te(B),E=new(C?Uint8Array:Array)(x+w),I=0,j=x+w;I<j;)switch(k=ue(this,_),k){case 16:for(G=3+H(this,2);G--;)E[I++]=R;break;case 17:for(G=3+H(this,3);G--;)E[I++]=0;R=0;break;case 18:for(G=11+H(this,7);G--;)E[I++]=0;R=0;break;default:R=E[I++]=k}z=te(C?E.subarray(0,x):E.slice(0,x)),M=te(C?E.subarray(x):E.slice(x)),this.j(z,M);break;default:throw Error("unknown BTYPE: "+l)}}return this.n()};var Ye=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Ie=C?new Uint16Array(Ye):Ye,Ze=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],We=C?new Uint16Array(Ze):Ze,$e=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],we=C?new Uint8Array($e):$e,Qe=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],qe=C?new Uint16Array(Qe):Qe,Je=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],be=C?new Uint8Array(Je):Je,Le=new(C?Uint8Array:Array)(288),re,Ne;for(re=0,Ne=Le.length;re<Ne;++re)Le[re]=143>=re?8:255>=re?9:279>=re?7:8;var Ot=te(Le),Ce=new(C?Uint8Array:Array)(30),Te,et;for(Te=0,et=Ce.length;Te<et;++Te)Ce[Te]=5;var It=te(Ce);function H(l,c){for(var u=l.f,h=l.d,f=l.input,d=l.a,m=f.length,y;h<c;){if(d>=m)throw Error("input buffer is broken");u|=f[d++]<<h,h+=8}return y=u&(1<<c)-1,l.f=u>>>c,l.d=h-c,l.a=d,y}function ue(l,c){for(var u=l.f,h=l.d,f=l.input,d=l.a,m=f.length,y=c[0],T=c[1],F,x;h<T&&!(d>=m);)u|=f[d++]<<h,h+=8;if(F=y[u&(1<<T)-1],x=F>>>16,x>h)throw Error("invalid code length: "+x);return l.f=u>>x,l.d=h-x,l.a=d,F&65535}J.prototype.j=function(l,c){var u=this.c,h=this.b;this.o=l;for(var f=u.length-258,d,m,y,T;(d=ue(this,l))!==256;)if(256>d)h>=f&&(this.b=h,u=this.e(),h=this.b),u[h++]=d;else for(m=d-257,T=We[m],0<we[m]&&(T+=H(this,we[m])),d=ue(this,c),y=qe[d],0<be[d]&&(y+=H(this,be[d])),h>=f&&(this.b=h,u=this.e(),h=this.b);T--;)u[h]=u[h++-y];for(;8<=this.d;)this.d-=8,this.a--;this.b=h},J.prototype.w=function(l,c){var u=this.c,h=this.b;this.o=l;for(var f=u.length,d,m,y,T;(d=ue(this,l))!==256;)if(256>d)h>=f&&(u=this.e(),f=u.length),u[h++]=d;else for(m=d-257,T=We[m],0<we[m]&&(T+=H(this,we[m])),d=ue(this,c),y=qe[d],0<be[d]&&(y+=H(this,be[d])),h+T>f&&(u=this.e(),f=u.length);T--;)u[h]=u[h++-y];for(;8<=this.d;)this.d-=8,this.a--;this.b=h},J.prototype.e=function(){var l=new(C?Uint8Array:Array)(this.b-32768),c=this.b-32768,u,h,f=this.c;if(C)l.set(f.subarray(32768,l.length));else for(u=0,h=l.length;u<h;++u)l[u]=f[u+32768];if(this.g.push(l),this.l+=l.length,C)f.set(f.subarray(c,c+32768));else for(u=0;32768>u;++u)f[u]=f[c+u];return this.b=32768,f},J.prototype.z=function(l){var c,u=this.input.length/this.a+1|0,h,f,d,m=this.input,y=this.c;return l&&(typeof l.p=="number"&&(u=l.p),typeof l.u=="number"&&(u+=l.u)),2>u?(h=(m.length-this.a)/this.o[2],d=258*(h/2)|0,f=d<y.length?y.length+d:y.length<<1):f=y.length*u,C?(c=new Uint8Array(f),c.set(y)):c=y,this.c=c},J.prototype.n=function(){var l=0,c=this.c,u=this.g,h,f=new(C?Uint8Array:Array)(this.l+(this.b-32768)),d,m,y,T;if(u.length===0)return C?this.c.subarray(32768,this.b):this.c.slice(32768,this.b);for(d=0,m=u.length;d<m;++d)for(h=u[d],y=0,T=h.length;y<T;++y)f[l++]=h[y];for(d=32768,m=this.b;d<m;++d)f[l++]=c[d];return this.g=[],this.buffer=f},J.prototype.v=function(){var l,c=this.b;return C?this.r?(l=new Uint8Array(c),l.set(this.c.subarray(0,c))):l=this.c.subarray(0,c):(this.c.length>c&&(this.c.length=c),l=this.c),this.buffer=l};function ke(l,c){var u,h;this.input=l,this.a=0,(c||!(c={}))&&(c.index&&(this.a=c.index),c.verify&&(this.A=c.verify)),u=l[this.a++],h=l[this.a++];switch(u&15){case tt:this.method=tt;break;default:throw Error("unsupported compression method")}if(((u<<8)+h)%31!==0)throw Error("invalid fcheck flag:"+((u<<8)+h)%31);if(h&32)throw Error("fdict flag is not supported");this.q=new J(l,{index:this.a,bufferSize:c.bufferSize,bufferType:c.bufferType,resize:c.resize})}ke.prototype.k=function(){var l=this.input,c,u;if(c=this.q.k(),this.a=this.q.a,this.A){u=(l[this.a++]<<24|l[this.a++]<<16|l[this.a++]<<8|l[this.a++])>>>0;var h=c;if(typeof h=="string"){var f=h.split(""),d,m;for(d=0,m=f.length;d<m;d++)f[d]=(f[d].charCodeAt(0)&255)>>>0;h=f}for(var y=1,T=0,F=h.length,x,w=0;0<F;){x=1024<F?1024:F,F-=x;do y+=h[w++],T+=y;while(--x);y%=65521,T%=65521}if(u!==(T<<16|y)>>>0)throw Error("invalid adler-32 checksum")}return c};var tt=8;Pe("Zlib.Inflate",ke),Pe("Zlib.Inflate.prototype.decompress",ke.prototype.k);var Re={ADAPTIVE:He.s,BLOCK:He.t},ce,he,oe,rt;if(Object.keys)ce=Object.keys(Re);else for(he in ce=[],oe=0,Re)ce[oe++]=he;for(oe=0,rt=ce.length;oe<rt;++oe)he=ce[oe],Pe("Zlib.Inflate.BufferType."+he,Re[he]);var at=Ke.Zlib.Inflate,nt={findSpan:function(l,c,u){var h=u.length-l-1;if(c>=u[h])return h-1;if(c<=u[l])return l;for(var f=l,d=h,m=Math.floor((f+d)/2);c<u[m]||c>=u[m+1];)c<u[m]?d=m:f=m,m=Math.floor((f+d)/2);return m},calcBasisFunctions:function(l,c,u,h){var f=[],d=[],m=[];f[0]=1;for(var y=1;y<=u;++y){d[y]=c-h[l+1-y],m[y]=h[l+y]-c;for(var T=0,F=0;F<y;++F){var x=m[F+1],w=d[y-F],S=f[F]/(x+w);f[F]=T+x*S,T=w*S}f[y]=T}return f},calcBSplinePoint:function(l,c,u,h){for(var f=this.findSpan(l,h,c),d=this.calcBasisFunctions(f,h,l,c),m=new ie(0,0,0,0),y=0;y<=l;++y){var T=u[f-l+y],F=d[y],x=T.w*F;m.x+=T.x*x,m.y+=T.y*x,m.z+=T.z*x,m.w+=T.w*F}return m},calcBasisFunctionDerivatives:function(l,c,u,h,f){for(var d=[],m=0;m<=u;++m)d[m]=0;for(var y=[],m=0;m<=h;++m)y[m]=d.slice(0);for(var T=[],m=0;m<=u;++m)T[m]=d.slice(0);T[0][0]=1;for(var F=d.slice(0),x=d.slice(0),w=1;w<=u;++w){F[w]=c-f[l+1-w],x[w]=f[l+w]-c;for(var S=0,L=0;L<w;++L){var B=x[L+1],_=F[w-L];T[w][L]=B+_;var z=T[L][w-1]/T[w][L];T[L][w]=S+B*z,S=_*z}T[w][w]=S}for(var w=0;w<=u;++w)y[0][w]=T[w][u];for(var L=0;L<=u;++L){for(var M=0,E=1,k=[],m=0;m<=u;++m)k[m]=d.slice(0);k[0][0]=1;for(var R=1;R<=h;++R){var G=0,I=L-R,j=u-R;L>=R&&(k[E][0]=k[M][0]/T[j+1][I],G=k[E][0]*T[I][j]);for(var Ae=I>=-1?1:-I,Fe=L-1<=j?R-1:u-L,w=Ae;w<=Fe;++w)k[E][w]=(k[M][w]-k[M][w-1])/T[j+1][I+w],G+=k[E][w]*T[I+w][j];L<=j&&(k[E][R]=-k[M][R-1]/T[j+1][L],G+=k[E][R]*T[L][j]),y[R][L]=G;var w=M;M=E,E=w}}for(var L=u,R=1;R<=h;++R){for(var w=0;w<=u;++w)y[R][w]*=L;L*=u-R}return y},calcBSplineDerivatives:function(l,c,u,h,f){for(var d=f<l?f:l,m=[],y=this.findSpan(l,h,c),T=this.calcBasisFunctionDerivatives(y,h,l,d,c),F=[],x=0;x<u.length;++x){var w=u[x].clone(),S=w.w;w.x*=S,w.y*=S,w.z*=S,F[x]=w}for(var B=0;B<=d;++B){for(var w=F[y-l].clone().multiplyScalar(T[B][0]),_=1;_<=l;++_)w.add(F[y-l+_].clone().multiplyScalar(T[B][_]));m[B]=w}for(var B=d+1;B<=f+1;++B)m[B]=new ie(0,0,0);return m},calcKoverI:function(l,c){for(var u=1,h=2;h<=l;++h)u*=h;for(var f=1,h=2;h<=c;++h)f*=h;for(var h=2;h<=l-c;++h)f*=h;return u/f},calcRationalCurveDerivatives:function(l){for(var c=l.length,u=[],h=[],f=0;f<c;++f){var d=l[f];u[f]=new ee(d.x,d.y,d.z),h[f]=d.w}for(var m=[],y=0;y<c;++y){for(var T=u[y].clone(),f=1;f<=y;++f)T.sub(m[y-f].clone().multiplyScalar(this.calcKoverI(y,f)*h[f]));m[y]=T.divideScalar(h[0])}return m},calcNURBSDerivatives:function(l,c,u,h,f){var d=this.calcBSplineDerivatives(l,c,u,h,f);return this.calcRationalCurveDerivatives(d)},calcSurfacePoint:function(l,c,u,h,f,d,m,y){for(var T=this.findSpan(l,d,u),F=this.findSpan(c,m,h),x=this.calcBasisFunctions(T,d,l,u),w=this.calcBasisFunctions(F,m,c,h),S=[],B=0;B<=c;++B){S[B]=new ie(0,0,0,0);for(var _=0;_<=l;++_){var z=f[T-l+_][F-c+B].clone(),M=z.w;z.x*=M,z.y*=M,z.z*=M,S[B].add(z.multiplyScalar(x[_]))}}for(var E=new ie(0,0,0,0),B=0;B<=c;++B)E.add(S[B].multiplyScalar(w[B]));E.divideScalar(E.w),y.set(E.x,E.y,E.z)}},ae=function(l,c,u,h,f){De.call(this),this.degree=l,this.knots=c,this.controlPoints=[],this.startKnot=h||0,this.endKnot=f||this.knots.length-1;for(var d=0;d<u.length;++d){var m=u[d];this.controlPoints[d]=new ie(m.x,m.y,m.z,m.w)}};ae.prototype=Object.create(De.prototype),ae.prototype.constructor=ae,ae.prototype.getPoint=function(l,c){var u=c||new ee,h=this.knots[this.startKnot]+l*(this.knots[this.endKnot]-this.knots[this.startKnot]),f=nt.calcBSplinePoint(this.degree,this.knots,this.controlPoints,h);return f.w!=1&&f.divideScalar(f.w),u.set(f.x,f.y,f.z)},ae.prototype.getTangent=function(l,c){var u=c||new ee,h=this.knots[0]+l*(this.knots[this.knots.length-1]-this.knots[0]),f=nt.calcNURBSDerivatives(this.degree,this.knots,this.controlPoints,h,1);return u.copy(f[1]).normalize(),u};var Lt=function(){var l,c,u;function h(e){Me.call(this,e)}h.prototype=Object.assign(Object.create(Me.prototype),{constructor:h,load:function(e,t,r,n){var a=this,i=a.path===""?Be.extractUrlBase(e):a.path,s=new ot(this.manager);s.setPath(a.path),s.setResponseType("arraybuffer"),s.setRequestHeader(a.requestHeader),s.setWithCredentials(a.withCredentials),s.load(e,function(o){try{t(a.parse(o,i))}catch(v){n?n(v):console.error(v),a.manager.itemError(e)}},r,n)},parse:function(e,t){if(w(e))l=new T().parse(e);else{var r=j(e);if(!S(r))throw new Error("THREE.FBXLoader: Unknown format.");if(B(r)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+B(r));l=new y().parse(r)}var n=new lt(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new f(n,this.manager).parse(l)}});function f(e,t){this.textureLoader=e,this.manager=t}f.prototype={constructor:f,parse:function(){c=this.parseConnections();var e=this.parseImages(),t=this.parseTextures(e),r=this.parseMaterials(t),n=this.parseDeformers(),a=new d().parse(n);return this.parseScene(n,a,r),u},parseConnections:function(){var e=new Map;if("Connections"in l){var t=l.Connections.connections;t.forEach(function(r){var n=r[0],a=r[1],i=r[2];e.has(n)||e.set(n,{parents:[],children:[]});var s={ID:a,relationship:i};e.get(n).parents.push(s),e.has(a)||e.set(a,{parents:[],children:[]});var o={ID:n,relationship:i};e.get(a).children.push(o)})}return e},parseImages:function(){var e={},t={};if("Video"in l.Objects){var r=l.Objects.Video;for(var n in r){var a=r[n],i=parseInt(n);if(e[i]=a.RelativeFilename||a.Filename,"Content"in a){var s=a.Content instanceof ArrayBuffer&&a.Content.byteLength>0,o=typeof a.Content=="string"&&a.Content!=="";if(s||o){var v=this.parseImage(r[n]);t[a.RelativeFilename||a.Filename]=v}}}}for(var i in e){var g=e[i];t[g]!==void 0?e[i]=t[g]:e[i]=e[i].split("\\").pop()}return e},parseImage:function(e){var t=e.Content,r=e.RelativeFilename||e.Filename,n=r.slice(r.lastIndexOf(".")+1).toLowerCase(),a;switch(n){case"bmp":a="image/bmp";break;case"jpg":case"jpeg":a="image/jpeg";break;case"png":a="image/png";break;case"tif":a="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",r),a="image/tga";break;default:console.warn('FBXLoader: Image type "'+n+'" is not supported.');return}if(typeof t=="string")return"data:"+a+";base64,"+t;var i=new Uint8Array(t);return window.URL.createObjectURL(new Blob([i],{type:a}))},parseTextures:function(e){var t=new Map;if("Texture"in l.Objects){var r=l.Objects.Texture;for(var n in r){var a=this.parseTexture(r[n],e);t.set(parseInt(n),a)}}return t},parseTexture:function(e,t){var r=this.loadTexture(e,t);r.ID=e.id,r.name=e.attrName;var n=e.WrapModeU,a=e.WrapModeV,i=n!==void 0?n.value:0,s=a!==void 0?a.value:0;if(r.wrapS=i===0?Ue:_e,r.wrapT=s===0?Ue:_e,"Scaling"in e){var o=e.Scaling.value;r.repeat.x=o[0],r.repeat.y=o[1]}return r},loadTexture:function(e,t){var r,n=this.textureLoader.path,a=c.get(e.id).children;a!==void 0&&a.length>0&&t[a[0].ID]!==void 0&&(r=t[a[0].ID],(r.indexOf("blob:")===0||r.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));var i,s=e.FileName.slice(-3).toLowerCase();if(s==="tga"){var o=this.manager.getHandler(".tga");o===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),i=new Ge):i=o.load(r)}else s==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),i=new Ge):i=this.textureLoader.load(r);return this.textureLoader.setPath(n),i},parseMaterials:function(e){var t=new Map;if("Material"in l.Objects){var r=l.Objects.Material;for(var n in r){var a=this.parseMaterial(r[n],e);a!==null&&t.set(parseInt(n),a)}}return t},parseMaterial:function(e,t){var r=e.id,n=e.attrName,a=e.ShadingModel;if(typeof a=="object"&&(a=a.value),!c.has(r))return null;var i=this.parseParameters(e,t,r),s;switch(a.toLowerCase()){case"phong":s=new Se;break;case"lambert":s=new ut;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',a),s=new Se;break}return s.setValues(i),s.name=n,s},parseParameters:function(e,t,r){var n={};e.BumpFactor&&(n.bumpScale=e.BumpFactor.value),e.Diffuse?n.color=new q().fromArray(e.Diffuse.value):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(n.color=new q().fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(n.displacementScale=e.DisplacementFactor.value),e.Emissive?n.emissive=new q().fromArray(e.Emissive.value):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(n.emissive=new q().fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(n.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(n.opacity=parseFloat(e.Opacity.value)),n.opacity<1&&(n.transparent=!0),e.ReflectionFactor&&(n.reflectivity=e.ReflectionFactor.value),e.Shininess&&(n.shininess=e.Shininess.value),e.Specular?n.specular=new q().fromArray(e.Specular.value):e.SpecularColor&&e.SpecularColor.type==="Color"&&(n.specular=new q().fromArray(e.SpecularColor.value));var a=this;return c.get(r).children.forEach(function(i){var s=i.relationship;switch(s){case"Bump":n.bumpMap=a.getTexture(t,i.ID);break;case"Maya|TEX_ao_map":n.aoMap=a.getTexture(t,i.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":n.map=a.getTexture(t,i.ID),n.map.encoding=ve;break;case"DisplacementColor":n.displacementMap=a.getTexture(t,i.ID);break;case"EmissiveColor":n.emissiveMap=a.getTexture(t,i.ID),n.emissiveMap.encoding=ve;break;case"NormalMap":case"Maya|TEX_normal_map":n.normalMap=a.getTexture(t,i.ID);break;case"ReflectionColor":n.envMap=a.getTexture(t,i.ID),n.envMap.mapping=ct,n.envMap.encoding=ve;break;case"SpecularColor":n.specularMap=a.getTexture(t,i.ID),n.specularMap.encoding=ve;break;case"TransparentColor":case"TransparencyFactor":n.alphaMap=a.getTexture(t,i.ID),n.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",s);break}}),n},getTexture:function(e,t){return"LayeredTexture"in l.Objects&&t in l.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=c.get(t).children[0].ID),e.get(t)},parseDeformers:function(){var e={},t={};if("Deformer"in l.Objects){var r=l.Objects.Deformer;for(var n in r){var a=r[n],i=c.get(parseInt(n));if(a.attrType==="Skin"){var s=this.parseSkeleton(i,r);s.ID=n,i.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),s.geometryID=i.parents[0].ID,e[n]=s}else if(a.attrType==="BlendShape"){var o={id:n};o.rawTargets=this.parseMorphTargets(i,r),o.id=n,i.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[n]=o}}}return{skeletons:e,morphTargets:t}},parseSkeleton:function(e,t){var r=[];return e.children.forEach(function(n){var a=t[n.ID];if(a.attrType!=="Cluster")return;var i={ID:n.ID,indices:[],weights:[],transformLink:new O().fromArray(a.TransformLink.a)};"Indexes"in a&&(i.indices=a.Indexes.a,i.weights=a.Weights.a),r.push(i)}),{rawBones:r,bones:[]}},parseMorphTargets:function(e,t){for(var r=[],n=0;n<e.children.length;n++){var a=e.children[n],i=t[a.ID],s={name:i.attrName,initialWeight:i.DeformPercent,id:i.id,fullWeights:i.FullWeights.a};if(i.attrType!=="BlendShapeChannel")return;s.geoID=c.get(parseInt(a.ID)).children.filter(function(o){return o.relationship===void 0})[0].ID,r.push(s)}return r},parseScene:function(e,t,r){u=new je;var n=this.parseModels(e.skeletons,t,r),a=l.Objects.Model,i=this;n.forEach(function(o){var v=a[o.ID];i.setLookAtProperties(o,v);var g=c.get(o.ID).parents;g.forEach(function(p){var b=n.get(p.ID);b!==void 0&&b.add(o)}),o.parent===null&&u.add(o)}),this.bindSkeleton(e.skeletons,t,n),this.createAmbientLight(),this.setupMorphMaterials(),u.traverse(function(o){if(o.userData.transformData){o.parent&&(o.userData.transformData.parentMatrixWorld=o.parent.matrix);var v=R(o.userData.transformData);o.applyMatrix4(v)}});var s=new m().parse();u.children.length===1&&u.children[0].isGroup&&(u.children[0].animations=s,u=u.children[0]),u.animations=s},parseModels:function(e,t,r){var n=new Map,a=l.Objects.Model;for(var i in a){var s=parseInt(i),o=a[i],v=c.get(s),g=this.buildSkeleton(v,e,s,o.attrName);if(!g){switch(o.attrType){case"Camera":g=this.createCamera(v);break;case"Light":g=this.createLight(v);break;case"Mesh":g=this.createMesh(v,t,r);break;case"NurbsCurve":g=this.createCurve(v,t);break;case"LimbNode":case"Root":g=new ze;break;case"Null":default:g=new je;break}g.name=o.attrName?me.sanitizeNodeName(o.attrName):"",g.ID=s}this.getTransformData(g,o),n.set(s,g)}return n},buildSkeleton:function(e,t,r,n){var a=null;return e.parents.forEach(function(i){for(var s in t){var o=t[s];o.rawBones.forEach(function(v,g){if(v.ID===i.ID){var p=a;a=new ze,a.matrixWorld.copy(v.transformLink),a.name=n?me.sanitizeNodeName(n):"",a.ID=r,o.bones[g]=a,p!==null&&a.add(p)}})}}),a},createCamera:function(e){var t,r;if(e.children.forEach(function(b){var A=l.Objects.NodeAttribute[b.ID];A!==void 0&&(r=A)}),r===void 0)t=new Ee;else{var n=0;r.CameraProjectionType!==void 0&&r.CameraProjectionType.value===1&&(n=1);var a=1;r.NearPlane!==void 0&&(a=r.NearPlane.value/1e3);var i=1e3;r.FarPlane!==void 0&&(i=r.FarPlane.value/1e3);var s=window.innerWidth,o=window.innerHeight;r.AspectWidth!==void 0&&r.AspectHeight!==void 0&&(s=r.AspectWidth.value,o=r.AspectHeight.value);var v=s/o,g=45;r.FieldOfView!==void 0&&(g=r.FieldOfView.value);var p=r.FocalLength?r.FocalLength.value:null;switch(n){case 0:t=new ft(g,v,a,i),p!==null&&t.setFocalLength(p);break;case 1:t=new ht(-s/2,s/2,o/2,-o/2,a,i);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+n+"."),t=new Ee;break}}return t},createLight:function(e){var t,r;if(e.children.forEach(function(p){var b=l.Objects.NodeAttribute[p.ID];b!==void 0&&(r=b)}),r===void 0)t=new Ee;else{var n;r.LightType===void 0?n=0:n=r.LightType.value;var a=16777215;r.Color!==void 0&&(a=new q().fromArray(r.Color.value));var i=r.Intensity===void 0?1:r.Intensity.value/100;r.CastLightOnObject!==void 0&&r.CastLightOnObject.value===0&&(i=0);var s=0;r.FarAttenuationEnd!==void 0&&(r.EnableFarAttenuation!==void 0&&r.EnableFarAttenuation.value===0?s=0:s=r.FarAttenuationEnd.value);var o=1;switch(n){case 0:t=new Ve(a,i,s,o);break;case 1:t=new vt(a,i);break;case 2:var v=Math.PI/3;r.InnerAngle!==void 0&&(v=Z.degToRad(r.InnerAngle.value));var g=0;r.OuterAngle!==void 0&&(g=Z.degToRad(r.OuterAngle.value),g=Math.max(g,1)),t=new pt(a,i,s,v,g,o);break;default:console.warn("THREE.FBXLoader: Unknown light type "+r.LightType.value+", defaulting to a PointLight."),t=new Ve(a,i);break}r.CastShadows!==void 0&&r.CastShadows.value===1&&(t.castShadow=!0)}return t},createMesh:function(e,t,r){var n,a=null,i=null,s=[];return e.children.forEach(function(o){t.has(o.ID)&&(a=t.get(o.ID)),r.has(o.ID)&&s.push(r.get(o.ID))}),s.length>1?i=s:s.length>0?i=s[0]:(i=new Se({color:13421772}),s.push(i)),"color"in a.attributes&&s.forEach(function(o){o.vertexColors=!0}),a.FBX_Deformer?(s.forEach(function(o){o.skinning=!0}),n=new mt(a,i),n.normalizeSkinWeights()):n=new dt(a,i),n},createCurve:function(e,t){var r=e.children.reduce(function(a,i){return t.has(i.ID)&&(a=t.get(i.ID)),a},null),n=new gt({color:3342591,linewidth:1});return new yt(r,n)},getTransformData:function(e,t){var r={};"InheritType"in t&&(r.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?r.eulerOrder=G(t.RotationOrder.value):r.eulerOrder="ZYX","Lcl_Translation"in t&&(r.translation=t.Lcl_Translation.value),"PreRotation"in t&&(r.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(r.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(r.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(r.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(r.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(r.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(r.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(r.rotationPivot=t.RotationPivot.value),e.userData.transformData=r},setLookAtProperties:function(e,t){if("LookAtProperty"in t){var r=c.get(e.ID).children;r.forEach(function(n){if(n.relationship==="LookAtProperty"){var a=l.Objects.Model[n.ID];if("Lcl_Translation"in a){var i=a.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(i),u.add(e.target)):e.lookAt(new ee().fromArray(i))}}})}},bindSkeleton:function(e,t,r){var n=this.parsePoseNodes();for(var a in e){var i=e[a],s=c.get(parseInt(i.ID)).parents;s.forEach(function(o){if(t.has(o.ID)){var v=o.ID,g=c.get(v);g.parents.forEach(function(p){if(r.has(p.ID)){var b=r.get(p.ID);b.bind(new wt(i.bones),n[p.ID])}})}})}},parsePoseNodes:function(){var e={};if("Pose"in l.Objects){var t=l.Objects.Pose;for(var r in t)if(t[r].attrType==="BindPose"){var n=t[r].PoseNode;Array.isArray(n)?n.forEach(function(a){e[a.Node]=new O().fromArray(a.Matrix.a)}):e[n.Node]=new O().fromArray(n.Matrix.a)}}return e},createAmbientLight:function(){if("GlobalSettings"in l&&"AmbientColor"in l.GlobalSettings){var e=l.GlobalSettings.AmbientColor.value,t=e[0],r=e[1],n=e[2];if(t!==0||r!==0||n!==0){var a=new q(t,r,n);u.add(new bt(a,1))}}},setupMorphMaterials:function(){var e=this;u.traverse(function(t){t.isMesh&&(t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach(function(r,n){e.setupMorphMaterial(t,r,n)}):e.setupMorphMaterial(t,t.material)))})},setupMorphMaterial:function(e,t,r){var n=e.uuid,a=t.uuid,i=!1;if(u.traverse(function(o){o.isMesh&&(Array.isArray(o.material)?o.material.forEach(function(v){v.uuid===a&&o.uuid!==n&&(i=!0)}):o.material.uuid===a&&o.uuid!==n&&(i=!0))}),i===!0){var s=t.clone();s.morphTargets=!0,r===void 0?e.material=s:e.material[r]=s}else t.morphTargets=!0}};function d(){}d.prototype={constructor:d,parse:function(e){var t=new Map;if("Geometry"in l.Objects){var r=l.Objects.Geometry;for(var n in r){var a=c.get(parseInt(n)),i=this.parseGeometry(a,r[n],e);t.set(parseInt(n),i)}}return t},parseGeometry:function(e,t,r){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,r);case"NurbsCurve":return this.parseNurbsGeometry(t)}},parseMeshGeometry:function(e,t,r){var n=r.skeletons,a=[],i=e.parents.map(function(p){return l.Objects.Model[p.ID]});if(i.length===0)return;var s=e.children.reduce(function(p,b){return n[b.ID]!==void 0&&(p=n[b.ID]),p},null);e.children.forEach(function(p){r.morphTargets[p.ID]!==void 0&&a.push(r.morphTargets[p.ID])});var o=i[0],v={};"RotationOrder"in o&&(v.eulerOrder=G(o.RotationOrder.value)),"InheritType"in o&&(v.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(v.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(v.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(v.scale=o.GeometricScaling.value);var g=R(v);return this.genGeometry(t,s,a,g)},genGeometry:function(e,t,r,n){var a=new de;e.attrName&&(a.name=e.attrName);var i=this.parseGeoNode(e,t),s=this.genBuffers(i),o=new se(s.vertex,3);if(o.applyMatrix4(n),a.setAttribute("position",o),s.colors.length>0&&a.setAttribute("color",new se(s.colors,3)),t&&(a.setAttribute("skinIndex",new Tt(s.weightsIndices,4)),a.setAttribute("skinWeight",new se(s.vertexWeights,4)),a.FBX_Deformer=t),s.normal.length>0){var v=new At().getNormalMatrix(n),g=new se(s.normal,3);g.applyNormalMatrix(v),a.setAttribute("normal",g)}if(s.uvs.forEach(function(U,X){var D="uv"+(X+1).toString();X===0&&(D="uv"),a.setAttribute(D,new se(s.uvs[X],2))}),i.material&&i.material.mappingType!=="AllSame"){var p=s.materialIndex[0],b=0;if(s.materialIndex.forEach(function(U,X){U!==p&&(a.addGroup(b,X-b,p),p=U,b=X)}),a.groups.length>0){var A=a.groups[a.groups.length-1],P=A.start+A.count;P!==s.materialIndex.length&&a.addGroup(P,s.materialIndex.length-P,p)}a.groups.length===0&&a.addGroup(0,s.materialIndex.length,s.materialIndex[0])}return this.addMorphTargets(a,e,r,n),a},parseGeoNode:function(e,t){var r={};if(r.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],r.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(r.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(r.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(r.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){r.uv=[];for(var n=0;e.LayerElementUV[n];)e.LayerElementUV[n].UV&&r.uv.push(this.parseUVs(e.LayerElementUV[n])),n++}return r.weightTable={},t!==null&&(r.skeleton=t,t.rawBones.forEach(function(a,i){a.indices.forEach(function(s,o){r.weightTable[s]===void 0&&(r.weightTable[s]=[]),r.weightTable[s].push({id:i,weight:a.weights[o]})})})),r},genBuffers:function(e){var t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},r=0,n=0,a=!1,i=[],s=[],o=[],v=[],g=[],p=[],b=this;return e.vertexIndices.forEach(function(A,P){var U=!1;A<0&&(A=A^-1,U=!0);var X=[],D=[];if(i.push(A*3,A*3+1,A*3+2),e.color){var K=M(P,r,A,e.color);o.push(K[0],K[1],K[2])}if(e.skeleton){if(e.weightTable[A]!==void 0&&e.weightTable[A].forEach(function(W){D.push(W.weight),X.push(W.id)}),D.length>4){a||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),a=!0);var $=[0,0,0,0],N=[0,0,0,0];D.forEach(function(W,Y){var Q=W,pe=X[Y];N.forEach(function(Xe,xe,it){if(Q>Xe){it[xe]=Q,Q=Xe;var st=$[xe];$[xe]=pe,pe=st}})}),X=$,D=N}for(;D.length<4;)D.push(0),X.push(0);for(var ne=0;ne<4;++ne)g.push(D[ne]),p.push(X[ne])}if(e.normal){var K=M(P,r,A,e.normal);s.push(K[0],K[1],K[2])}if(e.material&&e.material.mappingType!=="AllSame")var fe=M(P,r,A,e.material)[0];e.uv&&e.uv.forEach(function(W,Y){var Q=M(P,r,A,W);v[Y]===void 0&&(v[Y]=[]),v[Y].push(Q[0]),v[Y].push(Q[1])}),n++,U&&(b.genFace(t,e,i,fe,s,o,v,g,p,n),r++,n=0,i=[],s=[],o=[],v=[],g=[],p=[])}),t},genFace:function(e,t,r,n,a,i,s,o,v,g){for(var p=2;p<g;p++)e.vertex.push(t.vertexPositions[r[0]]),e.vertex.push(t.vertexPositions[r[1]]),e.vertex.push(t.vertexPositions[r[2]]),e.vertex.push(t.vertexPositions[r[(p-1)*3]]),e.vertex.push(t.vertexPositions[r[(p-1)*3+1]]),e.vertex.push(t.vertexPositions[r[(p-1)*3+2]]),e.vertex.push(t.vertexPositions[r[p*3]]),e.vertex.push(t.vertexPositions[r[p*3+1]]),e.vertex.push(t.vertexPositions[r[p*3+2]]),t.skeleton&&(e.vertexWeights.push(o[0]),e.vertexWeights.push(o[1]),e.vertexWeights.push(o[2]),e.vertexWeights.push(o[3]),e.vertexWeights.push(o[(p-1)*4]),e.vertexWeights.push(o[(p-1)*4+1]),e.vertexWeights.push(o[(p-1)*4+2]),e.vertexWeights.push(o[(p-1)*4+3]),e.vertexWeights.push(o[p*4]),e.vertexWeights.push(o[p*4+1]),e.vertexWeights.push(o[p*4+2]),e.vertexWeights.push(o[p*4+3]),e.weightsIndices.push(v[0]),e.weightsIndices.push(v[1]),e.weightsIndices.push(v[2]),e.weightsIndices.push(v[3]),e.weightsIndices.push(v[(p-1)*4]),e.weightsIndices.push(v[(p-1)*4+1]),e.weightsIndices.push(v[(p-1)*4+2]),e.weightsIndices.push(v[(p-1)*4+3]),e.weightsIndices.push(v[p*4]),e.weightsIndices.push(v[p*4+1]),e.weightsIndices.push(v[p*4+2]),e.weightsIndices.push(v[p*4+3])),t.color&&(e.colors.push(i[0]),e.colors.push(i[1]),e.colors.push(i[2]),e.colors.push(i[(p-1)*3]),e.colors.push(i[(p-1)*3+1]),e.colors.push(i[(p-1)*3+2]),e.colors.push(i[p*3]),e.colors.push(i[p*3+1]),e.colors.push(i[p*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(n),e.materialIndex.push(n),e.materialIndex.push(n)),t.normal&&(e.normal.push(a[0]),e.normal.push(a[1]),e.normal.push(a[2]),e.normal.push(a[(p-1)*3]),e.normal.push(a[(p-1)*3+1]),e.normal.push(a[(p-1)*3+2]),e.normal.push(a[p*3]),e.normal.push(a[p*3+1]),e.normal.push(a[p*3+2])),t.uv&&t.uv.forEach(function(b,A){e.uvs[A]===void 0&&(e.uvs[A]=[]),e.uvs[A].push(s[A][0]),e.uvs[A].push(s[A][1]),e.uvs[A].push(s[A][(p-1)*2]),e.uvs[A].push(s[A][(p-1)*2+1]),e.uvs[A].push(s[A][p*2]),e.uvs[A].push(s[A][p*2+1])})},addMorphTargets:function(e,t,r,n){if(r.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];var a=this;r.forEach(function(i){i.rawTargets.forEach(function(s){var o=l.Objects.Geometry[s.geoID];o!==void 0&&a.genMorphGeometry(e,t,o,n,s.name)})})},genMorphGeometry:function(e,t,r,n,a){for(var i=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],s=r.Vertices!==void 0?r.Vertices.a:[],o=r.Indexes!==void 0?r.Indexes.a:[],v=e.attributes.position.count*3,g=new Float32Array(v),p=0;p<o.length;p++){var b=o[p]*3;g[b]=s[p*3],g[b+1]=s[p*3+1],g[b+2]=s[p*3+2]}var A={vertexIndices:i,vertexPositions:g},P=this.genBuffers(A),U=new se(P.vertex,3);U.name=a||r.attrName,U.applyMatrix4(n),e.morphAttributes.position.push(U)},parseNormals:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.Normals.a,a=[];return r==="IndexToDirect"&&("NormalIndex"in e?a=e.NormalIndex.a:"NormalsIndex"in e&&(a=e.NormalsIndex.a)),{dataSize:3,buffer:n,indices:a,mappingType:t,referenceType:r}},parseUVs:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.UV.a,a=[];return r==="IndexToDirect"&&(a=e.UVIndex.a),{dataSize:2,buffer:n,indices:a,mappingType:t,referenceType:r}},parseVertexColors:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.Colors.a,a=[];return r==="IndexToDirect"&&(a=e.ColorIndex.a),{dataSize:4,buffer:n,indices:a,mappingType:t,referenceType:r}},parseMaterialIndices:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};for(var n=e.Materials.a,a=[],i=0;i<n.length;++i)a.push(i);return{dataSize:1,buffer:n,indices:a,mappingType:t,referenceType:r}},parseNurbsGeometry:function(e){if(ae===void 0)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new de;var t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new de;for(var r=t-1,n=e.KnotVector.a,a=[],i=e.Points.a,s=0,o=i.length;s<o;s+=4)a.push(new ie().fromArray(i,s));var v,g;if(e.Form==="Closed")a.push(a[0]);else if(e.Form==="Periodic"){v=r,g=n.length-1-v;for(var s=0;s<r;++s)a.push(a[s])}var p=new ae(r,n,a,v,g),b=p.getPoints(a.length*7),A=new Float32Array(b.length*3);b.forEach(function(U,X){U.toArray(A,X*3)});var P=new de;return P.setAttribute("position",new Ft(A,3)),P}};function m(){}m.prototype={constructor:m,parse:function(){var e=[],t=this.parseClips();if(t!==void 0)for(var r in t){var n=t[r],a=this.addClip(n);e.push(a)}return e},parseClips:function(){if(l.Objects.AnimationCurve===void 0)return;var e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);var t=this.parseAnimationLayers(e),r=this.parseAnimStacks(t);return r},parseAnimationCurveNodes:function(){var e=l.Objects.AnimationCurveNode,t=new Map;for(var r in e){var n=e[r];if(n.attrName.match(/S|R|T|DeformPercent/)!==null){var a={id:n.id,attr:n.attrName,curves:{}};t.set(a.id,a)}}return t},parseAnimationCurves:function(e){var t=l.Objects.AnimationCurve;for(var r in t){var n={id:t[r].id,times:t[r].KeyTime.a.map(_),values:t[r].KeyValueFloat.a},a=c.get(n.id);if(a!==void 0){var i=a.parents[0].ID,s=a.parents[0].relationship;s.match(/X/)?e.get(i).curves.x=n:s.match(/Y/)?e.get(i).curves.y=n:s.match(/Z/)?e.get(i).curves.z=n:s.match(/d|DeformPercent/)&&e.has(i)&&(e.get(i).curves.morph=n)}}},parseAnimationLayers:function(e){var t=l.Objects.AnimationLayer,r=new Map;for(var n in t){var a=[],i=c.get(parseInt(n));if(i!==void 0){var s=i.children;s.forEach(function(o,v){if(e.has(o.ID)){var g=e.get(o.ID);if(g.curves.x!==void 0||g.curves.y!==void 0||g.curves.z!==void 0){if(a[v]===void 0){var p=c.get(o.ID).parents.filter(function(D){return D.relationship!==void 0})[0].ID;if(p!==void 0){var b=l.Objects.Model[p.toString()];if(b===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",o);return}var A={modelName:b.attrName?me.sanitizeNodeName(b.attrName):"",ID:b.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};u.traverse(function(D){D.ID===b.id&&(A.transform=D.matrix,D.userData.transformData&&(A.eulerOrder=D.userData.transformData.eulerOrder))}),A.transform||(A.transform=new O),"PreRotation"in b&&(A.preRotation=b.PreRotation.value),"PostRotation"in b&&(A.postRotation=b.PostRotation.value),a[v]=A}}a[v]&&(a[v][g.attr]=g)}else if(g.curves.morph!==void 0){if(a[v]===void 0){var P=c.get(o.ID).parents.filter(function(N){return N.relationship!==void 0})[0].ID,U=c.get(P).parents[0].ID,X=c.get(U).parents[0].ID,p=c.get(X).parents[0].ID,b=l.Objects.Model[p],A={modelName:b.attrName?me.sanitizeNodeName(b.attrName):"",morphName:l.Objects.Deformer[P].attrName};a[v]=A}a[v][g.attr]=g}}}),r.set(parseInt(n),a)}}return r},parseAnimStacks:function(e){var t=l.Objects.AnimationStack,r={};for(var n in t){var a=c.get(parseInt(n)).children;a.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var i=e.get(a[0].ID);r[n]={name:t[n].attrName,layer:i}}return r},addClip:function(e){var t=[],r=this;return e.layer.forEach(function(n){t=t.concat(r.generateTracks(n))}),new xt(e.name,-1,t)},generateTracks:function(e){var t=[],r=new ee,n=new ge,a=new ee;if(e.transform&&e.transform.decompose(r,n,a),r=r.toArray(),n=new le().setFromQuaternion(n,e.eulerOrder).toArray(),a=a.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){var i=this.generateVectorTrack(e.modelName,e.T.curves,r,"position");i!==void 0&&t.push(i)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){var s=this.generateRotationTrack(e.modelName,e.R.curves,n,e.preRotation,e.postRotation,e.eulerOrder);s!==void 0&&t.push(s)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){var o=this.generateVectorTrack(e.modelName,e.S.curves,a,"scale");o!==void 0&&t.push(o)}if(e.DeformPercent!==void 0){var v=this.generateMorphTrack(e);v!==void 0&&t.push(v)}return t},generateVectorTrack:function(e,t,r,n){var a=this.getTimesForAllAxes(t),i=this.getKeyframeTrackValues(a,t,r);return new Bt(e+"."+n,a,i)},generateRotationTrack:function(e,t,r,n,a,i){t.x!==void 0&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(Z.degToRad)),t.y!==void 0&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(Z.degToRad)),t.z!==void 0&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(Z.degToRad));var s=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(s,t,r);n!==void 0&&(n=n.map(Z.degToRad),n.push(i),n=new le().fromArray(n),n=new ge().setFromEuler(n)),a!==void 0&&(a=a.map(Z.degToRad),a.push(i),a=new le().fromArray(a),a=new ge().setFromEuler(a).invert());for(var v=new ge,g=new le,p=[],b=0;b<o.length;b+=3)g.set(o[b],o[b+1],o[b+2],i),v.setFromEuler(g),n!==void 0&&v.premultiply(n),a!==void 0&&v.multiply(a),v.toArray(p,b/3*4);return new St(e+".quaternion",s,p)},generateMorphTrack:function(e){var t=e.DeformPercent.curves.morph,r=t.values.map(function(a){return a/100}),n=u.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new Et(e.modelName+".morphTargetInfluences["+n+"]",t.times,r)},getTimesForAllAxes:function(e){var t=[];return e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(r,n){return r-n}).filter(function(r,n,a){return a.indexOf(r)==n}),t},getKeyframeTrackValues:function(e,t,r){var n=r,a=[],i=-1,s=-1,o=-1;return e.forEach(function(v){if(t.x&&(i=t.x.times.indexOf(v)),t.y&&(s=t.y.times.indexOf(v)),t.z&&(o=t.z.times.indexOf(v)),i!==-1){var g=t.x.values[i];a.push(g),n[0]=g}else a.push(n[0]);if(s!==-1){var p=t.y.values[s];a.push(p),n[1]=p}else a.push(n[1]);if(o!==-1){var b=t.z.values[o];a.push(b),n[2]=b}else a.push(n[2])}),a},interpolateRotations:function(e){for(var t=1;t<e.values.length;t++){var r=e.values[t-1],n=e.values[t]-r,a=Math.abs(n);if(a>=180){for(var i=a/180,s=n/i,o=r+s,v=e.times[t-1],g=e.times[t]-v,p=g/i,b=v+p,A=[],P=[];b<e.times[t];)A.push(b),b+=p,P.push(o),o+=s;e.times=L(e.times,t,A),e.values=L(e.values,t,P)}}}};function y(){}y.prototype={constructor:y,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(e){this.currentIndent=0,this.allNodes=new x,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var t=this,r=e.split(/[\r\n]+/);return r.forEach(function(n,a){var i=n.match(/^[\s\t]*;/),s=n.match(/^[\s\t]*$/);if(i||s)return;var o=n.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),v=n.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),g=n.match("^\\t{"+(t.currentIndent-1)+"}}");o?t.parseNodeBegin(n,o):v?t.parseNodeProperty(n,v,r[++a]):g?t.popStack():n.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(n)}),this.allNodes},parseNodeBegin:function(e,t){var r=t[1].trim().replace(/^"/,"").replace(/"$/,""),n=t[2].split(",").map(function(o){return o.trim().replace(/^"/,"").replace(/"$/,"")}),a={name:r},i=this.parseNodeAttr(n),s=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(r,a):r in s?(r==="PoseNode"?s.PoseNode.push(a):s[r].id!==void 0&&(s[r]={},s[r][s[r].id]=s[r]),i.id!==""&&(s[r][i.id]=a)):typeof i.id=="number"?(s[r]={},s[r][i.id]=a):r!=="Properties70"&&(r==="PoseNode"?s[r]=[a]:s[r]=a),typeof i.id=="number"&&(a.id=i.id),i.name!==""&&(a.attrName=i.name),i.type!==""&&(a.attrType=i.type),this.pushStack(a)},parseNodeAttr:function(e){var t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var r="",n="";return e.length>1&&(r=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:r,type:n}},parseNodeProperty:function(e,t,r){var n=t[1].replace(/^"/,"").replace(/"$/,"").trim(),a=t[2].replace(/^"/,"").replace(/"$/,"").trim();n==="Content"&&a===","&&(a=r.replace(/"/g,"").replace(/,$/,"").trim());var i=this.getCurrentNode(),s=i.name;if(s==="Properties70"){this.parseNodeSpecialProperty(e,n,a);return}if(n==="C"){var o=a.split(",").slice(1),v=parseInt(o[0]),g=parseInt(o[1]),p=a.split(",").slice(3);p=p.map(function(b){return b.trim().replace(/^"/,"")}),n="connections",a=[v,g],Ae(a,p),i[n]===void 0&&(i[n]=[])}n==="Node"&&(i.id=a),n in i&&Array.isArray(i[n])?i[n].push(a):n!=="a"?i[n]=a:i.a=a,this.setCurrentProp(i,n),n==="a"&&a.slice(-1)!==","&&(i.a=I(a))},parseNodePropertyContinued:function(e){var t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=I(t.a))},parseNodeSpecialProperty:function(e,t,r){var n=r.split('",').map(function(g){return g.trim().replace(/^\"/,"").replace(/\s/,"_")}),a=n[0],i=n[1],s=n[2],o=n[3],v=n[4];switch(i){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":v=parseFloat(v);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":v=I(v);break}this.getPrevNode()[a]={type:i,type2:s,flag:o,value:v},this.setCurrentProp(this.getPrevNode(),a)}};function T(){}T.prototype={constructor:T,parse:function(e){var t=new F(e);t.skip(23);var r=t.getUint32();if(r<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+r);for(var n=new x;!this.endOfContent(t);){var a=this.parseNode(t,r);a!==null&&n.add(a.name,a)}return n},endOfContent:function(e){return e.size()%16===0?(e.getOffset()+160+16&~15)>=e.size():e.getOffset()+160+16>=e.size()},parseNode:function(e,t){var r={},n=t>=7500?e.getUint64():e.getUint32(),a=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();var i=e.getUint8(),s=e.getString(i);if(n===0)return null;for(var o=[],v=0;v<a;v++)o.push(this.parseProperty(e));var g=o.length>0?o[0]:"",p=o.length>1?o[1]:"",b=o.length>2?o[2]:"";for(r.singleProperty=a===1&&e.getOffset()===n;n>e.getOffset();){var A=this.parseNode(e,t);A!==null&&this.parseSubNode(s,r,A)}return r.propertyList=o,typeof g=="number"&&(r.id=g),p!==""&&(r.attrName=p),b!==""&&(r.attrType=b),s!==""&&(r.name=s),r},parseSubNode:function(e,t,r){if(r.singleProperty===!0){var n=r.propertyList[0];Array.isArray(n)?(t[r.name]=r,r.a=n):t[r.name]=n}else if(e==="Connections"&&r.name==="C"){var a=[];r.propertyList.forEach(function(b,A){A!==0&&a.push(b)}),t.connections===void 0&&(t.connections=[]),t.connections.push(a)}else if(r.name==="Properties70"){var i=Object.keys(r);i.forEach(function(b){t[b]=r[b]})}else if(e==="Properties70"&&r.name==="P"){var s=r.propertyList[0],o=r.propertyList[1],v=r.propertyList[2],g=r.propertyList[3],p;s.indexOf("Lcl ")===0&&(s=s.replace("Lcl ","Lcl_")),o.indexOf("Lcl ")===0&&(o=o.replace("Lcl ","Lcl_")),o==="Color"||o==="ColorRGB"||o==="Vector"||o==="Vector3D"||o.indexOf("Lcl_")===0?p=[r.propertyList[4],r.propertyList[5],r.propertyList[6]]:p=r.propertyList[4],t[s]={type:o,type2:v,flag:g,value:p}}else t[r.name]===void 0?typeof r.id=="number"?(t[r.name]={},t[r.name][r.id]=r):t[r.name]=r:r.name==="PoseNode"?(Array.isArray(t[r.name])||(t[r.name]=[t[r.name]]),t[r.name].push(r)):t[r.name][r.id]===void 0&&(t[r.name][r.id]=r)},parseProperty:function(e){var t=e.getString(1);switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var r=e.getUint32();return e.getArrayBuffer(r);case"S":var r=e.getUint32();return e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var n=e.getUint32(),a=e.getUint32(),i=e.getUint32();if(a===0)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}typeof at=="undefined"&&console.error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var s=new at(new Uint8Array(e.getArrayBuffer(i))),o=new F(s.decompress().buffer);switch(t){case"b":case"c":return o.getBooleanArray(n);case"d":return o.getFloat64Array(n);case"f":return o.getFloat32Array(n);case"i":return o.getInt32Array(n);case"l":return o.getInt64Array(n)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}};function F(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0}F.prototype={constructor:F,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return(this.getUint8()&1)===1},getBooleanArray:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getBoolean());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt32());return t},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e},getInt64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt64());return t},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat64());return t},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getString:function(e){for(var t=[],r=0;r<e;r++)t[r]=this.getUint8();var n=t.indexOf(0);return n>=0&&(t=t.slice(0,n)),Be.decodeText(new Uint8Array(t))}};function x(){}x.prototype={constructor:x,add:function(e,t){this[e]=t}};function w(e){var t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===j(e,0,t.length)}function S(e){var t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],r=0;function n(s){var o=e[s-1];return e=e.slice(r+s),r++,o}for(var a=0;a<t.length;++a){var i=n(1);if(i===t[a])return!1}return!0}function B(e){var t=/FBXVersion: (\d+)/,r=e.match(t);if(r){var n=parseInt(r[1]);return n}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function _(e){return e/46186158e3}var z=[];function M(e,t,r,n){var a;switch(n.mappingType){case"ByPolygonVertex":a=e;break;case"ByPolygon":a=t;break;case"ByVertice":a=r;break;case"AllSame":a=n.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+n.mappingType)}n.referenceType==="IndexToDirect"&&(a=n.indices[a]);var i=a*n.dataSize,s=i+n.dataSize;return Fe(z,n.buffer,i,s)}var E=new le,k=new ee;function R(e){var t=new O,r=new O,n=new O,a=new O,i=new O,s=new O,o=new O,v=new O,g=new O,p=new O,b=new O,A=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(k.fromArray(e.translation)),e.preRotation){var P=e.preRotation.map(Z.degToRad);P.push(e.eulerOrder),r.makeRotationFromEuler(E.fromArray(P))}if(e.rotation){var P=e.rotation.map(Z.degToRad);P.push(e.eulerOrder),n.makeRotationFromEuler(E.fromArray(P))}if(e.postRotation){var P=e.postRotation.map(Z.degToRad);P.push(e.eulerOrder),a.makeRotationFromEuler(E.fromArray(P))}e.scale&&i.scale(k.fromArray(e.scale)),e.scalingOffset&&o.setPosition(k.fromArray(e.scalingOffset)),e.scalingPivot&&s.setPosition(k.fromArray(e.scalingPivot)),e.rotationOffset&&v.setPosition(k.fromArray(e.rotationOffset)),e.rotationPivot&&g.setPosition(k.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(p=e.parentMatrixWorld);var U=r.multiply(n).multiply(a),X=new O;p.extractRotation(X);var D=new O;D.copyPosition(p);var K=new O;K.copy(X).invert().multiply(p);var $=new O;if(A===0)$.copy(X).multiply(U).multiply(K).multiply(i);else if(A===1)$.copy(X).multiply(K).multiply(U).multiply(i);else{var N=new O;N.copy(i).invert();var ne=new O().multiply(K).multiply(N);$.copy(X).multiply(U).multiply(ne).multiply(i)}var fe=new O;fe.copy(g).invert();var W=new O;W.copy(s).invert();var Y=new O;Y.copy(t).multiply(v).multiply(g).multiply(r).multiply(n).multiply(a).multiply(fe).multiply(o).multiply(s).multiply(i).multiply(W);var Q=new O().copyPosition(Y),pe=new O().copy(p).multiply(Q);return b.copyPosition(pe),Y=new O().multiply(b).multiply($),Y}function G(e){e=e||0;var t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return e===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function I(e){var t=e.split(",").map(function(r){return parseFloat(r)});return t}function j(e,t,r){return t===void 0&&(t=0),r===void 0&&(r=e.byteLength),Be.decodeText(new Uint8Array(e,t,r))}function Ae(e,t){for(var r=0,n=e.length,a=t.length;r<a;r++,n++)e[n]=t[r]}function Fe(e,t,r,n){for(var a=r,i=0;a<n;a++,i++)e[i]=t[a];return e}function L(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}return h}();export{Lt as FBXLoader};
