import r from"./ScreenBase.js";import a from"./elements/ScreenElementButton.js";import n from"./elements/ScreenElementJSONTree.js";import{REALM_WORLD_GENERATORS as h,REALM_WHITELIST as i,REALM_TYPES as c}from"../../backend/realm/RealmData.js";import s from"../../backend/realm/RealmData.js";export default class l extends r{constructor(e,t){super(e,t);this.group.add(this.background),this.fromService=!1,this.createRealm=this.createRealm.bind(this),this.updateData=this.updateData.bind(this),this.selectFromList=this.selectFromList.bind(this),this.selectedFromList=this.selectedFromList.bind(this),this.createEphemeral=this.createEphemeral.bind(this),this.isCreating=!1,this.jsonTree=new n(this,this,{width:this.width,height:this.height,alwaysUpdate:!0}),this.registerElement(this.jsonTree),this.cancelButton=new a(this,this,{x:-this.width/3,y:-this.height/2+.25,width:this.buttonWidth,height:this.buttonHeight}),this.cancelButton.setText("Cancel"),this.cancelButton.setOnClickCallback(()=>{this.data={},this.fromService=!1,this.screenManager.hideLastOpenScreen()}),this.registerElement(this.cancelButton),this.createButton=new a(this,this,{x:0,y:-this.height/2+.25,width:this.buttonWidth,height:this.buttonHeight}),this.createButton.setText("Create"),this.createButton.setOnClickCallback(this.createRealm),this.registerElement(this.createButton),this.createFromServiceButton=new a(this,this,{x:this.width/3,y:-this.height/2+.25,width:this.buttonWidth,height:this.buttonHeight}),this.createFromServiceButton.setText("Create From Service"),this.createFromServiceButton.setOnClickCallback(this.selectFromList),this.registerElement(this.createFromServiceButton),this.createEphemeralButton=new a(this,this,{x:this.width/3,y:-this.height/2+.1,width:this.buttonWidth,height:this.buttonHeight}),this.createEphemeralButton.setText("Create Emphemeral"),this.createEphemeralButton.setOnClickCallback(this.createEphemeral),this.registerElement(this.createEphemeralButton),this.data=void 0}getSchema(){return{type:"json",label:"name",items:{id:{type:"static",label:"ID"},name:{type:this.fromService?"static":"text",label:"Name"},iconURL:{type:this.fromService?"static":"text",label:"Icon"},whitelist:{type:"json",label:"Whitelist Settings",items:{type:{type:this.isCreating&&!this.fromService?"list":"static",label:"Whitelist Type",items:this.fromService?[i.SERVICE]:Object.values(i)}}},worldSettings:{type:"json",label:"World Settings",items:{worldGeneratorType:{type:"list",label:"Terrain Type",items:Object.values(h)}}}}}}showScreen(e,t={}){if(e&&!t.isCreating&&!this.screenManager.conjure.getWorld().realm)return"cancel";if(super.showScreen(e),!e)return;this.isCreating=Boolean(t.isCreating),this.isCreating&&!this.data&&(this.fromService=!1),this.jsonTree.setSchema(this.getSchema()),this.isCreating?(this.createButton.setText("Create"),this.createFromServiceButton.setHidden(!1),this.data=t.data?new s(t.data):s.create(),this.jsonTree.updateTree(this.data,this.updateData)):(this.createButton.setText("Update"),this.createFromServiceButton.setHidden(!0),this.data=this.screenManager.conjure.getWorld().realm.realmData,this.jsonTree.updateTree(this.data,this.updateData))}async createRealm(){this.isCreating?(await this.screenManager.conjure.realms.createRealm(this.data),console.log("Successfully made realm!",this.data),this.screenManager.hideLastOpenScreen(this.screenManager.screenRealms),this.screenManager.conjure.world.joinRealm(this.data),this.data=void 0):(this.data.timestamp=Date.now(),await this.screenManager.conjure.realms.updateRealm(new s(this.data)),this.screenManager.conjure.getWorld().forceReloadCurrentRealm())}async selectFromList(){this.screenManager.showScreen(this.screenManager.screenList),this.screenManager.screenList.setOnSelectCallback(this.selectedFromList),this.screenManager.screenList.setList((await this.screenManager.conjure.getProfile().getServiceManager().getPotentialRealms()).filter(e=>e.owner),"name")}async createEphemeral(){const e=s.create();e.type=c.EPHEMERAL,await this.screenManager.conjure.realms.createRealm(e),this.screenManager.hideLastOpenScreen(this.screenManager.screenRealms),this.screenManager.conjure.world.joinRealm(e),this.data=void 0}selectedFromList(e){if(!this.data)return;if(!e.owner)return;this.fromService=!0,this.data=new s(e),this.data.whitelist.type=i.SERVICE,this.jsonTree.setSchema(this.getSchema()),this.jsonTree.updateTree(this.data,this.updateData)}updateData(){}update(e){super.update(e)}}
