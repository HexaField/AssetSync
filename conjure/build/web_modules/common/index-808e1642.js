import{e as Oe}from"./os-fa818f34.js";import{m as _r,s as fe,f as me,p as Pr,u as kr,i as Ir,k as Er,r as Tr,a as Y,b as De}from"./index-bc6031b5.js";import{p as j}from"./process-e9e98960.js";import{b as z}from"./buffer-es6-e6024076.js";import{c as A,g as Sr,a as Me}from"./_commonjsHelpers-c99fd594.js";import{c as X,v as R,a as it,e as oe,k as se,l as ot,m as K,b as Cr}from"./datastore-utils-67e1084e.js";import{t as M}from"./to-string-b6e14ed9.js";import{f as ae}from"./from-string-5d106fde.js";import{c as Ne,e as T,s as Be}from"./index-19b99eb6.js";import{r as st}from"./__node-resolve:empty-8495aa00.js";function Ar(e){r.debug=r,r.default=r,r.coerce=c,r.disable=s,r.enable=i,r.enabled=a,r.humanize=_r,Object.keys(e).forEach(d=>{r[d]=e[d]}),r.instances=[],r.names=[],r.skips=[],r.formatters={};function t(d){let l=0;for(let h=0;h<d.length;h++)l=(l<<5)-l+d.charCodeAt(h),l|=0;return r.colors[Math.abs(l)%r.colors.length]}r.selectColor=t;function r(d){let l;function h(...y){if(!h.enabled)return;const v=h,w=Number(new Date),f=w-(l||w);v.diff=f,v.prev=l,v.curr=w,l=w,y[0]=r.coerce(y[0]),typeof y[0]!="string"&&y.unshift("%O");let p=0;y[0]=y[0].replace(/%([a-zA-Z%])/g,(m,_)=>{if(m==="%%")return m;p++;const b=r.formatters[_];if(typeof b=="function"){const k=y[p];m=b.call(v,k),y.splice(p,1),p--}return m}),r.formatArgs.call(v,y);const g=v.log||r.log;g.apply(v,y)}return h.namespace=d,h.enabled=r.enabled(d),h.useColors=r.useColors(),h.color=r.selectColor(d),h.destroy=n,h.extend=o,typeof r.init=="function"&&r.init(h),r.instances.push(h),h}function n(){const d=r.instances.indexOf(this);return d!==-1?(r.instances.splice(d,1),!0):!1}function o(d,l){const h=r(this.namespace+(typeof l=="undefined"?":":l)+d);return h.log=this.log,h}function i(d){r.save(d),r.names=[],r.skips=[];let l;const h=(typeof d=="string"?d:"").split(/[\s,]+/),y=h.length;for(l=0;l<y;l++){if(!h[l])continue;d=h[l].replace(/\*/g,".*?"),d[0]==="-"?r.skips.push(new RegExp("^"+d.substr(1)+"$")):r.names.push(new RegExp("^"+d+"$"))}for(l=0;l<r.instances.length;l++){const v=r.instances[l];v.enabled=r.enabled(v.namespace)}}function s(){const d=[...r.names.map(u),...r.skips.map(u).map(l=>"-"+l)].join(",");return r.enable(""),d}function a(d){if(d[d.length-1]==="*")return!0;let l,h;for(l=0,h=r.skips.length;l<h;l++)if(r.skips[l].test(d))return!1;for(l=0,h=r.names.length;l<h;l++)if(r.names[l].test(d))return!0;return!1}function u(d){return d.toString().substring(2,d.toString().length-2).replace(/\.\*\?$/,"*")}function c(d){return d instanceof Error?d.stack||d.message:d}return r.enable(r.load()),r}var qr=Ar,ue=A(function(e,t){t.formatArgs=n,t.save=o,t.load=i,t.useColors=r,t.storage=s(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){return typeof window!="undefined"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document!="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function n(u){if(u[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+u[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const c="color: "+this.color;u.splice(1,0,c,"color: inherit");let d=0,l=0;u[0].replace(/%[a-zA-Z%]/g,h=>{if(h==="%%")return;d++,h==="%c"&&(l=d)}),u.splice(l,0,c)}t.log=console.debug||console.log||(()=>{});function o(u){try{u?t.storage.setItem("debug",u):t.storage.removeItem("debug")}catch(c){}}function i(){let u;try{u=t.storage.getItem("debug")}catch(c){}return!u&&typeof j!="undefined"&&"env"in j&&(u=j.env.DEBUG),u}function s(){try{return localStorage}catch(u){}}e.exports=qr(t);const{formatters:a}=e.exports;a.j=function(u){try{return JSON.stringify(u)}catch(c){return"[UnexpectedJSONParseError]: "+c.message}}}),Rr=(e,t=1,r)=>{if(r={indent:" ",includeEmptyLines:!1,...r},typeof e!="string")throw new TypeError(`Expected \`input\` to be a \`string\`, got \`${typeof e}\``);if(typeof t!="number")throw new TypeError(`Expected \`count\` to be a \`number\`, got \`${typeof t}\``);if(typeof r.indent!="string")throw new TypeError(`Expected \`options.indent\` to be a \`string\`, got \`${typeof r.indent}\``);if(t===0)return e;const n=r.includeEmptyLines?/^/gm:/^(?!\s*$)/gm;return e.replace(n,r.indent.repeat(t))};const at=/\s+at.*(?:\(|\s)(.*)\)?/,xr=/^(?:(?:(?:node|(?:internal\/[\w/]*|.*node_modules\/(?:babel-polyfill|pirates)\/.*)?\w+)\.js:\d+:\d+)|native)/,Or=typeof st.homedir=="undefined"?"":st.homedir();var Dr=(e,t)=>(t=Object.assign({pretty:!1},t),e.replace(/\\/g,"/").split(`
`).filter(r=>{const n=r.match(at);if(n===null||!n[1])return!0;const o=n[1];return o.includes(".app/Contents/Resources/electron.asar")||o.includes(".app/Contents/Resources/default_app.asar")?!1:!xr.test(o)}).filter(r=>r.trim()!=="").map(r=>t.pretty?r.replace(at,(n,o)=>n.replace(o,o.replace(Or,"~"))):r).join(`
`));const Mr=e=>e.replace(/\s+at .*aggregate-error\/index.js:\d+:\d+\)?/g,"");class Nr extends Error{constructor(e){if(!Array.isArray(e))throw new TypeError(`Expected input to be an Array, got ${typeof e}`);e=[...e].map(r=>r instanceof Error?r:r!==null&&typeof r=="object"?Object.assign(new Error(r.message),r):new Error(r));let t=e.map(r=>typeof r.stack=="string"?Mr(Dr(r.stack)):String(r)).join(`
`);t=`
`+Rr(t,4),super(t),this.name="AggregateError",Object.defineProperty(this,"_errors",{value:e})}*[Symbol.iterator](){for(const e of this._errors)yield e}}var Le=Nr;const ut="[a-fA-F\\d:]",H=e=>e&&e.includeBoundaries?`(?:(?<=\\s|^)(?=${ut})|(?<=${ut})(?=\\s|$))`:"",F="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",q="[a-fA-F\\d]{1,4}",ye=`
(
(?:${q}:){7}(?:${q}|:)|                                // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${q}:){6}(?:${F}|:${q}|:)|                         // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${q}:){5}(?::${F}|(:${q}){1,2}|:)|                 // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${q}:){4}(?:(:${q}){0,1}:${F}|(:${q}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${q}:){3}(?:(:${q}){0,2}:${F}|(:${q}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${q}:){2}(?:(:${q}){0,3}:${F}|(:${q}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${q}:){1}(?:(:${q}){0,4}:${F}|(:${q}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::((?::${q}){0,5}:${F}|(?::${q}){1,7}|:))           // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(%[0-9a-zA-Z]{1,})?                                           // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),Br=new RegExp(`(?:^${F}$)|(?:^${ye}$)`),Lr=new RegExp(`^${F}$`),jr=new RegExp(`^${ye}$`),je=e=>e&&e.exact?Br:new RegExp(`(?:${H(e)}${F}${H(e)})|(?:${H(e)}${ye}${H(e)})`,"g");je.v4=e=>e&&e.exact?Lr:new RegExp(`${H(e)}${F}${H(e)}`,"g"),je.v6=e=>e&&e.exact?jr:new RegExp(`${H(e)}${ye}${H(e)}`,"g");var Fe=je;const ee=e=>Fe({exact:!0}).test(e);ee.v4=e=>Fe.v4({exact:!0}).test(e),ee.v6=e=>Fe.v6({exact:!0}).test(e),ee.version=e=>ee(e)?ee.v4(e)?4:6:void 0;var ge=ee;const Fr=ge,Ue=ge.v4,lt=ge.v6,ct=function(e,t,r){r=~~r;var n;if(Ue(e))n=t||new Uint8Array(r+4),e.split(/\./g).map(function(d){n[r++]=parseInt(d,10)&255});else if(lt(e)){var o=e.split(":",8),i;for(i=0;i<o.length;i++){var s=Ue(o[i]),a;s&&(a=ct(o[i]),o[i]=M(a.slice(0,2),"base16")),a&&++i<8&&o.splice(i,0,M(a.slice(2,4),"base16"))}if(o[0]==="")for(;o.length<8;)o.unshift("0");else if(o[o.length-1]==="")for(;o.length<8;)o.push("0");else if(o.length<8){for(i=0;i<o.length&&o[i]!=="";i++);var u=[i,"1"];for(i=9-o.length;i>0;i--)u.push("0");o.splice.apply(o,u)}for(n=t||new Uint8Array(r+16),i=0;i<o.length;i++){var c=parseInt(o[i],16);n[r++]=c>>8&255,n[r++]=c&255}}if(!n)throw Error("Invalid ip address: "+e);return n},Ur=function(e,t,r){t=~~t,r=r||e.length-t;var n=[],o;const i=new DataView(e.buffer);if(r===4){for(let s=0;s<r;s++)n.push(e[t+s]);o=n.join(".")}else if(r===16){for(let s=0;s<r;s+=2)n.push(i.getUint16(t+s).toString(16));o=n.join(":"),o=o.replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3"),o=o.replace(/:{3,4}/,"::")}return o};var ve={isIP:Fr,isV4:Ue,isV6:lt,toBytes:ct,toString:Ur};function N(e){if(typeof e=="number"){if(N.codes[e])return N.codes[e];throw new Error("no protocol with code: "+e)}else if(typeof e=="string"||e instanceof String){if(N.names[e])return N.names[e];throw new Error("no protocol with name: "+e)}throw new Error("invalid protocol id type: "+e)}const L=-1;N.lengthPrefixedVarSize=L,N.V=L,N.table=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,L,"ip6zone"],[53,L,"dns","resolvable"],[54,L,"dns4","resolvable"],[55,L,"dns6","resolvable"],[56,L,"dnsaddr","resolvable"],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,L,"unix",!1,"path"],[421,L,"ipfs"],[421,L,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,L,"garlic64"],[460,0,"quic"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,L,"memory"]],N.names={},N.codes={},N.table.map(e=>{const t=dt.apply(null,e);N.codes[t.code]=t,N.names[t.name]=t}),N.object=dt;function dt(e,t,r,n,o){return{code:e,size:t,name:r,resolvable:Boolean(n),path:Boolean(o)}}var Q=N,ht=le;function le(e,t){return t instanceof Uint8Array?le.toString(e,t):le.toBytes(e,t)}le.toString=function(t,r){t=Q(t);switch(t.code){case 4:case 41:return $r(r);case 6:case 273:case 33:case 132:return ft(r);case 53:case 54:case 55:case 56:case 400:case 777:return Kr(r);case 421:return Vr(r);case 444:return mt(r);case 445:return mt(r);default:return M(r,"base16")}},le.toBytes=function(t,r){t=Q(t);switch(t.code){case 4:return pt(r);case 41:return pt(r);case 6:case 273:case 33:case 132:return $e(parseInt(r,10));case 53:case 54:case 55:case 56:case 400:case 777:return zr(r);case 421:return Qr(r);case 444:return Hr(r);case 445:return Gr(r);default:return ae(r,"base16")}};function pt(e){if(!ve.isIP(e))throw new Error("invalid ip address");return ve.toBytes(e)}function $r(e){const t=ve.toString(e);if(!t||!ve.isIP(t))throw new Error("invalid ip address");return t}function $e(e){const t=new ArrayBuffer(2),r=new DataView(t);return r.setUint16(0,e),new Uint8Array(t)}function ft(e){const t=new DataView(e.buffer);return t.getUint16(0)}function zr(e){const t=ae(e),r=Uint8Array.from(R.encode(t.length));return X([r,t],r.length+t.length)}function Kr(e){const t=R.decode(e);if(e=e.slice(R.decode.bytes),e.length!==t)throw new Error("inconsistent lengths");return M(e)}function Qr(e){const t=new fe(e).multihash,r=Uint8Array.from(R.encode(t.length));return X([r,t],r.length+t.length)}function Vr(e){const t=R.decode(e),r=e.slice(R.decode.bytes);if(r.length!==t)throw new Error("inconsistent lengths");return M(r,"base58btc")}function Hr(e){const t=e.split(":");if(t.length!==2)throw new Error("failed to parse onion addr: "+t+" does not contain a port number");if(t[0].length!==16)throw new Error("failed to parse onion addr: "+t[0]+" not a Tor onion address.");const r=it.decode("b"+t[0]),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const o=$e(n);return X([r,o],r.length+o.length)}function Gr(e){const t=e.split(":");if(t.length!==2)throw new Error("failed to parse onion addr: "+t+" does not contain a port number");if(t[0].length!==56)throw new Error("failed to parse onion addr: "+t[0]+" not a Tor onion3 address.");const r=it.decode("b"+t[0]),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const o=$e(n);return X([r,o],r.length+o.length)}function mt(e){const t=e.slice(0,e.length-2),r=e.slice(e.length-2),n=M(t,"base32"),o=ft(r);return n+":"+o}var U={stringToStringTuples:yt,stringTuplesToString:gt,tuplesToStringTuples:bt,stringTuplesToTuples:vt,bytesToTuples:ze,tuplesToBytes:wt,bytesToString:Wr,stringToBytes:Pt,fromString:Yr,fromBytes:kt,validateBytes:Ke,isValidBytes:Xr,cleanPath:be,ParseError:Qe,protoFromTuple:ce,sizeForAddr:_t};function yt(e){const t=[],r=e.split("/").slice(1);if(r.length===1&&r[0]==="")return[];for(let n=0;n<r.length;n++){const o=r[n],i=Q(o);if(i.size===0){t.push([o]);continue}if(n++,n>=r.length)throw Qe("invalid address: "+e);if(i.path){t.push([o,be(r.slice(n).join("/"))]);break}t.push([o,r[n]])}return t}function gt(e){const t=[];return e.map(r=>{const n=ce(r);t.push(n.name),r.length>1&&t.push(r[1])}),be(t.join("/"))}function vt(e){return e.map(t=>{Array.isArray(t)||(t=[t]);const r=ce(t);return t.length>1?[r.code,ht.toBytes(r.code,t[1])]:[r.code]})}function bt(e){return e.map(t=>{const r=ce(t);return t.length>1?[r.code,ht.toString(r.code,t[1])]:[r.code]})}function wt(e){return kt(X(e.map(t=>{const r=ce(t);let n=Uint8Array.from(R.encode(r.code));return t.length>1&&(n=X([n,t[1]])),n})))}function _t(e,t){if(e.size>0)return e.size/8;if(e.size===0)return 0;{const r=R.decode(t);return r+R.decode.bytes}}function ze(e){const t=[];let r=0;for(;r<e.length;){const n=R.decode(e,r),o=R.decode.bytes,i=Q(n),s=_t(i,e.slice(r+o));if(s===0){t.push([n]),r+=o;continue}const a=e.slice(r+o,r+o+s);if(r+=s+o,r>e.length)throw Qe("Invalid address Uint8Array: "+M(e,"base16"));t.push([n,a])}return t}function Wr(e){const t=ze(e),r=bt(t);return gt(r)}function Pt(e){e=be(e);const t=yt(e),r=vt(t);return wt(r)}function Yr(e){return Pt(e)}function kt(e){const t=Ke(e);if(t)throw t;return Uint8Array.from(e)}function Ke(e){try{ze(e)}catch(t){return t}}function Xr(e){return Ke(e)===void 0}function be(e){return"/"+e.trim().split("/").filter(t=>t).join("/")}function Qe(e){return new Error("Error parsing address: "+e)}function ce(e){const t=Q(e[0]);return t}var It=A(function(e,t){const r=Symbol.for("nodejs.util.inspect.custom"),n=Ne.proto(function(o){if(!(this instanceof n))return new n(o);if(o==null&&(o=""),o instanceof Uint8Array)this.bytes=U.fromBytes(o);else if(typeof o=="string"||o instanceof String){if(o.length>0&&o.charAt(0)!=="/")throw new Error(`multiaddr "${o}" must start with a "/"`);this.bytes=U.fromString(o)}else if(o.bytes&&o.protos&&o.protoCodes)this.bytes=U.fromBytes(o.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr")},{className:"Multiaddr",symbolName:"@multiformats/js-multiaddr/multiaddr"});n.prototype.toString=function(){return U.bytesToString(this.bytes)},n.prototype.toJSON=n.prototype.toString,n.prototype.toOptions=function(){const i={},s=this.toString().split("/");return i.family=s[1]==="ip4"?"ipv4":"ipv6",i.host=s[2],i.transport=s[3],i.port=parseInt(s[4]),i},n.prototype[r]=function(){return"<Multiaddr "+M(this.bytes,"base16")+" - "+U.bytesToString(this.bytes)+">"},n.prototype.inspect=function(){return"<Multiaddr "+M(this.bytes,"base16")+" - "+U.bytesToString(this.bytes)+">"},n.prototype.protos=function(){return this.protoCodes().map(i=>Object.assign({},Q(i)))},n.prototype.protoCodes=function(){const i=[],s=this.bytes;let a=0;for(;a<s.length;){const u=R.decode(s,a),c=R.decode.bytes,d=Q(u),l=U.sizeForAddr(d,s.slice(a+c));a+=l+c,i.push(u)}return i},n.prototype.protoNames=function(){return this.protos().map(i=>i.name)},n.prototype.tuples=function(){return U.bytesToTuples(this.bytes)},n.prototype.stringTuples=function(){const i=U.bytesToTuples(this.bytes);return U.tuplesToStringTuples(i)},n.prototype.encapsulate=function(i){return i=n(i),n(this.toString()+i.toString())},n.prototype.decapsulate=function(i){i=i.toString();const s=this.toString(),a=s.lastIndexOf(i);if(a<0)throw new Error("Address "+this+" does not contain subaddress: "+i);return n(s.slice(0,a))},n.prototype.decapsulateCode=function(i){const s=this.tuples();for(let a=s.length-1;a>=0;a--)if(s[a][0]===i)return n(U.tuplesToBytes(s.slice(0,a)));return this},n.prototype.getPeerId=function(){let i=null;try{const s=this.stringTuples().filter(a=>{if(a[0]===Q.names.ipfs.code)return!0});i=s.pop()[1],i=M(new fe(i).multihash,"base58btc")}catch(s){i=null}return i},n.prototype.getPath=function(){let i=null;try{i=this.stringTuples().filter(s=>{const a=Q(s[0]);if(a.path)return!0})[0][1]}catch(s){i=null}return i},n.prototype.equals=function(i){return oe(this.bytes,i.bytes)},n.prototype.nodeAddress=function(){const i=this.protoCodes(),s=this.protoNames(),a=this.toString().split("/").slice(1);if(a.length<4)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6}/{address}/{tcp, udp}/{port}".');if(i[0]!==4&&i[0]!==41&&i[0]!==54&&i[0]!==55)throw new Error(`no protocol with name: "'${s[0]}'". Must have a valid family name: "{ip4, ip6, dns4, dns6}".`);if(a[2]!=="tcp"&&a[2]!=="udp")throw new Error(`no protocol with name: "'${s[1]}'". Must have a valid transport protocol: "{tcp, udp}".`);return{family:i[0]===41||i[0]===55?6:4,address:a[1],port:parseInt(a[3])}},n.fromNodeAddress=function(i,s){if(!i)throw new Error("requires node address object");if(!s)throw new Error("requires transport protocol");let a;switch(i.family){case"IPv4":a="ip4";break;case"IPv6":a="ip6";break;default:throw Error(`Invalid addr family. Got '${i.family}' instead of 'IPv4' or 'IPv6'`)}return n("/"+[a,i.address,s,i.port].join("/"))},n.prototype.isThinWaistAddress=function(i){const s=(i||this).protos();return s.length!==2||s[0].code!==4&&s[0].code!==41?!1:!(s[1].code!==6&&s[1].code!==273)},n.protocols=Q,n.isName=function(i){return n.isMultiaddr(i)?i.protos().some(s=>s.resolvable):!1},n.resolve=function(i){return!n.isMultiaddr(i)||!n.isName(i)?Promise.reject(Error("not a valid name")):Promise.reject(new Error("not implemented yet"))},t=e.exports=n});const{Buffer:$}=z,Et=Symbol.for("BufferList");function S(e){if(!(this instanceof S))return new S(e);S._init.call(this,e)}S._init=function(t){Object.defineProperty(this,Et,{value:!0}),this._bufs=[],this.length=0,t&&this.append(t)},S.prototype._new=function(t){return new S(t)},S.prototype._offset=function(t){if(t===0)return[0,0];let r=0;for(let n=0;n<this._bufs.length;n++){const o=r+this._bufs[n].length;if(t<o||n===this._bufs.length-1)return[n,t-r];r=o}},S.prototype._reverseOffset=function(e){const t=e[0];let r=e[1];for(let n=0;n<t;n++)r+=this._bufs[n].length;return r},S.prototype.get=function(t){if(t>this.length||t<0)return;const r=this._offset(t);return this._bufs[r[0]][r[1]]},S.prototype.slice=function(t,r){return typeof t=="number"&&t<0&&(t+=this.length),typeof r=="number"&&r<0&&(r+=this.length),this.copy(null,0,t,r)},S.prototype.copy=function(t,r,n,o){if((typeof n!="number"||n<0)&&(n=0),(typeof o!="number"||o>this.length)&&(o=this.length),n>=this.length)return t||$.alloc(0);if(o<=0)return t||$.alloc(0);const i=!!t,s=this._offset(n),a=o-n;let u=a,c=i&&r||0,d=s[1];if(n===0&&o===this.length){if(!i)return this._bufs.length===1?this._bufs[0]:$.concat(this._bufs,this.length);for(let l=0;l<this._bufs.length;l++)this._bufs[l].copy(t,c),c+=this._bufs[l].length;return t}if(u<=this._bufs[s[0]].length-d)return i?this._bufs[s[0]].copy(t,r,d,d+u):this._bufs[s[0]].slice(d,d+u);i||(t=$.allocUnsafe(a));for(let l=s[0];l<this._bufs.length;l++){const h=this._bufs[l].length-d;if(u>h)this._bufs[l].copy(t,c,d),c+=h;else{this._bufs[l].copy(t,c,d,d+u),c+=h;break}u-=h,d&&(d=0)}return t.length>c?t.slice(0,c):t},S.prototype.shallowSlice=function(t,r){if(t=t||0,r=typeof r!="number"?this.length:r,t<0&&(t+=this.length),r<0&&(r+=this.length),t===r)return this._new();const n=this._offset(t),o=this._offset(r),i=this._bufs.slice(n[0],o[0]+1);return o[1]===0?i.pop():i[i.length-1]=i[i.length-1].slice(0,o[1]),n[1]!==0&&(i[0]=i[0].slice(n[1])),this._new(i)},S.prototype.toString=function(t,r,n){return this.slice(r,n).toString(t)},S.prototype.consume=function(t){if(t=Math.trunc(t),Number.isNaN(t)||t<=0)return this;for(;this._bufs.length;)if(t>=this._bufs[0].length)t-=this._bufs[0].length,this.length-=this._bufs[0].length,this._bufs.shift();else{this._bufs[0]=this._bufs[0].slice(t),this.length-=t;break}return this},S.prototype.duplicate=function(){const t=this._new();for(let r=0;r<this._bufs.length;r++)t.append(this._bufs[r]);return t},S.prototype.append=function(t){if(t==null)return this;if(t.buffer)this._appendBuffer($.from(t.buffer,t.byteOffset,t.byteLength));else if(Array.isArray(t))for(let r=0;r<t.length;r++)this.append(t[r]);else if(this._isBufferList(t))for(let r=0;r<t._bufs.length;r++)this.append(t._bufs[r]);else typeof t=="number"&&(t=t.toString()),this._appendBuffer($.from(t));return this},S.prototype._appendBuffer=function(t){this._bufs.push(t),this.length+=t.length},S.prototype.indexOf=function(e,t,r){if(r===void 0&&typeof t=="string"&&(r=t,t=void 0),typeof e=="function"||Array.isArray(e))throw new TypeError('The "value" argument must be one of type string, Buffer, BufferList, or Uint8Array.');if(typeof e=="number"?e=$.from([e]):typeof e=="string"?e=$.from(e,r):this._isBufferList(e)?e=e.slice():Array.isArray(e.buffer)?e=$.from(e.buffer,e.byteOffset,e.byteLength):$.isBuffer(e)||(e=$.from(e)),t=Number(t||0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const n=this._offset(t);let o=n[0],i=n[1];for(;o<this._bufs.length;o++){const s=this._bufs[o];for(;i<s.length;){const a=s.length-i;if(a>=e.length){const u=s.indexOf(e,i);if(u!==-1)return this._reverseOffset([o,u]);i=s.length-e.length+1}else{const u=this._reverseOffset([o,i]);if(this._match(u,e))return u;i++}}i=0}return-1},S.prototype._match=function(e,t){if(this.length-e<t.length)return!1;for(let r=0;r<t.length;r++)if(this.get(e+r)!==t[r])return!1;return!0},function(){const e={readDoubleBE:8,readDoubleLE:8,readFloatBE:4,readFloatLE:4,readInt32BE:4,readInt32LE:4,readUInt32BE:4,readUInt32LE:4,readInt16BE:2,readInt16LE:2,readUInt16BE:2,readUInt16LE:2,readInt8:1,readUInt8:1,readIntBE:null,readIntLE:null,readUIntBE:null,readUIntLE:null};for(const t in e)(function(r){e[r]===null?S.prototype[r]=function(n,o){return this.slice(n,n+o)[r](0,o)}:S.prototype[r]=function(n){return this.slice(n,n+e[r])[r](0)}})(t)}(),S.prototype._isBufferList=function(t){return t instanceof S||S.isBufferList(t)},S.isBufferList=function(t){return t!=null&&t[Et]};var te=S;const{Buffer:Jr}=z,Tt=(e,t,r)=>{const n=R.encode(e,t,r);return Tt.bytes=R.encode.bytes,t||Jr.from(n)};var Ve=Tt;const{Buffer:St}=z,He=8,Ct=10*1024;function At(e){e=e||{};const t=Math.max(e.poolSize||Ct,e.minPoolSize||He),r=e.lengthEncoder||Ve;return n=>async function*(){let o=St.alloc(t),i=0;for await(const s of n){r(s.length,o,i);const a=o.slice(i,i+r.bytes);i+=r.bytes,o.length-i<He&&(o=St.alloc(t),i=0),yield new te().append(a).append(s)}}()}At.single=(e,t)=>{t=t||{};const r=t.lengthEncoder||Ve;return new te([r(e.length),e])};var Ge=At,Zr=He,en=Ct;Ge.MIN_POOL_SIZE=Zr,Ge.DEFAULT_POOL_SIZE=en;const{Buffer:tn}=z,rn=e=>new Proxy({},{get:(t,r)=>r[0]==="l"?e[r]:e.get(parseInt(r))}),qt=e=>{const t=R.decode(tn.isBuffer(e)?e:rn(e));return qt.bytes=R.decode.bytes,t};var Rt=qt;const{Buffer:nn}=z,xt=8,Ot=1024*1024*4,Dt=nn.alloc(0),G={LENGTH:"readLength",DATA:"readData"},on={[G.LENGTH]:(e,t,r,n)=>{t=t.append(e);let o;try{o=n.lengthDecoder(t)}catch(i){if(t.length>n.maxLengthLength)throw Object.assign(i,{message:"message length too long",code:"ERR_MSG_LENGTH_TOO_LONG"});if(i instanceof RangeError)return{mode:G.LENGTH,buffer:t};throw i}if(o>n.maxDataLength)throw Object.assign(new Error("message data too long"),{code:"ERR_MSG_DATA_TOO_LONG"});return e=t.shallowSlice(n.lengthDecoder.bytes),t=new te,n.onLength&&n.onLength(o),o<=0?(n.onData&&n.onData(Dt),{mode:G.LENGTH,chunk:e,buffer:t,data:Dt}):{mode:G.DATA,chunk:e,buffer:t,state:{dataLength:o}}},[G.DATA]:(e,t,r,n)=>{if(t=t.append(e),t.length<r.dataLength)return{mode:G.DATA,buffer:t,state:r};const{dataLength:o}=r,i=t.shallowSlice(0,o);return e=t.length>o?t.shallowSlice(o):null,t=new te,n.onData&&n.onData(i),{mode:G.LENGTH,chunk:e,buffer:t,data:i}}};function We(e){return e=e||{},e.lengthDecoder=e.lengthDecoder||Rt,e.maxLengthLength=e.maxLengthLength||xt,e.maxDataLength=e.maxDataLength||Ot,t=>async function*(){let r=new te,n=G.LENGTH,o;for await(let i of t)for(;i;){const s=on[n](i,r,o,e);({mode:n,chunk:i,buffer:r,state:o}=s),s.data&&(yield s.data)}if(r.length)throw Object.assign(new Error("unexpected end of input"),{code:"ERR_UNEXPECTED_EOF"})}()}We.fromReader=(e,t)=>{t=t||{};let r=1;const n={[Symbol.asyncIterator](){return this},next:async()=>{try{return await e.next(r)}catch(o){if(o.code==="ERR_UNDER_READ")return{done:!0,value:null};throw o}finally{r=1}}};return t.onLength=o=>{r=o},We(t)(n)};var Ye=We,sn=xt,an=Ot;Ye.MAX_LENGTH_LENGTH=sn,Ye.MAX_DATA_LENGTH=an;const{Buffer:un}=z,Mt=(e,t,r)=>(t=t||un.allocUnsafe(4),t.writeInt32BE(e,r),t);Mt.bytes=4;var ln=Mt;const Nt=e=>{if(e.length<4)throw RangeError("Could not decode int32BE");return e.readInt32BE(0)};Nt.bytes=4;var cn=Nt,dn=Ge,hn=Ye,pn=Ve,fn=Rt,mn=ln,yn=cn,re={encode:dn,decode:hn,varintEncode:pn,varintDecode:fn,int32BEEncode:mn,int32BEDecode:yn};const{AbortController:Bt,AbortSignal:gn}=typeof self!="undefined"?self:typeof window!="undefined"?window:void 0;var we=Bt,vn=gn,bn=Bt;we.AbortSignal=vn,we.default=bn;var Lt={createCipheriv:(e,t,r)=>{const n=me.cipher.createCipher("AES-CTR",M(t,"ascii"));return n.start({iv:M(r,"ascii")}),{update:o=>(n.update(me.util.createBuffer(M(o,"ascii"))),ae(n.output.getBytes(),"ascii"))}},createDecipheriv:(e,t,r)=>{const n=me.cipher.createDecipher("AES-CTR",M(t,"ascii"));return n.start({iv:M(r,"ascii")}),{update:o=>(n.update(me.util.createBuffer(M(o,"ascii"))),ae(n.output.getBytes(),"ascii"))}}};const jt={16:"aes-128-ctr",32:"aes-256-ctr"};var wn=function(e){const t=jt[e.length];if(!t){const r=Object.entries(jt).map(([n,o])=>`${n} (${o})`).join(" / ");throw T(new Error(`Invalid key length ${e.length} bytes. Must be ${r}`),"ERR_INVALID_KEY_LENGTH")}return t},_n=async function(e,t){const r=wn(e),n=Lt.createCipheriv(r,e,t),o=Lt.createDecipheriv(r,e,t),i={async encrypt(s){return n.update(s)},async decrypt(s){return o.update(s)}};return i},Pn={create:_n};const Ft={sha1:"sha1","sha2-256":"sha256","sha2-512":"sha512"};function kn(e,t,r,n,o){const i=Ft[o];if(!i){const a=Object.keys(Ft).join(" / ");throw T(new Error(`Hash '${o}' is unknown or not supported. Must be ${a}`),"ERR_UNSUPPORTED_HASH_TYPE")}const s=Pr(e,t,r,n,i);return kr.encode64(s)}var In=kn,En=Pn,Tn=Ir,Sn=Er,Cn=Tr,An=In,Xe={aes:En,hmac:Tn,keys:Sn,randomBytes:Cn,pbkdf2:An};async function*qn(e,t){let r=[];for await(const n of t)r.push(n),r.length===e&&(yield r,r=[]);r.length>0&&(yield r)}function*Rn(e,t){let r=[];for(const n of t)r.push(n),r.length===e&&(yield r,r=[]);r.length>0&&(yield r)}function Ut(e,t){return t===void 0?r=>Ut(e,r):t[Symbol.asyncIterator]?qn(e,t):Rn(e,t)}function J(e){if(typeof e.next=="function")return e;if(typeof e[Symbol.iterator]=="function")return e[Symbol.iterator]();if(typeof e[Symbol.asyncIterator]=="function")return e[Symbol.asyncIterator]();throw new TypeError('"values" does not to conform to any of the iterator or iterable protocols')}function Je(){let e,t;const r=new Promise((n,o)=>{t=n,e=o});return{promise:r,reject:e,resolve:t}}function xn(e,t){const r=J(t),n=[],o=[];let i=!1,s=!1;function a(){for(;o.length>0&&n.length>0;){const l=o.shift(),{error:h,value:y}=n.shift();h?l.reject(h):l.resolve({done:!1,value:y})}for(;o.length>0&&s;){const{resolve:l}=o.shift();l({done:!0,value:void 0})}}async function u(){if(s)return;if(i)return;if(n.length>=e)return;i=!0;try{const{done:l,value:h}=await r.next();l?s=!0:n.push({value:h})}catch(l){s=!0,n.push({error:l})}a(),i=!1,u()}async function c(){if(n.length>0){const{error:h,value:y}=n.shift();if(h)throw h;return u(),{done:!1,value:y}}if(s)return{done:!0,value:void 0};const l=Je();return o.push(l),u(),l.promise}const d={next:c,[Symbol.asyncIterator]:()=>d};return d}function*On(e,t){const r=[];let n;try{for(const o of t){if(r.push(o),r.length<=e)continue;yield r.shift()}}catch(o){n=o}for(const o of r)yield o;if(n)throw n}function _e(e,t){return t===void 0?r=>_e(e,r):e===0?t:t[Symbol.asyncIterator]?xn(e,t):On(e,t)}async function Dn(e){const t=[];for await(const r of e)t.push(r);return t}function Mn(e){return e[Symbol.asyncIterator]?Dn(e):Array.from(e)}async function*Nn(e){for await(const t of e)yield*t}function*Bn(e){for(const t of e)yield*t}function Ln(...e){const t=e.find(r=>r[Symbol.asyncIterator]!==void 0);return t?Nn(e):Bn(e)}async function jn(e){for await(const t of e);}function Fn(e){if(e[Symbol.asyncIterator])return jn(e);for(const t of e);}async function*$t(e,t){for await(const r of t)await e(r)&&(yield r)}function Pe(e,t){return t===void 0?r=>$t(e,r):$t(e,t)}async function*de(e){for await(const t of e)t&&typeof t!="string"&&(t[Symbol.iterator]||t[Symbol.asyncIterator])?yield*de(t):yield t}async function*zt(e,t){for await(const r of t)yield await e(r)}function ke(e,t){return t===void 0?r=>zt(e,r):zt(e,t)}function Kt(e,t){return t===void 0?r=>Kt(e,r):Pe(r=>r!=null,de(ke(e,t)))}function Un(e,t,r){const n=J(r),o=[],i=[];let s=!1,a=!1,u=0,c=null;function d(){for(;i.length>0&&o.length>0;){const{resolve:w}=i.shift(),f=o.shift();w({done:!1,value:f})}for(;i.length>0&&u===0&&s;){const{resolve:w,reject:f}=i.shift();c?(f(c),c=null):w({done:!0,value:void 0})}}async function l(){if(s){d();return}if(a)return;if(u+o.length>=e)return;a=!0,u++;try{const{done:w,value:f}=await n.next();w?(s=!0,u--,d()):h(f)}catch(w){s=!0,u--,c=w,d()}a=!1,l()}async function h(w){try{const f=await t(w);if(f&&f[Symbol.asyncIterator])for await(const p of f)o.push(p);else o.push(f)}catch(f){s=!0,c=f}u--,d(),l()}async function y(){if(o.length===0){const f=Je();return i.push(f),l(),f.promise}const w=o.shift();return l(),{done:!1,value:w}}const v={next:y,[Symbol.asyncIterator]:()=>v};return v}function Ie(e,t,r){return t===void 0?(n,o)=>o?Ie(e,n,o):Ie(e,n):r===void 0?n=>Ie(e,t,n):Pe(n=>n!=null,de(Un(e,t,r)))}async function $n(e){return new Promise(t=>{e.once("readable",()=>{t()})})}async function*zn(e){for(;;){const t=e.read();if(t!==null){yield t;continue}if(e._readableState.ended)break;await $n(e)}}function Kn(e){return typeof e[Symbol.asyncIterator]=="function"?e:zn(e)}async function*Qn(...e){const t=new Set(e.map(J));for(;t.size>0;)for(const r of t){const n=await r.next();n.done?t.delete(r):yield n.value}}function Qt(e,...t){let r=e();for(const n of t)r=n(r);return r}async function*Vn(e,t,r){let n=null;const o=u=>({value:t(u)}),i=async function*(u){for await(const c of u){if(n)return;yield c}},s=Qt(()=>r,_e(1),i,ke(o),_e(e-1)),a=J(s);for(;;){const{value:u,done:c}=await a.next();if(c)break;try{const d=await u.value;n||(yield d)}catch(d){n=d}}if(n)throw n}function Ee(e,t,r){return t===void 0?(n,o)=>Ee(e,n,o):r===void 0?n=>Ee(e,t,n):e===1?ke(t,r):Vn(e,t,r)}function Te(e,t,r){return t===void 0?(n,o)=>o?Te(e,n,o):Te(e,n):r===void 0?n=>Te(e,t,n):Pe(n=>n!=null,de(Ee(e,t,r)))}async function*Hn(...e){const t=e.map(J),r=new Set,n=new Map;let o=null,i=null,s=null;const a=l=>{o=l,i&&i(l)},u=l=>{s&&s(l)},c=()=>new Promise((l,h)=>{if(o&&h(o),n.size>0)return l();s=l,i=h}),d=l=>{const h=Promise.resolve(l.next()).then(async({done:y,value:v})=>{y||n.set(l,v),r.delete(h)});r.add(h),h.then(u,a)};for(const l of t)d(l);for(;;){if(r.size===0&&n.size===0)return;await c();for(const[l,h]of n)n.delete(l),yield h,d(l)}}async function Vt(e,t,r){let n=t;for await(const o of r)n=await e(n,o);return n}function Ze(e,t,r){return t===void 0?(n,o)=>o?Vt(e,n,o):Ze(e,n):r===void 0?n=>Ze(e,t,n):Vt(e,t,r)}async function*Gn(e,t){let r=0;for await(const n of t)if(yield await n,r++,r>=e)break}function*Wn(e,t){let r=0;for(const n of t)if(yield n,r++,r>=e)break}function Ht(e,t){return t===void 0?r=>Ht(e,r):t[Symbol.asyncIterator]?Gn(e,t):Wn(e,t)}async function*Gt(e,t){for await(const r of t)await e(r),yield r}function Yn(e,t){return t===void 0?r=>Gt(e,r):Gt(e,t)}function Wt(e,t){let r=e[0]+t[0],n=e[1]+t[1];if(n>=1e9){const o=n%1e9;r+=(n-o)/1e9,n=o}return[r,n]}async function*Xn(e,t){const r=t[Symbol.asyncIterator]();let n=[0,0];for(;;){const o=j.hrtime(),{value:i,done:s}=await r.next(),a=j.hrtime(o);if(n=Wt(n,a),e.progress&&e.progress(a,n),s)return e.total&&e.total(n),i;yield i}}function*Jn(e,t){const r=t[Symbol.iterator]();let n=[0,0];for(;;){const o=j.hrtime(),{value:i,done:s}=r.next(),a=j.hrtime(o);if(n=Wt(n,a),e.progress&&e.progress(a,n),s)return e.total&&e.total(n),i;yield i}}function Yt(e={},t){return t===void 0?r=>Yt(e,r):t[Symbol.asyncIterator]!==void 0?Xn(e,t):Jn(e,t)}function Zn(e,t,r){const n=J(r),o=[],i=[];let s=!1,a=!1,u=0,c=null;function d(){for(;i.length>0&&o.length>0;){const{resolve:w}=i.shift(),f=o.shift();w({done:!1,value:f})}for(;i.length>0&&u===0&&s;){const{resolve:w,reject:f}=i.shift();c?(f(c),c=null):w({done:!0,value:void 0})}}async function l(){if(s){d();return}if(a)return;if(u+o.length>=e)return;a=!0,u++;try{const{done:w,value:f}=await n.next();w?(s=!0,u--,d()):h(f)}catch(w){s=!0,u--,c=w,d()}a=!1,l()}async function h(w){try{const f=await t(w);o.push(f)}catch(f){s=!0,c=f}u--,d(),l()}async function y(){if(o.length===0){const f=Je();return i.push(f),l(),f.promise}const w=o.shift();return l(),{done:!1,value:w}}const v={next:y,[Symbol.asyncIterator]:()=>v};return v}function Se(e,t,r){return t===void 0?(n,o)=>o?Se(e,n,o):Se(e,n):r===void 0?n=>Se(e,t,n):Zn(e,t,r)}async function Xt(e,t){let r=null,n=null,o=null;const i=c=>{r=c,n&&n(c)},s=()=>{o&&o()},a=()=>{e.removeListener("error",i),e.removeListener("drain",s)};e.once("error",i);const u=()=>new Promise((c,d)=>{if(r)return d(r);e.once("drain",s),o=c,n=d});for await(const c of t)if(e.write(c)===!1&&await u(),r)break;if(a(),r)throw r}function ei(e,t){return t===void 0?r=>Xt(e,r):Xt(e,t)}var ti=Object.freeze({__proto__:null,batch:Ut,buffer:_e,collect:Mn,concat:Ln,consume:Fn,filter:Pe,flatMap:Kt,flatTransform:Ie,flatten:de,fromStream:Kn,getIterator:J,map:ke,merge:Qn,parallelFlatMap:Te,parallelMap:Ee,parallelMerge:Hn,pipeline:Qt,reduce:Ze,take:Ht,tap:Yn,time:Yt,transform:Se,writeToStream:ei}),Jt=function(e){if(!e)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,r=Object.create(null),n=Object.create(null);function o(i,s){r[i]=s,t++,t>=e&&(t=0,n=r,r=Object.create(null))}return{has:function(i){return r[i]!==void 0||n[i]!==void 0},remove:function(i){r[i]!==void 0&&(r[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var s=r[i];if(s!==void 0)return s;if((s=n[i])!==void 0)return o(i,s),s},set:function(i,s){r[i]!==void 0?r[i]=s:o(i,s)},clear:function(){r=Object.create(null),n=Object.create(null)}}},Zt=Sr(ti),ri=(e,t)=>(t=t||(()=>{}),e.then(r=>new Promise(n=>{n(t())}).then(()=>r),r=>new Promise(n=>{n(t())}).then(()=>{throw r})));class er extends Error{constructor(e){super(e);this.name="TimeoutError"}}const tr=(e,t,r)=>new Promise((n,o)=>{if(typeof t!="number"||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===Infinity){n(e);return}const i=setTimeout(()=>{if(typeof r=="function"){try{n(r())}catch(u){o(u)}return}const s=typeof r=="string"?r:`Promise timed out after ${t} milliseconds`,a=r instanceof Error?r:new er(s);typeof e.cancel=="function"&&e.cancel(),o(a)},t);ri(e.then(n,o),()=>{clearTimeout(i)})});var V=tr,ni=tr,ii=er;V.default=ni,V.TimeoutError=ii;var rr=A(function(e,t){/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */var r=z.Buffer;function n(i,s){for(var a in i)s[a]=i[a]}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?e.exports=z:(n(z,t),t.Buffer=o);function o(i,s,a){return r(i,s,a)}o.prototype=Object.create(r.prototype),n(r,o),o.from=function(i,s,a){if(typeof i=="number")throw new TypeError("Argument must not be a number");return r(i,s,a)},o.alloc=function(i,s,a){if(typeof i!="number")throw new TypeError("Argument must be a number");var u=r(i);return s!==void 0?typeof a=="string"?u.fill(s,a):u.fill(s):u.fill(0),u},o.allocUnsafe=function(i){if(typeof i!="number")throw new TypeError("Argument must be a number");return r(i)},o.allocUnsafeSlow=function(i){if(typeof i!="number")throw new TypeError("Argument must be a number");return z.SlowBuffer(i)}}),nr=A(function(e){var t=65536,r=4294967295;function n(){throw new Error(`Secure random number generation is not supported by this browser.
Use Chrome, Firefox or Internet Explorer 11`)}var o=rr.Buffer,i=Me.crypto||Me.msCrypto;i&&i.getRandomValues?e.exports=s:e.exports=n;function s(a,u){if(a>r)throw new RangeError("requested too many random bytes");var c=o.allocUnsafe(a);if(a>0)if(a>t)for(var d=0;d<a;d+=t)i.getRandomValues(c.slice(d,d+t));else i.getRandomValues(c);return typeof u=="function"?j.nextTick(function(){u(null,c)}):c}});const{EventEmitter:oi}=Oe;function ir(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let r=0,n=e.length;r<n;++r)if(e[r]!==t[r])return!1;return!0}function et(){return{contacts:[],dontSplit:!1,left:null,right:null}}function he(e,t){if(!(t instanceof Uint8Array))throw new TypeError(e+" is not a Uint8Array")}class tt extends oi{constructor(e={}){super();this.localNodeId=e.localNodeId||nr(20),this.numberOfNodesPerKBucket=e.numberOfNodesPerKBucket||20,this.numberOfNodesToPing=e.numberOfNodesToPing||3,this.distance=e.distance||tt.distance,this.arbiter=e.arbiter||tt.arbiter,this.metadata=Object.assign({},e.metadata),he("option.localNodeId as parameter 1",this.localNodeId),this.root=et()}static arbiter(e,t){return e.vectorClock>t.vectorClock?e:t}static distance(e,t){let r=0,n=0;const o=Math.min(e.length,t.length),i=Math.max(e.length,t.length);for(;n<o;++n)r=r*256+(e[n]^t[n]);for(;n<i;++n)r=r*256+255;return r}add(e){he("contact.id",(e||{}).id);let t=0,r=this.root;for(;r.contacts===null;)r=this._determineNode(r,e.id,t++);const n=this._indexOf(r,e.id);return n>=0?(this._update(r,n,e),this):r.contacts.length<this.numberOfNodesPerKBucket?(r.contacts.push(e),this.emit("added",e),this):r.dontSplit?(this.emit("ping",r.contacts.slice(0,this.numberOfNodesToPing),e),this):(this._split(r,t),this.add(e))}closest(e,t=Infinity){if(he("id",e),!Number.isInteger(t)&&t!==Infinity||t<=0)throw new TypeError("n is not positive number");let r=[];for(let n=[this.root],o=0;n.length>0&&r.length<t;){const i=n.pop();if(i.contacts===null){const s=this._determineNode(i,e,o++);n.push(i.left===s?i.right:i.left),n.push(s)}else r=r.concat(i.contacts)}return r.map(n=>[this.distance(n.id,e),n]).sort((n,o)=>n[0]-o[0]).slice(0,t).map(n=>n[1])}count(){let e=0;for(const t=[this.root];t.length>0;){const r=t.pop();r.contacts===null?t.push(r.right,r.left):e+=r.contacts.length}return e}_determineNode(e,t,r){const n=r>>3,o=r%8;if(t.length<=n&&o!==0)return e.left;const i=t[n];return i&1<<7-o?e.right:e.left}get(e){he("id",e);let t=0,r=this.root;for(;r.contacts===null;)r=this._determineNode(r,e,t++);const n=this._indexOf(r,e);return n>=0?r.contacts[n]:null}_indexOf(e,t){for(let r=0;r<e.contacts.length;++r)if(ir(e.contacts[r].id,t))return r;return-1}remove(e){he("the id as parameter 1",e);let t=0,r=this.root;for(;r.contacts===null;)r=this._determineNode(r,e,t++);const n=this._indexOf(r,e);if(n>=0){const o=r.contacts.splice(n,1)[0];this.emit("removed",o)}return this}_split(e,t){e.left=et(),e.right=et();for(const o of e.contacts)this._determineNode(e,o.id,t).contacts.push(o);e.contacts=null;const r=this._determineNode(e,this.localNodeId,t),n=e.left===r?e.right:e.left;n.dontSplit=!0}toArray(){let e=[];for(const t=[this.root];t.length>0;){const r=t.pop();r.contacts===null?t.push(r.right,r.left):e=e.concat(r.contacts)}return e}_update(e,t,r){if(!ir(e.contacts[t].id,r.id))throw new Error("wrong index for _update");const n=e.contacts[t],o=this.arbiter(n,r);if(o===n&&n!==r)return;e.contacts.splice(t,1),e.contacts.push(o),this.emit("updated",n,o)}}var si=tt,Z=W;function W(e,t){if(e.length!==t.length)throw new Error("Inputs should have the same length");for(var r=Buffer.allocUnsafe(e.length),n=0;n<e.length;n++)r[n]=e[n]^t[n];return r}W.compare=function(t,r){if(t.length!==r.length)throw new Error("Inputs should have the same length");for(var n=0;n<t.length;n++){if(t[n]===r[n])continue;return t[n]<r[n]?-1:1}return 0},W.gt=function(t,r){return W.compare(t,r)===1},W.lt=function(t,r){return W.compare(t,r)===-1},W.eq=function(t,r){return W.compare(t,r)===0};var or=async(e,t,{concurrency:r=Infinity,stopOnError:n=!0}={})=>new Promise((o,i)=>{if(typeof t!="function")throw new TypeError("Mapper function is required");if(!((Number.isSafeInteger(r)||r===Infinity)&&r>=1))throw new TypeError(`Expected \`concurrency\` to be an integer from 1 and up or \`Infinity\`, got \`${r}\` (${typeof r})`);const s=[],a=[],u=e[Symbol.iterator]();let c=!1,d=!1,l=0,h=0;const y=()=>{if(c)return;const v=u.next(),w=h;if(h++,v.done){d=!0,l===0&&(!n&&a.length!==0?i(new Le(a)):o(s));return}l++,(async()=>{try{const f=await v.value;s[w]=await t(f,w),l--,y()}catch(f){n?(c=!0,i(f)):(a.push(f),l--,y())}})()};for(let v=0;v<r&&!(y(),d);v++);}),P=A(function(e,t){const r=se.multihash,{Key:n}=Be,{Record:o}=K;t.convertBuffer=i=>se.digest(i,"sha2-256"),t.convertPeerId=i=>se.digest(i.id,"sha2-256"),t.bufferToKey=i=>new n("/"+t.encodeBase32(i),!1),t.keyForPublicKey=i=>X([ae("/pk/"),i.id]),t.isPublicKeyKey=i=>M(i.slice(0,4))==="/pk/",t.fromPublicKeyKey=i=>new Y(i.slice(4)),t.now=()=>Date.now(),t.encodeBase32=i=>{const s=new ot.Encoder;return s.write(i).finalize()},t.decodeBase32=i=>{const s=new ot.Decoder;return Uint8Array.from(s.write(i).finalize())},t.sortClosestPeers=async(i,s)=>{const a=await or(i,async u=>{const c=await t.convertPeerId(u);return{peer:u,distance:Z(c,s)}});return a.sort(t.xorCompare).map(u=>u.peer)},t.xorCompare=(i,s)=>Z.compare(i.distance,s.distance),t.pathSize=(i,s)=>Math.ceil(i/s),t.createPutRecord=(i,s)=>{const a=new Date,u=new o(i,s,a);return u.serialize()},t.logger=(i,s)=>{const a=["libp2p","dht"];s&&a.push(s),i&&a.push(`${i.toB58String().slice(0,8)}`),ue.formatters.b=c=>r.toB58String(c);const u=ue(a.join(":"));return u.error=ue(a.concat(["error"]).join(":")),u},t.TimeoutError=class extends Error{get code(){return"ETIMEDOUT"}},t.withTimeout=(i,s)=>async(...a)=>Promise.race([i(...a),new Promise((u,c)=>{setTimeout(()=>{c(T(new Error("Async function did not complete before timeout"),"ETIMEDOUT"))},s)})]),t.mapParallel=async function(i,s){const a=[];for await(const u of i)a.push(s(u));return Promise.all(a)}});class ai{constructor(e,t){this.self=e,this._onPing=this._onPing.bind(this),this._onInit(t)}async _onInit(e){const t=await P.convertPeerId(this.self);this.kb=new si({localNodeId:t,numberOfNodesPerKBucket:e,numberOfNodesToPing:1}),this.kb.on("ping",this._onPing)}_onPing(e,t){const r=e[0];this.kb.remove(r.id),this.kb.add(t)}get size(){return this.kb.count()}async find(e){const t=await P.convertPeerId(e),r=this.closestPeer(t);if(r&&r.isEqual(e))return r}closestPeer(e){const t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t){return this.kb.closest(e,t).map(r=>r.peer)}async add(e){const t=await P.convertPeerId(e);this.kb.add({id:t,peer:e})}async remove(e){const t=await P.convertPeerId(e);this.kb.remove(t)}}var ui=ai,D=A(function(e,t){const r=t.second=1e3,n=t.minute=60*r,o=t.hour=60*n;t.MAX_RECORD_AGE=36*o,t.PROTOCOL_DHT="/kad/1.0.0",t.PROVIDERS_KEY_PREFIX="/providers/",t.PROVIDERS_LRU_CACHE_SIZE=256,t.PROVIDERS_VALIDITY=24*o,t.PROVIDERS_CLEANUP_INTERVAL=o,t.READ_MESSAGE_TIMEOUT=10*r,t.GET_MANY_RECORD_COUNT=16,t.K=20,t.ALPHA=3,t.defaultRandomWalk={enabled:!0,queriesPerPeriod:1,interval:5*n,timeout:10*r,delay:10*r}});const sr=()=>{};class li{constructor({min:e=0,max:t=Infinity,handlers:r={}}){this.min=e,this.max=t,this._onConnect=r.onConnect||sr,this._onDisconnect=r.onDisconnect||sr,this.peers=new Set}set registrar(e){this._registrar=e}disconnect(e){this._onDisconnect(e)}}var ci=Ne(li,{className:"Topology",symbolName:"@libp2p/js-interfaces/topology"});class di extends ci{constructor({min:e,max:t,multicodecs:r,handlers:n}){super({min:e,max:t,handlers:n});if(!r)throw new Error("one or more multicodec should be provided");if(!n)throw new Error("the handlers should be provided");if(typeof n.onConnect!="function")throw new Error("the 'onConnect' handler must be provided");if(typeof n.onDisconnect!="function")throw new Error("the 'onDisconnect' handler must be provided");this.multicodecs=Array.isArray(r)?r:[r],this._registrar=void 0,this._onProtocolChange=this._onProtocolChange.bind(this),this._onPeerConnect=this._onPeerConnect.bind(this)}set registrar(e){this._registrar=e,this._registrar.peerStore.on("change:protocols",this._onProtocolChange),this._registrar.connectionManager.on("peer:connect",this._onPeerConnect),this._updatePeers(this._registrar.peerStore.peers.values())}_updatePeers(e){for(const{id:t,protocols:r}of e)if(this.multicodecs.filter(n=>r.includes(n)).length){this.peers.add(t.toB58String());const n=this._registrar.getConnection(t);n&&this._onConnect(t,n)}else this.peers.delete(t.toB58String())}_onProtocolChange({peerId:e,protocols:t}){const r=this.peers.has(e.toB58String()),n=t.filter(o=>this.multicodecs.includes(o));r&&n.length===0&&this._onDisconnect(e);for(const o of t)if(this.multicodecs.includes(o)){const i=this._registrar.peerStore.get(e);this._updatePeers([i]);return}}_onPeerConnect(e){const t=e.remotePeer,r=this._registrar.peerStore.protoBook.get(t);if(!r)return;this.multicodecs.find(n=>r.includes(n))&&(this.peers.add(t.toB58String()),this._onConnect(t,e))}}var hi=Ne(di,{className:"MulticodecTopology",symbolName:"@libp2p/js-interfaces/topology/multicodec-topology"}),pi=`// can't use, because protocol-buffers doesn't support imports
// so we have to duplicate for now :(
// import "record.proto";

message Record {
  // adjusted for javascript
  optional bytes key = 1;
  optional bytes value = 2;
  optional bytes author = 3;
  optional bytes signature = 4;
  optional string timeReceived = 5;
}

message Message {
  enum MessageType {
    PUT_VALUE = 0;
    GET_VALUE = 1;
    ADD_PROVIDER = 2;
    GET_PROVIDERS = 3;
    FIND_NODE = 4;
    PING = 5;
  }

  enum ConnectionType {
    // sender does not have a connection to peer, and no extra information (default)
    NOT_CONNECTED = 0;

    // sender has a live connection to peer
    CONNECTED = 1;

    // sender recently connected to peer
    CAN_CONNECT = 2;

    // sender recently tried to connect to peer repeatedly but failed to connect
    // ("try" here is loose, but this should signal "made strong effort, failed")
    CANNOT_CONNECT = 3;
  }

  message Peer {
    // ID of a given peer.
    optional bytes id = 1;

    // multiaddrs for a given peer
    repeated bytes addrs = 2;

    // used to signal the sender's connection capabilities to the peer
    optional ConnectionType connection = 3;
  }

  // defines what type of message it is.
  optional MessageType type = 1;

  // defines what coral cluster level this query/response belongs to.
  // in case we want to implement coral's cluster rings in the future.
  optional int32 clusterLevelRaw = 10;

  // Used to specify the key associated with this message.
  // PUT_VALUE, GET_VALUE, ADD_PROVIDER, GET_PROVIDERS
  // adjusted for javascript
  optional bytes key = 2;

  // Used to return a value
  // PUT_VALUE, GET_VALUE
  // adjusted Record to bytes for js
  optional bytes record = 3;

  // Used to return peers closer to a key in a query
  // GET_VALUE, GET_PROVIDERS, FIND_NODE
  repeated Peer closerPeers = 8;

  // Used to return Providers
  // GET_VALUE, ADD_PROVIDER, GET_PROVIDERS
  repeated Peer providerPeers = 9;
}`;const{Record:fi}=K,Ce=Cr(pi),mi=Ce.Message.MessageType,ar=Ce.Message.ConnectionType;class Ae{constructor(e,t,r){if(t&&!(t instanceof Uint8Array))throw new Error("Key must be a Uint8Array");this.type=e,this.key=t,this._clusterLevelRaw=r,this.closerPeers=[],this.providerPeers=[],this.record=null}get clusterLevel(){const e=this._clusterLevelRaw-1;return e<0?0:e}set clusterLevel(e){this._clusterLevelRaw=e}serialize(){const e={key:this.key,type:this.type,clusterLevelRaw:this._clusterLevelRaw,closerPeers:this.closerPeers.map(ur),providerPeers:this.providerPeers.map(ur)};return this.record&&(this.record instanceof Uint8Array?e.record=this.record:e.record=this.record.serialize()),Ce.Message.encode(e)}static deserialize(e){const t=Ce.Message.decode(e),r=new Ae(t.type,t.key,t.clusterLevelRaw);return r.closerPeers=t.closerPeers.map(lr),r.providerPeers=t.providerPeers.map(lr),t.record&&(r.record=fi.deserialize(t.record)),r}}Ae.TYPES=mi,Ae.CONNECTION_TYPES=ar;function ur(e){return{id:e.id.id,addrs:(e.multiaddrs||[]).map(t=>t.bytes),connection:ar.CONNECTED}}function lr(e){return{id:new Y(e.id),multiaddrs:e.addrs.map(t=>It(t))}}var x=Ae;const{Record:yi}=K;var gi=e=>{const t=P.logger(e.peerId,"rpc:get-value");return async function(n,o){const i=o.key;if(t("key: %b",i),!i||i.length===0)throw T(new Error("Invalid key"),"ERR_INVALID_KEY");const s=new x(x.TYPES.GET_VALUE,i,o.clusterLevel);if(P.isPublicKeyKey(i)){t("is public key");const c=P.fromPublicKeyKey(i);let d;if(e._isSelf(c))d=e.peerId;else{const l=e.peerStore.get(c);d=l&&l.id}if(d&&d.pubKey)return t("returning found public key"),s.record=new yi(i,d.pubKey.bytes),s}const[a,u]=await Promise.all([e._checkLocalDatastore(i),e._betterPeersToQuery(o,n)]);return a&&(t("got record"),s.record=a),u.length>0&&(t("got closer %s",u.length),s.closerPeers=u),s}},vi=e=>{const t=P.logger(e.peerId,"rpc:put-value");return async function(n,o){const i=o.key;t("key: %b",i);const s=o.record;if(!s){const u=`Empty record from: ${n.toB58String()}`;throw t.error(u),T(new Error(u),"ERR_EMPTY_RECORD")}await e._verifyRecordLocally(s),s.timeReceived=new Date;const a=P.bufferToKey(s.key);return await e.datastore.put(a,s.serialize()),e.onPut(s,n),o}},bi=e=>{const t=P.logger(e.peerId,"rpc:find-node");return async function(n,o){t("start");let i;oe(o.key,e.peerId.id)?i=[{id:e.peerId}]:i=await e._betterPeersToQuery(o,n);const s=new x(o.type,new Uint8Array(0),o.clusterLevel);return i.length>0?s.closerPeers=i:t("handle FindNode %s: could not find anything",n.toB58String()),s}},wi=e=>{const t=P.logger(e.peerId,"rpc:add-provider");return async function(n,o){if(t("start"),!o.key||o.key.length===0)throw T(new Error("Missing key"),"ERR_MISSING_KEY");let i;try{i=new fe(o.key)}catch(s){const a=`Invalid CID: ${s.message}`;throw T(new Error(a),"ERR_INVALID_CID")}return o.providerPeers.forEach(s=>{if(!s.id.isEqual(n)){t("invalid provider peer %s from %s",s.id.toB58String(),n.toB58String());return}if(s.multiaddrs.length<1){t("no valid addresses for provider %s. Ignore",n.toB58String());return}if(t("received provider %s for %s (addrs %s)",n.toB58String(),i.toBaseEncodedString(),s.multiaddrs.map(a=>a.toString())),!e._isSelf(s.id))return e.peerStore.addressBook.add(s.id,s.multiaddrs),e.providers.addProvider(i,s.id)}),e.providers.addProvider(i,n)}},_i=e=>{const t=P.logger(e.peerId,"rpc:get-providers");return async function(n,o){let i;try{i=new fe(o.key)}catch(y){throw T(new Error(`Invalid CID: ${y.message}`),"ERR_INVALID_CID")}t("%s",i.toBaseEncodedString());const s=P.bufferToKey(i.bytes),[a,u,c]=await Promise.all([e.datastore.has(s),e.providers.getProviders(i),e._betterPeersToQuery(o,n)]),d=u.map(y=>({id:y})),l=c.map(y=>({id:y.id}));a&&d.push({id:e.peerId});const h=new x(o.type,o.key,o.clusterLevel);return d.length>0&&(h.providerPeers=d),l.length>0&&(h.closerPeers=l),t("got %s providers %s closerPeers",d.length,l.length),h}},Pi=e=>{const t=P.logger(e.peerId,"rpc:ping");return function(n,o){return t("from %s",n.toB58String()),o}};const ne=x.TYPES;var ki=e=>{const t={[ne.GET_VALUE]:gi(e),[ne.PUT_VALUE]:vi(e),[ne.FIND_NODE]:bi(e),[ne.ADD_PROVIDER]:wi(e),[ne.GET_PROVIDERS]:_i(e),[ne.PING]:Pi(e)};return function(n){return t[n]}},Ii=e=>{const t=P.logger(e.peerId,"rpc"),r=ki(e);async function n(o,i){const s=r(i.type);try{await e._add(o)}catch(a){t.error("Failed to update the kbucket store",a)}if(!s){t.error(`no handler found for message type: ${i.type}`);return}return s(o,i)}return async function({stream:i,connection:s}){const a=s.remotePeer;try{await e._add(a)}catch(c){t.error(c)}const u=a.toB58String();t("from: %s",u),await De(i.source,re.decode(),c=>async function*(){for await(const d of c){const l=x.deserialize(d.slice()),h=await n(a,l);h&&(yield h.serialize())}}(),re.encode(),i.sink)}};const{consume:Ei}=Zt;class Ti{constructor(e){this.dht=e,this.readMessageTimeout=D.READ_MESSAGE_TIMEOUT,this._log=P.logger(this.dht.peerId,"net"),this._rpc=Ii(this.dht),this._onPeerConnected=this._onPeerConnected.bind(this),this._running=!1}async start(){if(this._running)return;if(!this.dht.isStarted)throw T(new Error("Can not start network"),"ERR_CANNOT_START_NETWORK");this._running=!0,this.dht._clientMode===!1&&this.dht.registrar.handle(this.dht.protocol,this._rpc);const e=new hi({multicodecs:[this.dht.protocol],handlers:{onConnect:this._onPeerConnected,onDisconnect:()=>{}}});this._registrarId=await this.dht.registrar.register(e)}async stop(){if(!this.dht.isStarted&&!this.isStarted)return;this._running=!1,await this.dht.registrar.unregister(this._registrarId)}get isStarted(){return this._running}get isConnected(){return this.dht.isStarted&&this.isStarted}async _onPeerConnected(e){await this.dht._add(e),this._log("added to the routing table: %s",e.toB58String())}async sendRequest(e,t){if(!this.isConnected)throw T(new Error("Network is offline"),"ERR_NETWORK_OFFLINE");const r=e.toB58String();this._log("sending to: %s",r);let n=this.dht.registrar.connectionManager.get(e);n||(n=await this.dht.dialer.connectToPeer(e));const{stream:o}=await n.newStream(this.dht.protocol);return this._writeReadMessage(o,t.serialize())}async sendMessage(e,t){if(!this.isConnected)throw T(new Error("Network is offline"),"ERR_NETWORK_OFFLINE");const r=e.toB58String();this._log("sending to: %s",r);let n=this.dht.registrar.connectionManager.get(e);n||(n=await this.dht.dialer.connectToPeer(e));const{stream:o}=await n.newStream(this.dht.protocol);return this._writeMessage(o,t.serialize())}async _writeReadMessage(e,t){return V(Si(e,t),this.readMessageTimeout)}_writeMessage(e,t){return De([t],re.encode(),e,Ei)}}async function Si(e,t){const r=await De([t],re.encode(),e,re.decode(),async n=>{for await(const o of n)return o.slice()});if(r.length===0)throw T(new Error("No message received"),"ERR_NO_MESSAGE_RECEIVED");return x.deserialize(r)}var Ci=Ti;class Ai{constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peerId)}async add(e){if(this.peerDistances.find(n=>oe(n.peerId.id,e.id)))return;const t=await P.convertPeerId(e),r={peerId:e,distance:Z(this.originDhtKey,t)};this.peerDistances.push(r),this.peerDistances.sort((n,o)=>Z.compare(n.distance,o.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(e){if(!e.length)return!1;if(!this.length)return!0;const t=await or(e,n=>P.convertPeerId(n)),r=this.peerDistances[this.peerDistances.length-1].distance;for(const n of t){const o=Z(this.originDhtKey,n);if(Z.compare(o,r)<0)return!0}return!1}}var qi=Ai,Ri=A(function(e,t){(function(){var r,n,o,i,s,a,u,c,d,l,h,y,v,w,f;o=Math.floor,l=Math.min,n=function(p,g){return p<g?-1:p>g?1:0},d=function(p,g,m,_,b){var k;if(m==null&&(m=0),b==null&&(b=n),m<0)throw new Error("lo must be non-negative");for(_==null&&(_=p.length);m<_;)k=o((m+_)/2),b(g,p[k])<0?_=k:m=k+1;return[].splice.apply(p,[m,m-m].concat(g)),g},a=function(p,g,m){return m==null&&(m=n),p.push(g),w(p,0,p.length-1,m)},s=function(p,g){var m,_;return g==null&&(g=n),m=p.pop(),p.length?(_=p[0],p[0]=m,f(p,0,g)):_=m,_},c=function(p,g,m){var _;return m==null&&(m=n),_=p[0],p[0]=g,f(p,0,m),_},u=function(p,g,m){var _;return m==null&&(m=n),p.length&&m(p[0],g)<0&&(_=[p[0],g],g=_[0],p[0]=_[1],f(p,0,m)),g},i=function(p,g){var m,_,b,k,I,E;for(g==null&&(g=n),k=function(){E=[];for(var C=0,O=o(p.length/2);0<=O?C<O:C>O;0<=O?C++:C--)E.push(C);return E}.apply(this).reverse(),I=[],_=0,b=k.length;_<b;_++)m=k[_],I.push(f(p,m,g));return I},v=function(p,g,m){var _;return m==null&&(m=n),_=p.indexOf(g),_===-1?void 0:(w(p,0,_,m),f(p,_,m))},h=function(p,g,m){var _,b,k,I,E;if(m==null&&(m=n),b=p.slice(0,g),!b.length)return b;for(i(b,m),E=p.slice(g),k=0,I=E.length;k<I;k++)_=E[k],u(b,_,m);return b.sort(m).reverse()},y=function(p,g,m){var _,b,k,I,E,C,O,B,ie,xe;if(m==null&&(m=n),g*10<=p.length){if(I=p.slice(0,g).sort(m),!I.length)return I;for(k=I[I.length-1],B=p.slice(g),E=0,O=B.length;E<O;E++)_=B[E],m(_,k)<0&&(d(I,_,0,null,m),I.pop(),k=I[I.length-1]);return I}for(i(p,m),xe=[],b=C=0,ie=l(g,p.length);0<=ie?C<ie:C>ie;b=0<=ie?++C:--C)xe.push(s(p,m));return xe},w=function(p,g,m,_){var b,k,I;for(_==null&&(_=n),b=p[m];m>g;){if(I=m-1>>1,k=p[I],_(b,k)<0){p[m]=k,m=I;continue}break}return p[m]=b},f=function(p,g,m){var _,b,k,I,E;for(m==null&&(m=n),b=p.length,E=g,k=p[g],_=2*g+1;_<b;)I=_+1,I<b&&!(m(p[_],p[I])<0)&&(_=I),p[g]=p[_],g=_,_=2*g+1;return p[g]=k,w(p,E,g,m)},r=function(){p.push=a,p.pop=s,p.replace=c,p.pushpop=u,p.heapify=i,p.updateItem=v,p.nlargest=h,p.nsmallest=y;function p(g){this.cmp=g??n,this.nodes=[]}return p.prototype.push=function(g){return a(this.nodes,g,this.cmp)},p.prototype.pop=function(){return s(this.nodes,this.cmp)},p.prototype.peek=function(){return this.nodes[0]},p.prototype.contains=function(g){return this.nodes.indexOf(g)!==-1},p.prototype.replace=function(g){return c(this.nodes,g,this.cmp)},p.prototype.pushpop=function(g){return u(this.nodes,g,this.cmp)},p.prototype.heapify=function(){return i(this.nodes,this.cmp)},p.prototype.updateItem=function(g){return v(this.nodes,g,this.cmp)},p.prototype.clear=function(){return this.nodes=[]},p.prototype.empty=function(){return this.nodes.length===0},p.prototype.size=function(){return this.nodes.length},p.prototype.clone=function(){var g;return g=new p,g.nodes=this.nodes.slice(0),g},p.prototype.toArray=function(){return this.nodes.slice(0)},p.prototype.insert=p.prototype.push,p.prototype.top=p.prototype.peek,p.prototype.front=p.prototype.peek,p.prototype.has=p.prototype.contains,p.prototype.copy=p.prototype.clone,p}(),function(p,g){return e.exports=g()}(this,function(){return r})}).call(Me)}),xi=Ri;const rt=ue("libp2p:dht:peer-queue");class nt{static async fromPeerId(e){const t=await P.convertPeerId(e);return new nt(t)}static async fromKey(e){const t=await P.convertBuffer(e);return new nt(t)}constructor(e){rt("create: %b",e),this.from=e,this.heap=new xi(P.xorCompare)}async enqueue(e){rt("enqueue %s",e.toB58String());const t=await P.convertPeerId(e),r={id:e,distance:Z(this.from,t)};this.heap.push(r)}dequeue(){const e=this.heap.pop();return rt("dequeue %s",e.id.toB58String()),e.id}get length(){return this.heap.size()}}var Oi=nt;const Di=3e4;class Mi{constructor(e,t){if(this.run=e,this.queryFunc=P.withTimeout(t,Di),!this.queryFunc)throw new Error("Path requires a `queryFn` to be specified");if(typeof this.queryFunc!="function")throw new Error("Path expected `queryFn` to be a function. Got "+typeof this.queryFunc);this.initialPeers=[],this.peersToQuery=null}addInitialPeer(e){this.initialPeers.push(e)}async execute(){const e=await Oi.fromKey(this.run.query.key);this.peersToQuery=e,await Promise.all(this.initialPeers.map(t=>this.addPeerToQuery(t))),await this.run.workerQueue(this)}async addPeerToQuery(e){if(this.run.query.dht._isSelf(e))return;if(this.run.peersSeen.has(e.toB58String()))return;await this.peersToQuery.enqueue(e)}}var Ni=Mi;function Bi(e,t,r,n){for(var o=e.length,i=r+(n?1:-1);n?i--:++i<o;)if(t(e[i],i,e))return i;return-1}var Li=Bi;function ji(e){return e!==e}var Fi=ji;function Ui(e,t,r){for(var n=r-1,o=e.length;++n<o;)if(e[n]===t)return n;return-1}var $i=Ui;function zi(e,t,r){return t===t?$i(e,t,r):Li(e,Fi,r)}var Ki=zi,Qi=Array.isArray,Vi=Qi;function Hi(){}var Gi=Hi,Wi=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;function r(n){return function(){if(n===null)throw new Error("Callback was already called.");var o=n;n=null,o.apply(this,arguments)}}e.exports=t.default}),cr=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;function r(n,o){o=o|0;for(var i=Math.max(n.length-o,0),s=Array(i),a=0;a<i;a++)s[a]=n[o+a];return s}e.exports=t.default}),dr=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.hasNextTick=t.hasSetImmediate=void 0,t.fallback=s,t.wrap=a;var r=n(cr);function n(c){return c&&c.__esModule?c:{default:c}}var o=t.hasSetImmediate=typeof setImmediate=="function"&&setImmediate,i=t.hasNextTick=typeof j=="object"&&typeof j.nextTick=="function";function s(c){setTimeout(c,0)}function a(c){return function(d){var l=(0,r.default)(arguments,1);c(function(){d.apply(null,l)})}}var u;o?u=setImmediate:i?u=j.nextTick:u=s,t.default=a(u)}),Yi=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;function r(){this.head=this.tail=null,this.length=0}function n(o,i){o.length=1,o.head=o.tail=i}r.prototype.removeLink=function(o){return o.prev?o.prev.next=o.next:this.head=o.next,o.next?o.next.prev=o.prev:this.tail=o.prev,o.prev=o.next=null,this.length-=1,o},r.prototype.empty=function(){for(;this.head;)this.shift();return this},r.prototype.insertAfter=function(o,i){i.prev=o,i.next=o.next,o.next?o.next.prev=i:this.tail=i,o.next=i,this.length+=1},r.prototype.insertBefore=function(o,i){i.prev=o.prev,i.next=o,o.prev?o.prev.next=i:this.head=i,o.prev=i,this.length+=1},r.prototype.unshift=function(o){this.head?this.insertBefore(this.head,o):n(this,o)},r.prototype.push=function(o){this.tail?this.insertAfter(this.tail,o):n(this,o)},r.prototype.shift=function(){return this.head&&this.removeLink(this.head)},r.prototype.pop=function(){return this.tail&&this.removeLink(this.tail)},r.prototype.toArray=function(){for(var o=Array(this.length),i=this.head,s=0;s<this.length;s++)o[s]=i.data,i=i.next;return o},r.prototype.remove=function(o){for(var i=this.head;i;){var s=i.next;o(i)&&this.removeLink(i),i=s}return this},e.exports=t.default});function Xi(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var Ji=Xi,Zi=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(o){return function(){var i=(0,r.default)(arguments),s=i.pop();o.call(this,i,s)}};var r=n(cr);function n(o){return o&&o.__esModule?o:{default:o}}e.exports=t.default}),eo=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=s;var r=i(Ji),n=i(Zi),o=i(dr);function i(c){return c&&c.__esModule?c:{default:c}}function s(c){return(0,n.default)(function(d,l){var h;try{h=c.apply(this,d)}catch(y){return l(y)}(0,r.default)(h)&&typeof h.then=="function"?h.then(function(y){a(l,null,y)},function(y){a(l,y.message?y:new Error(y))}):l(null,h)})}function a(c,d,l){try{c(d,l)}catch(h){(0,o.default)(u,h)}}function u(c){throw c}e.exports=t.default}),hr=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isAsync=void 0;var r=n(eo);function n(a){return a&&a.__esModule?a:{default:a}}var o=typeof Symbol=="function";function i(a){return o&&a[Symbol.toStringTag]==="AsyncFunction"}function s(a){return i(a)?(0,r.default)(a):a}t.default=s,t.isAsync=i}),to=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=d;var r=c(Ki),n=c(Vi),o=c(Gi),i=c(Wi),s=c(dr),a=c(Yi),u=c(hr);function c(l){return l&&l.__esModule?l:{default:l}}function d(l,h,y){if(h==null)h=1;else if(h===0)throw new Error("Concurrency must not be zero");var v=(0,u.default)(l),w=0,f=[],p=!1;function g(k,I,E){if(E!=null&&typeof E!="function")throw new Error("task callback must be a function");if(b.started=!0,(0,n.default)(k)||(k=[k]),k.length===0&&b.idle())return(0,s.default)(function(){b.drain()});for(var C=0,O=k.length;C<O;C++){var B={data:k[C],callback:E||o.default};I?b._tasks.unshift(B):b._tasks.push(B)}p||(p=!0,(0,s.default)(function(){p=!1,b.process()}))}function m(k){return function(I){w-=1;for(var E=0,C=k.length;E<C;E++){var O=k[E],B=(0,r.default)(f,O,0);B===0?f.shift():B>0&&f.splice(B,1),O.callback.apply(O,arguments),I!=null&&b.error(I,O.data)}w<=b.concurrency-b.buffer&&b.unsaturated(),b.idle()&&b.drain(),b.process()}}var _=!1,b={_tasks:new a.default,concurrency:h,payload:y,saturated:o.default,unsaturated:o.default,buffer:h/4,empty:o.default,drain:o.default,error:o.default,started:!1,paused:!1,push:function(k,I){g(k,!1,I)},kill:function(){b.drain=o.default,b._tasks.empty()},unshift:function(k,I){g(k,!0,I)},remove:function(k){b._tasks.remove(k)},process:function(){if(_)return;for(_=!0;!b.paused&&w<b.concurrency&&b._tasks.length;){var k=[],I=[],E=b._tasks.length;b.payload&&(E=Math.min(E,b.payload));for(var C=0;C<E;C++){var O=b._tasks.shift();k.push(O),f.push(O),I.push(O.data)}w+=1,b._tasks.length===0&&b.empty(),w===b.concurrency&&b.saturated();var B=(0,i.default)(m(k));v(I,B)}_=!1},length:function(){return b._tasks.length},running:function(){return w},workersList:function(){return f},idle:function(){return b._tasks.length+w===0},pause:function(){b.paused=!0},resume:function(){if(b.paused===!1)return;b.paused=!1,(0,s.default)(b.process)}};return b}e.exports=t.default}),ro=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(i,s){var a=(0,n.default)(i);return(0,r.default)(function(u,c){a(u[0],c)},s,1)};var r=o(to),n=o(hr);function o(i){return i&&i.__esModule?i:{default:i}}e.exports=t.default}),no=Object.prototype.toString,io=function(e){return no.call(e)==="[object Function]"},pr=typeof setImmediate=="function"?setImmediate:function(){var t=[].slice.apply(arguments);t.splice(1,0,0),setTimeout.apply(null,t)},oo=function(e){if(!io(e.then))throw new TypeError("Expected a promise");return function(t){e.then(function(r){pr(t,null,r)},function(r){pr(t,r)})}};class so{constructor(e,t,r,n){this.dht=e,this.run=t,this.path=r,this.log=n,this.concurrency=this.dht.concurrency,this.queue=this.setupQueue(),this.execution=null}setupQueue(){const e=ro((t,r)=>{oo(this.processNext(t))(r)},this.concurrency);return e.error=t=>{this.log.error("queue",t),this.stop(t)},e.drain=()=>{this.log("queue:drain"),this.stop()},e.unsaturated=()=>{this.running&&this.fill()},e.buffer=0,e}stop(e){if(!this.running)return;this.running=!1,this.queue.kill(),this.log("worker:stop, %d workers still running",this.run.workers.filter(t=>t.running).length),e?this.execution.reject(e):this.execution.resolve()}async execute(){this.running=!0,this.execution={};const e=new Promise((t,r)=>Object.assign(this.execution,{resolve:t,reject:r}));this.fill(),await e}fill(){for(;this.queue.running()+this.queue.length()<this.concurrency&&this.path.peersToQuery.length>0;)this.queue.push(this.path.peersToQuery.dequeue())}async processNext(e){if(!this.running)return;if(this.run.peersSeen.has(e.toB58String()))return;let t,r;try{t=await this.run.continueQuerying(this)}catch(i){r=i}if(!this.running)return;if(r)throw r;if(!t){this.stop();return}if(this.run.peersSeen.has(e.toB58String()))return;this.run.peersSeen.add(e.toB58String()),this.log("queue:work");let n,o;try{n=await this.execQuery(e)}catch(i){o=i}if(!this.running)return;if(this.log("queue:work:done",o,n),o)throw o;if(n&&n.queryComplete){this.log("query:complete"),this.run.stop();return}n&&n.pathComplete&&this.stop()}async execQuery(e){let t,r;try{t=await this.path.queryFunc(e)}catch(n){r=n}if(!this.running)return;if(r){this.run.errors.push(r);return}if(await this.run.peersQueried.add(e),t.pathComplete||t.queryComplete)return this.path.res=t,{pathComplete:t.pathComplete,queryComplete:t.queryComplete};t.closerPeers&&t.closerPeers.length>0&&await Promise.all(t.closerPeers.map(async n=>{if(this.dht._isSelf(n.id))return;this.dht._peerDiscovered(n.id,n.multiaddrs),await this.path.addPeerToQuery(n.id)}))}}var ao=so;class uo extends Oe{constructor(e){super();this.query=e,this.running=!1,this.workers=[],this.peersSeen=new Set,this.errors=[],this.peersQueried=null}stop(){if(!this.running)return;this.running=!1;for(const e of this.workers)e.stop()}async execute(e){const t=[],r=Math.min(this.query.dht.disjointPaths,e.length);for(let o=0;o<r;o++)t.push(new Ni(this,this.query.makePath(o,r)));e.forEach((o,i)=>{t[i%r].addInitialPeer(o)}),await this.executePaths(t);const n={finalSet:new Set(this.peersQueried.peers),paths:[]};for(const o of t)o.res&&(o.res.pathComplete||o.res.queryComplete)&&(o.res.success=!0,n.paths.push(o.res));return n}async executePaths(e){this.running=!0,this.emit("start");try{await Promise.all(e.map(t=>t.execute()))}finally{this.stop(),this.emit("complete")}if(this.errors.length===this.peersSeen.size)throw this.errors[0]}async workerQueue(e){await this.init(),await this.startWorker(e)}async startWorker(e){const t=new ao(this.query.dht,this,e,this.query._log);this.workers.push(t),await t.execute()}async init(){if(this.peersQueried)return;if(this.peersQueriedPromise){await this.peersQueriedPromise;return}this.peersQueriedPromise=(async()=>{const e=await P.convertBuffer(this.query.key);this.peersQueried=new qi(e,this.query.dht.kBucketSize)})(),await this.peersQueriedPromise,delete this.peersQueriedPromise}async continueQuerying(e){if(this.peersQueried.length<this.peersQueried.capacity)return!0;const t=e.queue.workersList().map(n=>n.data),r=await this.peersQueried.anyCloser(t);return!!r}}var lo=uo;const co=se.multihash;class ho{constructor(e,t,r){this.dht=e,this.key=t,this.makePath=r,this._log=P.logger(this.dht.peerId,"query:"+co.toB58String(t)),this.running=!1,this._onStart=this._onStart.bind(this),this._onComplete=this._onComplete.bind(this)}async run(e){return this.dht._queryManager.running?e.length===0?(this._log.error("Running query with no peers"),{finalSet:new Set,paths:[]}):(this._run=new lo(this),this._log(`query running with K=${this.dht.kBucketSize}, A=${this.dht.concurrency}, D=${Math.min(this.dht.disjointPaths,e.length)}`),this._run.once("start",this._onStart),this._run.once("complete",this._onComplete),this._run.execute(e)):(this._log.error("Attempt to run query after shutdown"),{finalSet:new Set,paths:[]})}_onStart(){this.running=!0,this._startTime=Date.now(),this._log("query:start"),this.dht._queryManager.queryStarted(this)}_onComplete(){this.stop()}stop(){if(this._log(`query:done in ${Date.now()-this._startTime}ms`),this._run&&this._log(`${this._run.errors.length} of ${this._run.peersSeen.size} peers errored (${this._run.errors.length/this._run.peersSeen.size*100}% fail rate)`),!this.running)return;this._run.removeListener("start",this._onStart),this._run.removeListener("complete",this._onComplete),this.running=!1,this._run&&this._run.stop(),this.dht._queryManager.queryCompleted(this)}}var qe=ho;const po=K.Record;var fo=e=>{const t=async(o,i)=>e.datastore.put(P.bufferToKey(o),i),r=async o=>{e._log("getLocal %b",o);const i=await e.datastore.get(P.bufferToKey(o));e._log("found %b in local datastore",o);const s=po.deserialize(i);return await e._verifyRecordLocally(s),s},n=async(o,i,s)=>{const a=await P.createPutRecord(o,s);return Promise.all(i.map(async u=>{if(oe(u.val,s))return;if(e._isSelf(u.from)){try{await e._putLocal(o,a)}catch(c){e._log.error("Failed error correcting self",c)}return}try{await e._putValueToPeer(o,a,u.from)}catch(c){e._log.error("Failed error correcting entry",c)}}))};return{async _putLocal(o,i){return t(o,i)},async put(o,i,s={}){e._log("PutValue %b",o);const a=await P.createPutRecord(o,i);await t(o,a);let u=0,c=0;await P.mapParallel(e.getClosestPeers(o,{shallow:!0}),async l=>{try{u+=1,await e._putValueToPeer(o,a,l),c+=1}catch(h){e._log.error("Failed to put to peer (%b): %s",l.id,h)}});const d=s.minPeers||u;if(d>c){const l=T(new Error(`Failed to put value to enough peers: ${c}/${d}`),"ERR_NOT_ENOUGH_PUT_PEERS");throw e._log.error(l),l}},async get(o,i={}){i.timeout=i.timeout||D.minute,e._log("_get %b",o);const s=await e.getMany(o,D.GET_MANY_RECORD_COUNT,i),a=s.map(d=>d.val);let u=0;try{u=K.selection.bestRecord(e.selectors,o,a)}catch(d){if(d.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw d}const c=a[u];if(e._log("GetValue %b %s",o,c),!c)throw T(new Error("best value was not found"),"ERR_NOT_FOUND");return await n(o,s,c),c},async getMany(o,i,s={}){s.timeout=s.timeout||D.minute,e._log("getMany %b (%s)",o,i);let a=[],u;try{u=await r(o)}catch(v){if(i===0)throw v}if(u&&a.push({val:u.value,from:e.peerId}),a.length>=i)return a;const c=[],d=await P.convertBuffer(o),l=e.routingTable.closestPeers(d,this.kBucketSize);if(e._log("peers in rt: %d",l.length),l.length===0){const v="Failed to lookup key! No peers from routing table!";if(e._log.error(v),a.length===0)throw T(new Error(v),"ERR_NO_PEERS_IN_ROUTING_TABLE");return a}const h=new qe(e,o,(v,w)=>{const f=P.pathSize(i-a.length,w),p=[];return c.push(p),async g=>{let m,_,b;try{const I=await e._getValueOrPeers(g,o);m=I.record,_=I.peers}catch(I){if(I.code!=="ERR_INVALID_RECORD")throw I;b=I}const k={closerPeers:_};return(m&&m.value||b)&&p.push({val:m&&m.value,from:g}),p.length>=f&&(k.pathComplete=!0),k}});let y;try{await V(h.run(l),s.timeout)}catch(v){y=v}if(h.stop(),a=[].concat.apply(a,c).slice(0,i),y&&a.length===0)throw y;return a}}};class mo{constructor(){this.list=[]}push(e){return this.has(e.id)?!1:(this.list.push(e),!0)}has(e){const t=this.list.find(r=>r.id.isEqual(e));return Boolean(t)}toArray(){return this.list.slice()}pop(){return this.list.pop()}get length(){return this.list.length}}var yo=mo;class go extends yo{constructor(e){super();this.limit=e}push(e){return this.length<this.limit?super.push(e):!1}}var fr=go,vo=e=>{const t=async(r,n)=>{const o=new x(x.TYPES.GET_PROVIDERS,n.bytes,0);return e.network.sendRequest(r,o)};return{async provide(r){e._log("provide: %s",r.toBaseEncodedString());const n=[];await e.providers.addProvider(r,e.peerId);const o=e.libp2p?e.libp2p.multiaddrs:[],i=new x(x.TYPES.ADD_PROVIDER,r.bytes,0);if(i.providerPeers=[{id:e.peerId,multiaddrs:o}],await P.mapParallel(e.getClosestPeers(r.bytes),async s=>{e._log("putProvider %s to %s",r.toBaseEncodedString(),s.toB58String());try{await e.network.sendMessage(s,i)}catch(a){n.push(a)}}),n.length)throw T(new Error(`Failed to provide to ${n.length} of ${e.kBucketSize} peers`,"ERR_SOME_PROVIDES_FAILED"),{errors:n})},async*findProviders(r,n={}){const o=n.timeout||D.minute,i=n.maxNumProviders||D.K;e._log("findProviders %s",r.toBaseEncodedString());const s=new fr(i),a=await e.providers.getProviders(r);if(a.forEach(l=>{const h=e.peerStore.get(l)||{};s.push({id:h.id||l,multiaddrs:(h.addresses||[]).map(y=>y.multiaddr)})}),s.length>=i){for(const l of s.toArray())yield l;return}const u=[],c=new qe(e,r.bytes,(l,h)=>{const y=P.pathSize(i-s.length,h),v=new fr(y);return u.push(v),async w=>{const f=await t(w,r),p=f.providerPeers;return e._log("(%s) found %s provider entries",e.peerId.toB58String(),p.length),p.forEach(g=>{v.push({id:g.id})}),v.length>=y?{pathComplete:!0}:{closerPeers:f.closerPeers}}}),d=e.routingTable.closestPeers(r.bytes,e.kBucketSize);try{await V(c.run(d),o)}catch(l){if(l.name!==V.TimeoutError.name)throw l}finally{c.stop()}if(u.forEach(l=>{l.toArray().forEach(h=>{s.push(h)})}),s.length===0)throw T(new Error("no providers found"),"ERR_NOT_FOUND");for(const l of s.toArray())yield l}}},bo=e=>{const t=async i=>{e._log("findPeerLocal %s",i.toB58String());const s=await e.routingTable.find(i),a=s&&e.peerStore.get(s);if(a)return{id:a.id,multiaddrs:a.addresses.map(u=>u.multiaddr)}},r=async(i,s)=>{const a=new x(x.TYPES.GET_VALUE,s,0);return e.network.sendRequest(i,a)},n=async(i,s)=>{e._log("closerPeersSingle %b from %s",i,s.toB58String());const a=await e.peerRouting._findPeerSingle(s,new Y(i));return a.closerPeers.filter(u=>!e._isSelf(u.id)).map(u=>(e.peerStore.addressBook.add(u.id,u.multiaddrs),u))},o=async i=>{const s=P.keyForPublicKey(i),a=await r(i,s);if(!a.record||!a.record.value)throw T(`Node not responding with its public key: ${i.toB58String()}`,"ERR_INVALID_RECORD");const u=Y.createFromPubKey(a.record.value);if(!u.isEqual(i))throw T("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");return u.pubKey};return{async _findPeerSingle(i,s){e._log("findPeerSingle %s",i.toB58String());const a=new x(x.TYPES.FIND_NODE,s.id,0);return e.network.sendRequest(i,a)},async findPeer(i,s={}){s.timeout=s.timeout||D.minute,e._log("findPeer %s",i.toB58String());const a=await t(i);if(a!=null)return e._log("found local"),a;const u=await P.convertPeerId(i),c=e.routingTable.closestPeers(u,e.kBucketSize);if(c.length===0)throw T(new Error("Peer lookup failed"),"ERR_LOOKUP_FAILED");const d=c.find(f=>f.isEqual(i));if(d){const f=e.peerStore.get(i);if(f)return e._log("found in peerStore"),{id:f.id,multiaddrs:f.addresses.map(p=>p.multiaddr)}}const l=new qe(e,i.id,()=>async f=>{const p=await this._findPeerSingle(f,i),g=p.closerPeers.find(m=>m.id.isEqual(i));return g?{peer:g,queryComplete:!0}:{closerPeers:p.closerPeers}});let h,y;try{y=await V(l.run(c),s.timeout)}catch(f){h=f}if(l.stop(),h)throw h;let v=!1;if(y.paths.forEach(f=>{f.success&&(v=!0,e.peerStore.addressBook.add(f.peer.id,f.peer.multiaddrs))}),e._log("findPeer %s: %s",i.toB58String(),v),!v)throw T(new Error("No peer found"),"ERR_NOT_FOUND");const w=e.peerStore.get(i);return{id:w.id,multiaddrs:w.addresses.map(f=>f.multiaddr)}},async*getClosestPeers(i,s={shallow:!1}){e._log("getClosestPeers to %b",i);const a=await P.convertBuffer(i),u=e.routingTable.closestPeers(a,e.kBucketSize),c=new qe(e,i,()=>async h=>{const y=await n(i,h);return{closerPeers:y,pathComplete:s.shallow?!0:void 0}}),d=await c.run(u);if(!d||!d.finalSet)return[];const l=await P.sortClosestPeers(Array.from(d.finalSet),a);for(const h of l.slice(0,e.kBucketSize))yield h},async getPublicKey(i){e._log("getPublicKey %s",i.toB58String());const s=e.peerStore.get(i);if(s&&s.id.pubKey)return e._log("getPublicKey: found local copy"),s.id.pubKey;let a;try{a=await o(i)}catch(c){const d=P.keyForPublicKey(i),l=await e.get(d);a=Xe.keys.unmarshalPublicKey(l)}s.id=new Y(i.id,null,a);const u=s.addresses.map(c=>c.multiaddr);return e.peerStore.addressBook.add(s.id,u),e.peerStore.keyBook.set(s.id,a),a}}},wo=A(function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function o(u,c,d){this.fn=u,this.context=c,this.once=d||!1}function i(u,c,d,l,h){if(typeof d!="function")throw new TypeError("The listener must be a function");var y=new o(d,l||u,h),v=r?r+c:c;return u._events[v]?u._events[v].fn?u._events[v]=[u._events[v],y]:u._events[v].push(y):(u._events[v]=y,u._eventsCount++),u}function s(u,c){--u._eventsCount===0?u._events=new n:delete u._events[c]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var c=[],d,l;if(this._eventsCount===0)return c;for(l in d=this._events)t.call(d,l)&&c.push(r?l.slice(1):l);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(d)):c},a.prototype.listeners=function(c){var d=r?r+c:c,l=this._events[d];if(!l)return[];if(l.fn)return[l.fn];for(var h=0,y=l.length,v=new Array(y);h<y;h++)v[h]=l[h].fn;return v},a.prototype.listenerCount=function(c){var d=r?r+c:c,l=this._events[d];return l?l.fn?1:l.length:0},a.prototype.emit=function(c,d,l,h,y,v){var w=r?r+c:c;if(!this._events[w])return!1;var f=this._events[w],p=arguments.length,g,m;if(f.fn){f.once&&this.removeListener(c,f.fn,void 0,!0);switch(p){case 1:return f.fn.call(f.context),!0;case 2:return f.fn.call(f.context,d),!0;case 3:return f.fn.call(f.context,d,l),!0;case 4:return f.fn.call(f.context,d,l,h),!0;case 5:return f.fn.call(f.context,d,l,h,y),!0;case 6:return f.fn.call(f.context,d,l,h,y,v),!0}for(m=1,g=new Array(p-1);m<p;m++)g[m-1]=arguments[m];f.fn.apply(f.context,g)}else{var _=f.length,b;for(m=0;m<_;m++){f[m].once&&this.removeListener(c,f[m].fn,void 0,!0);switch(p){case 1:f[m].fn.call(f[m].context);break;case 2:f[m].fn.call(f[m].context,d);break;case 3:f[m].fn.call(f[m].context,d,l);break;case 4:f[m].fn.call(f[m].context,d,l,h);break;default:if(!g)for(b=1,g=new Array(p-1);b<p;b++)g[b-1]=arguments[b];f[m].fn.apply(f[m].context,g)}}}return!0},a.prototype.on=function(c,d,l){return i(this,c,d,l,!1)},a.prototype.once=function(c,d,l){return i(this,c,d,l,!0)},a.prototype.removeListener=function(c,d,l,h){var y=r?r+c:c;if(!this._events[y])return this;if(!d)return s(this,y),this;var v=this._events[y];if(v.fn)v.fn===d&&(!h||v.once)&&(!l||v.context===l)&&s(this,y);else{for(var w=0,f=[],p=v.length;w<p;w++)(v[w].fn!==d||h&&!v[w].once||l&&v[w].context!==l)&&f.push(v[w]);f.length?this._events[y]=f.length===1?f[0]:f:s(this,y)}return this},a.prototype.removeAllListeners=function(c){var d;return c?(d=r?r+c:c,this._events[d]&&s(this,d)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,e.exports=a}),_o=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});function r(n,o,i){let s=0,a=n.length;for(;a>0;){const u=a/2|0;let c=s+u;i(n[c],o)<=0?(s=++c,a-=u+1):a=u}return s}t.default=r}),Po=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(){this._queue=[]}enqueue(n,o){o=Object.assign({priority:0},o);const i={priority:o.priority,run:n};if(this.size&&this._queue[this.size-1].priority>=o.priority){this._queue.push(i);return}const s=_o.default(this._queue,i,(a,u)=>u.priority-a.priority);this._queue.splice(s,0,i)}dequeue(){const n=this._queue.shift();return n==null?void 0:n.run}filter(n){return this._queue.filter(o=>o.priority===n.priority).map(o=>o.run)}get size(){return this._queue.length}}t.default=r}),ko=A(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});const r=()=>{},n=new V.TimeoutError;class o extends wo{constructor(i){var s,a,u,c;super();if(this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=r,this._resolveIdle=r,i=Object.assign({carryoverConcurrencyCount:!1,intervalCap:Infinity,interval:0,concurrency:Infinity,autoStart:!0,queueClass:Po.default},i),!(typeof i.intervalCap=="number"&&i.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(a=(s=i.intervalCap)===null||s===void 0?void 0:s.toString())!==null&&a!==void 0?a:""}\` (${typeof i.intervalCap})`);if(i.interval===void 0||!(Number.isFinite(i.interval)&&i.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(c=(u=i.interval)===null||u===void 0?void 0:u.toString())!==null&&c!==void 0?c:""}\` (${typeof i.interval})`);this._carryoverConcurrencyCount=i.carryoverConcurrencyCount,this._isIntervalIgnored=i.intervalCap===Infinity||i.interval===0,this._intervalCap=i.intervalCap,this._interval=i.interval,this._queue=new i.queueClass,this._queueClass=i.queueClass,this.concurrency=i.concurrency,this._timeout=i.timeout,this._throwOnTimeout=i.throwOnTimeout===!0,this._isPaused=i.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=r,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=r,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const i=Date.now();if(this._intervalId===void 0){const s=this._intervalEnd-i;if(s<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},s)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const i=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const s=this._queue.dequeue();return s?(this.emit("active"),s(),i&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){if(this._isIntervalIgnored||this._intervalId!==void 0)return;this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(i){if(!(typeof i=="number"&&i>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${i}\` (${typeof i})`);this._concurrency=i,this._processQueue()}async add(i,s={}){return new Promise((a,u)=>{const c=async()=>{this._pendingCount++,this._intervalCount++;try{const d=this._timeout===void 0&&s.timeout===void 0?i():V.default(Promise.resolve(i()),s.timeout===void 0?this._timeout:s.timeout,()=>{(s.throwOnTimeout===void 0?this._throwOnTimeout:s.throwOnTimeout)&&u(n);return});a(await d)}catch(d){u(d)}this._next()};this._queue.enqueue(c,s),this._tryToStartAnother(),this.emit("add")})}async addAll(i,s){return Promise.all(i.map(async a=>this.add(a,s)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){return this._queue.size===0?void 0:new Promise(i=>{const s=this._resolveEmpty;this._resolveEmpty=()=>{s(),i()}})}async onIdle(){return this._pendingCount===0&&this._queue.size===0?void 0:new Promise(i=>{const s=this._resolveIdle;this._resolveIdle=()=>{s(),i()}})}get size(){return this._queue.size}sizeBy(i){return this._queue.filter(i).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(i){this._timeout=i}}t.default=o});const{Key:Io}=Be,{default:Eo}=ko;class To{constructor(e,t,r){this.datastore=e,this._log=P.logger(t,"providers"),this.cleanupInterval=D.PROVIDERS_CLEANUP_INTERVAL,this.provideValidity=D.PROVIDERS_VALIDITY,this.lruCacheSize=r||D.PROVIDERS_LRU_CACHE_SIZE,this.providers=Jt(this.lruCacheSize),this.syncQueue=new Eo({concurrency:1})}start(){this._cleaner=setInterval(()=>this._cleanup(),this.cleanupInterval)}stop(){clearInterval(this._cleaner),this._cleaner=null}_cleanup(){return this.syncQueue.add(async()=>{this._log("start cleanup");const e=Date.now();let t=0,r=0;const n=new Map,o=this.datastore.batch(),i=this.datastore.query({prefix:D.PROVIDERS_KEY_PREFIX});for await(const s of i)try{const{cid:a,peerId:u}=mr(s.key),c=yr(s.value),d=Date.now(),l=d-c,h=l>this.provideValidity;if(this._log("comparing: %d - %d = %d > %d %s",d,c,l,this.provideValidity,h?"(expired)":""),h){r++,o.delete(s.key);const y=n.get(a)||new Set;y.add(u),n.set(a,y)}t++}catch(a){this._log.error(a.message)}this._log("deleting %d / %d entries",r,t),n.size&&await o.commit();for(const[s,a]of n){const u=pe(s),c=this.providers.get(u);if(c){for(const d of a)c.delete(d);c.size===0?this.providers.remove(u):this.providers.set(u,c)}}this._log("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){const t=pe(e);let r=this.providers.get(t);return r||(r=await Co(this.datastore,e),this.providers.set(t,r)),r}async addProvider(e,t){return this.syncQueue.add(async()=>{this._log("addProvider %s",e.toBaseEncodedString());const r=await this._getProvidersMap(e);this._log("loaded %s provs",r.size);const n=Date.now();r.set(P.encodeBase32(t.id),n);const o=pe(e);return this.providers.set(o,r),So(this.datastore,e,t,n)})}async getProviders(e){return this.syncQueue.add(async()=>{this._log("getProviders %s",e.toBaseEncodedString());const t=await this._getProvidersMap(e);return[...t.keys()].map(r=>new Y(P.decodeBase32(r)))})}}function pe(e){return e=typeof e=="string"?e:P.encodeBase32(e.bytes),D.PROVIDERS_KEY_PREFIX+e}async function So(e,t,r,n){const o=[pe(t),"/",P.encodeBase32(r.id)].join(""),i=new Io(o),s=Uint8Array.from(R.encode(n));return e.put(i,s)}function mr(e){const t=e.toString().split("/");if(t.length!==4)throw new Error("incorrectly formatted provider entry key in datastore: "+e);return{cid:t[2],peerId:t[3]}}async function Co(e,t){const r=new Map,n=e.query({prefix:pe(t)});for await(const o of n){const{peerId:i}=mr(o.key);r.set(i,yr(o.value))}return r}function yr(e){return R.decode(e)}var Ao=To,qo=async(e,t,{concurrency:r=Infinity,stopOnError:n=!0}={})=>new Promise((o,i)=>{if(typeof t!="function")throw new TypeError("Mapper function is required");if(!((Number.isSafeInteger(r)||r===Infinity)&&r>=1))throw new TypeError(`Expected \`concurrency\` to be an integer from 1 and up or \`Infinity\`, got \`${r}\` (${typeof r})`);const s=[],a=[],u=e[Symbol.iterator]();let c=!1,d=!1,l=0,h=0;const y=()=>{if(c)return;const v=u.next(),w=h;if(h++,v.done){d=!0,l===0&&(!n&&a.length!==0?i(new Le(a)):o(s));return}l++,(async()=>{try{const f=await v.value;s[w]=await t(f,w),l--,y()}catch(f){n?(c=!0,i(f)):(a.push(f),l--,y())}})()};for(let v=0;v<r&&!(y(),d);v++);});const gr=async(e,t,r)=>qo(new Array(e).fill(),(n,o)=>t(o),r);var vr=gr,Ro=gr;vr.default=Ro;const{logger:xo}=P;class Oo{constructor(e,t){if(!e)throw new Error("Random Walk needs an instance of the Kademlia DHT");this._kadDHT=e,this._options={...D.defaultRandomWalk,...t},this.log=xo(e.peerId,"random-walk"),this._timeoutId=void 0}start(){if(this._timeoutId||!this._options.enabled)return;this._timeoutId=setTimeout(()=>{this._runPeriodically()},this._options.delay)}stop(){this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=void 0),this._controller&&this._controller.abort()}async _runPeriodically(){for(;this._timeoutId;){try{await this._walk(this._options.queriesPerPeriod,this._options.timeout)}catch(e){this._kadDHT._log.error("random-walk:error",e)}await new Promise(e=>{this._timeoutId=setTimeout(e,this._options.interval)})}}async _walk(e,t){this.log("start"),this._controller=new we;try{await vr(e,async r=>{this.log("running query %d",r);try{const n=await this._randomPeerId();if(!this._controller)return;await this._query(n,{timeout:t,signal:this._controller.signal})}catch(n){if(n&&n.code!=="ETIMEDOUT")throw this.log.error("query %d finished with error",r,n),n}this.log("finished query %d",r)})}finally{this._controller=null,this.log("finished queries")}}async _query(e,t){this.log("query:%s",e.toB58String());let r;try{r=await this._kadDHT.findPeer(e,t)}catch(n){if(n&&n.code==="ERR_NOT_FOUND")return;throw n}throw this.log("query:found",r),T(`random-walk: ACTUALLY FOUND PEER: ${r}, ${e.toB58String()}`,"ERR_FOUND_RANDOM_PEER")}async _randomPeerId(){const e=await se(Xe.randomBytes(16),"sha2-256");return new Y(e)}}var Do=Oo;class Mo{constructor(){this.queries=new Set,this.running=!1}queryStarted(e){this.queries.add(e)}queryCompleted(e){this.queries.delete(e)}start(){this.running=!0}stop(){this.running=!1;for(const e of this.queries)e.stop();this.queries.clear()}}var No=Mo;const{EventEmitter:Bo}=Oe,{MemoryDatastore:Lo}=Be,br=K.Record;class jo extends Bo{constructor({libp2p:e,dialer:t,peerId:r,peerStore:n,registrar:o,protocolPrefix:i="/ipfs",forceProtocolLegacy:s=!1,datastore:a=new Lo,kBucketSize:u=D.K,clientMode:c=!1,concurrency:d=D.ALPHA,validators:l={},selectors:h={},randomWalk:y={},onPut:v=()=>{},onRemove:w=()=>{}}){super();if(!t)throw new Error("libp2p-kad-dht requires an instance of Dialer");this.libp2p=e,this.dialer=t,this.peerId=r,this.peerStore=n,this.registrar=o,this.protocol=i+(s?"":D.PROTOCOL_DHT),this.kBucketSize=u,this._clientMode=c,this.concurrency=d,this.disjointPaths=Math.ceil(this.kBucketSize/2),this.routingTable=new ui(this.peerId,this.kBucketSize),this.datastore=a,this.providers=new Ao(this.datastore,this.peerId),this.validators={pk:K.validator.validators.pk,...l},this.selectors={pk:K.selection.selectors.pk,...h},this.network=new Ci(this),this._log=P.logger(this.peerId),this.randomWalk=new Do(this,y),this._queryManager=new No,this._running=!1,this.contentFetching=fo(this),this.contentRouting=vo(this),this.peerRouting=bo(this),this.onPut=v,this.onRemove=w}get isStarted(){return this._running}async start(){this._running=!0,this.providers.start(),this._queryManager.start(),await this.network.start(),this.randomWalk.start()}stop(){return this._running=!1,this.randomWalk.stop(),this.providers.stop(),this._queryManager.stop(),this.network.stop()}async put(e,t,r={}){return this.contentFetching.put(e,t,r)}async get(e,t={}){return this.contentFetching.get(e,t)}async getMany(e,t,r={}){return this.contentFetching.getMany(e,t,r)}async removeLocal(e){this._log("removeLocal: %b",e);const t=P.bufferToKey(e);try{await this.datastore.delete(t)}catch(r){if(r.code==="ERR_NOT_FOUND")return;throw r}}async provide(e){return this.contentRouting.provide(e)}async*findProviders(e,t={}){for await(const r of this.contentRouting.findProviders(e,t))yield r}async findPeer(e,t={}){return this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={shallow:!1}){for await(const r of this.peerRouting.getClosestPeers(e,t))yield r}async getPublicKey(e){return this.peerRouting.getPublicKey(e)}_peerDiscovered(e,t){this.emit("peer",{id:e,multiaddrs:t})}async _nearestPeersToQuery(e){const t=await P.convertBuffer(e.key),r=this.routingTable.closestPeers(t,this.kBucketSize);return r.map(n=>{const o=this.peerStore.get(n);return{id:n,multiaddrs:o?o.addresses.map(i=>i.multiaddr):[]}})}async _betterPeersToQuery(e,t){this._log("betterPeersToQuery");const r=await this._nearestPeersToQuery(e);return r.filter(n=>this._isSelf(n.id)?(this._log.error("trying to return self as closer"),!1):!n.id.isEqual(t))}async _checkLocalDatastore(e){this._log("checkLocalDatastore: %b",e);const t=P.bufferToKey(e);let r;try{r=await this.datastore.get(t)}catch(o){if(o.code==="ERR_NOT_FOUND")return;throw o}const n=br.deserialize(r);if(!n)throw T("Invalid record","ERR_INVALID_RECORD");if(n.timeReceived==null||P.now()-n.timeReceived>D.MAX_RECORD_AGE){await this.datastore.delete(t),this.onRemove(n);return}return n}async _add(e){await this.routingTable.add(e)}async _verifyRecordLocally(e){this._log("verifyRecordLocally"),await K.validator.verifyRecord(this.validators,e)}_isSelf(e){return e&&oe(this.peerId.id,e.id)}async _putValueToPeer(e,t,r){const n=new x(x.TYPES.PUT_VALUE,e,0);n.record=t;const o=await this.network.sendRequest(r,n);if(!o.record.value.equals(br.deserialize(t).value))throw T(new Error("value not put correctly"),"ERR_PUT_VALUE_INVALID")}async _getValueOrPeers(e,t){const r=await this._getValueSingle(e,t),n=r.closerPeers,o=r.record;if(o){try{await this._verifyRecordOnline(o)}catch(i){const s="invalid record received, discarded";throw this._log(s),T(new Error(s),"ERR_INVALID_RECORD")}return{record:o,peers:n}}if(n.length>0)return{peers:n};throw T(new Error("Not found"),"ERR_NOT_FOUND")}async _getValueSingle(e,t){const r=new x(x.TYPES.GET_VALUE,t,0);return this.network.sendRequest(e,r)}async _verifyRecordOnline(e){await K.validator.verifyRecord(this.validators,e)}}var Re=jo,wr="/ipfs"+D.PROTOCOL_DHT;Re.multicodec=wr;var Fo=Object.freeze(Object.assign(Object.create(null),Re,{default:Re,multicodec:wr}));export{te as B,Le as a,ue as b,ge as c,re as d,we as e,Xe as f,rr as g,Jt as h,Fo as i,nr as j,Re as k,V as p,Zt as r,It as s};
