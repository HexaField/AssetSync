import*as p from"https://cdn.skypack.dev/pin/three@v0.117.1-NetLzdTnw9ga3y6o633U/min/three.js";import b from"./Feature.js";import c from"../../../../../web_modules/abi-decoder.js";import w from"../structures/StructureRoom.js";import m from"../../screens/text/TextRenderer3D.js";import{Sky as g}from"../../../../../web_modules/three/examples/jsm/objects/Sky.js";import v from"../../util/three-gif-loader/gif-loader.js";export default class M extends b{constructor(t){super(t);this.piecesCount=16,this.room=new w(t.conjure,t.group,{roomHeight:.1,roomWidth:this.piecesCount*4}),this.superrareABI=[{constant:!0,inputs:[{name:"interfaceId",type:"bytes4"}],name:"supportsInterface",outputs:[{name:"",type:"bool"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"_enabled",type:"bool"}],name:"enableWhitelist",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[],name:"name",outputs:[{name:"",type:"string"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[{name:"tokenId",type:"uint256"}],name:"getApproved",outputs:[{name:"",type:"address"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"to",type:"address"},{name:"tokenId",type:"uint256"}],name:"approve",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[],name:"totalSupply",outputs:[{name:"",type:"uint256"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"from",type:"address"},{name:"to",type:"address"},{name:"tokenId",type:"uint256"}],name:"transferFrom",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!1,inputs:[{name:"_tokenId",type:"uint256"},{name:"_uri",type:"string"}],name:"updateTokenMetadata",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[{name:"owner",type:"address"},{name:"index",type:"uint256"}],name:"tokenOfOwnerByIndex",outputs:[{name:"",type:"uint256"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[{name:"_address",type:"address"}],name:"isWhitelisted",outputs:[{name:"",type:"bool"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[{name:"_tokenId",type:"uint256"}],name:"tokenCreator",outputs:[{name:"",type:"address"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"from",type:"address"},{name:"to",type:"address"},{name:"tokenId",type:"uint256"}],name:"safeTransferFrom",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[{name:"index",type:"uint256"}],name:"tokenByIndex",outputs:[{name:"",type:"uint256"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"_tokenId",type:"uint256"}],name:"deleteToken",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[{name:"tokenId",type:"uint256"}],name:"ownerOf",outputs:[{name:"",type:"address"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[{name:"owner",type:"address"}],name:"balanceOf",outputs:[{name:"",type:"uint256"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[],name:"renounceOwnership",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!1,inputs:[{name:"_removedAddress",type:"address"}],name:"removeFromWhitelist",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[],name:"owner",outputs:[{name:"",type:"address"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[],name:"isOwner",outputs:[{name:"",type:"bool"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[],name:"symbol",outputs:[{name:"",type:"string"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"to",type:"address"},{name:"approved",type:"bool"}],name:"setApprovalForAll",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!1,inputs:[{name:"_whitelistees",type:"address[]"}],name:"initWhitelist",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!1,inputs:[{name:"from",type:"address"},{name:"to",type:"address"},{name:"tokenId",type:"uint256"},{name:"_data",type:"bytes"}],name:"safeTransferFrom",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[{name:"tokenId",type:"uint256"}],name:"tokenURI",outputs:[{name:"",type:"string"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"_uri",type:"string"}],name:"addNewToken",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!1,inputs:[{name:"_newAddress",type:"address"}],name:"addToWhitelist",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[{name:"owner",type:"address"},{name:"operator",type:"address"}],name:"isApprovedForAll",outputs:[{name:"",type:"bool"}],payable:!1,stateMutability:"view",type:"function"},{constant:!1,inputs:[{name:"newOwner",type:"address"}],name:"transferOwnership",outputs:[],payable:!1,stateMutability:"nonpayable",type:"function"},{inputs:[{name:"_name",type:"string"},{name:"_symbol",type:"string"},{name:"_oldSuperRare",type:"address"}],payable:!1,stateMutability:"nonpayable",type:"constructor"},{anonymous:!1,inputs:[{indexed:!0,name:"_tokenId",type:"uint256"},{indexed:!1,name:"_uri",type:"string"}],name:"TokenURIUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,name:"_newAddress",type:"address"}],name:"AddToWhitelist",type:"event"},{anonymous:!1,inputs:[{indexed:!0,name:"_removedAddress",type:"address"}],name:"RemoveFromWhitelist",type:"event"},{anonymous:!1,inputs:[{indexed:!0,name:"previousOwner",type:"address"},{indexed:!0,name:"newOwner",type:"address"}],name:"OwnershipTransferred",type:"event"},{anonymous:!1,inputs:[{indexed:!0,name:"from",type:"address"},{indexed:!0,name:"to",type:"address"},{indexed:!0,name:"tokenId",type:"uint256"}],name:"Transfer",type:"event"},{anonymous:!1,inputs:[{indexed:!0,name:"owner",type:"address"},{indexed:!0,name:"approved",type:"address"},{indexed:!0,name:"tokenId",type:"uint256"}],name:"Approval",type:"event"},{anonymous:!1,inputs:[{indexed:!0,name:"owner",type:"address"},{indexed:!0,name:"operator",type:"address"},{indexed:!1,name:"approved",type:"bool"}],name:"ApprovalForAll",type:"event"}],this.pieces=[],this.gifLoader=new v}async preload(){this.sky=new g,this.sky.scale.setScalar(45e4),this.realm.group.add(this.sky);var t=this.sky.material.uniforms;t.turbidity.value=1,t.rayleigh.value=1,t.mieCoefficient.value=.005,t.mieDirectionalG.value=.7;var e=Math.PI*(.05-.5),n=2*Math.PI*(.2-.5);this.realm.conjure.sunPos.x=Math.cos(n),this.realm.conjure.sunPos.y=Math.sin(n)*Math.sin(e),this.realm.conjure.sunPos.z=Math.sin(n)*Math.cos(e),this.realm.conjure.dirLight.intensity=1.2,this.realm.conjure.dirLight.position.copy(this.realm.conjure.sunPos),t.sunPosition.value.copy(this.realm.conjure.sunPos),this.realm.conjure.loadingScreen.setText("Creating gallery..."),console.log("Creating gallery..."),this.loadingTex=await this.realm.conjure.load.texture("/assets/icons/loading.png"),console.log("Creating pieces...");for(let i=0;i<this.piecesCount;i++){let s=i>=this.piecesCount/2,o=this.room.roomWidth/this.piecesCount*(s?i-this.piecesCount/2:i)-this.room.roomWidth/4+1,a=this.createPainting(new p.Vector3(o*2*(s?-1:1),2.5,(s?1:-1)*this.room.roomLength*.45));s&&a.rotateY(Math.PI)}this.loadArtwork()}async load(){}async unload(){this.room.destroy()}update(t){}async loadArtwork(){c.addABI(this.superrareABI);let t=await(await fetch("https://cors-anywhere.herokuapp.com/https://api.etherscan.io/api?module=account&action=txlist&address=0xb932a70a57673d89f4acffbe830e8ed7f75fb9e0&startblock=0&endblock=latest&page=1&sort=desc&offset=100")).json();if(!t.result)return;let e=0;for(let i of t.result){let s=Date.now(),o=c.decodeMethod(i.input);if(!o||!o.params)continue;if(o.name==="addNewToken"){let a=await(await fetch(o.params[0].value)).json();if(Number(a.media.size)>100*1e3*1e3)continue;let r=a.media.mimeType.toString();if(r.includes("gltf-binary")){let d=await this.realm.conjure.load.gltf(a.media.uri);if(!d||!d.scene)continue;this.pieces[e].mesh.material.visible=!1,this.pieces[e].mesh.add(d.scene)}else{let d=a.media.dimensions.split("x");if(r.includes("mp4")){continue;let u=document.createElement("video");u.crossOrigin="anonymous",u.loop=!0,this.pieces[e].mesh.material.map=new p.VideoTexture(u),this.realm.conjure.getAudioManager().createFromMediaSource(u,this.pieces[e].mesh),this.pieces[e].mesh.userData.media=u;var n=new XMLHttpRequest;n.open("GET",a.media.uri,!0),n.responseType="blob",n.onload=y=>{if(y.target.status===200){let f=y.target.response,h=URL.createObjectURL(f);u.src=h,u.play(),u.volume=0}},n.onerror=function(){console.log("Failed to get video at",a.media.uri)},n.send()}else if(r.includes("gif")){continue;this.pieces[e].mesh.material.map=await this.gifLoader.load(a.media.uri)}else if(r.includes("png")||r.includes("jpg")||r.includes("jpeg"))this.pieces[e].mesh.material.map=await this.realm.conjure.load.texture(a.media.uri);else{console.log("ArtGallery: Received unsupported file type:",r);continue}this.pieces[e].mesh.material.transparent=r.includes("png");let l=Number(d[0])/Number(d[1]);l>1&&this.pieces[e].mesh.geometry.scale(l,1,1),l<1&&(this.pieces[e].createdBy.group.position.setY(-l*1.75),this.pieces[e].name.group.position.setY(l*1.75),this.pieces[e].description.group.position.setY(l*2),this.pieces[e].mesh.geometry.scale(1,l,1))}if(this.pieces[e].createdBy.setText(a.createdBy.trim()),this.pieces[e].name.setText(a.name.trim()+", "+a.yearCreated.trim()+", "+Math.round(Number(a.media.size)/(1024*1024))+"Mb"),this.pieces[e].description.setText(this.explodeString(a.description.trim().replace(`
`,""),100)),this.pieces[e].mesh.material.map.generateMipmaps=!1,this.pieces[e].mesh.material.map.wrapS=this.pieces[e].mesh.material.map.wrapT=p.ClampToEdgeWrapping,this.pieces[e].mesh.material.map.minFilter=p.LinearFilter,e++,console.log("Artwork number",e,"of type",r,"took",Date.now()-s,"ms to load "),e>=this.piecesCount)return}}}createPainting(t){let e=new p.Mesh(new p.PlaneBufferGeometry(3,3),new p.MeshBasicMaterial({map:this.loadingTex,side:p.DoubleSide})),n=this.pieces.length%2?1:-1,i=new m(this.realm.conjure,e,{text:"Loading...",width:1,scale:2,color:0});i.group.position.set(0,-1.75,0);let s=new m(this.realm.conjure,e,{text:"",width:1,scale:2,color:0});s.group.position.set(0,1.75,0);let o=new m(this.realm.conjure,e,{text:"",width:1,scale:2,color:0,alignY:"bottom"});o.group.position.set(0,2,0);let a=new p.PointLight(16772744,.4,20,2);return a.position.set(0,1,1),e.add(a),e.receiveShadow=!1,e.castShadow=!0,e.position.copy(t),this.realm.group.add(e),this.pieces.push({mesh:e,createdBy:i,description:o,name:s}),e}explodeString(t,e){for(var n="",i=Math.floor(t.length/e),s=0;s<i+1;s++)n+=t.substr(s*e,e),s!==i&&(n+=`
`);return n}}
