import*as n from" https://cdn.skypack.dev/pin/three@v0.123.0-STd7XeVUbImsNuMmqKGL/min/three.js";import{number as c}from"../../conjure/util/number.js";import{NETWORKING_OPCODES as l,PHYSICS_TYPES as u}from"../Constants.js";export default class a{constructor(t){this.realm=t,this.world=t.world,this.conjure=t.conjure,this.scene=this.conjure.scene,this.objects=[],this.vec3=new n.Vector3,this.quat=new n.Quaternion,this.physicsTypes=Object.values(u)}async groupObjects(t,e,o){if(!t||!e||!t.parent||!e.parent)return;if(e.parent===t)return;if(this.getIsParentOfRecursive(e,t))return;let s=this.getTopGroupObject(e),i=this.getTopGroupObject(t);if(!s||!i)return;this.conjure.world.objectControls.detachAll(),e.parent.remove(e);let r=e.clone();i!==s&&(this.getObject(s)?await this.conjure.getWorld().destroyObject(s):await this.conjure.getWorld().updateObject(s)),t.add(r),r.userData.hash&&(r.userData.hash=null),await this.conjure.getWorld().updateObject(i),this.conjure.getScreens().screenObjectsHierarchy.updateObjects(),o||this.conjure.getWorld().sendData(l.OBJECT.UPDATE,{newParentUUID:t.UUID,newChildUUID:r.UUID})}getObject(t){for(let e of this.objects)if(e===t)return e}getObjectByHash(t){for(let e of this.objects)if(e.userData.hash===t)return e}getObjectByUUID(t){for(let e of this.objects)if(e.uuid===t)return e}addObject(t){console.log(t)}getTopGroupObject(t){for(let e of this.objects)if(this.getIsParentOfRecursive(e,t))return e;return}getIsParentOfRecursive(t,e){return t===e?!0:e.parent?this.getIsParentOfRecursive(t,e.parent):!1}getIsChildOfRecursive(t,e){if(this.getIsParentOfRecursive(t,e))return!1;if(t===e)return!0;for(let o of t.children)if(o===e)return!0;if(e.children)for(let o of e.children)return this.getIsChildOfRecursive(o,e);return!1}destroyAllObjects(){for(let t of this.objects)t.body&&this.conjure.physics.destroy(t.body),t.material&&t.material.dispose(),t.geometry&&t.geometry.dispose(),this.scene.remove(t);this.objects=[],this.conjure.renderer.renderLists.dispose()}destroyObjectByUUID(t){for(let e of this.objects)e.uuid===t&&this.destroyObject(e)}destroyObject(t,e={}){if(t.body&&this.conjure.physics.destroy(t.body),!e.isChild)for(let o=0;o<this.objects.length;o++)this.objects[o]===t&&this.objects.splice(o,1);e.isChild?t.parent.remove(t):this.scene.remove(t),t.material&&t.material.dispose(),t.geometry&&t.geometry.dispose(),this.conjure.getScreens().screenObjectsHierarchy.updateObjects(),this.conjure.renderer.renderLists.dispose()}removeObject(t){for(let e=0;e<this.objects.length;e++)this.objects[e]===t&&this.objects.splice(e,1)}rgbToHex(t){var e=c(t).toString(16);return e.length<2&&(e="0"+e),e}update(t){for(let e of this.objects)if(e.body){let o=e.getWorldPosition(this.vec3);(o.y<-10||o.y>100||o.x>100||o.x<-100||o.z>100||o.z<-100)&&this.teleport(e,0,10,0)}if(this.conjure.getScreens().mouseOver)this.conjure.postProcessing.setHoverObject();else{let e=t.mouseRaycaster.intersectObjects(this.objects,!0);e.length>0?this.conjure.postProcessing.setHoverObject(e[0].object):this.conjure.postProcessing.setHoverObject()}}updateObjectFromClient(t,e){for(let o of this.objects)o.uuid===t&&(o.body?(o.body.setCollisionFlags(2),o.position.set(e.position.x,e.position.y,e.position.z),o.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),o.body.needUpdate=!0,o.body.once.update(()=>{o.body.setCollisionFlags(0),e.velocity&&o.body.setVelocity(e.velocity.x,e.velocity.y,e.velocity.z),e.angularVelocity&&o.body.setAngularVelocity(e.angularVelocity.x,e.angularVelocity.y,e.angularVelocity.z)})):(o.position.set(e.position.x,e.position.y,e.position.z),o.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z)))}teleport(t,e,o,s){t.body.setCollisionFlags(2),t.position.set(e,o,s),t.body.needUpdate=!0,t.body.once.update(()=>{t.body.setCollisionFlags(0),t.body.setVelocity(0,0,0),t.body.setAngularVelocity(0,0,0)})}}
