import{b as W,n as j,as as q,V as s,o as U,e as F,r as z,at as G,u as S,au as E,av as H,L as O,a3 as I}from"../../../../common/three.module-36fff313.js";var d=function(T,o){W.call(this,T),this.type="Reflector";var u=this;o=o||{};var A=o.color!==void 0?new j(o.color):new j(8355711),y=o.textureWidth||512,R=o.textureHeight||512,C=o.clipBias||0,g=o.shader||d.ReflectorShader,l=new q,i=new s,n=new s,M=new s,c=new U,h=new s(0,0,-1),r=new F,v=new s,w=new s,m=new F,p=new U,t=new z,D={minFilter:O,magFilter:O,format:I},f=new G(y,R,D);(!S.isPowerOfTwo(y)||!S.isPowerOfTwo(R))&&(f.texture.generateMipmaps=!1);var b=new E({uniforms:H.clone(g.uniforms),fragmentShader:g.fragmentShader,vertexShader:g.vertexShader});b.uniforms.tDiffuse.value=f.texture,b.uniforms.color.value=A,b.uniforms.textureMatrix.value=p,this.material=b,this.onBeforeRender=function(e,V,x){if(n.setFromMatrixPosition(u.matrixWorld),M.setFromMatrixPosition(x.matrixWorld),c.extractRotation(u.matrixWorld),i.set(0,0,1),i.applyMatrix4(c),v.subVectors(n,M),v.dot(i)>0)return;v.reflect(i).negate(),v.add(n),c.extractRotation(x.matrixWorld),h.set(0,0,-1),h.applyMatrix4(c),h.add(M),w.subVectors(n,h),w.reflect(i).negate(),w.add(n),t.position.copy(v),t.up.set(0,1,0),t.up.applyMatrix4(c),t.up.reflect(i),t.lookAt(w),t.far=x.far,t.updateMatrixWorld(),t.projectionMatrix.copy(x.projectionMatrix),p.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),p.multiply(t.projectionMatrix),p.multiply(t.matrixWorldInverse),p.multiply(u.matrixWorld),l.setFromNormalAndCoplanarPoint(i,n),l.applyMatrix4(t.matrixWorldInverse),r.set(l.normal.x,l.normal.y,l.normal.z,l.constant);var a=t.projectionMatrix;m.x=(Math.sign(r.x)+a.elements[8])/a.elements[0],m.y=(Math.sign(r.y)+a.elements[9])/a.elements[5],m.z=-1,m.w=(1+a.elements[10])/a.elements[14],r.multiplyScalar(2/r.dot(m)),a.elements[2]=r.x,a.elements[6]=r.y,a.elements[10]=r.z+1-C,a.elements[14]=r.w,f.texture.encoding=e.outputEncoding,u.visible=!1;var k=e.getRenderTarget(),B=e.xr.enabled,L=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(f),e.state.buffers.depth.setMask(!0),e.autoClear===!1&&e.clear(),e.render(V,t),e.xr.enabled=B,e.shadowMap.autoUpdate=L,e.setRenderTarget(k);var P=x.viewport;P!==void 0&&e.state.viewport(P),u.visible=!0},this.getRenderTarget=function(){return f}};d.prototype=Object.create(W.prototype),d.prototype.constructor=d,d.ReflectorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:["uniform mat4 textureMatrix;","varying vec4 vUv;","void main() {","	vUv = textureMatrix * vec4( position, 1.0 );","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join(`
`),fragmentShader:["uniform vec3 color;","uniform sampler2D tDiffuse;","varying vec4 vUv;","float blendOverlay( float base, float blend ) {","	return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );","}","vec3 blendOverlay( vec3 base, vec3 blend ) {","	return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );","}","void main() {","	vec4 base = texture2DProj( tDiffuse, vUv );","	gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );","}"].join(`
`)};export{d as Reflector};
