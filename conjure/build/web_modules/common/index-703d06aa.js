import{e as wr}from"./events-18451fd5.js";import{t as H,f as Re,c as Pe,v as W,s as Vt,a as Qr,b as _r,d as Ie,k as Qt,e as L,u as Ta,w as Sa,x as xa,n as Ra,r as Ca,y as Da,q as Wt,i as Wr,g as Ee,h as Yt,j as kr}from"./index-b1567acb.js";import{p as he}from"./process-e9e98960.js";import{b as Ce}from"./buffer-es6-e6024076.js";import{c as G,g as Oa,a as Yr}from"./_commonjsHelpers-c99fd594.js";import{d as Jr}from"./__node-resolve:empty-d7309c3b.js";import{s as Pr}from"./index-11133e6d.js";import{b as qa}from"./browser-f3be077b.js";var Ma=(e,t=1,r)=>{if(r={indent:" ",includeEmptyLines:!1,...r},typeof e!="string")throw new TypeError(`Expected \`input\` to be a \`string\`, got \`${typeof e}\``);if(typeof t!="number")throw new TypeError(`Expected \`count\` to be a \`number\`, got \`${typeof t}\``);if(typeof r.indent!="string")throw new TypeError(`Expected \`options.indent\` to be a \`string\`, got \`${typeof r.indent}\``);if(t===0)return e;const n=r.includeEmptyLines?/^/gm:/^(?!\s*$)/gm;return e.replace(n,r.indent.repeat(t))};const Xr=/\s+at.*(?:\(|\s)(.*)\)?/,Ba=/^(?:(?:(?:node|(?:internal\/[\w/]*|.*node_modules\/(?:babel-polyfill|pirates)\/.*)?\w+)\.js:\d+:\d+)|native)/,Ua=typeof Jr.homedir=="undefined"?"":Jr.homedir();var Na=(e,t)=>(t=Object.assign({pretty:!1},t),e.replace(/\\/g,"/").split(`
`).filter(r=>{const n=r.match(Xr);if(n===null||!n[1])return!0;const a=n[1];return a.includes(".app/Contents/Resources/electron.asar")||a.includes(".app/Contents/Resources/default_app.asar")?!1:!Ba.test(a)}).filter(r=>r.trim()!=="").map(r=>t.pretty?r.replace(Xr,(n,a)=>n.replace(a,a.replace(Ua,"~"))):r).join(`
`));const La=e=>e.replace(/\s+at .*aggregate-error\/index.js:\d+:\d+\)?/g,"");class ja extends Error{constructor(e){if(!Array.isArray(e))throw new TypeError(`Expected input to be an Array, got ${typeof e}`);e=[...e].map(r=>r instanceof Error?r:r!==null&&typeof r=="object"?Object.assign(new Error(r.message),r):new Error(r));let t=e.map(r=>typeof r.stack=="string"?La(Na(r.stack)):String(r)).join(`
`);t=`
`+Ma(t,4),super(t),this.name="AggregateError",Object.defineProperty(this,"_errors",{value:e})}*[Symbol.iterator](){for(const e of this._errors)yield e}}var Ir=ja;const Zr="[a-fA-F\\d:]",ve=e=>e&&e.includeBoundaries?`(?:(?<=\\s|^)(?=${Zr})|(?<=${Zr})(?=\\s|$))`:"",ce="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",V="[a-fA-F\\d]{1,4}",Jt=`
(
(?:${V}:){7}(?:${V}|:)|                                // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${V}:){6}(?:${ce}|:${V}|:)|                         // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${V}:){5}(?::${ce}|(:${V}){1,2}|:)|                 // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${V}:){4}(?:(:${V}){0,1}:${ce}|(:${V}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${V}:){3}(?:(:${V}){0,2}:${ce}|(:${V}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${V}:){2}(?:(:${V}){0,3}:${ce}|(:${V}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${V}:){1}(?:(:${V}){0,4}:${ce}|(:${V}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::((?::${V}){0,5}:${ce}|(?::${V}){1,7}|:))           // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(%[0-9a-zA-Z]{1,})?                                           // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),Fa=new RegExp(`(?:^${ce}$)|(?:^${Jt}$)`),$a=new RegExp(`^${ce}$`),Ka=new RegExp(`^${Jt}$`),Er=e=>e&&e.exact?Fa:new RegExp(`(?:${ve(e)}${ce}${ve(e)})|(?:${ve(e)}${Jt}${ve(e)})`,"g");Er.v4=e=>e&&e.exact?$a:new RegExp(`${ve(e)}${ce}${ve(e)}`,"g"),Er.v6=e=>e&&e.exact?Ka:new RegExp(`${ve(e)}${Jt}${ve(e)}`,"g");var Ar=Er;const De=e=>Ar({exact:!0}).test(e);De.v4=e=>Ar.v4({exact:!0}).test(e),De.v6=e=>Ar.v6({exact:!0}).test(e),De.version=e=>De(e)?De.v4(e)?4:6:void 0;var Xt=De;const za=Xt,Tr=Xt.v4,en=Xt.v6,tn=function(e,t,r){r=~~r;var n;if(Tr(e))n=t||new Uint8Array(r+4),e.split(/\./g).map(function(m){n[r++]=parseInt(m,10)&255});else if(en(e)){var a=e.split(":",8),i;for(i=0;i<a.length;i++){var o=Tr(a[i]),u;o&&(u=tn(a[i]),a[i]=H(u.slice(0,2),"base16")),u&&++i<8&&a.splice(i,0,H(u.slice(2,4),"base16"))}if(a[0]==="")for(;a.length<8;)a.unshift("0");else if(a[a.length-1]==="")for(;a.length<8;)a.push("0");else if(a.length<8){for(i=0;i<a.length&&a[i]!=="";i++);var d=[i,"1"];for(i=9-a.length;i>0;i--)d.push("0");a.splice.apply(a,d)}for(n=t||new Uint8Array(r+16),i=0;i<a.length;i++){var l=parseInt(a[i],16);n[r++]=l>>8&255,n[r++]=l&255}}if(!n)throw Error("Invalid ip address: "+e);return n},Ha=function(e,t,r){t=~~t,r=r||e.length-t;var n=[],a;const i=new DataView(e.buffer);if(r===4){for(let o=0;o<r;o++)n.push(e[t+o]);a=n.join(".")}else if(r===16){for(let o=0;o<r;o+=2)n.push(i.getUint16(t+o).toString(16));a=n.join(":"),a=a.replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3"),a=a.replace(/:{3,4}/,"::")}return a};var Zt={isIP:za,isV4:Tr,isV6:en,toBytes:tn,toString:Ha};function re(e){if(typeof e=="number"){if(re.codes[e])return re.codes[e];throw new Error("no protocol with code: "+e)}else if(typeof e=="string"||e instanceof String){if(re.names[e])return re.names[e];throw new Error("no protocol with name: "+e)}throw new Error("invalid protocol id type: "+e)}const ie=-1;re.lengthPrefixedVarSize=ie,re.V=ie,re.table=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,ie,"ip6zone"],[53,ie,"dns","resolvable"],[54,ie,"dns4","resolvable"],[55,ie,"dns6","resolvable"],[56,ie,"dnsaddr","resolvable"],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,ie,"unix",!1,"path"],[421,ie,"ipfs"],[421,ie,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,ie,"garlic64"],[460,0,"quic"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,ie,"memory"]],re.names={},re.codes={},re.table.map(e=>{const t=rn.apply(null,e);re.codes[t.code]=t,re.names[t.name]=t}),re.object=rn;function rn(e,t,r,n,a){return{code:e,size:t,name:r,resolvable:Boolean(n),path:Boolean(a)}}var pe=re,nn=Le;function Le(e,t){return t instanceof Uint8Array?Le.toString(e,t):Le.toBytes(e,t)}Le.toString=function(t,r){t=pe(t);switch(t.code){case 4:case 41:return Ga(r);case 6:case 273:case 33:case 132:return on(r);case 53:case 54:case 55:case 56:case 400:case 777:return Qa(r);case 421:return Ya(r);case 444:return sn(r);case 445:return sn(r);default:return H(r,"base16")}},Le.toBytes=function(t,r){t=pe(t);switch(t.code){case 4:return an(r);case 41:return an(r);case 6:case 273:case 33:case 132:return Sr(parseInt(r,10));case 53:case 54:case 55:case 56:case 400:case 777:return Va(r);case 421:return Wa(r);case 444:return Ja(r);case 445:return Xa(r);default:return Re(r,"base16")}};function an(e){if(!Zt.isIP(e))throw new Error("invalid ip address");return Zt.toBytes(e)}function Ga(e){const t=Zt.toString(e);if(!t||!Zt.isIP(t))throw new Error("invalid ip address");return t}function Sr(e){const t=new ArrayBuffer(2),r=new DataView(t);return r.setUint16(0,e),new Uint8Array(t)}function on(e){const t=new DataView(e.buffer);return t.getUint16(0)}function Va(e){const t=Re(e),r=Uint8Array.from(W.encode(t.length));return Pe([r,t],r.length+t.length)}function Qa(e){const t=W.decode(e);if(e=e.slice(W.decode.bytes),e.length!==t)throw new Error("inconsistent lengths");return H(e)}function Wa(e){const t=new Vt(e).multihash,r=Uint8Array.from(W.encode(t.length));return Pe([r,t],r.length+t.length)}function Ya(e){const t=W.decode(e),r=e.slice(W.decode.bytes);if(r.length!==t)throw new Error("inconsistent lengths");return H(r,"base58btc")}function Ja(e){const t=e.split(":");if(t.length!==2)throw new Error("failed to parse onion addr: "+t+" does not contain a port number");if(t[0].length!==16)throw new Error("failed to parse onion addr: "+t[0]+" not a Tor onion address.");const r=Qr.decode("b"+t[0]),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const a=Sr(n);return Pe([r,a],r.length+a.length)}function Xa(e){const t=e.split(":");if(t.length!==2)throw new Error("failed to parse onion addr: "+t+" does not contain a port number");if(t[0].length!==56)throw new Error("failed to parse onion addr: "+t[0]+" not a Tor onion3 address.");const r=Qr.decode("b"+t[0]),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const a=Sr(n);return Pe([r,a],r.length+a.length)}function sn(e){const t=e.slice(0,e.length-2),r=e.slice(e.length-2),n=H(t,"base32"),a=on(r);return n+":"+a}var le={stringToStringTuples:un,stringTuplesToString:cn,tuplesToStringTuples:dn,stringTuplesToTuples:ln,bytesToTuples:xr,tuplesToBytes:hn,bytesToString:Za,stringToBytes:fn,fromString:ei,fromBytes:mn,validateBytes:Rr,isValidBytes:ti,cleanPath:er,ParseError:Cr,protoFromTuple:je,sizeForAddr:pn};function un(e){const t=[],r=e.split("/").slice(1);if(r.length===1&&r[0]==="")return[];for(let n=0;n<r.length;n++){const a=r[n],i=pe(a);if(i.size===0){t.push([a]);continue}if(n++,n>=r.length)throw Cr("invalid address: "+e);if(i.path){t.push([a,er(r.slice(n).join("/"))]);break}t.push([a,r[n]])}return t}function cn(e){const t=[];return e.map(r=>{const n=je(r);t.push(n.name),r.length>1&&t.push(r[1])}),er(t.join("/"))}function ln(e){return e.map(t=>{Array.isArray(t)||(t=[t]);const r=je(t);return t.length>1?[r.code,nn.toBytes(r.code,t[1])]:[r.code]})}function dn(e){return e.map(t=>{const r=je(t);return t.length>1?[r.code,nn.toString(r.code,t[1])]:[r.code]})}function hn(e){return mn(Pe(e.map(t=>{const r=je(t);let n=Uint8Array.from(W.encode(r.code));return t.length>1&&(n=Pe([n,t[1]])),n})))}function pn(e,t){if(e.size>0)return e.size/8;if(e.size===0)return 0;{const r=W.decode(t);return r+W.decode.bytes}}function xr(e){const t=[];let r=0;for(;r<e.length;){const n=W.decode(e,r),a=W.decode.bytes,i=pe(n),o=pn(i,e.slice(r+a));if(o===0){t.push([n]),r+=a;continue}const u=e.slice(r+a,r+a+o);if(r+=o+a,r>e.length)throw Cr("Invalid address Uint8Array: "+H(e,"base16"));t.push([n,u])}return t}function Za(e){const t=xr(e),r=dn(t);return cn(r)}function fn(e){e=er(e);const t=un(e),r=ln(t);return hn(r)}function ei(e){return fn(e)}function mn(e){const t=Rr(e);if(t)throw t;return Uint8Array.from(e)}function Rr(e){try{xr(e)}catch(t){return t}}function ti(e){return Rr(e)===void 0}function er(e){return"/"+e.trim().split("/").filter(t=>t).join("/")}function Cr(e){return new Error("Error parsing address: "+e)}function je(e){const t=pe(e[0]);return t}var yn=G(function(e,t){const r=Symbol.for("nodejs.util.inspect.custom"),n=_r.proto(function(a){if(!(this instanceof n))return new n(a);if(a==null&&(a=""),a instanceof Uint8Array)this.bytes=le.fromBytes(a);else if(typeof a=="string"||a instanceof String){if(a.length>0&&a.charAt(0)!=="/")throw new Error(`multiaddr "${a}" must start with a "/"`);this.bytes=le.fromString(a)}else if(a.bytes&&a.protos&&a.protoCodes)this.bytes=le.fromBytes(a.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr")},{className:"Multiaddr",symbolName:"@multiformats/js-multiaddr/multiaddr"});n.prototype.toString=function(){return le.bytesToString(this.bytes)},n.prototype.toJSON=n.prototype.toString,n.prototype.toOptions=function(){const i={},o=this.toString().split("/");return i.family=o[1]==="ip4"?"ipv4":"ipv6",i.host=o[2],i.transport=o[3],i.port=parseInt(o[4]),i},n.prototype[r]=function(){return"<Multiaddr "+H(this.bytes,"base16")+" - "+le.bytesToString(this.bytes)+">"},n.prototype.inspect=function(){return"<Multiaddr "+H(this.bytes,"base16")+" - "+le.bytesToString(this.bytes)+">"},n.prototype.protos=function(){return this.protoCodes().map(i=>Object.assign({},pe(i)))},n.prototype.protoCodes=function(){const i=[],o=this.bytes;let u=0;for(;u<o.length;){const d=W.decode(o,u),l=W.decode.bytes,m=pe(d),h=le.sizeForAddr(m,o.slice(u+l));u+=h+l,i.push(d)}return i},n.prototype.protoNames=function(){return this.protos().map(i=>i.name)},n.prototype.tuples=function(){return le.bytesToTuples(this.bytes)},n.prototype.stringTuples=function(){const i=le.bytesToTuples(this.bytes);return le.tuplesToStringTuples(i)},n.prototype.encapsulate=function(i){return i=n(i),n(this.toString()+i.toString())},n.prototype.decapsulate=function(i){i=i.toString();const o=this.toString(),u=o.lastIndexOf(i);if(u<0)throw new Error("Address "+this+" does not contain subaddress: "+i);return n(o.slice(0,u))},n.prototype.decapsulateCode=function(i){const o=this.tuples();for(let u=o.length-1;u>=0;u--)if(o[u][0]===i)return n(le.tuplesToBytes(o.slice(0,u)));return this},n.prototype.getPeerId=function(){let i=null;try{const o=this.stringTuples().filter(u=>{if(u[0]===pe.names.ipfs.code)return!0});i=o.pop()[1],i=H(new Vt(i).multihash,"base58btc")}catch(o){i=null}return i},n.prototype.getPath=function(){let i=null;try{i=this.stringTuples().filter(o=>{const u=pe(o[0]);if(u.path)return!0})[0][1]}catch(o){i=null}return i},n.prototype.equals=function(i){return Ie(this.bytes,i.bytes)},n.prototype.nodeAddress=function(){const i=this.protoCodes(),o=this.protoNames(),u=this.toString().split("/").slice(1);if(u.length<4)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6}/{address}/{tcp, udp}/{port}".');if(i[0]!==4&&i[0]!==41&&i[0]!==54&&i[0]!==55)throw new Error(`no protocol with name: "'${o[0]}'". Must have a valid family name: "{ip4, ip6, dns4, dns6}".`);if(u[2]!=="tcp"&&u[2]!=="udp")throw new Error(`no protocol with name: "'${o[1]}'". Must have a valid transport protocol: "{tcp, udp}".`);return{family:i[0]===41||i[0]===55?6:4,address:u[1],port:parseInt(u[3])}},n.fromNodeAddress=function(i,o){if(!i)throw new Error("requires node address object");if(!o)throw new Error("requires transport protocol");let u;switch(i.family){case"IPv4":u="ip4";break;case"IPv6":u="ip6";break;default:throw Error(`Invalid addr family. Got '${i.family}' instead of 'IPv4' or 'IPv6'`)}return n("/"+[u,i.address,o,i.port].join("/"))},n.prototype.isThinWaistAddress=function(i){const o=(i||this).protos();return o.length!==2||o[0].code!==4&&o[0].code!==41?!1:!(o[1].code!==6&&o[1].code!==273)},n.protocols=pe,n.isName=function(i){return n.isMultiaddr(i)?i.protos().some(o=>o.resolvable):!1},n.resolve=function(i){return!n.isMultiaddr(i)||!n.isName(i)?Promise.reject(Error("not a valid name")):Promise.reject(new Error("not implemented yet"))},t=e.exports=n});const{Buffer:de}=Ce,gn=Symbol.for("BufferList");function F(e){if(!(this instanceof F))return new F(e);F._init.call(this,e)}F._init=function(t){Object.defineProperty(this,gn,{value:!0}),this._bufs=[],this.length=0,t&&this.append(t)},F.prototype._new=function(t){return new F(t)},F.prototype._offset=function(t){if(t===0)return[0,0];let r=0;for(let n=0;n<this._bufs.length;n++){const a=r+this._bufs[n].length;if(t<a||n===this._bufs.length-1)return[n,t-r];r=a}},F.prototype._reverseOffset=function(e){const t=e[0];let r=e[1];for(let n=0;n<t;n++)r+=this._bufs[n].length;return r},F.prototype.get=function(t){if(t>this.length||t<0)return;const r=this._offset(t);return this._bufs[r[0]][r[1]]},F.prototype.slice=function(t,r){return typeof t=="number"&&t<0&&(t+=this.length),typeof r=="number"&&r<0&&(r+=this.length),this.copy(null,0,t,r)},F.prototype.copy=function(t,r,n,a){if((typeof n!="number"||n<0)&&(n=0),(typeof a!="number"||a>this.length)&&(a=this.length),n>=this.length)return t||de.alloc(0);if(a<=0)return t||de.alloc(0);const i=!!t,o=this._offset(n),u=a-n;let d=u,l=i&&r||0,m=o[1];if(n===0&&a===this.length){if(!i)return this._bufs.length===1?this._bufs[0]:de.concat(this._bufs,this.length);for(let h=0;h<this._bufs.length;h++)this._bufs[h].copy(t,l),l+=this._bufs[h].length;return t}if(d<=this._bufs[o[0]].length-m)return i?this._bufs[o[0]].copy(t,r,m,m+d):this._bufs[o[0]].slice(m,m+d);i||(t=de.allocUnsafe(u));for(let h=o[0];h<this._bufs.length;h++){const v=this._bufs[h].length-m;if(d>v)this._bufs[h].copy(t,l,m),l+=v;else{this._bufs[h].copy(t,l,m,m+d),l+=v;break}d-=v,m&&(m=0)}return t.length>l?t.slice(0,l):t},F.prototype.shallowSlice=function(t,r){if(t=t||0,r=typeof r!="number"?this.length:r,t<0&&(t+=this.length),r<0&&(r+=this.length),t===r)return this._new();const n=this._offset(t),a=this._offset(r),i=this._bufs.slice(n[0],a[0]+1);return a[1]===0?i.pop():i[i.length-1]=i[i.length-1].slice(0,a[1]),n[1]!==0&&(i[0]=i[0].slice(n[1])),this._new(i)},F.prototype.toString=function(t,r,n){return this.slice(r,n).toString(t)},F.prototype.consume=function(t){if(t=Math.trunc(t),Number.isNaN(t)||t<=0)return this;for(;this._bufs.length;)if(t>=this._bufs[0].length)t-=this._bufs[0].length,this.length-=this._bufs[0].length,this._bufs.shift();else{this._bufs[0]=this._bufs[0].slice(t),this.length-=t;break}return this},F.prototype.duplicate=function(){const t=this._new();for(let r=0;r<this._bufs.length;r++)t.append(this._bufs[r]);return t},F.prototype.append=function(t){if(t==null)return this;if(t.buffer)this._appendBuffer(de.from(t.buffer,t.byteOffset,t.byteLength));else if(Array.isArray(t))for(let r=0;r<t.length;r++)this.append(t[r]);else if(this._isBufferList(t))for(let r=0;r<t._bufs.length;r++)this.append(t._bufs[r]);else typeof t=="number"&&(t=t.toString()),this._appendBuffer(de.from(t));return this},F.prototype._appendBuffer=function(t){this._bufs.push(t),this.length+=t.length},F.prototype.indexOf=function(e,t,r){if(r===void 0&&typeof t=="string"&&(r=t,t=void 0),typeof e=="function"||Array.isArray(e))throw new TypeError('The "value" argument must be one of type string, Buffer, BufferList, or Uint8Array.');if(typeof e=="number"?e=de.from([e]):typeof e=="string"?e=de.from(e,r):this._isBufferList(e)?e=e.slice():Array.isArray(e.buffer)?e=de.from(e.buffer,e.byteOffset,e.byteLength):de.isBuffer(e)||(e=de.from(e)),t=Number(t||0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const n=this._offset(t);let a=n[0],i=n[1];for(;a<this._bufs.length;a++){const o=this._bufs[a];for(;i<o.length;){const u=o.length-i;if(u>=e.length){const d=o.indexOf(e,i);if(d!==-1)return this._reverseOffset([a,d]);i=o.length-e.length+1}else{const d=this._reverseOffset([a,i]);if(this._match(d,e))return d;i++}}i=0}return-1},F.prototype._match=function(e,t){if(this.length-e<t.length)return!1;for(let r=0;r<t.length;r++)if(this.get(e+r)!==t[r])return!1;return!0},function(){const e={readDoubleBE:8,readDoubleLE:8,readFloatBE:4,readFloatLE:4,readInt32BE:4,readInt32LE:4,readUInt32BE:4,readUInt32LE:4,readInt16BE:2,readInt16LE:2,readUInt16BE:2,readUInt16LE:2,readInt8:1,readUInt8:1,readIntBE:null,readIntLE:null,readUIntBE:null,readUIntLE:null};for(const t in e)(function(r){e[r]===null?F.prototype[r]=function(n,a){return this.slice(n,n+a)[r](0,a)}:F.prototype[r]=function(n){return this.slice(n,n+e[r])[r](0)}})(t)}(),F.prototype._isBufferList=function(t){return t instanceof F||F.isBufferList(t)},F.isBufferList=function(t){return t!=null&&t[gn]};var Oe=F;const{Buffer:ri}=Ce,vn=(e,t,r)=>{const n=W.encode(e,t,r);return vn.bytes=W.encode.bytes,t||ri.from(n)};var Dr=vn;const{Buffer:bn}=Ce,Or=8,wn=10*1024;function _n(e){e=e||{};const t=Math.max(e.poolSize||wn,e.minPoolSize||Or),r=e.lengthEncoder||Dr;return n=>async function*(){let a=bn.alloc(t),i=0;for await(const o of n){r(o.length,a,i);const u=a.slice(i,i+r.bytes);i+=r.bytes,a.length-i<Or&&(a=bn.alloc(t),i=0),yield new Oe().append(u).append(o)}}()}_n.single=(e,t)=>{t=t||{};const r=t.lengthEncoder||Dr;return new Oe([r(e.length),e])};var qr=_n,ni=Or,ai=wn;qr.MIN_POOL_SIZE=ni,qr.DEFAULT_POOL_SIZE=ai;const{Buffer:ii}=Ce,oi=e=>new Proxy({},{get:(t,r)=>r[0]==="l"?e[r]:e.get(parseInt(r))}),kn=e=>{const t=W.decode(ii.isBuffer(e)?e:oi(e));return kn.bytes=W.decode.bytes,t};var Pn=kn;const{Buffer:si}=Ce,In=8,En=1024*1024*4,An=si.alloc(0),be={LENGTH:"readLength",DATA:"readData"},ui={[be.LENGTH]:(e,t,r,n)=>{t=t.append(e);let a;try{a=n.lengthDecoder(t)}catch(i){if(t.length>n.maxLengthLength)throw Object.assign(i,{message:"message length too long",code:"ERR_MSG_LENGTH_TOO_LONG"});if(i instanceof RangeError)return{mode:be.LENGTH,buffer:t};throw i}if(a>n.maxDataLength)throw Object.assign(new Error("message data too long"),{code:"ERR_MSG_DATA_TOO_LONG"});return e=t.shallowSlice(n.lengthDecoder.bytes),t=new Oe,n.onLength&&n.onLength(a),a<=0?(n.onData&&n.onData(An),{mode:be.LENGTH,chunk:e,buffer:t,data:An}):{mode:be.DATA,chunk:e,buffer:t,state:{dataLength:a}}},[be.DATA]:(e,t,r,n)=>{if(t=t.append(e),t.length<r.dataLength)return{mode:be.DATA,buffer:t,state:r};const{dataLength:a}=r,i=t.shallowSlice(0,a);return e=t.length>a?t.shallowSlice(a):null,t=new Oe,n.onData&&n.onData(i),{mode:be.LENGTH,chunk:e,buffer:t,data:i}}};function Mr(e){return e=e||{},e.lengthDecoder=e.lengthDecoder||Pn,e.maxLengthLength=e.maxLengthLength||In,e.maxDataLength=e.maxDataLength||En,t=>async function*(){let r=new Oe,n=be.LENGTH,a;for await(let i of t)for(;i;){const o=ui[n](i,r,a,e);({mode:n,chunk:i,buffer:r,state:a}=o),o.data&&(yield o.data)}if(r.length)throw Object.assign(new Error("unexpected end of input"),{code:"ERR_UNEXPECTED_EOF"})}()}Mr.fromReader=(e,t)=>{t=t||{};let r=1;const n={[Symbol.asyncIterator](){return this},next:async()=>{try{return await e.next(r)}catch(a){if(a.code==="ERR_UNDER_READ")return{done:!0,value:null};throw a}finally{r=1}}};return t.onLength=a=>{r=a},Mr(t)(n)};var Br=Mr,ci=In,li=En;Br.MAX_LENGTH_LENGTH=ci,Br.MAX_DATA_LENGTH=li;const{Buffer:di}=Ce,Tn=(e,t,r)=>(t=t||di.allocUnsafe(4),t.writeInt32BE(e,r),t);Tn.bytes=4;var hi=Tn;const Sn=e=>{if(e.length<4)throw RangeError("Could not decode int32BE");return e.readInt32BE(0)};Sn.bytes=4;var pi=Sn,fi=qr,mi=Br,yi=Dr,gi=Pn,vi=hi,bi=pi,qe={encode:fi,decode:mi,varintEncode:yi,varintDecode:gi,int32BEEncode:vi,int32BEDecode:bi};const{AbortController:xn,AbortSignal:wi}=typeof self!="undefined"?self:typeof window!="undefined"?window:void 0;var tr=xn,_i=wi,ki=xn;tr.AbortSignal=_i,tr.default=ki;var Rn={createCipheriv:(e,t,r)=>{const n=Qt.cipher.createCipher("AES-CTR",H(t,"ascii"));return n.start({iv:H(r,"ascii")}),{update:a=>(n.update(Qt.util.createBuffer(H(a,"ascii"))),Re(n.output.getBytes(),"ascii"))}},createDecipheriv:(e,t,r)=>{const n=Qt.cipher.createDecipher("AES-CTR",H(t,"ascii"));return n.start({iv:H(r,"ascii")}),{update:a=>(n.update(Qt.util.createBuffer(H(a,"ascii"))),Re(n.output.getBytes(),"ascii"))}}};const Cn={16:"aes-128-ctr",32:"aes-256-ctr"};var Pi=function(e){const t=Cn[e.length];if(!t){const r=Object.entries(Cn).map(([n,a])=>`${n} (${a})`).join(" / ");throw L(new Error(`Invalid key length ${e.length} bytes. Must be ${r}`),"ERR_INVALID_KEY_LENGTH")}return t},Ii=async function(e,t){const r=Pi(e),n=Rn.createCipheriv(r,e,t),a=Rn.createDecipheriv(r,e,t),i={async encrypt(o){return n.update(o)},async decrypt(o){return a.update(o)}};return i},Ei={create:Ii};const Dn={sha1:"sha1","sha2-256":"sha256","sha2-512":"sha512"};function Ai(e,t,r,n,a){const i=Dn[a];if(!i){const u=Object.keys(Dn).join(" / ");throw L(new Error(`Hash '${a}' is unknown or not supported. Must be ${u}`),"ERR_UNSUPPORTED_HASH_TYPE")}const o=Ta(e,t,r,n,i);return Sa.encode64(o)}var Ti=Ai,Si=Ei,xi=xa,Ri=Ra,Ci=Ca,Di=Ti,Ur={aes:Si,hmac:xi,keys:Ri,randomBytes:Ci,pbkdf2:Di};async function*Oi(e,t){let r=[];for await(const n of t)r.push(n),r.length===e&&(yield r,r=[]);r.length>0&&(yield r)}function*qi(e,t){let r=[];for(const n of t)r.push(n),r.length===e&&(yield r,r=[]);r.length>0&&(yield r)}function On(e,t){return t===void 0?r=>On(e,r):t[Symbol.asyncIterator]?Oi(e,t):qi(e,t)}function Ae(e){if(typeof e.next=="function")return e;if(typeof e[Symbol.iterator]=="function")return e[Symbol.iterator]();if(typeof e[Symbol.asyncIterator]=="function")return e[Symbol.asyncIterator]();throw new TypeError('"values" does not to conform to any of the iterator or iterable protocols')}function Nr(){let e,t;const r=new Promise((n,a)=>{t=n,e=a});return{promise:r,reject:e,resolve:t}}function Mi(e,t){const r=Ae(t),n=[],a=[];let i=!1,o=!1;function u(){for(;a.length>0&&n.length>0;){const h=a.shift(),{error:v,value:w}=n.shift();v?h.reject(v):h.resolve({done:!1,value:w})}for(;a.length>0&&o;){const{resolve:h}=a.shift();h({done:!0,value:void 0})}}async function d(){if(o)return;if(i)return;if(n.length>=e)return;i=!0;try{const{done:h,value:v}=await r.next();h?o=!0:n.push({value:v})}catch(h){o=!0,n.push({error:h})}u(),i=!1,d()}async function l(){if(n.length>0){const{error:v,value:w}=n.shift();if(v)throw v;return d(),{done:!1,value:w}}if(o)return{done:!0,value:void 0};const h=Nr();return a.push(h),d(),h.promise}const m={next:l,[Symbol.asyncIterator]:()=>m};return m}function*Bi(e,t){const r=[];let n;try{for(const a of t){if(r.push(a),r.length<=e)continue;yield r.shift()}}catch(a){n=a}for(const a of r)yield a;if(n)throw n}function rr(e,t){return t===void 0?r=>rr(e,r):e===0?t:t[Symbol.asyncIterator]?Mi(e,t):Bi(e,t)}async function Ui(e){const t=[];for await(const r of e)t.push(r);return t}function Ni(e){return e[Symbol.asyncIterator]?Ui(e):Array.from(e)}async function*Li(e){for await(const t of e)yield*t}function*ji(e){for(const t of e)yield*t}function Fi(...e){const t=e.find(r=>r[Symbol.asyncIterator]!==void 0);return t?Li(e):ji(e)}async function $i(e){for await(const t of e);}function Ki(e){if(e[Symbol.asyncIterator])return $i(e);for(const t of e);}async function*qn(e,t){for await(const r of t)await e(r)&&(yield r)}function nr(e,t){return t===void 0?r=>qn(e,r):qn(e,t)}async function*Fe(e){for await(const t of e)t&&typeof t!="string"&&(t[Symbol.iterator]||t[Symbol.asyncIterator])?yield*Fe(t):yield t}async function*Mn(e,t){for await(const r of t)yield await e(r)}function ar(e,t){return t===void 0?r=>Mn(e,r):Mn(e,t)}function Bn(e,t){return t===void 0?r=>Bn(e,r):nr(r=>r!=null,Fe(ar(e,t)))}function zi(e,t,r){const n=Ae(r),a=[],i=[];let o=!1,u=!1,d=0,l=null;function m(){for(;i.length>0&&a.length>0;){const{resolve:c}=i.shift(),p=a.shift();c({done:!1,value:p})}for(;i.length>0&&d===0&&o;){const{resolve:c,reject:p}=i.shift();l?(p(l),l=null):c({done:!0,value:void 0})}}async function h(){if(o){m();return}if(u)return;if(d+a.length>=e)return;u=!0,d++;try{const{done:c,value:p}=await n.next();c?(o=!0,d--,m()):v(p)}catch(c){o=!0,d--,l=c,m()}u=!1,h()}async function v(c){try{const p=await t(c);if(p&&p[Symbol.asyncIterator])for await(const f of p)a.push(f);else a.push(p)}catch(p){o=!0,l=p}d--,m(),h()}async function w(){if(a.length===0){const p=Nr();return i.push(p),h(),p.promise}const c=a.shift();return h(),{done:!1,value:c}}const E={next:w,[Symbol.asyncIterator]:()=>E};return E}function ir(e,t,r){return t===void 0?(n,a)=>a?ir(e,n,a):ir(e,n):r===void 0?n=>ir(e,t,n):nr(n=>n!=null,Fe(zi(e,t,r)))}async function Hi(e){return new Promise(t=>{e.once("readable",()=>{t()})})}async function*Gi(e){for(;;){const t=e.read();if(t!==null){yield t;continue}if(e._readableState.ended)break;await Hi(e)}}function Vi(e){return typeof e[Symbol.asyncIterator]=="function"?e:Gi(e)}async function*Qi(...e){const t=new Set(e.map(Ae));for(;t.size>0;)for(const r of t){const n=await r.next();n.done?t.delete(r):yield n.value}}function Un(e,...t){let r=e();for(const n of t)r=n(r);return r}async function*Wi(e,t,r){let n=null;const a=d=>({value:t(d)}),i=async function*(d){for await(const l of d){if(n)return;yield l}},o=Un(()=>r,rr(1),i,ar(a),rr(e-1)),u=Ae(o);for(;;){const{value:d,done:l}=await u.next();if(l)break;try{const m=await d.value;n||(yield m)}catch(m){n=m}}if(n)throw n}function or(e,t,r){return t===void 0?(n,a)=>or(e,n,a):r===void 0?n=>or(e,t,n):e===1?ar(t,r):Wi(e,t,r)}function sr(e,t,r){return t===void 0?(n,a)=>a?sr(e,n,a):sr(e,n):r===void 0?n=>sr(e,t,n):nr(n=>n!=null,Fe(or(e,t,r)))}async function*Yi(...e){const t=e.map(Ae),r=new Set,n=new Map;let a=null,i=null,o=null;const u=h=>{a=h,i&&i(h)},d=h=>{o&&o(h)},l=()=>new Promise((h,v)=>{if(a&&v(a),n.size>0)return h();o=h,i=v}),m=h=>{const v=Promise.resolve(h.next()).then(async({done:w,value:E})=>{w||n.set(h,E),r.delete(v)});r.add(v),v.then(d,u)};for(const h of t)m(h);for(;;){if(r.size===0&&n.size===0)return;await l();for(const[h,v]of n)n.delete(h),yield v,m(h)}}async function Nn(e,t,r){let n=t;for await(const a of r)n=await e(n,a);return n}function Lr(e,t,r){return t===void 0?(n,a)=>a?Nn(e,n,a):Lr(e,n):r===void 0?n=>Lr(e,t,n):Nn(e,t,r)}async function*Ji(e,t){let r=0;for await(const n of t)if(yield await n,r++,r>=e)break}function*Xi(e,t){let r=0;for(const n of t)if(yield n,r++,r>=e)break}function Ln(e,t){return t===void 0?r=>Ln(e,r):t[Symbol.asyncIterator]?Ji(e,t):Xi(e,t)}async function*jn(e,t){for await(const r of t)await e(r),yield r}function Zi(e,t){return t===void 0?r=>jn(e,r):jn(e,t)}function Fn(e,t){let r=e[0]+t[0],n=e[1]+t[1];if(n>=1e9){const a=n%1e9;r+=(n-a)/1e9,n=a}return[r,n]}async function*eo(e,t){const r=t[Symbol.asyncIterator]();let n=[0,0];for(;;){const a=he.hrtime(),{value:i,done:o}=await r.next(),u=he.hrtime(a);if(n=Fn(n,u),e.progress&&e.progress(u,n),o)return e.total&&e.total(n),i;yield i}}function*to(e,t){const r=t[Symbol.iterator]();let n=[0,0];for(;;){const a=he.hrtime(),{value:i,done:o}=r.next(),u=he.hrtime(a);if(n=Fn(n,u),e.progress&&e.progress(u,n),o)return e.total&&e.total(n),i;yield i}}function $n(e={},t){return t===void 0?r=>$n(e,r):t[Symbol.asyncIterator]!==void 0?eo(e,t):to(e,t)}function ro(e,t,r){const n=Ae(r),a=[],i=[];let o=!1,u=!1,d=0,l=null;function m(){for(;i.length>0&&a.length>0;){const{resolve:c}=i.shift(),p=a.shift();c({done:!1,value:p})}for(;i.length>0&&d===0&&o;){const{resolve:c,reject:p}=i.shift();l?(p(l),l=null):c({done:!0,value:void 0})}}async function h(){if(o){m();return}if(u)return;if(d+a.length>=e)return;u=!0,d++;try{const{done:c,value:p}=await n.next();c?(o=!0,d--,m()):v(p)}catch(c){o=!0,d--,l=c,m()}u=!1,h()}async function v(c){try{const p=await t(c);a.push(p)}catch(p){o=!0,l=p}d--,m(),h()}async function w(){if(a.length===0){const p=Nr();return i.push(p),h(),p.promise}const c=a.shift();return h(),{done:!1,value:c}}const E={next:w,[Symbol.asyncIterator]:()=>E};return E}function ur(e,t,r){return t===void 0?(n,a)=>a?ur(e,n,a):ur(e,n):r===void 0?n=>ur(e,t,n):ro(e,t,r)}async function Kn(e,t){let r=null,n=null,a=null;const i=l=>{r=l,n&&n(l)},o=()=>{a&&a()},u=()=>{e.removeListener("error",i),e.removeListener("drain",o)};e.once("error",i);const d=()=>new Promise((l,m)=>{if(r)return m(r);e.once("drain",o),a=l,n=m});for await(const l of t)if(e.write(l)===!1&&await d(),r)break;if(u(),r)throw r}function no(e,t){return t===void 0?r=>Kn(e,r):Kn(e,t)}var ao=Object.freeze({__proto__:null,batch:On,buffer:rr,collect:Ni,concat:Fi,consume:Ki,filter:nr,flatMap:Bn,flatTransform:ir,flatten:Fe,fromStream:Vi,getIterator:Ae,map:ar,merge:Qi,parallelFlatMap:sr,parallelMap:or,parallelMerge:Yi,pipeline:Un,reduce:Lr,take:Ln,tap:Zi,time:$n,transform:ur,writeToStream:no}),zn=function(e){if(!e)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,r=Object.create(null),n=Object.create(null);function a(i,o){r[i]=o,t++,t>=e&&(t=0,n=r,r=Object.create(null))}return{has:function(i){return r[i]!==void 0||n[i]!==void 0},remove:function(i){r[i]!==void 0&&(r[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=r[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return a(i,o),o},set:function(i,o){r[i]!==void 0?r[i]=o:a(i,o)},clear:function(){r=Object.create(null),n=Object.create(null)}}},Hn=Oa(ao),io=(e,t)=>(t=t||(()=>{}),e.then(r=>new Promise(n=>{n(t())}).then(()=>r),r=>new Promise(n=>{n(t())}).then(()=>{throw r})));class Gn extends Error{constructor(e){super(e);this.name="TimeoutError"}}const Vn=(e,t,r)=>new Promise((n,a)=>{if(typeof t!="number"||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===Infinity){n(e);return}const i=setTimeout(()=>{if(typeof r=="function"){try{n(r())}catch(d){a(d)}return}const o=typeof r=="string"?r:`Promise timed out after ${t} milliseconds`,u=r instanceof Error?r:new Gn(o);typeof e.cancel=="function"&&e.cancel(),a(u)},t);io(e.then(n,a),()=>{clearTimeout(i)})});var fe=Vn,oo=Vn,so=Gn;fe.default=oo,fe.TimeoutError=so;var me=G(function(e){/**
 * [js-sha3]{@link https://github.com/emn178/js-sha3}
 *
 * @version 0.8.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2015-2018
 * @license MIT
 */(function(){var t="input is invalid type",r="finalize already called",n=typeof window=="object",a=n?window:{};a.JS_SHA3_NO_WINDOW&&(n=!1);var i=!n&&typeof self=="object",o=!a.JS_SHA3_NO_NODE_JS&&typeof he=="object"&&he.versions&&he.versions.node;o?a=Yr:i&&(a=self);var u=!a.JS_SHA3_NO_COMMON_JS&&!0&&e.exports,d=!a.JS_SHA3_NO_ARRAY_BUFFER&&typeof ArrayBuffer!="undefined",l="0123456789abcdef".split(""),m=[31,7936,2031616,520093696],h=[4,1024,262144,67108864],v=[1,256,65536,16777216],w=[6,1536,393216,100663296],E=[0,8,16,24],c=[1,0,32898,0,32906,2147483648,2147516416,2147483648,32907,0,2147483649,0,2147516545,2147483648,32777,2147483648,138,0,136,0,2147516425,0,2147483658,0,2147516555,0,139,2147483648,32905,2147483648,32771,2147483648,32770,2147483648,128,2147483648,32778,0,2147483658,2147483648,2147516545,2147483648,32896,2147483648,2147483649,0,2147516424,2147483648],p=[224,256,384,512],f=[128,256],P=["hex","buffer","arrayBuffer","array","digest"],y={"128":168,"256":136};(a.JS_SHA3_NO_NODE_JS||!Array.isArray)&&(Array.isArray=function(s){return Object.prototype.toString.call(s)==="[object Array]"}),d&&(a.JS_SHA3_NO_ARRAY_BUFFER_IS_VIEW||!ArrayBuffer.isView)&&(ArrayBuffer.isView=function(s){return typeof s=="object"&&s.buffer&&s.buffer.constructor===ArrayBuffer});for(var b=function(s,k,I){return function(T){return new K(s,k,s).update(T)[I]()}},g=function(s,k,I){return function(T,x){return new K(s,k,x).update(T)[I]()}},_=function(s,k,I){return function(T,x,D,q){return ne["cshake"+s].update(T,x,D,q)[I]()}},A=function(s,k,I){return function(T,x,D,q){return ne["kmac"+s].update(T,x,D,q)[I]()}},R=function(s,k,I,T){for(var x=0;x<P.length;++x){var D=P[x];s[D]=k(I,T,D)}return s},S=function(s,k){var I=b(s,k,"hex");return I.create=function(){return new K(s,k,s)},I.update=function(T){return I.create().update(T)},R(I,b,s,k)},U=function(s,k){var I=g(s,k,"hex");return I.create=function(T){return new K(s,k,T)},I.update=function(T,x){return I.create(x).update(T)},R(I,g,s,k)},Q=function(s,k){var I=y[s],T=_(s,k,"hex");return T.create=function(x,D,q){return!D&&!q?ne["shake"+s].create(x):new K(s,k,x).bytepad([D,q],I)},T.update=function(x,D,q,C){return T.create(D,q,C).update(x)},R(T,_,s,k)},ae=function(s,k){var I=y[s],T=A(s,k,"hex");return T.create=function(x,D,q){return new br(s,k,D).bytepad(["KMAC",q],I).bytepad([x],I)},T.update=function(x,D,q,C){return T.create(x,q,C).update(D)},R(T,A,s,k)},ue=[{name:"keccak",padding:v,bits:p,createMethod:S},{name:"sha3",padding:w,bits:p,createMethod:S},{name:"shake",padding:m,bits:f,createMethod:U},{name:"cshake",padding:h,bits:f,createMethod:Q},{name:"kmac",padding:h,bits:f,createMethod:ae}],ne={},N=[],ge=0;ge<ue.length;++ge)for(var xe=ue[ge],Ve=xe.bits,Ue=0;Ue<Ve.length;++Ue){var vr=xe.name+"_"+Ve[Ue];if(N.push(vr),ne[vr]=xe.createMethod(Ve[Ue],xe.padding),xe.name!=="sha3"){var Vr=xe.name+Ve[Ue];N.push(Vr),ne[Vr]=ne[vr]}}function K(s,k,I){this.blocks=[],this.s=[],this.padding=k,this.outputBits=I,this.reset=!0,this.finalized=!1,this.block=0,this.start=0,this.blockCount=1600-(s<<1)>>5,this.byteCount=this.blockCount<<2,this.outputBlocks=I>>5,this.extraBytes=(I&31)>>3;for(var T=0;T<50;++T)this.s[T]=0}K.prototype.update=function(s){if(this.finalized)throw new Error(r);var k,I=typeof s;if(I!=="string"){if(I==="object"){if(s===null)throw new Error(t);if(d&&s.constructor===ArrayBuffer)s=new Uint8Array(s);else if(!Array.isArray(s)&&(!d||!ArrayBuffer.isView(s)))throw new Error(t)}else throw new Error(t);k=!0}for(var T=this.blocks,x=this.byteCount,D=s.length,q=this.blockCount,C=0,z=this.s,M,$;C<D;){if(this.reset)for(this.reset=!1,T[0]=this.block,M=1;M<q+1;++M)T[M]=0;if(k)for(M=this.start;C<D&&M<x;++C)T[M>>2]|=s[C]<<E[M++&3];else for(M=this.start;C<D&&M<x;++C)$=s.charCodeAt(C),$<128?T[M>>2]|=$<<E[M++&3]:$<2048?(T[M>>2]|=(192|$>>6)<<E[M++&3],T[M>>2]|=(128|$&63)<<E[M++&3]):$<55296||$>=57344?(T[M>>2]|=(224|$>>12)<<E[M++&3],T[M>>2]|=(128|$>>6&63)<<E[M++&3],T[M>>2]|=(128|$&63)<<E[M++&3]):($=65536+(($&1023)<<10|s.charCodeAt(++C)&1023),T[M>>2]|=(240|$>>18)<<E[M++&3],T[M>>2]|=(128|$>>12&63)<<E[M++&3],T[M>>2]|=(128|$>>6&63)<<E[M++&3],T[M>>2]|=(128|$&63)<<E[M++&3]);if(this.lastByteIndex=M,M>=x){for(this.start=M-x,this.block=T[q],M=0;M<q;++M)z[M]^=T[M];Ne(z),this.reset=!0}else this.start=M}return this},K.prototype.encode=function(s,k){var I=s&255,T=1,x=[I];for(s=s>>8,I=s&255;I>0;)x.unshift(I),s=s>>8,I=s&255,++T;return k?x.push(T):x.unshift(T),this.update(x),x.length},K.prototype.encodeString=function(s){var k,I=typeof s;if(I!=="string"){if(I==="object"){if(s===null)throw new Error(t);if(d&&s.constructor===ArrayBuffer)s=new Uint8Array(s);else if(!Array.isArray(s)&&(!d||!ArrayBuffer.isView(s)))throw new Error(t)}else throw new Error(t);k=!0}var T=0,x=s.length;if(k)T=x;else for(var D=0;D<s.length;++D){var q=s.charCodeAt(D);q<128?T+=1:q<2048?T+=2:q<55296||q>=57344?T+=3:(q=65536+((q&1023)<<10|s.charCodeAt(++D)&1023),T+=4)}return T+=this.encode(T*8),this.update(s),T},K.prototype.bytepad=function(s,k){for(var I=this.encode(k),T=0;T<s.length;++T)I+=this.encodeString(s[T]);var x=k-I%k,D=[];return D.length=x,this.update(D),this},K.prototype.finalize=function(){if(this.finalized)return;this.finalized=!0;var s=this.blocks,k=this.lastByteIndex,I=this.blockCount,T=this.s;if(s[k>>2]|=this.padding[k&3],this.lastByteIndex===this.byteCount)for(s[0]=s[I],k=1;k<I+1;++k)s[k]=0;for(s[I-1]|=2147483648,k=0;k<I;++k)T[k]^=s[k];Ne(T)},K.prototype.toString=K.prototype.hex=function(){this.finalize();for(var s=this.blockCount,k=this.s,I=this.outputBlocks,T=this.extraBytes,x=0,D=0,q="",C;D<I;){for(x=0;x<s&&D<I;++x,++D)C=k[x],q+=l[C>>4&15]+l[C&15]+l[C>>12&15]+l[C>>8&15]+l[C>>20&15]+l[C>>16&15]+l[C>>28&15]+l[C>>24&15];D%s===0&&(Ne(k),x=0)}return T&&(C=k[x],q+=l[C>>4&15]+l[C&15],T>1&&(q+=l[C>>12&15]+l[C>>8&15]),T>2&&(q+=l[C>>20&15]+l[C>>16&15])),q},K.prototype.arrayBuffer=function(){this.finalize();var s=this.blockCount,k=this.s,I=this.outputBlocks,T=this.extraBytes,x=0,D=0,q=this.outputBits>>3,C;T?C=new ArrayBuffer(I+1<<2):C=new ArrayBuffer(q);for(var z=new Uint32Array(C);D<I;){for(x=0;x<s&&D<I;++x,++D)z[D]=k[x];D%s===0&&Ne(k)}return T&&(z[x]=k[x],C=C.slice(0,q)),C},K.prototype.buffer=K.prototype.arrayBuffer,K.prototype.digest=K.prototype.array=function(){this.finalize();for(var s=this.blockCount,k=this.s,I=this.outputBlocks,T=this.extraBytes,x=0,D=0,q=[],C,z;D<I;){for(x=0;x<s&&D<I;++x,++D)C=D<<2,z=k[x],q[C]=z&255,q[C+1]=z>>8&255,q[C+2]=z>>16&255,q[C+3]=z>>24&255;D%s===0&&Ne(k)}return T&&(C=D<<2,z=k[x],q[C]=z&255,T>1&&(q[C+1]=z>>8&255),T>2&&(q[C+2]=z>>16&255)),q};function br(s,k,I){K.call(this,s,k,I)}br.prototype=new K,br.prototype.finalize=function(){return this.encode(this.outputBits,!0),K.prototype.finalize.call(this)};var Ne=function(s){var k,I,T,x,D,q,C,z,M,$,Qe,We,Ye,Je,Xe,Ze,et,tt,rt,nt,at,it,ot,st,ut,ct,lt,dt,ht,pt,ft,mt,yt,gt,vt,bt,wt,_t,kt,Pt,It,Et,At,Tt,St,xt,Rt,Ct,Dt,Ot,qt,Mt,Bt,Ut,Nt,Lt,jt,Ft,$t,Kt,zt,Ht,Gt;for(T=0;T<48;T+=2)x=s[0]^s[10]^s[20]^s[30]^s[40],D=s[1]^s[11]^s[21]^s[31]^s[41],q=s[2]^s[12]^s[22]^s[32]^s[42],C=s[3]^s[13]^s[23]^s[33]^s[43],z=s[4]^s[14]^s[24]^s[34]^s[44],M=s[5]^s[15]^s[25]^s[35]^s[45],$=s[6]^s[16]^s[26]^s[36]^s[46],Qe=s[7]^s[17]^s[27]^s[37]^s[47],We=s[8]^s[18]^s[28]^s[38]^s[48],Ye=s[9]^s[19]^s[29]^s[39]^s[49],k=We^(q<<1|C>>>31),I=Ye^(C<<1|q>>>31),s[0]^=k,s[1]^=I,s[10]^=k,s[11]^=I,s[20]^=k,s[21]^=I,s[30]^=k,s[31]^=I,s[40]^=k,s[41]^=I,k=x^(z<<1|M>>>31),I=D^(M<<1|z>>>31),s[2]^=k,s[3]^=I,s[12]^=k,s[13]^=I,s[22]^=k,s[23]^=I,s[32]^=k,s[33]^=I,s[42]^=k,s[43]^=I,k=q^($<<1|Qe>>>31),I=C^(Qe<<1|$>>>31),s[4]^=k,s[5]^=I,s[14]^=k,s[15]^=I,s[24]^=k,s[25]^=I,s[34]^=k,s[35]^=I,s[44]^=k,s[45]^=I,k=z^(We<<1|Ye>>>31),I=M^(Ye<<1|We>>>31),s[6]^=k,s[7]^=I,s[16]^=k,s[17]^=I,s[26]^=k,s[27]^=I,s[36]^=k,s[37]^=I,s[46]^=k,s[47]^=I,k=$^(x<<1|D>>>31),I=Qe^(D<<1|x>>>31),s[8]^=k,s[9]^=I,s[18]^=k,s[19]^=I,s[28]^=k,s[29]^=I,s[38]^=k,s[39]^=I,s[48]^=k,s[49]^=I,Je=s[0],Xe=s[1],xt=s[11]<<4|s[10]>>>28,Rt=s[10]<<4|s[11]>>>28,dt=s[20]<<3|s[21]>>>29,ht=s[21]<<3|s[20]>>>29,Kt=s[31]<<9|s[30]>>>23,zt=s[30]<<9|s[31]>>>23,Et=s[40]<<18|s[41]>>>14,At=s[41]<<18|s[40]>>>14,gt=s[2]<<1|s[3]>>>31,vt=s[3]<<1|s[2]>>>31,Ze=s[13]<<12|s[12]>>>20,et=s[12]<<12|s[13]>>>20,Ct=s[22]<<10|s[23]>>>22,Dt=s[23]<<10|s[22]>>>22,pt=s[33]<<13|s[32]>>>19,ft=s[32]<<13|s[33]>>>19,Ht=s[42]<<2|s[43]>>>30,Gt=s[43]<<2|s[42]>>>30,Ut=s[5]<<30|s[4]>>>2,Nt=s[4]<<30|s[5]>>>2,bt=s[14]<<6|s[15]>>>26,wt=s[15]<<6|s[14]>>>26,tt=s[25]<<11|s[24]>>>21,rt=s[24]<<11|s[25]>>>21,Ot=s[34]<<15|s[35]>>>17,qt=s[35]<<15|s[34]>>>17,mt=s[45]<<29|s[44]>>>3,yt=s[44]<<29|s[45]>>>3,st=s[6]<<28|s[7]>>>4,ut=s[7]<<28|s[6]>>>4,Lt=s[17]<<23|s[16]>>>9,jt=s[16]<<23|s[17]>>>9,_t=s[26]<<25|s[27]>>>7,kt=s[27]<<25|s[26]>>>7,nt=s[36]<<21|s[37]>>>11,at=s[37]<<21|s[36]>>>11,Mt=s[47]<<24|s[46]>>>8,Bt=s[46]<<24|s[47]>>>8,Tt=s[8]<<27|s[9]>>>5,St=s[9]<<27|s[8]>>>5,ct=s[18]<<20|s[19]>>>12,lt=s[19]<<20|s[18]>>>12,Ft=s[29]<<7|s[28]>>>25,$t=s[28]<<7|s[29]>>>25,Pt=s[38]<<8|s[39]>>>24,It=s[39]<<8|s[38]>>>24,it=s[48]<<14|s[49]>>>18,ot=s[49]<<14|s[48]>>>18,s[0]=Je^~Ze&tt,s[1]=Xe^~et&rt,s[10]=st^~ct&dt,s[11]=ut^~lt&ht,s[20]=gt^~bt&_t,s[21]=vt^~wt&kt,s[30]=Tt^~xt&Ct,s[31]=St^~Rt&Dt,s[40]=Ut^~Lt&Ft,s[41]=Nt^~jt&$t,s[2]=Ze^~tt&nt,s[3]=et^~rt&at,s[12]=ct^~dt&pt,s[13]=lt^~ht&ft,s[22]=bt^~_t&Pt,s[23]=wt^~kt&It,s[32]=xt^~Ct&Ot,s[33]=Rt^~Dt&qt,s[42]=Lt^~Ft&Kt,s[43]=jt^~$t&zt,s[4]=tt^~nt&it,s[5]=rt^~at&ot,s[14]=dt^~pt&mt,s[15]=ht^~ft&yt,s[24]=_t^~Pt&Et,s[25]=kt^~It&At,s[34]=Ct^~Ot&Mt,s[35]=Dt^~qt&Bt,s[44]=Ft^~Kt&Ht,s[45]=$t^~zt&Gt,s[6]=nt^~it&Je,s[7]=at^~ot&Xe,s[16]=pt^~mt&st,s[17]=ft^~yt&ut,s[26]=Pt^~Et&gt,s[27]=It^~At&vt,s[36]=Ot^~Mt&Tt,s[37]=qt^~Bt&St,s[46]=Kt^~Ht&Ut,s[47]=zt^~Gt&Nt,s[8]=it^~Je&Ze,s[9]=ot^~Xe&et,s[18]=mt^~st&ct,s[19]=yt^~ut&lt,s[28]=Et^~gt&bt,s[29]=At^~vt&wt,s[38]=Mt^~Tt&xt,s[39]=Bt^~St&Rt,s[48]=Ht^~Ut&Lt,s[49]=Gt^~Nt&jt,s[0]^=c[T],s[1]^=c[T+1]};if(u)e.exports=ne;else for(ge=0;ge<N.length;++ge)a[N[ge]]=ne[N[ge]]})()}),uo=G(function(e,t){(function(r,n){var a={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function i(c){if(!Array.isArray(c)&&!ArrayBuffer.isView(c))return!1;for(var p=0;p<c.length;p++)if(!Number.isInteger(c[p])||c[p]<0||c[p]>255)return!1;return!0}function o(c,p){return(c&65535)*p+(((c>>>16)*p&65535)<<16)}function u(c,p){return c<<p|c>>>32-p}function d(c){return c^=c>>>16,c=o(c,2246822507),c^=c>>>13,c=o(c,3266489909),c^=c>>>16,c}function l(c,p){c=[c[0]>>>16,c[0]&65535,c[1]>>>16,c[1]&65535],p=[p[0]>>>16,p[0]&65535,p[1]>>>16,p[1]&65535];var f=[0,0,0,0];return f[3]+=c[3]+p[3],f[2]+=f[3]>>>16,f[3]&=65535,f[2]+=c[2]+p[2],f[1]+=f[2]>>>16,f[2]&=65535,f[1]+=c[1]+p[1],f[0]+=f[1]>>>16,f[1]&=65535,f[0]+=c[0]+p[0],f[0]&=65535,[f[0]<<16|f[1],f[2]<<16|f[3]]}function m(c,p){c=[c[0]>>>16,c[0]&65535,c[1]>>>16,c[1]&65535],p=[p[0]>>>16,p[0]&65535,p[1]>>>16,p[1]&65535];var f=[0,0,0,0];return f[3]+=c[3]*p[3],f[2]+=f[3]>>>16,f[3]&=65535,f[2]+=c[2]*p[3],f[1]+=f[2]>>>16,f[2]&=65535,f[2]+=c[3]*p[2],f[1]+=f[2]>>>16,f[2]&=65535,f[1]+=c[1]*p[3],f[0]+=f[1]>>>16,f[1]&=65535,f[1]+=c[2]*p[2],f[0]+=f[1]>>>16,f[1]&=65535,f[1]+=c[3]*p[1],f[0]+=f[1]>>>16,f[1]&=65535,f[0]+=c[0]*p[3]+c[1]*p[2]+c[2]*p[1]+c[3]*p[0],f[0]&=65535,[f[0]<<16|f[1],f[2]<<16|f[3]]}function h(c,p){return p%=64,p===32?[c[1],c[0]]:p<32?[c[0]<<p|c[1]>>>32-p,c[1]<<p|c[0]>>>32-p]:(p-=32,[c[1]<<p|c[0]>>>32-p,c[0]<<p|c[1]>>>32-p])}function v(c,p){return p%=64,p===0?c:p<32?[c[0]<<p|c[1]>>>32-p,c[1]<<p]:[c[1]<<p-32,0]}function w(c,p){return[c[0]^p[0],c[1]^p[1]]}function E(c){return c=w(c,[0,c[0]>>>1]),c=m(c,[4283543511,3981806797]),c=w(c,[0,c[0]>>>1]),c=m(c,[3301882366,444984403]),c=w(c,[0,c[0]>>>1]),c}a.x86.hash32=function(c,p){if(a.inputValidation&&!i(c))return n;p=p||0;for(var f=c.length%4,P=c.length-f,y=p,b=0,g=3432918353,_=461845907,A=0;A<P;A=A+4)b=c[A]|c[A+1]<<8|c[A+2]<<16|c[A+3]<<24,b=o(b,g),b=u(b,15),b=o(b,_),y^=b,y=u(y,13),y=o(y,5)+3864292196;b=0;switch(f){case 3:b^=c[A+2]<<16;case 2:b^=c[A+1]<<8;case 1:b^=c[A],b=o(b,g),b=u(b,15),b=o(b,_),y^=b}return y^=c.length,y=d(y),y>>>0},a.x86.hash128=function(c,p){if(a.inputValidation&&!i(c))return n;p=p||0;for(var f=c.length%16,P=c.length-f,y=p,b=p,g=p,_=p,A=0,R=0,S=0,U=0,Q=597399067,ae=2869860233,ue=951274213,ne=2716044179,N=0;N<P;N=N+16)A=c[N]|c[N+1]<<8|c[N+2]<<16|c[N+3]<<24,R=c[N+4]|c[N+5]<<8|c[N+6]<<16|c[N+7]<<24,S=c[N+8]|c[N+9]<<8|c[N+10]<<16|c[N+11]<<24,U=c[N+12]|c[N+13]<<8|c[N+14]<<16|c[N+15]<<24,A=o(A,Q),A=u(A,15),A=o(A,ae),y^=A,y=u(y,19),y+=b,y=o(y,5)+1444728091,R=o(R,ae),R=u(R,16),R=o(R,ue),b^=R,b=u(b,17),b+=g,b=o(b,5)+197830471,S=o(S,ue),S=u(S,17),S=o(S,ne),g^=S,g=u(g,15),g+=_,g=o(g,5)+2530024501,U=o(U,ne),U=u(U,18),U=o(U,Q),_^=U,_=u(_,13),_+=y,_=o(_,5)+850148119;A=0,R=0,S=0,U=0;switch(f){case 15:U^=c[N+14]<<16;case 14:U^=c[N+13]<<8;case 13:U^=c[N+12],U=o(U,ne),U=u(U,18),U=o(U,Q),_^=U;case 12:S^=c[N+11]<<24;case 11:S^=c[N+10]<<16;case 10:S^=c[N+9]<<8;case 9:S^=c[N+8],S=o(S,ue),S=u(S,17),S=o(S,ne),g^=S;case 8:R^=c[N+7]<<24;case 7:R^=c[N+6]<<16;case 6:R^=c[N+5]<<8;case 5:R^=c[N+4],R=o(R,ae),R=u(R,16),R=o(R,ue),b^=R;case 4:A^=c[N+3]<<24;case 3:A^=c[N+2]<<16;case 2:A^=c[N+1]<<8;case 1:A^=c[N],A=o(A,Q),A=u(A,15),A=o(A,ae),y^=A}return y^=c.length,b^=c.length,g^=c.length,_^=c.length,y+=b,y+=g,y+=_,b+=y,g+=y,_+=y,y=d(y),b=d(b),g=d(g),_=d(_),y+=b,y+=g,y+=_,b+=y,g+=y,_+=y,("00000000"+(y>>>0).toString(16)).slice(-8)+("00000000"+(b>>>0).toString(16)).slice(-8)+("00000000"+(g>>>0).toString(16)).slice(-8)+("00000000"+(_>>>0).toString(16)).slice(-8)},a.x64.hash128=function(c,p){if(a.inputValidation&&!i(c))return n;p=p||0;for(var f=c.length%16,P=c.length-f,y=[0,p],b=[0,p],g=[0,0],_=[0,0],A=[2277735313,289559509],R=[1291169091,658871167],S=0;S<P;S=S+16)g=[c[S+4]|c[S+5]<<8|c[S+6]<<16|c[S+7]<<24,c[S]|c[S+1]<<8|c[S+2]<<16|c[S+3]<<24],_=[c[S+12]|c[S+13]<<8|c[S+14]<<16|c[S+15]<<24,c[S+8]|c[S+9]<<8|c[S+10]<<16|c[S+11]<<24],g=m(g,A),g=h(g,31),g=m(g,R),y=w(y,g),y=h(y,27),y=l(y,b),y=l(m(y,[0,5]),[0,1390208809]),_=m(_,R),_=h(_,33),_=m(_,A),b=w(b,_),b=h(b,31),b=l(b,y),b=l(m(b,[0,5]),[0,944331445]);g=[0,0],_=[0,0];switch(f){case 15:_=w(_,v([0,c[S+14]],48));case 14:_=w(_,v([0,c[S+13]],40));case 13:_=w(_,v([0,c[S+12]],32));case 12:_=w(_,v([0,c[S+11]],24));case 11:_=w(_,v([0,c[S+10]],16));case 10:_=w(_,v([0,c[S+9]],8));case 9:_=w(_,[0,c[S+8]]),_=m(_,R),_=h(_,33),_=m(_,A),b=w(b,_);case 8:g=w(g,v([0,c[S+7]],56));case 7:g=w(g,v([0,c[S+6]],48));case 6:g=w(g,v([0,c[S+5]],40));case 5:g=w(g,v([0,c[S+4]],32));case 4:g=w(g,v([0,c[S+3]],24));case 3:g=w(g,v([0,c[S+2]],16));case 2:g=w(g,v([0,c[S+1]],8));case 1:g=w(g,[0,c[S]]),g=m(g,A),g=h(g,31),g=m(g,R),y=w(y,g)}return y=w(y,[0,c.length]),b=w(b,[0,c.length]),y=l(y,b),b=l(b,y),y=E(y),b=E(b),y=l(y,b),b=l(b,y),("00000000"+(y[0]>>>0).toString(16)).slice(-8)+("00000000"+(y[1]>>>0).toString(16)).slice(-8)+("00000000"+(b[0]>>>0).toString(16)).slice(-8)+("00000000"+(b[1]>>>0).toString(16)).slice(-8)},e.exports&&(t=e.exports=a),t.murmurHash3=a})()}),Qn=uo;const co=e=>{const t=new Uint8Array(4);for(let r=0;r<4;r++)t[r]=e&255,e=e>>8;return t};var lo={fromNumberTo32BitBuf:co},ho="Input must be an string, Buffer or Uint8Array";function po(e){var t;if(e instanceof Uint8Array)t=e;else if(e instanceof Buffer)t=new Uint8Array(e);else if(typeof e=="string")t=new Uint8Array(Buffer.from(e,"utf8"));else throw new Error(ho);return t}function fo(e){return Array.prototype.map.call(e,function(t){return(t<16?"0":"")+t.toString(16)}).join("")}function cr(e){return(4294967296+e).toString(16).substring(1)}function mo(e,t,r){for(var n=`
`+e+" = ",a=0;a<t.length;a+=2){if(r===32)n+=cr(t[a]).toUpperCase(),n+=" ",n+=cr(t[a+1]).toUpperCase();else if(r===64)n+=cr(t[a+1]).toUpperCase(),n+=cr(t[a]).toUpperCase();else throw new Error("Invalid size "+r);a%6===4?n+=`
`+new Array(e.length+4).join(" "):a<t.length-2&&(n+=" ")}console.log(n)}function yo(e,t,r){for(var n=new Date().getTime(),a=new Uint8Array(t),i=0;i<t;i++)a[i]=i%256;var o=new Date().getTime();for(console.log("Generated random input in "+(o-n)+"ms"),n=o,i=0;i<r;i++){var u=e(a),d=new Date().getTime(),l=d-n;n=d,console.log("Hashed in "+l+"ms: "+u.substring(0,20)+"..."),console.log(Math.round(t/(1<<20)/(l/1e3)*100)/100+" MB PER SECOND")}}var lr={normalizeInput:po,toHex:fo,debugPrint:mo,testSpeed:yo};function dr(e,t,r){var n=e[t]+e[r],a=e[t+1]+e[r+1];n>=4294967296&&a++,e[t]=n,e[t+1]=a}function Wn(e,t,r,n){var a=e[t]+r;r<0&&(a+=4294967296);var i=e[t+1]+n;a>=4294967296&&i++,e[t]=a,e[t+1]=i}function go(e,t){return e[t]^e[t+1]<<8^e[t+2]<<16^e[t+3]<<24}function we(e,t,r,n,a,i){var o=$e[a],u=$e[a+1],d=$e[i],l=$e[i+1];dr(B,e,t),Wn(B,e,o,u);var m=B[n]^B[e],h=B[n+1]^B[e+1];B[n]=h,B[n+1]=m,dr(B,r,n),m=B[t]^B[r],h=B[t+1]^B[r+1],B[t]=m>>>24^h<<8,B[t+1]=h>>>24^m<<8,dr(B,e,t),Wn(B,e,d,l),m=B[n]^B[e],h=B[n+1]^B[e+1],B[n]=m>>>16^h<<16,B[n+1]=h>>>16^m<<16,dr(B,r,n),m=B[t]^B[r],h=B[t+1]^B[r+1],B[t]=h>>>31^m<<1,B[t+1]=m>>>31^h<<1}var Yn=new Uint32Array([4089235720,1779033703,2227873595,3144134277,4271175723,1013904242,1595750129,2773480762,2917565137,1359893119,725511199,2600822924,4215389547,528734635,327033209,1541459225]),vo=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3],ee=new Uint8Array(vo.map(function(e){return e*2})),B=new Uint32Array(32),$e=new Uint32Array(32);function Jn(e,t){var r=0;for(r=0;r<16;r++)B[r]=e.h[r],B[r+16]=Yn[r];for(B[24]=B[24]^e.t,B[25]=B[25]^e.t/4294967296,t&&(B[28]=~B[28],B[29]=~B[29]),r=0;r<32;r++)$e[r]=go(e.b,4*r);for(r=0;r<12;r++)we(0,8,16,24,ee[r*16+0],ee[r*16+1]),we(2,10,18,26,ee[r*16+2],ee[r*16+3]),we(4,12,20,28,ee[r*16+4],ee[r*16+5]),we(6,14,22,30,ee[r*16+6],ee[r*16+7]),we(0,10,20,30,ee[r*16+8],ee[r*16+9]),we(2,12,22,24,ee[r*16+10],ee[r*16+11]),we(4,14,16,26,ee[r*16+12],ee[r*16+13]),we(6,8,18,28,ee[r*16+14],ee[r*16+15]);for(r=0;r<16;r++)e.h[r]=e.h[r]^B[r]^B[r+16]}function Xn(e,t){if(e===0||e>64)throw new Error("Illegal output length, expected 0 < length <= 64");if(t&&t.length>64)throw new Error("Illegal key, expected Uint8Array with 0 < length <= 64");for(var r={b:new Uint8Array(128),h:new Uint32Array(16),t:0,c:0,outlen:e},n=0;n<16;n++)r.h[n]=Yn[n];var a=t?t.length:0;return r.h[0]^=16842752^a<<8^e,t&&(jr(r,t),r.c=128),r}function jr(e,t){for(var r=0;r<t.length;r++)e.c===128&&(e.t+=e.c,Jn(e,!1),e.c=0),e.b[e.c++]=t[r]}function Zn(e){for(e.t+=e.c;e.c<128;)e.b[e.c++]=0;Jn(e,!0);for(var t=new Uint8Array(e.outlen),r=0;r<e.outlen;r++)t[r]=e.h[r>>2]>>8*(r&3);return t}function ea(e,t,r){r=r||64,e=lr.normalizeInput(e);var n=Xn(r,t);return jr(n,e),Zn(n)}function bo(e,t,r){var n=ea(e,t,r);return lr.toHex(n)}var Ke={blake2b:ea,blake2bHex:bo,blake2bInit:Xn,blake2bUpdate:jr,blake2bFinal:Zn};function wo(e,t){return e[t]^e[t+1]<<8^e[t+2]<<16^e[t+3]<<24}function _e(e,t,r,n,a,i){j[e]=j[e]+j[t]+a,j[n]=hr(j[n]^j[e],16),j[r]=j[r]+j[n],j[t]=hr(j[t]^j[r],12),j[e]=j[e]+j[t]+i,j[n]=hr(j[n]^j[e],8),j[r]=j[r]+j[n],j[t]=hr(j[t]^j[r],7)}function hr(e,t){return e>>>t^e<<32-t}var ta=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),te=new Uint8Array([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0]),j=new Uint32Array(16),Z=new Uint32Array(16);function ra(e,t){var r=0;for(r=0;r<8;r++)j[r]=e.h[r],j[r+8]=ta[r];for(j[12]^=e.t,j[13]^=e.t/4294967296,t&&(j[14]=~j[14]),r=0;r<16;r++)Z[r]=wo(e.b,4*r);for(r=0;r<10;r++)_e(0,4,8,12,Z[te[r*16+0]],Z[te[r*16+1]]),_e(1,5,9,13,Z[te[r*16+2]],Z[te[r*16+3]]),_e(2,6,10,14,Z[te[r*16+4]],Z[te[r*16+5]]),_e(3,7,11,15,Z[te[r*16+6]],Z[te[r*16+7]]),_e(0,5,10,15,Z[te[r*16+8]],Z[te[r*16+9]]),_e(1,6,11,12,Z[te[r*16+10]],Z[te[r*16+11]]),_e(2,7,8,13,Z[te[r*16+12]],Z[te[r*16+13]]),_e(3,4,9,14,Z[te[r*16+14]],Z[te[r*16+15]]);for(r=0;r<8;r++)e.h[r]^=j[r]^j[r+8]}function na(e,t){if(!(e>0&&e<=32))throw new Error("Incorrect output length, should be in [1, 32]");var r=t?t.length:0;if(t&&!(r>0&&r<=32))throw new Error("Incorrect key length, should be in [1, 32]");var n={h:new Uint32Array(ta),b:new Uint32Array(64),c:0,t:0,outlen:e};return n.h[0]^=16842752^r<<8^e,r>0&&(Fr(n,t),n.c=64),n}function Fr(e,t){for(var r=0;r<t.length;r++)e.c===64&&(e.t+=e.c,ra(e,!1),e.c=0),e.b[e.c++]=t[r]}function aa(e){for(e.t+=e.c;e.c<64;)e.b[e.c++]=0;ra(e,!0);for(var t=new Uint8Array(e.outlen),r=0;r<e.outlen;r++)t[r]=e.h[r>>2]>>8*(r&3)&255;return t}function ia(e,t,r){r=r||32,e=lr.normalizeInput(e);var n=na(r,t);return Fr(n,e),aa(n)}function _o(e,t,r){var n=ia(e,t,r);return lr.toHex(n)}var ze={blake2s:ia,blake2sHex:_o,blake2sInit:na,blake2sUpdate:Fr,blake2sFinal:aa},Me={blake2b:Ke.blake2b,blake2bHex:Ke.blake2bHex,blake2bInit:Ke.blake2bInit,blake2bUpdate:Ke.blake2bUpdate,blake2bFinal:Ke.blake2bFinal,blake2s:ze.blake2s,blake2sHex:ze.blake2sHex,blake2sInit:ze.blake2sInit,blake2sUpdate:ze.blake2sUpdate,blake2sFinal:ze.blake2sFinal};const ko=45569,Po=45633,Io={init:Me.blake2bInit,update:Me.blake2bUpdate,digest:Me.blake2bFinal},Eo={init:Me.blake2sInit,update:Me.blake2sUpdate,digest:Me.blake2sFinal},oa=(e,t)=>async r=>{const n=t.init(e,null);return t.update(n,r),t.digest(n)};var Ao=e=>{for(let t=0;t<64;t++)e[ko+t]=oa(t+1,Io);for(let t=0;t<32;t++)e[Po+t]=oa(t+1,Eo)};const{factory:pr}=Da,{fromNumberTo32BitBuf:To}=lo,oe=e=>async t=>{switch(e){case"sha3-224":return new Uint8Array(me.sha3_224.arrayBuffer(t));case"sha3-256":return new Uint8Array(me.sha3_256.arrayBuffer(t));case"sha3-384":return new Uint8Array(me.sha3_384.arrayBuffer(t));case"sha3-512":return new Uint8Array(me.sha3_512.arrayBuffer(t));case"shake-128":return new Uint8Array(me.shake128.create(128).update(t).arrayBuffer());case"shake-256":return new Uint8Array(me.shake256.create(256).update(t).arrayBuffer());case"keccak-224":return new Uint8Array(me.keccak224.arrayBuffer(t));case"keccak-256":return new Uint8Array(me.keccak256.arrayBuffer(t));case"keccak-384":return new Uint8Array(me.keccak384.arrayBuffer(t));case"keccak-512":return new Uint8Array(me.keccak512.arrayBuffer(t));case"murmur3-128":return Re(Qn.x64.hash128(t),"base16");case"murmur3-32":return To(Qn.x86.hash32(t));default:throw new TypeError(`${e} is not a supported algorithm`)}},So=e=>e;var J={identity:So,sha1:pr("sha1"),sha2256:pr("sha2-256"),sha2512:pr("sha2-512"),dblSha2256:pr("dbl-sha2-256"),sha3224:oe("sha3-224"),sha3256:oe("sha3-256"),sha3384:oe("sha3-384"),sha3512:oe("sha3-512"),shake128:oe("shake-128"),shake256:oe("shake-256"),keccak224:oe("keccak-224"),keccak256:oe("keccak-256"),keccak384:oe("keccak-384"),keccak512:oe("keccak-512"),murmur3128:oe("murmur3-128"),murmur332:oe("murmur3-32"),addBlake:Ao};async function se(e,t,r){const n=await se.digest(e,t,r);return Wt.encode(n,t,r)}se.multihash=Wt,se.digest=async(e,t,r)=>{const n=se.createHash(t),a=await n(e);return r?a.slice(0,r):a},se.createHash=function(e){if(!e)throw L(new Error("hash algorithm must be specified"),"ERR_HASH_ALGORITHM_NOT_SPECIFIED");if(e=Wt.coerceCode(e),!se.functions[e])throw L(new Error(`multihash function '${e}' not yet supported`),"ERR_HASH_ALGORITHM_NOT_SUPPORTED");return se.functions[e]},se.functions={0:J.identity,17:J.sha1,18:J.sha2256,19:J.sha2512,20:J.sha3512,21:J.sha3384,22:J.sha3256,23:J.sha3224,24:J.shake128,25:J.shake256,26:J.keccak224,27:J.keccak256,28:J.keccak384,29:J.keccak512,34:J.murmur3128,35:J.murmur332,86:J.dblSha2256},J.addBlake(se.functions),se.validate=async(e,t)=>{const r=await se(e,Wt.decode(t).name);return Ie(t,r)};var Te=se,xo=`// Record represents a dht record that contains a value
// for a key value pair
message Record {
  // The key that references this record
  bytes key = 1;

  // The actual value this record is storing
  bytes value = 2;

  // Note: These fields were removed from the Record message
  // hash of the authors public key
  // optional bytes author = 3;
  // A PKI signature for the key+value+author
  // optional bytes signature = 4;

  // Time the record was received, set by receiver
  optional string timeReceived = 5;
}`,Ro=e=>{const t=e.getUTCFullYear(),r=String(e.getUTCMonth()+1).padStart(2,"0"),n=String(e.getUTCDate()).padStart(2,"0"),a=String(e.getUTCHours()).padStart(2,"0"),i=String(e.getUTCMinutes()).padStart(2,"0"),o=String(e.getUTCSeconds()).padStart(2,"0"),u=e.getUTCMilliseconds(),d=u*1e3*1e3;return`${t}-${r}-${n}T${a}:${i}:${o}.${d}Z`},Co=e=>{const t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),r=String(e).trim().match(t);if(!r)throw new Error("Invalid format");const n=parseInt(r[1],10),a=parseInt(r[2],10)-1,i=parseInt(r[3],10),o=parseInt(r[4],10),u=parseInt(r[5],10),d=parseInt(r[6],10),l=parseInt(r[7].slice(0,-6),10);return new Date(Date.UTC(n,a,i,o,u,d,l))},sa={toRFC3339:Ro,parseRFC3339:Co};const ua=Wr(xo).Record;class $r{constructor(e,t,r){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=r}serialize(){return ua.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:this.timeReceived&&sa.toRFC3339(this.timeReceived)}}static deserialize(e){const t=ua.decode(e);return $r.fromDeserialized(t)}static fromDeserialized(e){let t;e.timeReceived&&(t=sa.parseRFC3339(e.timeReceived));const r=new $r(e.key,e.value,t);return r}}var Do=$r;const Oo=async(e,t)=>{if(!(e instanceof Uint8Array))throw L(new Error('"key" must be a Uint8Array'),"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(e.byteLength<5)throw L(new Error("invalid public key record"),"ERR_INVALID_RECORD_KEY_TOO_SHORT");const r=H(e.subarray(0,4));if(r!=="/pk/")throw L(new Error("key was not prefixed with /pk/"),"ERR_INVALID_RECORD_KEY_BAD_PREFIX");const n=e.slice(4),a=await Te(t,"sha2-256");if(!Ie(n,a))throw L(new Error("public key does not match passed in key"),"ERR_INVALID_RECORD_HASH_MISMATCH")};var qo={func:Oo,sign:!1},Mo={pk:qo};const Bo=(e,t)=>{const r=t.key,n=H(r),a=n.split("/");if(a.length<3)return;const i=e[a[1].toString()];if(!i){const o="Invalid record keytype";throw L(new Error(o),"ERR_INVALID_RECORD_KEY_TYPE")}return i.func(r,t.value)};var Uo={verifyRecord:Bo,validators:Mo};const No=(e,t)=>0;var Lo=No,jo={pk:Lo};const Fo=(e,t,r)=>{if(r.length===0){const o="No records given";throw L(new Error(o),"ERR_NO_RECORDS_RECEIVED")}const n=H(t),a=n.split("/");if(a.length<3){const o="Record key does not have a selector function";throw L(new Error(o),"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}const i=e[a[1].toString()];if(!i){const o=`Unrecognized key prefix: ${a[1]}`;throw L(new Error(o),"ERR_UNRECOGNIZED_KEY_PREFIX")}return i(t,r)};var $o={bestRecord:Fo,selectors:jo},ye={Record:Do,validator:Uo,selection:$o};const{EventEmitter:Ko}=wr;function ca(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let r=0,n=e.length;r<n;++r)if(e[r]!==t[r])return!1;return!0}function Kr(){return{contacts:[],dontSplit:!1,left:null,right:null}}function He(e,t){if(!(t instanceof Uint8Array))throw new TypeError(e+" is not a Uint8Array")}class zr extends Ko{constructor(e={}){super();this.localNodeId=e.localNodeId||qa(20),this.numberOfNodesPerKBucket=e.numberOfNodesPerKBucket||20,this.numberOfNodesToPing=e.numberOfNodesToPing||3,this.distance=e.distance||zr.distance,this.arbiter=e.arbiter||zr.arbiter,this.metadata=Object.assign({},e.metadata),He("option.localNodeId as parameter 1",this.localNodeId),this.root=Kr()}static arbiter(e,t){return e.vectorClock>t.vectorClock?e:t}static distance(e,t){let r=0,n=0;const a=Math.min(e.length,t.length),i=Math.max(e.length,t.length);for(;n<a;++n)r=r*256+(e[n]^t[n]);for(;n<i;++n)r=r*256+255;return r}add(e){He("contact.id",(e||{}).id);let t=0,r=this.root;for(;r.contacts===null;)r=this._determineNode(r,e.id,t++);const n=this._indexOf(r,e.id);return n>=0?(this._update(r,n,e),this):r.contacts.length<this.numberOfNodesPerKBucket?(r.contacts.push(e),this.emit("added",e),this):r.dontSplit?(this.emit("ping",r.contacts.slice(0,this.numberOfNodesToPing),e),this):(this._split(r,t),this.add(e))}closest(e,t=Infinity){if(He("id",e),!Number.isInteger(t)&&t!==Infinity||t<=0)throw new TypeError("n is not positive number");let r=[];for(let n=[this.root],a=0;n.length>0&&r.length<t;){const i=n.pop();if(i.contacts===null){const o=this._determineNode(i,e,a++);n.push(i.left===o?i.right:i.left),n.push(o)}else r=r.concat(i.contacts)}return r.map(n=>[this.distance(n.id,e),n]).sort((n,a)=>n[0]-a[0]).slice(0,t).map(n=>n[1])}count(){let e=0;for(const t=[this.root];t.length>0;){const r=t.pop();r.contacts===null?t.push(r.right,r.left):e+=r.contacts.length}return e}_determineNode(e,t,r){const n=r>>3,a=r%8;if(t.length<=n&&a!==0)return e.left;const i=t[n];return i&1<<7-a?e.right:e.left}get(e){He("id",e);let t=0,r=this.root;for(;r.contacts===null;)r=this._determineNode(r,e,t++);const n=this._indexOf(r,e);return n>=0?r.contacts[n]:null}_indexOf(e,t){for(let r=0;r<e.contacts.length;++r)if(ca(e.contacts[r].id,t))return r;return-1}remove(e){He("the id as parameter 1",e);let t=0,r=this.root;for(;r.contacts===null;)r=this._determineNode(r,e,t++);const n=this._indexOf(r,e);if(n>=0){const a=r.contacts.splice(n,1)[0];this.emit("removed",a)}return this}_split(e,t){e.left=Kr(),e.right=Kr();for(const a of e.contacts)this._determineNode(e,a.id,t).contacts.push(a);e.contacts=null;const r=this._determineNode(e,this.localNodeId,t),n=e.left===r?e.right:e.left;n.dontSplit=!0}toArray(){let e=[];for(const t=[this.root];t.length>0;){const r=t.pop();r.contacts===null?t.push(r.right,r.left):e=e.concat(r.contacts)}return e}_update(e,t,r){if(!ca(e.contacts[t].id,r.id))throw new Error("wrong index for _update");const n=e.contacts[t],a=this.arbiter(n,r);if(a===n&&n!==r)return;e.contacts.splice(t,1),e.contacts.push(a),this.emit("updated",n,a)}}var zo=zr,la=G(function(e,t){var r=function(d,l){return l||(l={}),d.split("").forEach(function(m,h){m in l||(l[m]=h)}),l},n={alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",charmap:{0:14,1:8}};n.charmap=r(n.alphabet,n.charmap);var a={alphabet:"0123456789ABCDEFGHJKMNPQRSTVWXYZ",charmap:{O:0,I:1,L:1}};a.charmap=r(a.alphabet,a.charmap);var i={alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",charmap:{}};i.charmap=r(i.alphabet,i.charmap);function o(d){if(this.buf=[],this.shift=8,this.carry=0,d){switch(d.type){case"rfc4648":this.charmap=t.rfc4648.charmap;break;case"crockford":this.charmap=t.crockford.charmap;break;case"base32hex":this.charmap=t.base32hex.charmap;break;default:throw new Error("invalid type")}d.charmap&&(this.charmap=d.charmap)}}o.prototype.charmap=n.charmap,o.prototype.write=function(d){var l=this.charmap,m=this.buf,h=this.shift,v=this.carry;return d.toUpperCase().split("").forEach(function(w){if(w=="=")return;var E=l[w]&255;h-=5,h>0?v|=E<<h:h<0?(m.push(v|E>>-h),h+=8,v=E<<h&255):(m.push(v|E),h=8,v=0)}),this.shift=h,this.carry=v,this},o.prototype.finalize=function(d){return d&&this.write(d),this.shift!==8&&this.carry!==0&&(this.buf.push(this.carry),this.shift=8,this.carry=0),this.buf};function u(d){if(this.buf="",this.shift=3,this.carry=0,d){switch(d.type){case"rfc4648":this.alphabet=t.rfc4648.alphabet;break;case"crockford":this.alphabet=t.crockford.alphabet;break;case"base32hex":this.alphabet=t.base32hex.alphabet;break;default:throw new Error("invalid type")}d.alphabet?this.alphabet=d.alphabet:d.lc&&(this.alphabet=this.alphabet.toLowerCase())}}u.prototype.alphabet=n.alphabet,u.prototype.write=function(d){var l=this.shift,m=this.carry,h,v,w;for(w=0;w<d.length;w++)v=d[w],h=m|v>>l,this.buf+=this.alphabet[h&31],l>5&&(l-=5,h=v>>l,this.buf+=this.alphabet[h&31]),l=5-l,m=v<<l,l=8-l;return this.shift=l,this.carry=m,this},u.prototype.finalize=function(d){return d&&this.write(d),this.shift!==3&&(this.buf+=this.alphabet[this.carry&31],this.shift=3,this.carry=0),this.buf},t.encode=function(d,l){return new u(l).finalize(d)},t.decode=function(d,l){return new o(l).finalize(d)},t.Decoder=o,t.Encoder=u,t.charmap=r,t.crockford=a,t.rfc4648=n,t.base32hex=i}),Se=ke;function ke(e,t){if(e.length!==t.length)throw new Error("Inputs should have the same length");for(var r=Buffer.allocUnsafe(e.length),n=0;n<e.length;n++)r[n]=e[n]^t[n];return r}ke.compare=function(t,r){if(t.length!==r.length)throw new Error("Inputs should have the same length");for(var n=0;n<t.length;n++){if(t[n]===r[n])continue;return t[n]<r[n]?-1:1}return 0},ke.gt=function(t,r){return ke.compare(t,r)===1},ke.lt=function(t,r){return ke.compare(t,r)===-1},ke.eq=function(t,r){return ke.compare(t,r)===0};var da=async(e,t,{concurrency:r=Infinity,stopOnError:n=!0}={})=>new Promise((a,i)=>{if(typeof t!="function")throw new TypeError("Mapper function is required");if(!((Number.isSafeInteger(r)||r===Infinity)&&r>=1))throw new TypeError(`Expected \`concurrency\` to be an integer from 1 and up or \`Infinity\`, got \`${r}\` (${typeof r})`);const o=[],u=[],d=e[Symbol.iterator]();let l=!1,m=!1,h=0,v=0;const w=()=>{if(l)return;const E=d.next(),c=v;if(v++,E.done){m=!0,h===0&&(!n&&u.length!==0?i(new Ir(u)):a(o));return}h++,(async()=>{try{const p=await E.value;o[c]=await t(p,c),h--,w()}catch(p){n?(l=!0,i(p)):(u.push(p),h--,w())}})()};for(let E=0;E<r&&!(w(),m);E++);}),O=G(function(e,t){const r=Te.multihash,{Key:n}=Pr,{Record:a}=ye;t.convertBuffer=i=>Te.digest(i,"sha2-256"),t.convertPeerId=i=>Te.digest(i.id,"sha2-256"),t.bufferToKey=i=>new n("/"+t.encodeBase32(i),!1),t.keyForPublicKey=i=>Pe([Re("/pk/"),i.id]),t.isPublicKeyKey=i=>H(i.slice(0,4))==="/pk/",t.fromPublicKeyKey=i=>new Ee(i.slice(4)),t.now=()=>Date.now(),t.encodeBase32=i=>{const o=new la.Encoder;return o.write(i).finalize()},t.decodeBase32=i=>{const o=new la.Decoder;return Uint8Array.from(o.write(i).finalize())},t.sortClosestPeers=async(i,o)=>{const u=await da(i,async d=>{const l=await t.convertPeerId(d);return{peer:d,distance:Se(l,o)}});return u.sort(t.xorCompare).map(d=>d.peer)},t.xorCompare=(i,o)=>Se.compare(i.distance,o.distance),t.pathSize=(i,o)=>Math.ceil(i/o),t.createPutRecord=(i,o)=>{const u=new Date,d=new a(i,o,u);return d.serialize()},t.logger=(i,o)=>{const u=["libp2p","dht"];o&&u.push(o),i&&u.push(`${i.toB58String().slice(0,8)}`),Yt.formatters.b=l=>r.toB58String(l);const d=Yt(u.join(":"));return d.error=Yt(u.concat(["error"]).join(":")),d},t.TimeoutError=class extends Error{get code(){return"ETIMEDOUT"}},t.withTimeout=(i,o)=>async(...u)=>Promise.race([i(...u),new Promise((d,l)=>{setTimeout(()=>{l(L(new Error("Async function did not complete before timeout"),"ETIMEDOUT"))},o)})]),t.mapParallel=async function(i,o){const u=[];for await(const d of i)u.push(o(d));return Promise.all(u)}});class Ho{constructor(e,t){this.self=e,this._onPing=this._onPing.bind(this),this._onInit(t)}async _onInit(e){const t=await O.convertPeerId(this.self);this.kb=new zo({localNodeId:t,numberOfNodesPerKBucket:e,numberOfNodesToPing:1}),this.kb.on("ping",this._onPing)}_onPing(e,t){const r=e[0];this.kb.remove(r.id),this.kb.add(t)}get size(){return this.kb.count()}async find(e){const t=await O.convertPeerId(e),r=this.closestPeer(t);if(r&&r.isEqual(e))return r}closestPeer(e){const t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t){return this.kb.closest(e,t).map(r=>r.peer)}async add(e){const t=await O.convertPeerId(e);this.kb.add({id:t,peer:e})}async remove(e){const t=await O.convertPeerId(e);this.kb.remove(t)}}var Go=Ho,X=G(function(e,t){const r=t.second=1e3,n=t.minute=60*r,a=t.hour=60*n;t.MAX_RECORD_AGE=36*a,t.PROTOCOL_DHT="/kad/1.0.0",t.PROVIDERS_KEY_PREFIX="/providers/",t.PROVIDERS_LRU_CACHE_SIZE=256,t.PROVIDERS_VALIDITY=24*a,t.PROVIDERS_CLEANUP_INTERVAL=a,t.READ_MESSAGE_TIMEOUT=10*r,t.GET_MANY_RECORD_COUNT=16,t.K=20,t.ALPHA=3,t.defaultRandomWalk={enabled:!0,queriesPerPeriod:1,interval:5*n,timeout:10*r,delay:10*r}});const ha=()=>{};class Vo{constructor({min:e=0,max:t=Infinity,handlers:r={}}){this.min=e,this.max=t,this._onConnect=r.onConnect||ha,this._onDisconnect=r.onDisconnect||ha,this.peers=new Set}set registrar(e){this._registrar=e}disconnect(e){this._onDisconnect(e)}}var Qo=_r(Vo,{className:"Topology",symbolName:"@libp2p/js-interfaces/topology"});class Wo extends Qo{constructor({min:e,max:t,multicodecs:r,handlers:n}){super({min:e,max:t,handlers:n});if(!r)throw new Error("one or more multicodec should be provided");if(!n)throw new Error("the handlers should be provided");if(typeof n.onConnect!="function")throw new Error("the 'onConnect' handler must be provided");if(typeof n.onDisconnect!="function")throw new Error("the 'onDisconnect' handler must be provided");this.multicodecs=Array.isArray(r)?r:[r],this._registrar=void 0,this._onProtocolChange=this._onProtocolChange.bind(this),this._onPeerConnect=this._onPeerConnect.bind(this)}set registrar(e){this._registrar=e,this._registrar.peerStore.on("change:protocols",this._onProtocolChange),this._registrar.connectionManager.on("peer:connect",this._onPeerConnect),this._updatePeers(this._registrar.peerStore.peers.values())}_updatePeers(e){for(const{id:t,protocols:r}of e)if(this.multicodecs.filter(n=>r.includes(n)).length){this.peers.add(t.toB58String());const n=this._registrar.getConnection(t);n&&this._onConnect(t,n)}else this.peers.delete(t.toB58String())}_onProtocolChange({peerId:e,protocols:t}){const r=this.peers.has(e.toB58String()),n=t.filter(a=>this.multicodecs.includes(a));r&&n.length===0&&this._onDisconnect(e);for(const a of t)if(this.multicodecs.includes(a)){const i=this._registrar.peerStore.get(e);this._updatePeers([i]);return}}_onPeerConnect(e){const t=e.remotePeer,r=this._registrar.peerStore.protoBook.get(t);if(!r)return;this.multicodecs.find(n=>r.includes(n))&&(this.peers.add(t.toB58String()),this._onConnect(t,e))}}var Yo=_r(Wo,{className:"MulticodecTopology",symbolName:"@libp2p/js-interfaces/topology/multicodec-topology"}),Jo=`// can't use, because protocol-buffers doesn't support imports
// so we have to duplicate for now :(
// import "record.proto";

message Record {
  // adjusted for javascript
  optional bytes key = 1;
  optional bytes value = 2;
  optional bytes author = 3;
  optional bytes signature = 4;
  optional string timeReceived = 5;
}

message Message {
  enum MessageType {
    PUT_VALUE = 0;
    GET_VALUE = 1;
    ADD_PROVIDER = 2;
    GET_PROVIDERS = 3;
    FIND_NODE = 4;
    PING = 5;
  }

  enum ConnectionType {
    // sender does not have a connection to peer, and no extra information (default)
    NOT_CONNECTED = 0;

    // sender has a live connection to peer
    CONNECTED = 1;

    // sender recently connected to peer
    CAN_CONNECT = 2;

    // sender recently tried to connect to peer repeatedly but failed to connect
    // ("try" here is loose, but this should signal "made strong effort, failed")
    CANNOT_CONNECT = 3;
  }

  message Peer {
    // ID of a given peer.
    optional bytes id = 1;

    // multiaddrs for a given peer
    repeated bytes addrs = 2;

    // used to signal the sender's connection capabilities to the peer
    optional ConnectionType connection = 3;
  }

  // defines what type of message it is.
  optional MessageType type = 1;

  // defines what coral cluster level this query/response belongs to.
  // in case we want to implement coral's cluster rings in the future.
  optional int32 clusterLevelRaw = 10;

  // Used to specify the key associated with this message.
  // PUT_VALUE, GET_VALUE, ADD_PROVIDER, GET_PROVIDERS
  // adjusted for javascript
  optional bytes key = 2;

  // Used to return a value
  // PUT_VALUE, GET_VALUE
  // adjusted Record to bytes for js
  optional bytes record = 3;

  // Used to return peers closer to a key in a query
  // GET_VALUE, GET_PROVIDERS, FIND_NODE
  repeated Peer closerPeers = 8;

  // Used to return Providers
  // GET_VALUE, ADD_PROVIDER, GET_PROVIDERS
  repeated Peer providerPeers = 9;
}`;const{Record:Xo}=ye,fr=Wr(Jo),Zo=fr.Message.MessageType,pa=fr.Message.ConnectionType;class mr{constructor(e,t,r){if(t&&!(t instanceof Uint8Array))throw new Error("Key must be a Uint8Array");this.type=e,this.key=t,this._clusterLevelRaw=r,this.closerPeers=[],this.providerPeers=[],this.record=null}get clusterLevel(){const e=this._clusterLevelRaw-1;return e<0?0:e}set clusterLevel(e){this._clusterLevelRaw=e}serialize(){const e={key:this.key,type:this.type,clusterLevelRaw:this._clusterLevelRaw,closerPeers:this.closerPeers.map(fa),providerPeers:this.providerPeers.map(fa)};return this.record&&(this.record instanceof Uint8Array?e.record=this.record:e.record=this.record.serialize()),fr.Message.encode(e)}static deserialize(e){const t=fr.Message.decode(e),r=new mr(t.type,t.key,t.clusterLevelRaw);return r.closerPeers=t.closerPeers.map(ma),r.providerPeers=t.providerPeers.map(ma),t.record&&(r.record=Xo.deserialize(t.record)),r}}mr.TYPES=Zo,mr.CONNECTION_TYPES=pa;function fa(e){return{id:e.id.id,addrs:(e.multiaddrs||[]).map(t=>t.bytes),connection:pa.CONNECTED}}function ma(e){return{id:new Ee(e.id),multiaddrs:e.addrs.map(t=>yn(t))}}var Y=mr;const{Record:es}=ye;var ts=e=>{const t=O.logger(e.peerId,"rpc:get-value");return async function(n,a){const i=a.key;if(t("key: %b",i),!i||i.length===0)throw L(new Error("Invalid key"),"ERR_INVALID_KEY");const o=new Y(Y.TYPES.GET_VALUE,i,a.clusterLevel);if(O.isPublicKeyKey(i)){t("is public key");const l=O.fromPublicKeyKey(i);let m;if(e._isSelf(l))m=e.peerId;else{const h=e.peerStore.get(l);m=h&&h.id}if(m&&m.pubKey)return t("returning found public key"),o.record=new es(i,m.pubKey.bytes),o}const[u,d]=await Promise.all([e._checkLocalDatastore(i),e._betterPeersToQuery(a,n)]);return u&&(t("got record"),o.record=u),d.length>0&&(t("got closer %s",d.length),o.closerPeers=d),o}},rs=e=>{const t=O.logger(e.peerId,"rpc:put-value");return async function(n,a){const i=a.key;t("key: %b",i);const o=a.record;if(!o){const d=`Empty record from: ${n.toB58String()}`;throw t.error(d),L(new Error(d),"ERR_EMPTY_RECORD")}await e._verifyRecordLocally(o),o.timeReceived=new Date;const u=O.bufferToKey(o.key);return await e.datastore.put(u,o.serialize()),e.onPut(o,n),a}},ns=e=>{const t=O.logger(e.peerId,"rpc:find-node");return async function(n,a){t("start");let i;Ie(a.key,e.peerId.id)?i=[{id:e.peerId}]:i=await e._betterPeersToQuery(a,n);const o=new Y(a.type,new Uint8Array(0),a.clusterLevel);return i.length>0?o.closerPeers=i:t("handle FindNode %s: could not find anything",n.toB58String()),o}},as=e=>{const t=O.logger(e.peerId,"rpc:add-provider");return async function(n,a){if(t("start"),!a.key||a.key.length===0)throw L(new Error("Missing key"),"ERR_MISSING_KEY");let i;try{i=new Vt(a.key)}catch(o){const u=`Invalid CID: ${o.message}`;throw L(new Error(u),"ERR_INVALID_CID")}return a.providerPeers.forEach(o=>{if(!o.id.isEqual(n)){t("invalid provider peer %s from %s",o.id.toB58String(),n.toB58String());return}if(o.multiaddrs.length<1){t("no valid addresses for provider %s. Ignore",n.toB58String());return}if(t("received provider %s for %s (addrs %s)",n.toB58String(),i.toBaseEncodedString(),o.multiaddrs.map(u=>u.toString())),!e._isSelf(o.id))return e.peerStore.addressBook.add(o.id,o.multiaddrs),e.providers.addProvider(i,o.id)}),e.providers.addProvider(i,n)}},is=e=>{const t=O.logger(e.peerId,"rpc:get-providers");return async function(n,a){let i;try{i=new Vt(a.key)}catch(w){throw L(new Error(`Invalid CID: ${w.message}`),"ERR_INVALID_CID")}t("%s",i.toBaseEncodedString());const o=O.bufferToKey(i.bytes),[u,d,l]=await Promise.all([e.datastore.has(o),e.providers.getProviders(i),e._betterPeersToQuery(a,n)]),m=d.map(w=>({id:w})),h=l.map(w=>({id:w.id}));u&&m.push({id:e.peerId});const v=new Y(a.type,a.key,a.clusterLevel);return m.length>0&&(v.providerPeers=m),h.length>0&&(v.closerPeers=h),t("got %s providers %s closerPeers",m.length,h.length),v}},os=e=>{const t=O.logger(e.peerId,"rpc:ping");return function(n,a){return t("from %s",n.toB58String()),a}};const Be=Y.TYPES;var ss=e=>{const t={[Be.GET_VALUE]:ts(e),[Be.PUT_VALUE]:rs(e),[Be.FIND_NODE]:ns(e),[Be.ADD_PROVIDER]:as(e),[Be.GET_PROVIDERS]:is(e),[Be.PING]:os(e)};return function(n){return t[n]}},us=e=>{const t=O.logger(e.peerId,"rpc"),r=ss(e);async function n(a,i){const o=r(i.type);try{await e._add(a)}catch(u){t.error("Failed to update the kbucket store",u)}if(!o){t.error(`no handler found for message type: ${i.type}`);return}return o(a,i)}return async function({stream:i,connection:o}){const u=o.remotePeer;try{await e._add(u)}catch(l){t.error(l)}const d=u.toB58String();t("from: %s",d),await kr(i.source,qe.decode(),l=>async function*(){for await(const m of l){const h=Y.deserialize(m.slice()),v=await n(u,h);v&&(yield v.serialize())}}(),qe.encode(),i.sink)}};const{consume:cs}=Hn;class ls{constructor(e){this.dht=e,this.readMessageTimeout=X.READ_MESSAGE_TIMEOUT,this._log=O.logger(this.dht.peerId,"net"),this._rpc=us(this.dht),this._onPeerConnected=this._onPeerConnected.bind(this),this._running=!1}async start(){if(this._running)return;if(!this.dht.isStarted)throw L(new Error("Can not start network"),"ERR_CANNOT_START_NETWORK");this._running=!0,this.dht._clientMode===!1&&this.dht.registrar.handle(this.dht.protocol,this._rpc);const e=new Yo({multicodecs:[this.dht.protocol],handlers:{onConnect:this._onPeerConnected,onDisconnect:()=>{}}});this._registrarId=await this.dht.registrar.register(e)}async stop(){if(!this.dht.isStarted&&!this.isStarted)return;this._running=!1,await this.dht.registrar.unregister(this._registrarId)}get isStarted(){return this._running}get isConnected(){return this.dht.isStarted&&this.isStarted}async _onPeerConnected(e){await this.dht._add(e),this._log("added to the routing table: %s",e.toB58String())}async sendRequest(e,t){if(!this.isConnected)throw L(new Error("Network is offline"),"ERR_NETWORK_OFFLINE");const r=e.toB58String();this._log("sending to: %s",r);let n=this.dht.registrar.connectionManager.get(e);n||(n=await this.dht.dialer.connectToPeer(e));const{stream:a}=await n.newStream(this.dht.protocol);return this._writeReadMessage(a,t.serialize())}async sendMessage(e,t){if(!this.isConnected)throw L(new Error("Network is offline"),"ERR_NETWORK_OFFLINE");const r=e.toB58String();this._log("sending to: %s",r);let n=this.dht.registrar.connectionManager.get(e);n||(n=await this.dht.dialer.connectToPeer(e));const{stream:a}=await n.newStream(this.dht.protocol);return this._writeMessage(a,t.serialize())}async _writeReadMessage(e,t){return fe(ds(e,t),this.readMessageTimeout)}_writeMessage(e,t){return kr([t],qe.encode(),e,cs)}}async function ds(e,t){const r=await kr([t],qe.encode(),e,qe.decode(),async n=>{for await(const a of n)return a.slice()});if(r.length===0)throw L(new Error("No message received"),"ERR_NO_MESSAGE_RECEIVED");return Y.deserialize(r)}var hs=ls;class ps{constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peerId)}async add(e){if(this.peerDistances.find(n=>Ie(n.peerId.id,e.id)))return;const t=await O.convertPeerId(e),r={peerId:e,distance:Se(this.originDhtKey,t)};this.peerDistances.push(r),this.peerDistances.sort((n,a)=>Se.compare(n.distance,a.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(e){if(!e.length)return!1;if(!this.length)return!0;const t=await da(e,n=>O.convertPeerId(n)),r=this.peerDistances[this.peerDistances.length-1].distance;for(const n of t){const a=Se(this.originDhtKey,n);if(Se.compare(a,r)<0)return!0}return!1}}var fs=ps,ms=G(function(e,t){(function(){var r,n,a,i,o,u,d,l,m,h,v,w,E,c,p;a=Math.floor,h=Math.min,n=function(f,P){return f<P?-1:f>P?1:0},m=function(f,P,y,b,g){var _;if(y==null&&(y=0),g==null&&(g=n),y<0)throw new Error("lo must be non-negative");for(b==null&&(b=f.length);y<b;)_=a((y+b)/2),g(P,f[_])<0?b=_:y=_+1;return[].splice.apply(f,[y,y-y].concat(P)),P},u=function(f,P,y){return y==null&&(y=n),f.push(P),c(f,0,f.length-1,y)},o=function(f,P){var y,b;return P==null&&(P=n),y=f.pop(),f.length?(b=f[0],f[0]=y,p(f,0,P)):b=y,b},l=function(f,P,y){var b;return y==null&&(y=n),b=f[0],f[0]=P,p(f,0,y),b},d=function(f,P,y){var b;return y==null&&(y=n),f.length&&y(f[0],P)<0&&(b=[f[0],P],P=b[0],f[0]=b[1],p(f,0,y)),P},i=function(f,P){var y,b,g,_,A,R;for(P==null&&(P=n),_=function(){R=[];for(var S=0,U=a(f.length/2);0<=U?S<U:S>U;0<=U?S++:S--)R.push(S);return R}.apply(this).reverse(),A=[],b=0,g=_.length;b<g;b++)y=_[b],A.push(p(f,y,P));return A},E=function(f,P,y){var b;return y==null&&(y=n),b=f.indexOf(P),b===-1?void 0:(c(f,0,b,y),p(f,b,y))},v=function(f,P,y){var b,g,_,A,R;if(y==null&&(y=n),g=f.slice(0,P),!g.length)return g;for(i(g,y),R=f.slice(P),_=0,A=R.length;_<A;_++)b=R[_],d(g,b,y);return g.sort(y).reverse()},w=function(f,P,y){var b,g,_,A,R,S,U,Q,ae,ue;if(y==null&&(y=n),P*10<=f.length){if(A=f.slice(0,P).sort(y),!A.length)return A;for(_=A[A.length-1],Q=f.slice(P),R=0,U=Q.length;R<U;R++)b=Q[R],y(b,_)<0&&(m(A,b,0,null,y),A.pop(),_=A[A.length-1]);return A}for(i(f,y),ue=[],g=S=0,ae=h(P,f.length);0<=ae?S<ae:S>ae;g=0<=ae?++S:--S)ue.push(o(f,y));return ue},c=function(f,P,y,b){var g,_,A;for(b==null&&(b=n),g=f[y];y>P;){if(A=y-1>>1,_=f[A],b(g,_)<0){f[y]=_,y=A;continue}break}return f[y]=g},p=function(f,P,y){var b,g,_,A,R;for(y==null&&(y=n),g=f.length,R=P,_=f[P],b=2*P+1;b<g;)A=b+1,A<g&&!(y(f[b],f[A])<0)&&(b=A),f[P]=f[b],P=b,b=2*P+1;return f[P]=_,c(f,R,P,y)},r=function(){f.push=u,f.pop=o,f.replace=l,f.pushpop=d,f.heapify=i,f.updateItem=E,f.nlargest=v,f.nsmallest=w;function f(P){this.cmp=P??n,this.nodes=[]}return f.prototype.push=function(P){return u(this.nodes,P,this.cmp)},f.prototype.pop=function(){return o(this.nodes,this.cmp)},f.prototype.peek=function(){return this.nodes[0]},f.prototype.contains=function(P){return this.nodes.indexOf(P)!==-1},f.prototype.replace=function(P){return l(this.nodes,P,this.cmp)},f.prototype.pushpop=function(P){return d(this.nodes,P,this.cmp)},f.prototype.heapify=function(){return i(this.nodes,this.cmp)},f.prototype.updateItem=function(P){return E(this.nodes,P,this.cmp)},f.prototype.clear=function(){return this.nodes=[]},f.prototype.empty=function(){return this.nodes.length===0},f.prototype.size=function(){return this.nodes.length},f.prototype.clone=function(){var P;return P=new f,P.nodes=this.nodes.slice(0),P},f.prototype.toArray=function(){return this.nodes.slice(0)},f.prototype.insert=f.prototype.push,f.prototype.top=f.prototype.peek,f.prototype.front=f.prototype.peek,f.prototype.has=f.prototype.contains,f.prototype.copy=f.prototype.clone,f}(),function(f,P){return e.exports=P()}(this,function(){return r})}).call(Yr)}),ys=ms;const Hr=Yt("libp2p:dht:peer-queue");class Gr{static async fromPeerId(e){const t=await O.convertPeerId(e);return new Gr(t)}static async fromKey(e){const t=await O.convertBuffer(e);return new Gr(t)}constructor(e){Hr("create: %b",e),this.from=e,this.heap=new ys(O.xorCompare)}async enqueue(e){Hr("enqueue %s",e.toB58String());const t=await O.convertPeerId(e),r={id:e,distance:Se(this.from,t)};this.heap.push(r)}dequeue(){const e=this.heap.pop();return Hr("dequeue %s",e.id.toB58String()),e.id}get length(){return this.heap.size()}}var gs=Gr;const vs=3e4;class bs{constructor(e,t){if(this.run=e,this.queryFunc=O.withTimeout(t,vs),!this.queryFunc)throw new Error("Path requires a `queryFn` to be specified");if(typeof this.queryFunc!="function")throw new Error("Path expected `queryFn` to be a function. Got "+typeof this.queryFunc);this.initialPeers=[],this.peersToQuery=null}addInitialPeer(e){this.initialPeers.push(e)}async execute(){const e=await gs.fromKey(this.run.query.key);this.peersToQuery=e,await Promise.all(this.initialPeers.map(t=>this.addPeerToQuery(t))),await this.run.workerQueue(this)}async addPeerToQuery(e){if(this.run.query.dht._isSelf(e))return;if(this.run.peersSeen.has(e.toB58String()))return;await this.peersToQuery.enqueue(e)}}var ws=bs;function _s(e,t,r,n){for(var a=e.length,i=r+(n?1:-1);n?i--:++i<a;)if(t(e[i],i,e))return i;return-1}var ks=_s;function Ps(e){return e!==e}var Is=Ps;function Es(e,t,r){for(var n=r-1,a=e.length;++n<a;)if(e[n]===t)return n;return-1}var As=Es;function Ts(e,t,r){return t===t?As(e,t,r):ks(e,Is,r)}var Ss=Ts,xs=Array.isArray,Rs=xs;function Cs(){}var Ds=Cs,Os=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;function r(n){return function(){if(n===null)throw new Error("Callback was already called.");var a=n;n=null,a.apply(this,arguments)}}e.exports=t.default}),ya=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;function r(n,a){a=a|0;for(var i=Math.max(n.length-a,0),o=Array(i),u=0;u<i;u++)o[u]=n[a+u];return o}e.exports=t.default}),ga=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.hasNextTick=t.hasSetImmediate=void 0,t.fallback=o,t.wrap=u;var r=n(ya);function n(l){return l&&l.__esModule?l:{default:l}}var a=t.hasSetImmediate=typeof setImmediate=="function"&&setImmediate,i=t.hasNextTick=typeof he=="object"&&typeof he.nextTick=="function";function o(l){setTimeout(l,0)}function u(l){return function(m){var h=(0,r.default)(arguments,1);l(function(){m.apply(null,h)})}}var d;a?d=setImmediate:i?d=he.nextTick:d=o,t.default=u(d)}),qs=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;function r(){this.head=this.tail=null,this.length=0}function n(a,i){a.length=1,a.head=a.tail=i}r.prototype.removeLink=function(a){return a.prev?a.prev.next=a.next:this.head=a.next,a.next?a.next.prev=a.prev:this.tail=a.prev,a.prev=a.next=null,this.length-=1,a},r.prototype.empty=function(){for(;this.head;)this.shift();return this},r.prototype.insertAfter=function(a,i){i.prev=a,i.next=a.next,a.next?a.next.prev=i:this.tail=i,a.next=i,this.length+=1},r.prototype.insertBefore=function(a,i){i.prev=a.prev,i.next=a,a.prev?a.prev.next=i:this.head=i,a.prev=i,this.length+=1},r.prototype.unshift=function(a){this.head?this.insertBefore(this.head,a):n(this,a)},r.prototype.push=function(a){this.tail?this.insertAfter(this.tail,a):n(this,a)},r.prototype.shift=function(){return this.head&&this.removeLink(this.head)},r.prototype.pop=function(){return this.tail&&this.removeLink(this.tail)},r.prototype.toArray=function(){for(var a=Array(this.length),i=this.head,o=0;o<this.length;o++)a[o]=i.data,i=i.next;return a},r.prototype.remove=function(a){for(var i=this.head;i;){var o=i.next;a(i)&&this.removeLink(i),i=o}return this},e.exports=t.default});function Ms(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var Bs=Ms,Us=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(a){return function(){var i=(0,r.default)(arguments),o=i.pop();a.call(this,i,o)}};var r=n(ya);function n(a){return a&&a.__esModule?a:{default:a}}e.exports=t.default}),Ns=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=o;var r=i(Bs),n=i(Us),a=i(ga);function i(l){return l&&l.__esModule?l:{default:l}}function o(l){return(0,n.default)(function(m,h){var v;try{v=l.apply(this,m)}catch(w){return h(w)}(0,r.default)(v)&&typeof v.then=="function"?v.then(function(w){u(h,null,w)},function(w){u(h,w.message?w:new Error(w))}):h(null,v)})}function u(l,m,h){try{l(m,h)}catch(v){(0,a.default)(d,v)}}function d(l){throw l}e.exports=t.default}),va=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isAsync=void 0;var r=n(Ns);function n(u){return u&&u.__esModule?u:{default:u}}var a=typeof Symbol=="function";function i(u){return a&&u[Symbol.toStringTag]==="AsyncFunction"}function o(u){return i(u)?(0,r.default)(u):u}t.default=o,t.isAsync=i}),Ls=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=m;var r=l(Ss),n=l(Rs),a=l(Ds),i=l(Os),o=l(ga),u=l(qs),d=l(va);function l(h){return h&&h.__esModule?h:{default:h}}function m(h,v,w){if(v==null)v=1;else if(v===0)throw new Error("Concurrency must not be zero");var E=(0,d.default)(h),c=0,p=[],f=!1;function P(_,A,R){if(R!=null&&typeof R!="function")throw new Error("task callback must be a function");if(g.started=!0,(0,n.default)(_)||(_=[_]),_.length===0&&g.idle())return(0,o.default)(function(){g.drain()});for(var S=0,U=_.length;S<U;S++){var Q={data:_[S],callback:R||a.default};A?g._tasks.unshift(Q):g._tasks.push(Q)}f||(f=!0,(0,o.default)(function(){f=!1,g.process()}))}function y(_){return function(A){c-=1;for(var R=0,S=_.length;R<S;R++){var U=_[R],Q=(0,r.default)(p,U,0);Q===0?p.shift():Q>0&&p.splice(Q,1),U.callback.apply(U,arguments),A!=null&&g.error(A,U.data)}c<=g.concurrency-g.buffer&&g.unsaturated(),g.idle()&&g.drain(),g.process()}}var b=!1,g={_tasks:new u.default,concurrency:v,payload:w,saturated:a.default,unsaturated:a.default,buffer:v/4,empty:a.default,drain:a.default,error:a.default,started:!1,paused:!1,push:function(_,A){P(_,!1,A)},kill:function(){g.drain=a.default,g._tasks.empty()},unshift:function(_,A){P(_,!0,A)},remove:function(_){g._tasks.remove(_)},process:function(){if(b)return;for(b=!0;!g.paused&&c<g.concurrency&&g._tasks.length;){var _=[],A=[],R=g._tasks.length;g.payload&&(R=Math.min(R,g.payload));for(var S=0;S<R;S++){var U=g._tasks.shift();_.push(U),p.push(U),A.push(U.data)}c+=1,g._tasks.length===0&&g.empty(),c===g.concurrency&&g.saturated();var Q=(0,i.default)(y(_));E(A,Q)}b=!1},length:function(){return g._tasks.length},running:function(){return c},workersList:function(){return p},idle:function(){return g._tasks.length+c===0},pause:function(){g.paused=!0},resume:function(){if(g.paused===!1)return;g.paused=!1,(0,o.default)(g.process)}};return g}e.exports=t.default}),js=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(i,o){var u=(0,n.default)(i);return(0,r.default)(function(d,l){u(d[0],l)},o,1)};var r=a(Ls),n=a(va);function a(i){return i&&i.__esModule?i:{default:i}}e.exports=t.default}),Fs=Object.prototype.toString,$s=function(e){return Fs.call(e)==="[object Function]"},ba=typeof setImmediate=="function"?setImmediate:function(){var t=[].slice.apply(arguments);t.splice(1,0,0),setTimeout.apply(null,t)},Ks=function(e){if(!$s(e.then))throw new TypeError("Expected a promise");return function(t){e.then(function(r){ba(t,null,r)},function(r){ba(t,r)})}};class zs{constructor(e,t,r,n){this.dht=e,this.run=t,this.path=r,this.log=n,this.concurrency=this.dht.concurrency,this.queue=this.setupQueue(),this.execution=null}setupQueue(){const e=js((t,r)=>{Ks(this.processNext(t))(r)},this.concurrency);return e.error=t=>{this.log.error("queue",t),this.stop(t)},e.drain=()=>{this.log("queue:drain"),this.stop()},e.unsaturated=()=>{this.running&&this.fill()},e.buffer=0,e}stop(e){if(!this.running)return;this.running=!1,this.queue.kill(),this.log("worker:stop, %d workers still running",this.run.workers.filter(t=>t.running).length),e?this.execution.reject(e):this.execution.resolve()}async execute(){this.running=!0,this.execution={};const e=new Promise((t,r)=>Object.assign(this.execution,{resolve:t,reject:r}));this.fill(),await e}fill(){for(;this.queue.running()+this.queue.length()<this.concurrency&&this.path.peersToQuery.length>0;)this.queue.push(this.path.peersToQuery.dequeue())}async processNext(e){if(!this.running)return;if(this.run.peersSeen.has(e.toB58String()))return;let t,r;try{t=await this.run.continueQuerying(this)}catch(i){r=i}if(!this.running)return;if(r)throw r;if(!t){this.stop();return}if(this.run.peersSeen.has(e.toB58String()))return;this.run.peersSeen.add(e.toB58String()),this.log("queue:work");let n,a;try{n=await this.execQuery(e)}catch(i){a=i}if(!this.running)return;if(this.log("queue:work:done",a,n),a)throw a;if(n&&n.queryComplete){this.log("query:complete"),this.run.stop();return}n&&n.pathComplete&&this.stop()}async execQuery(e){let t,r;try{t=await this.path.queryFunc(e)}catch(n){r=n}if(!this.running)return;if(r){this.run.errors.push(r);return}if(await this.run.peersQueried.add(e),t.pathComplete||t.queryComplete)return this.path.res=t,{pathComplete:t.pathComplete,queryComplete:t.queryComplete};t.closerPeers&&t.closerPeers.length>0&&await Promise.all(t.closerPeers.map(async n=>{if(this.dht._isSelf(n.id))return;this.dht._peerDiscovered(n.id,n.multiaddrs),await this.path.addPeerToQuery(n.id)}))}}var Hs=zs;class Gs extends wr{constructor(e){super();this.query=e,this.running=!1,this.workers=[],this.peersSeen=new Set,this.errors=[],this.peersQueried=null}stop(){if(!this.running)return;this.running=!1;for(const e of this.workers)e.stop()}async execute(e){const t=[],r=Math.min(this.query.dht.disjointPaths,e.length);for(let a=0;a<r;a++)t.push(new ws(this,this.query.makePath(a,r)));e.forEach((a,i)=>{t[i%r].addInitialPeer(a)}),await this.executePaths(t);const n={finalSet:new Set(this.peersQueried.peers),paths:[]};for(const a of t)a.res&&(a.res.pathComplete||a.res.queryComplete)&&(a.res.success=!0,n.paths.push(a.res));return n}async executePaths(e){this.running=!0,this.emit("start");try{await Promise.all(e.map(t=>t.execute()))}finally{this.stop(),this.emit("complete")}if(this.errors.length===this.peersSeen.size)throw this.errors[0]}async workerQueue(e){await this.init(),await this.startWorker(e)}async startWorker(e){const t=new Hs(this.query.dht,this,e,this.query._log);this.workers.push(t),await t.execute()}async init(){if(this.peersQueried)return;if(this.peersQueriedPromise){await this.peersQueriedPromise;return}this.peersQueriedPromise=(async()=>{const e=await O.convertBuffer(this.query.key);this.peersQueried=new fs(e,this.query.dht.kBucketSize)})(),await this.peersQueriedPromise,delete this.peersQueriedPromise}async continueQuerying(e){if(this.peersQueried.length<this.peersQueried.capacity)return!0;const t=e.queue.workersList().map(n=>n.data),r=await this.peersQueried.anyCloser(t);return!!r}}var Vs=Gs;const Qs=Te.multihash;class Ws{constructor(e,t,r){this.dht=e,this.key=t,this.makePath=r,this._log=O.logger(this.dht.peerId,"query:"+Qs.toB58String(t)),this.running=!1,this._onStart=this._onStart.bind(this),this._onComplete=this._onComplete.bind(this)}async run(e){return this.dht._queryManager.running?e.length===0?(this._log.error("Running query with no peers"),{finalSet:new Set,paths:[]}):(this._run=new Vs(this),this._log(`query running with K=${this.dht.kBucketSize}, A=${this.dht.concurrency}, D=${Math.min(this.dht.disjointPaths,e.length)}`),this._run.once("start",this._onStart),this._run.once("complete",this._onComplete),this._run.execute(e)):(this._log.error("Attempt to run query after shutdown"),{finalSet:new Set,paths:[]})}_onStart(){this.running=!0,this._startTime=Date.now(),this._log("query:start"),this.dht._queryManager.queryStarted(this)}_onComplete(){this.stop()}stop(){if(this._log(`query:done in ${Date.now()-this._startTime}ms`),this._run&&this._log(`${this._run.errors.length} of ${this._run.peersSeen.size} peers errored (${this._run.errors.length/this._run.peersSeen.size*100}% fail rate)`),!this.running)return;this._run.removeListener("start",this._onStart),this._run.removeListener("complete",this._onComplete),this.running=!1,this._run&&this._run.stop(),this.dht._queryManager.queryCompleted(this)}}var yr=Ws;const Ys=ye.Record;var Js=e=>{const t=async(a,i)=>e.datastore.put(O.bufferToKey(a),i),r=async a=>{e._log("getLocal %b",a);const i=await e.datastore.get(O.bufferToKey(a));e._log("found %b in local datastore",a);const o=Ys.deserialize(i);return await e._verifyRecordLocally(o),o},n=async(a,i,o)=>{const u=await O.createPutRecord(a,o);return Promise.all(i.map(async d=>{if(Ie(d.val,o))return;if(e._isSelf(d.from)){try{await e._putLocal(a,u)}catch(l){e._log.error("Failed error correcting self",l)}return}try{await e._putValueToPeer(a,u,d.from)}catch(l){e._log.error("Failed error correcting entry",l)}}))};return{async _putLocal(a,i){return t(a,i)},async put(a,i,o={}){e._log("PutValue %b",a);const u=await O.createPutRecord(a,i);await t(a,u);let d=0,l=0;await O.mapParallel(e.getClosestPeers(a,{shallow:!0}),async h=>{try{d+=1,await e._putValueToPeer(a,u,h),l+=1}catch(v){e._log.error("Failed to put to peer (%b): %s",h.id,v)}});const m=o.minPeers||d;if(m>l){const h=L(new Error(`Failed to put value to enough peers: ${l}/${m}`),"ERR_NOT_ENOUGH_PUT_PEERS");throw e._log.error(h),h}},async get(a,i={}){i.timeout=i.timeout||X.minute,e._log("_get %b",a);const o=await e.getMany(a,X.GET_MANY_RECORD_COUNT,i),u=o.map(m=>m.val);let d=0;try{d=ye.selection.bestRecord(e.selectors,a,u)}catch(m){if(m.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw m}const l=u[d];if(e._log("GetValue %b %s",a,l),!l)throw L(new Error("best value was not found"),"ERR_NOT_FOUND");return await n(a,o,l),l},async getMany(a,i,o={}){o.timeout=o.timeout||X.minute,e._log("getMany %b (%s)",a,i);let u=[],d;try{d=await r(a)}catch(E){if(i===0)throw E}if(d&&u.push({val:d.value,from:e.peerId}),u.length>=i)return u;const l=[],m=await O.convertBuffer(a),h=e.routingTable.closestPeers(m,this.kBucketSize);if(e._log("peers in rt: %d",h.length),h.length===0){const E="Failed to lookup key! No peers from routing table!";if(e._log.error(E),u.length===0)throw L(new Error(E),"ERR_NO_PEERS_IN_ROUTING_TABLE");return u}const v=new yr(e,a,(E,c)=>{const p=O.pathSize(i-u.length,c),f=[];return l.push(f),async P=>{let y,b,g;try{const A=await e._getValueOrPeers(P,a);y=A.record,b=A.peers}catch(A){if(A.code!=="ERR_INVALID_RECORD")throw A;g=A}const _={closerPeers:b};return(y&&y.value||g)&&f.push({val:y&&y.value,from:P}),f.length>=p&&(_.pathComplete=!0),_}});let w;try{await fe(v.run(h),o.timeout)}catch(E){w=E}if(v.stop(),u=[].concat.apply(u,l).slice(0,i),w&&u.length===0)throw w;return u}}};class Xs{constructor(){this.list=[]}push(e){return this.has(e.id)?!1:(this.list.push(e),!0)}has(e){const t=this.list.find(r=>r.id.isEqual(e));return Boolean(t)}toArray(){return this.list.slice()}pop(){return this.list.pop()}get length(){return this.list.length}}var Zs=Xs;class eu extends Zs{constructor(e){super();this.limit=e}push(e){return this.length<this.limit?super.push(e):!1}}var wa=eu,tu=e=>{const t=async(r,n)=>{const a=new Y(Y.TYPES.GET_PROVIDERS,n.bytes,0);return e.network.sendRequest(r,a)};return{async provide(r){e._log("provide: %s",r.toBaseEncodedString());const n=[];await e.providers.addProvider(r,e.peerId);const a=e.libp2p?e.libp2p.multiaddrs:[],i=new Y(Y.TYPES.ADD_PROVIDER,r.bytes,0);if(i.providerPeers=[{id:e.peerId,multiaddrs:a}],await O.mapParallel(e.getClosestPeers(r.bytes),async o=>{e._log("putProvider %s to %s",r.toBaseEncodedString(),o.toB58String());try{await e.network.sendMessage(o,i)}catch(u){n.push(u)}}),n.length)throw L(new Error(`Failed to provide to ${n.length} of ${e.kBucketSize} peers`,"ERR_SOME_PROVIDES_FAILED"),{errors:n})},async*findProviders(r,n={}){const a=n.timeout||X.minute,i=n.maxNumProviders||X.K;e._log("findProviders %s",r.toBaseEncodedString());const o=new wa(i),u=await e.providers.getProviders(r);if(u.forEach(h=>{const v=e.peerStore.get(h)||{};o.push({id:v.id||h,multiaddrs:(v.addresses||[]).map(w=>w.multiaddr)})}),o.length>=i){for(const h of o.toArray())yield h;return}const d=[],l=new yr(e,r.bytes,(h,v)=>{const w=O.pathSize(i-o.length,v),E=new wa(w);return d.push(E),async c=>{const p=await t(c,r),f=p.providerPeers;return e._log("(%s) found %s provider entries",e.peerId.toB58String(),f.length),f.forEach(P=>{E.push({id:P.id})}),E.length>=w?{pathComplete:!0}:{closerPeers:p.closerPeers}}}),m=e.routingTable.closestPeers(r.bytes,e.kBucketSize);try{await fe(l.run(m),a)}catch(h){if(h.name!==fe.TimeoutError.name)throw h}finally{l.stop()}if(d.forEach(h=>{h.toArray().forEach(v=>{o.push(v)})}),o.length===0)throw L(new Error("no providers found"),"ERR_NOT_FOUND");for(const h of o.toArray())yield h}}},ru=e=>{const t=async i=>{e._log("findPeerLocal %s",i.toB58String());const o=await e.routingTable.find(i),u=o&&e.peerStore.get(o);if(u)return{id:u.id,multiaddrs:u.addresses.map(d=>d.multiaddr)}},r=async(i,o)=>{const u=new Y(Y.TYPES.GET_VALUE,o,0);return e.network.sendRequest(i,u)},n=async(i,o)=>{e._log("closerPeersSingle %b from %s",i,o.toB58String());const u=await e.peerRouting._findPeerSingle(o,new Ee(i));return u.closerPeers.filter(d=>!e._isSelf(d.id)).map(d=>(e.peerStore.addressBook.add(d.id,d.multiaddrs),d))},a=async i=>{const o=O.keyForPublicKey(i),u=await r(i,o);if(!u.record||!u.record.value)throw L(`Node not responding with its public key: ${i.toB58String()}`,"ERR_INVALID_RECORD");const d=Ee.createFromPubKey(u.record.value);if(!d.isEqual(i))throw L("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");return d.pubKey};return{async _findPeerSingle(i,o){e._log("findPeerSingle %s",i.toB58String());const u=new Y(Y.TYPES.FIND_NODE,o.id,0);return e.network.sendRequest(i,u)},async findPeer(i,o={}){o.timeout=o.timeout||X.minute,e._log("findPeer %s",i.toB58String());const u=await t(i);if(u!=null)return e._log("found local"),u;const d=await O.convertPeerId(i),l=e.routingTable.closestPeers(d,e.kBucketSize);if(l.length===0)throw L(new Error("Peer lookup failed"),"ERR_LOOKUP_FAILED");const m=l.find(p=>p.isEqual(i));if(m){const p=e.peerStore.get(i);if(p)return e._log("found in peerStore"),{id:p.id,multiaddrs:p.addresses.map(f=>f.multiaddr)}}const h=new yr(e,i.id,()=>async p=>{const f=await this._findPeerSingle(p,i),P=f.closerPeers.find(y=>y.id.isEqual(i));return P?{peer:P,queryComplete:!0}:{closerPeers:f.closerPeers}});let v,w;try{w=await fe(h.run(l),o.timeout)}catch(p){v=p}if(h.stop(),v)throw v;let E=!1;if(w.paths.forEach(p=>{p.success&&(E=!0,e.peerStore.addressBook.add(p.peer.id,p.peer.multiaddrs))}),e._log("findPeer %s: %s",i.toB58String(),E),!E)throw L(new Error("No peer found"),"ERR_NOT_FOUND");const c=e.peerStore.get(i);return{id:c.id,multiaddrs:c.addresses.map(p=>p.multiaddr)}},async*getClosestPeers(i,o={shallow:!1}){e._log("getClosestPeers to %b",i);const u=await O.convertBuffer(i),d=e.routingTable.closestPeers(u,e.kBucketSize),l=new yr(e,i,()=>async v=>{const w=await n(i,v);return{closerPeers:w,pathComplete:o.shallow?!0:void 0}}),m=await l.run(d);if(!m||!m.finalSet)return[];const h=await O.sortClosestPeers(Array.from(m.finalSet),u);for(const v of h.slice(0,e.kBucketSize))yield v},async getPublicKey(i){e._log("getPublicKey %s",i.toB58String());const o=e.peerStore.get(i);if(o&&o.id.pubKey)return e._log("getPublicKey: found local copy"),o.id.pubKey;let u;try{u=await a(i)}catch(l){const m=O.keyForPublicKey(i),h=await e.get(m);u=Ur.keys.unmarshalPublicKey(h)}o.id=new Ee(i.id,null,u);const d=o.addresses.map(l=>l.multiaddr);return e.peerStore.addressBook.add(o.id,d),e.peerStore.keyBook.set(o.id,u),u}}},nu=G(function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function a(d,l,m){this.fn=d,this.context=l,this.once=m||!1}function i(d,l,m,h,v){if(typeof m!="function")throw new TypeError("The listener must be a function");var w=new a(m,h||d,v),E=r?r+l:l;return d._events[E]?d._events[E].fn?d._events[E]=[d._events[E],w]:d._events[E].push(w):(d._events[E]=w,d._eventsCount++),d}function o(d,l){--d._eventsCount===0?d._events=new n:delete d._events[l]}function u(){this._events=new n,this._eventsCount=0}u.prototype.eventNames=function(){var l=[],m,h;if(this._eventsCount===0)return l;for(h in m=this._events)t.call(m,h)&&l.push(r?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(m)):l},u.prototype.listeners=function(l){var m=r?r+l:l,h=this._events[m];if(!h)return[];if(h.fn)return[h.fn];for(var v=0,w=h.length,E=new Array(w);v<w;v++)E[v]=h[v].fn;return E},u.prototype.listenerCount=function(l){var m=r?r+l:l,h=this._events[m];return h?h.fn?1:h.length:0},u.prototype.emit=function(l,m,h,v,w,E){var c=r?r+l:l;if(!this._events[c])return!1;var p=this._events[c],f=arguments.length,P,y;if(p.fn){p.once&&this.removeListener(l,p.fn,void 0,!0);switch(f){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,m),!0;case 3:return p.fn.call(p.context,m,h),!0;case 4:return p.fn.call(p.context,m,h,v),!0;case 5:return p.fn.call(p.context,m,h,v,w),!0;case 6:return p.fn.call(p.context,m,h,v,w,E),!0}for(y=1,P=new Array(f-1);y<f;y++)P[y-1]=arguments[y];p.fn.apply(p.context,P)}else{var b=p.length,g;for(y=0;y<b;y++){p[y].once&&this.removeListener(l,p[y].fn,void 0,!0);switch(f){case 1:p[y].fn.call(p[y].context);break;case 2:p[y].fn.call(p[y].context,m);break;case 3:p[y].fn.call(p[y].context,m,h);break;case 4:p[y].fn.call(p[y].context,m,h,v);break;default:if(!P)for(g=1,P=new Array(f-1);g<f;g++)P[g-1]=arguments[g];p[y].fn.apply(p[y].context,P)}}}return!0},u.prototype.on=function(l,m,h){return i(this,l,m,h,!1)},u.prototype.once=function(l,m,h){return i(this,l,m,h,!0)},u.prototype.removeListener=function(l,m,h,v){var w=r?r+l:l;if(!this._events[w])return this;if(!m)return o(this,w),this;var E=this._events[w];if(E.fn)E.fn===m&&(!v||E.once)&&(!h||E.context===h)&&o(this,w);else{for(var c=0,p=[],f=E.length;c<f;c++)(E[c].fn!==m||v&&!E[c].once||h&&E[c].context!==h)&&p.push(E[c]);p.length?this._events[w]=p.length===1?p[0]:p:o(this,w)}return this},u.prototype.removeAllListeners=function(l){var m;return l?(m=r?r+l:l,this._events[m]&&o(this,m)):(this._events=new n,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=r,u.EventEmitter=u,e.exports=u}),au=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});function r(n,a,i){let o=0,u=n.length;for(;u>0;){const d=u/2|0;let l=o+d;i(n[l],a)<=0?(o=++l,u-=d+1):u=d}return o}t.default=r}),iu=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});class r{constructor(){this._queue=[]}enqueue(n,a){a=Object.assign({priority:0},a);const i={priority:a.priority,run:n};if(this.size&&this._queue[this.size-1].priority>=a.priority){this._queue.push(i);return}const o=au.default(this._queue,i,(u,d)=>d.priority-u.priority);this._queue.splice(o,0,i)}dequeue(){const n=this._queue.shift();return n==null?void 0:n.run}filter(n){return this._queue.filter(a=>a.priority===n.priority).map(a=>a.run)}get size(){return this._queue.length}}t.default=r}),ou=G(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});const r=()=>{},n=new fe.TimeoutError;class a extends nu{constructor(i){var o,u,d,l;super();if(this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=r,this._resolveIdle=r,i=Object.assign({carryoverConcurrencyCount:!1,intervalCap:Infinity,interval:0,concurrency:Infinity,autoStart:!0,queueClass:iu.default},i),!(typeof i.intervalCap=="number"&&i.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(u=(o=i.intervalCap)===null||o===void 0?void 0:o.toString())!==null&&u!==void 0?u:""}\` (${typeof i.intervalCap})`);if(i.interval===void 0||!(Number.isFinite(i.interval)&&i.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(l=(d=i.interval)===null||d===void 0?void 0:d.toString())!==null&&l!==void 0?l:""}\` (${typeof i.interval})`);this._carryoverConcurrencyCount=i.carryoverConcurrencyCount,this._isIntervalIgnored=i.intervalCap===Infinity||i.interval===0,this._intervalCap=i.intervalCap,this._interval=i.interval,this._queue=new i.queueClass,this._queueClass=i.queueClass,this.concurrency=i.concurrency,this._timeout=i.timeout,this._throwOnTimeout=i.throwOnTimeout===!0,this._isPaused=i.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=r,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=r,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const i=Date.now();if(this._intervalId===void 0){const o=this._intervalEnd-i;if(o<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},o)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const i=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const o=this._queue.dequeue();return o?(this.emit("active"),o(),i&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){if(this._isIntervalIgnored||this._intervalId!==void 0)return;this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(i){if(!(typeof i=="number"&&i>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${i}\` (${typeof i})`);this._concurrency=i,this._processQueue()}async add(i,o={}){return new Promise((u,d)=>{const l=async()=>{this._pendingCount++,this._intervalCount++;try{const m=this._timeout===void 0&&o.timeout===void 0?i():fe.default(Promise.resolve(i()),o.timeout===void 0?this._timeout:o.timeout,()=>{(o.throwOnTimeout===void 0?this._throwOnTimeout:o.throwOnTimeout)&&d(n);return});u(await m)}catch(m){d(m)}this._next()};this._queue.enqueue(l,o),this._tryToStartAnother(),this.emit("add")})}async addAll(i,o){return Promise.all(i.map(async u=>this.add(u,o)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){return this._queue.size===0?void 0:new Promise(i=>{const o=this._resolveEmpty;this._resolveEmpty=()=>{o(),i()}})}async onIdle(){return this._pendingCount===0&&this._queue.size===0?void 0:new Promise(i=>{const o=this._resolveIdle;this._resolveIdle=()=>{o(),i()}})}get size(){return this._queue.size}sizeBy(i){return this._queue.filter(i).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(i){this._timeout=i}}t.default=a});const{Key:su}=Pr,{default:uu}=ou;class cu{constructor(e,t,r){this.datastore=e,this._log=O.logger(t,"providers"),this.cleanupInterval=X.PROVIDERS_CLEANUP_INTERVAL,this.provideValidity=X.PROVIDERS_VALIDITY,this.lruCacheSize=r||X.PROVIDERS_LRU_CACHE_SIZE,this.providers=zn(this.lruCacheSize),this.syncQueue=new uu({concurrency:1})}start(){this._cleaner=setInterval(()=>this._cleanup(),this.cleanupInterval)}stop(){clearInterval(this._cleaner),this._cleaner=null}_cleanup(){return this.syncQueue.add(async()=>{this._log("start cleanup");const e=Date.now();let t=0,r=0;const n=new Map,a=this.datastore.batch(),i=this.datastore.query({prefix:X.PROVIDERS_KEY_PREFIX});for await(const o of i)try{const{cid:u,peerId:d}=_a(o.key),l=ka(o.value),m=Date.now(),h=m-l,v=h>this.provideValidity;if(this._log("comparing: %d - %d = %d > %d %s",m,l,h,this.provideValidity,v?"(expired)":""),v){r++,a.delete(o.key);const w=n.get(u)||new Set;w.add(d),n.set(u,w)}t++}catch(u){this._log.error(u.message)}this._log("deleting %d / %d entries",r,t),n.size&&await a.commit();for(const[o,u]of n){const d=Ge(o),l=this.providers.get(d);if(l){for(const m of u)l.delete(m);l.size===0?this.providers.remove(d):this.providers.set(d,l)}}this._log("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){const t=Ge(e);let r=this.providers.get(t);return r||(r=await du(this.datastore,e),this.providers.set(t,r)),r}async addProvider(e,t){return this.syncQueue.add(async()=>{this._log("addProvider %s",e.toBaseEncodedString());const r=await this._getProvidersMap(e);this._log("loaded %s provs",r.size);const n=Date.now();r.set(O.encodeBase32(t.id),n);const a=Ge(e);return this.providers.set(a,r),lu(this.datastore,e,t,n)})}async getProviders(e){return this.syncQueue.add(async()=>{this._log("getProviders %s",e.toBaseEncodedString());const t=await this._getProvidersMap(e);return[...t.keys()].map(r=>new Ee(O.decodeBase32(r)))})}}function Ge(e){return e=typeof e=="string"?e:O.encodeBase32(e.bytes),X.PROVIDERS_KEY_PREFIX+e}async function lu(e,t,r,n){const a=[Ge(t),"/",O.encodeBase32(r.id)].join(""),i=new su(a),o=Uint8Array.from(W.encode(n));return e.put(i,o)}function _a(e){const t=e.toString().split("/");if(t.length!==4)throw new Error("incorrectly formatted provider entry key in datastore: "+e);return{cid:t[2],peerId:t[3]}}async function du(e,t){const r=new Map,n=e.query({prefix:Ge(t)});for await(const a of n){const{peerId:i}=_a(a.key);r.set(i,ka(a.value))}return r}function ka(e){return W.decode(e)}var hu=cu,pu=async(e,t,{concurrency:r=Infinity,stopOnError:n=!0}={})=>new Promise((a,i)=>{if(typeof t!="function")throw new TypeError("Mapper function is required");if(!((Number.isSafeInteger(r)||r===Infinity)&&r>=1))throw new TypeError(`Expected \`concurrency\` to be an integer from 1 and up or \`Infinity\`, got \`${r}\` (${typeof r})`);const o=[],u=[],d=e[Symbol.iterator]();let l=!1,m=!1,h=0,v=0;const w=()=>{if(l)return;const E=d.next(),c=v;if(v++,E.done){m=!0,h===0&&(!n&&u.length!==0?i(new Ir(u)):a(o));return}h++,(async()=>{try{const p=await E.value;o[c]=await t(p,c),h--,w()}catch(p){n?(l=!0,i(p)):(u.push(p),h--,w())}})()};for(let E=0;E<r&&!(w(),m);E++);});const Pa=async(e,t,r)=>pu(new Array(e).fill(),(n,a)=>t(a),r);var Ia=Pa,fu=Pa;Ia.default=fu;const{logger:mu}=O;class yu{constructor(e,t){if(!e)throw new Error("Random Walk needs an instance of the Kademlia DHT");this._kadDHT=e,this._options={...X.defaultRandomWalk,...t},this.log=mu(e.peerId,"random-walk"),this._timeoutId=void 0}start(){if(this._timeoutId||!this._options.enabled)return;this._timeoutId=setTimeout(()=>{this._runPeriodically()},this._options.delay)}stop(){this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=void 0),this._controller&&this._controller.abort()}async _runPeriodically(){for(;this._timeoutId;){try{await this._walk(this._options.queriesPerPeriod,this._options.timeout)}catch(e){this._kadDHT._log.error("random-walk:error",e)}await new Promise(e=>{this._timeoutId=setTimeout(e,this._options.interval)})}}async _walk(e,t){this.log("start"),this._controller=new tr;try{await Ia(e,async r=>{this.log("running query %d",r);try{const n=await this._randomPeerId();if(!this._controller)return;await this._query(n,{timeout:t,signal:this._controller.signal})}catch(n){if(n&&n.code!=="ETIMEDOUT")throw this.log.error("query %d finished with error",r,n),n}this.log("finished query %d",r)})}finally{this._controller=null,this.log("finished queries")}}async _query(e,t){this.log("query:%s",e.toB58String());let r;try{r=await this._kadDHT.findPeer(e,t)}catch(n){if(n&&n.code==="ERR_NOT_FOUND")return;throw n}throw this.log("query:found",r),L(`random-walk: ACTUALLY FOUND PEER: ${r}, ${e.toB58String()}`,"ERR_FOUND_RANDOM_PEER")}async _randomPeerId(){const e=await Te(Ur.randomBytes(16),"sha2-256");return new Ee(e)}}var gu=yu;class vu{constructor(){this.queries=new Set,this.running=!1}queryStarted(e){this.queries.add(e)}queryCompleted(e){this.queries.delete(e)}start(){this.running=!0}stop(){this.running=!1;for(const e of this.queries)e.stop();this.queries.clear()}}var bu=vu;const{EventEmitter:wu}=wr,{MemoryDatastore:_u}=Pr,Ea=ye.Record;class ku extends wu{constructor({libp2p:e,dialer:t,peerId:r,peerStore:n,registrar:a,protocolPrefix:i="/ipfs",forceProtocolLegacy:o=!1,datastore:u=new _u,kBucketSize:d=X.K,clientMode:l=!1,concurrency:m=X.ALPHA,validators:h={},selectors:v={},randomWalk:w={},onPut:E=()=>{},onRemove:c=()=>{}}){super();if(!t)throw new Error("libp2p-kad-dht requires an instance of Dialer");this.libp2p=e,this.dialer=t,this.peerId=r,this.peerStore=n,this.registrar=a,this.protocol=i+(o?"":X.PROTOCOL_DHT),this.kBucketSize=d,this._clientMode=l,this.concurrency=m,this.disjointPaths=Math.ceil(this.kBucketSize/2),this.routingTable=new Go(this.peerId,this.kBucketSize),this.datastore=u,this.providers=new hu(this.datastore,this.peerId),this.validators={pk:ye.validator.validators.pk,...h},this.selectors={pk:ye.selection.selectors.pk,...v},this.network=new hs(this),this._log=O.logger(this.peerId),this.randomWalk=new gu(this,w),this._queryManager=new bu,this._running=!1,this.contentFetching=Js(this),this.contentRouting=tu(this),this.peerRouting=ru(this),this.onPut=E,this.onRemove=c}get isStarted(){return this._running}async start(){this._running=!0,this.providers.start(),this._queryManager.start(),await this.network.start(),this.randomWalk.start()}stop(){return this._running=!1,this.randomWalk.stop(),this.providers.stop(),this._queryManager.stop(),this.network.stop()}async put(e,t,r={}){return this.contentFetching.put(e,t,r)}async get(e,t={}){return this.contentFetching.get(e,t)}async getMany(e,t,r={}){return this.contentFetching.getMany(e,t,r)}async provide(e){return this.contentRouting.provide(e)}async*findProviders(e,t={}){for await(const r of this.contentRouting.findProviders(e,t))yield r}async findPeer(e,t={}){return this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={shallow:!1}){for await(const r of this.peerRouting.getClosestPeers(e,t))yield r}async getPublicKey(e){return this.peerRouting.getPublicKey(e)}_peerDiscovered(e,t){this.emit("peer",{id:e,multiaddrs:t})}async _nearestPeersToQuery(e){const t=await O.convertBuffer(e.key),r=this.routingTable.closestPeers(t,this.kBucketSize);return r.map(n=>{const a=this.peerStore.get(n);return{id:n,multiaddrs:a?a.addresses.map(i=>i.multiaddr):[]}})}async _betterPeersToQuery(e,t){this._log("betterPeersToQuery");const r=await this._nearestPeersToQuery(e);return r.filter(n=>this._isSelf(n.id)?(this._log.error("trying to return self as closer"),!1):!n.id.isEqual(t))}async _checkLocalDatastore(e){this._log("checkLocalDatastore: %b",e);const t=O.bufferToKey(e);let r;try{r=await this.datastore.get(t)}catch(a){if(a.code==="ERR_NOT_FOUND")return;throw a}const n=Ea.deserialize(r);if(!n)throw L("Invalid record","ERR_INVALID_RECORD");if(n.timeReceived==null||O.now()-n.timeReceived>X.MAX_RECORD_AGE){await this.datastore.delete(t),this.onRemove(n);return}return n}async _add(e){await this.routingTable.add(e)}async _verifyRecordLocally(e){this._log("verifyRecordLocally"),await ye.validator.verifyRecord(this.validators,e)}_isSelf(e){return e&&Ie(this.peerId.id,e.id)}async _putValueToPeer(e,t,r){const n=new Y(Y.TYPES.PUT_VALUE,e,0);n.record=t;const a=await this.network.sendRequest(r,n);if(!a.record.value.equals(Ea.deserialize(t).value))throw L(new Error("value not put correctly"),"ERR_PUT_VALUE_INVALID")}async _getValueOrPeers(e,t){const r=await this._getValueSingle(e,t),n=r.closerPeers,a=r.record;if(a){try{await this._verifyRecordOnline(a)}catch(i){const o="invalid record received, discarded";throw this._log(o),L(new Error(o),"ERR_INVALID_RECORD")}return{record:a,peers:n}}if(n.length>0)return{peers:n};throw L(new Error("Not found"),"ERR_NOT_FOUND")}async _getValueSingle(e,t){const r=new Y(Y.TYPES.GET_VALUE,t,0);return this.network.sendRequest(e,r)}async _verifyRecordOnline(e){await ye.validator.verifyRecord(this.validators,e)}}var gr=ku,Aa="/ipfs"+X.PROTOCOL_DHT;gr.multicodec=Aa;var Pu=Object.freeze(Object.assign(Object.create(null),gr,{default:gr,multicodec:Aa}));export{Oe as B,Ir as a,Xt as b,qe as c,tr as d,Ur as e,Te as f,gr as g,zn as h,Pu as i,fe as p,Hn as r,yn as s};
