import*as o from"https://cdn.skypack.dev/pin/three@v0.117.1-NetLzdTnw9ga3y6o633U/min/three.js";import{number as n}from"./util/number.js";export class AudioManager{constructor(t){this.conjure=t,this.buffers={},this.sounds=[],this.sources=[]}getSources(){return this.sources}getAudioContext(){return this.audioListener.context}getHasContext(){return this.audioListener!==void 0}async create(t){if(this.getHasContext())return;t&&(this.conjure.getLoadingScreen().setText(`WARNING!

This realm automatically plays audio.
Please click to continue.`),await this.conjure.getLoadingScreen().awaitInput()),this.audioListener=new o.AudioListener,await this.audioListener.context.resume(),this.conjure.camera.add(this.audioListener),this.setMasterVolume(1),this.audioLoader=new o.AudioLoader}async load(t,i){if(this.buffers[t])return;if(!i)return;await new Promise((e,s)=>{this.audioLoader.load(i,u=>(this.buffers[t]=u,e()))})}createFromMediaSource(t,i,e={}){if(!this.audioListener)return;let s=new o.PositionalAudio(this.audioListener);s.setMediaElementSource(t),s.setVolume(e.volume===void 0?1:e.volume),s.setRefDistance(e.refDistance===void 0?20:e.refDistance),i.userData.sound=s,this.sources.push(i)}play(t,i={}){if(!this.audioListener||!this.buffers[t])return;let e=i.positional?new o.PositionalAudio(this.audioListener):new o.Audio(this.audioListener);return e.setBuffer(this.buffers[t]),e.setLoop(Boolean(i.loop)),e.setVolume(i.volume===void 0?1:i.volume),i.positional&&e.setRefDistance(i.refDistance===void 0?20:i.refDistance),e.play(),e.onEnded=()=>{for(let s in this.sounds)e===this.sounds[s]&&this.sounds.slice(s,1)},this.sounds.push(e),e}setMasterVolume(t){if(!this.audioListener)return;this.audioListener.setMasterVolume(n(t)),this.updateSources()}async toggleMute(){return this.audioListener||await this.create(!1),this.audioListener.setMasterVolume(this.audioListener.getMasterVolume()===0?1:0),this.updateSources(),this.audioListener.getMasterVolume()}updateSources(){for(let t of this.sources)t.userData.media.volume=this.audioListener.getMasterVolume()}}
