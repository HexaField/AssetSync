import{E as x,e as Se}from"./common/events-18451fd5.js";import{n as O,p as F}from"./common/process-e9e98960.js";import{g as R,B as d,i as Ee}from"./common/buffer-es6-e6024076.js";import{d as Oe,i as q,a as ke}from"./common/util-17dff6c2.js";import{u as _e}from"./common/url-8d978716.js";class ee extends Error{constructor(e,t,r,i){super();Object.defineProperty(this,"req",{enumerable:!1,value:e,writable:!1}),Object.defineProperty(this,"res",{enumerable:!1,value:t,writable:!1}),Object.defineProperty(this,"response",{enumerable:!1,value:r,writable:!1}),Object.defineProperty(this,"code",{value:t.statusCode,writable:!1});let n=`${this.name}: ${t.statusCode} ${t.statusMessage} on ${e.method} ${e.path}`;const s=this.flattenErrors(r);s.length>0&&(n+=`
  `+s.join(`
  `)),Object.defineProperty(this,"message",{value:n,writable:!1}),i?Object.defineProperty(this,"stack",{value:this.message+`
`+i,writable:!1}):Error.captureStackTrace(this,ee)}get name(){return this.constructor.name}flattenErrors(e,t=""){let r=[];for(const i in e){if(!e.hasOwnProperty(i)||i==="message"||i==="code")continue;Array.isArray(e[i])&&(r=r.concat(e[i].map(n=>`${t+i}: ${n}`)))}return r}}var Ie=ee;class te extends Error{constructor(e,t,r,i){super();Object.defineProperty(this,"req",{enumerable:!1,value:e,writable:!1}),Object.defineProperty(this,"res",{enumerable:!1,value:t,writable:!1}),Object.defineProperty(this,"response",{enumerable:!1,value:r,writable:!1}),Object.defineProperty(this,"code",{value:+r.code||-1,writable:!1});let n=this.name+": "+(r.message||"Unknown error");if(r.errors)n+=`
  `+this.flattenErrors(r.errors).join(`
  `);else{const s=this.flattenErrors(r);s.length>0&&(n+=`
  `+s.join(`
  `))}Object.defineProperty(this,"message",{value:n,writable:!1}),i?Object.defineProperty(this,"stack",{value:this.message+`
`+i,writable:!1}):Error.captureStackTrace(this,te)}get name(){return`${this.constructor.name} [${this.code}]`}flattenErrors(e,t=""){let r=[];for(const i in e){if(!e.hasOwnProperty(i)||i==="message"||i==="code")continue;e[i]._errors?r=r.concat(e[i]._errors.map(n=>`${t+i}: ${n.message}`)):Array.isArray(e[i])?r=r.concat(e[i].map(n=>`${t+i}: ${n}`)):typeof e[i]=="object"&&(r=r.concat(this.flattenErrors(e[i],t+i+".")))}return r}}var Ae=te,U=D(R.fetch)&&D(R.ReadableStream),L;function Ce(){if(typeof L!="undefined")return L;try{new R.Blob([new ArrayBuffer(1)]),L=!0}catch(e){L=!1}return L}var C;function W(e){C||(C=new R.XMLHttpRequest,C.open("GET",R.location.host?"/":"https://example.com"));try{return C.responseType=e,C.responseType===e}catch(t){return!1}}var $=typeof R.ArrayBuffer!="undefined",Ne=$&&D(R.ArrayBuffer.prototype.slice),Me=$&&W("arraybuffer"),xe=!U&&Ne&&W("ms-stream"),qe=!U&&$&&W("moz-chunked-arraybuffer"),re=D(C.overrideMimeType),Le=D(R.VBArray);function D(e){return typeof e=="function"}C=null;function N(){this.head=null,this.tail=null,this.length=0}N.prototype.push=function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length},N.prototype.unshift=function(e){var t={data:e,next:this.head};this.length===0&&(this.tail=t),this.head=t,++this.length},N.prototype.shift=function(){if(this.length===0)return;var e=this.head.data;return this.length===1?this.head=this.tail=null:this.head=this.head.next,--this.length,e},N.prototype.clear=function(){this.head=this.tail=null,this.length=0},N.prototype.join=function(e){if(this.length===0)return"";for(var t=this.head,r=""+t.data;t=t.next;)r+=e+t.data;return r},N.prototype.concat=function(e){if(this.length===0)return d.alloc(0);if(this.length===1)return this.head.data;for(var t=d.allocUnsafe(e>>>0),r=this.head,i=0;r;)r.data.copy(t,i),i+=r.data.length,r=r.next;return t};var De=d.isEncoding||function(e){switch(e&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function He(e){if(e&&!De(e))throw new Error("Unknown encoding: "+e)}function H(e){this.encoding=(e||"utf8").toLowerCase().replace(/[-_]/,""),He(e);switch(this.encoding){case"utf8":this.surrogateSize=3;break;case"ucs2":case"utf16le":this.surrogateSize=2,this.detectIncompleteChar=Be;break;case"base64":this.surrogateSize=3,this.detectIncompleteChar=Pe;break;default:this.write=je;return}this.charBuffer=new d(6),this.charReceived=0,this.charLength=0}H.prototype.write=function(e){for(var t="";this.charLength;){var r=e.length>=this.charLength-this.charReceived?this.charLength-this.charReceived:e.length;if(e.copy(this.charBuffer,this.charReceived,0,r),this.charReceived+=r,this.charReceived<this.charLength)return"";e=e.slice(r,e.length),t=this.charBuffer.slice(0,this.charLength).toString(this.encoding);var n=t.charCodeAt(t.length-1);if(n>=55296&&n<=56319){this.charLength+=this.surrogateSize,t="";continue}if(this.charReceived=this.charLength=0,e.length===0)return t;break}this.detectIncompleteChar(e);var i=e.length;this.charLength&&(e.copy(this.charBuffer,0,e.length-this.charReceived,i),i-=this.charReceived),t+=e.toString(this.encoding,0,i);var i=t.length-1,n=t.charCodeAt(i);if(n>=55296&&n<=56319){var s=this.surrogateSize;return this.charLength+=s,this.charReceived+=s,this.charBuffer.copy(this.charBuffer,s,0,s),e.copy(this.charBuffer,0,0,s),t.substring(0,i)}return t},H.prototype.detectIncompleteChar=function(e){for(var t=e.length>=3?3:e.length;t>0;t--){var r=e[e.length-t];if(t==1&&r>>5==6){this.charLength=2;break}if(t<=2&&r>>4==14){this.charLength=3;break}if(t<=3&&r>>3==30){this.charLength=4;break}}this.charReceived=t},H.prototype.end=function(e){var t="";if(e&&e.length&&(t=this.write(e)),this.charReceived){var r=this.charReceived,i=this.charBuffer,n=this.encoding;t+=i.slice(0,r).toString(n)}return t};function je(e){return e.toString(this.encoding)}function Be(e){this.charReceived=e.length%2,this.charLength=this.charReceived?2:0}function Pe(e){this.charReceived=e.length%3,this.charLength=this.charReceived?3:0}l.ReadableState=ie;var h=Oe("stream");q(l,x);function Fe(e,t,r){if(typeof e.prependListener=="function")return e.prependListener(t,r);!e._events||!e._events[t]?e.on(t,r):Array.isArray(e._events[t])?e._events[t].unshift(r):e._events[t]=[r,e._events[t]]}function Ue(e,t){return e.listeners(t).length}function ie(e,t){e=e||{},this.objectMode=!!e.objectMode,t instanceof I&&(this.objectMode=this.objectMode||!!e.readableObjectMode);var r=e.highWaterMark,i=this.objectMode?16:16*1024;this.highWaterMark=r||r===0?r:i,this.highWaterMark=~~this.highWaterMark,this.buffer=new N,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(this.decoder=new H(e.encoding),this.encoding=e.encoding)}function l(e){if(!(this instanceof l))return new l(e);this._readableState=new ie(e,this),this.readable=!0,e&&typeof e.read=="function"&&(this._read=e.read),x.call(this)}l.prototype.push=function(e,t){var r=this._readableState;return!r.objectMode&&typeof e=="string"&&(t=t||r.defaultEncoding,t!==r.encoding&&(e=d.from(e,t),t="")),ne(this,r,e,t,!1)},l.prototype.unshift=function(e){var t=this._readableState;return ne(this,t,e,"",!0)},l.prototype.isPaused=function(){return this._readableState.flowing===!1};function ne(e,t,r,i,n){var s=Ge(t,r);if(s)e.emit("error",s);else if(r===null)t.reading=!1,Ye(e,t);else if(t.objectMode||r&&r.length>0)if(t.ended&&!n){var a=new Error("stream.push() after EOF");e.emit("error",a)}else if(t.endEmitted&&n){var c=new Error("stream.unshift() after end event");e.emit("error",c)}else{var b;t.decoder&&!n&&!i&&(r=t.decoder.write(r),b=!t.objectMode&&r.length===0),n||(t.reading=!1),b||(t.flowing&&t.length===0&&!t.sync?(e.emit("data",r),e.read(0)):(t.length+=t.objectMode?1:r.length,n?t.buffer.unshift(r):t.buffer.push(r),t.needReadable&&j(e))),Xe(e,t)}else n||(t.reading=!1);return We(t)}function We(e){return!e.ended&&(e.needReadable||e.length<e.highWaterMark||e.length===0)}l.prototype.setEncoding=function(e){return this._readableState.decoder=new H(e),this._readableState.encoding=e,this};var ae=8388608;function $e(e){return e>=ae?e=ae:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}function se(e,t){return e<=0||t.length===0&&t.ended?0:t.objectMode?1:e!==e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=$e(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}l.prototype.read=function(e){h("read",e),e=parseInt(e,10);var t=this._readableState,r=e;if(e!==0&&(t.emittedReadable=!1),e===0&&t.needReadable&&(t.length>=t.highWaterMark||t.ended))return h("read: emitReadable",t.length,t.ended),t.length===0&&t.ended?Y(this):j(this),null;if(e=se(e,t),e===0&&t.ended)return t.length===0&&Y(this),null;var i=t.needReadable;h("need readable",i),(t.length===0||t.length-e<t.highWaterMark)&&(i=!0,h("length less than watermark",i)),t.ended||t.reading?(i=!1,h("reading or ended",i)):i&&(h("do read"),t.reading=!0,t.sync=!0,t.length===0&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=se(r,t)));var n;return e>0?n=he(e,t):n=null,n===null?(t.needReadable=!0,e=0):t.length-=e,t.length===0&&(t.ended||(t.needReadable=!0),r!==e&&t.ended&&Y(this)),n!==null&&this.emit("data",n),n};function Ge(e,t){var r=null;return!d.isBuffer(t)&&typeof t!="string"&&t!==null&&t!==void 0&&!e.objectMode&&(r=new TypeError("Invalid non-string/buffer chunk")),r}function Ye(e,t){if(t.ended)return;if(t.decoder){var r=t.decoder.end();r&&r.length&&(t.buffer.push(r),t.length+=t.objectMode?1:r.length)}t.ended=!0,j(e)}function j(e){var t=e._readableState;t.needReadable=!1,t.emittedReadable||(h("emitReadable",t.flowing),t.emittedReadable=!0,t.sync?O(oe,e):oe(e))}function oe(e){h("emit readable"),e.emit("readable"),G(e)}function Xe(e,t){t.readingMore||(t.readingMore=!0,O(ze,e,t))}function ze(e,t){for(var r=t.length;!t.reading&&!t.flowing&&!t.ended&&t.length<t.highWaterMark&&!(h("maybeReadMore read 0"),e.read(0),r===t.length);)r=t.length;t.readingMore=!1}l.prototype._read=function(e){this.emit("error",new Error("not implemented"))},l.prototype.pipe=function(e,t){var r=this,i=this._readableState;switch(i.pipesCount){case 0:i.pipes=e;break;case 1:i.pipes=[i.pipes,e];break;default:i.pipes.push(e);break}i.pipesCount+=1,h("pipe count=%d opts=%j",i.pipesCount,t);var n=!t||t.end!==!1,s=n?c:k;i.endEmitted?O(s):r.once("end",s),e.on("unpipe",a);function a(S){h("onunpipe"),S===r&&k()}function c(){h("onend"),e.end()}var b=Ve(r);e.on("drain",b);var g=!1;function k(){h("cleanup"),e.removeListener("close",y),e.removeListener("finish",v),e.removeListener("drain",b),e.removeListener("error",w),e.removeListener("unpipe",a),r.removeListener("end",c),r.removeListener("end",k),r.removeListener("data",f),g=!0,i.awaitDrain&&(!e._writableState||e._writableState.needDrain)&&b()}var _=!1;r.on("data",f);function f(S){h("ondata"),_=!1;var o=e.write(S);o===!1&&!_&&((i.pipesCount===1&&i.pipes===e||i.pipesCount>1&&le(i.pipes,e)!==-1)&&!g&&(h("false write response, pause",r._readableState.awaitDrain),r._readableState.awaitDrain++,_=!0),r.pause())}function w(S){h("onerror",S),T(),e.removeListener("error",w),Ue(e,"error")===0&&e.emit("error",S)}Fe(e,"error",w);function y(){e.removeListener("finish",v),T()}e.once("close",y);function v(){h("onfinish"),e.removeListener("close",y),T()}e.once("finish",v);function T(){h("unpipe"),r.unpipe(e)}return e.emit("pipe",r),i.flowing||(h("pipe resume"),r.resume()),e};function Ve(e){return function(){var t=e._readableState;h("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,t.awaitDrain===0&&e.listeners("data").length&&(t.flowing=!0,G(e))}}l.prototype.unpipe=function(e){var t=this._readableState;if(t.pipesCount===0)return this;if(t.pipesCount===1)return e&&e!==t.pipes?this:(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this),this);if(!e){var r=t.pipes,i=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var n=0;n<i;n++)r[n].emit("unpipe",this);return this}var s=le(t.pipes,e);return s===-1?this:(t.pipes.splice(s,1),t.pipesCount-=1,t.pipesCount===1&&(t.pipes=t.pipes[0]),e.emit("unpipe",this),this)},l.prototype.on=function(e,t){var r=x.prototype.on.call(this,e,t);if(e==="data")this._readableState.flowing!==!1&&this.resume();else if(e==="readable"){var i=this._readableState;!i.endEmitted&&!i.readableListening&&(i.readableListening=i.needReadable=!0,i.emittedReadable=!1,i.reading?i.length&&j(this):O(Ke,this))}return r},l.prototype.addListener=l.prototype.on;function Ke(e){h("readable nexttick read 0"),e.read(0)}l.prototype.resume=function(){var e=this._readableState;return e.flowing||(h("resume"),e.flowing=!0,Je(this,e)),this};function Je(e,t){t.resumeScheduled||(t.resumeScheduled=!0,O(Qe,e,t))}function Qe(e,t){t.reading||(h("resume read 0"),e.read(0)),t.resumeScheduled=!1,t.awaitDrain=0,e.emit("resume"),G(e),t.flowing&&!t.reading&&e.read(0)}l.prototype.pause=function(){return h("call pause flowing=%j",this._readableState.flowing),this._readableState.flowing!==!1&&(h("pause"),this._readableState.flowing=!1,this.emit("pause")),this};function G(e){var t=e._readableState;for(h("flow",t.flowing);t.flowing&&e.read()!==null;);}l.prototype.wrap=function(e){var t=this._readableState,r=!1,i=this;e.on("end",function(){if(h("wrapped end"),t.decoder&&!t.ended){var a=t.decoder.end();a&&a.length&&i.push(a)}i.push(null)}),e.on("data",function(a){if(h("wrapped data"),t.decoder&&(a=t.decoder.write(a)),t.objectMode&&a==null)return;if(!t.objectMode&&(!a||!a.length))return;var c=i.push(a);c||(r=!0,e.pause())});for(var n in e)this[n]===void 0&&typeof e[n]=="function"&&(this[n]=function(a){return function(){return e[a].apply(e,arguments)}}(n));var s=["error","close","destroy","pause","resume"];return it(s,function(a){e.on(a,i.emit.bind(i,a))}),i._read=function(a){h("wrapped _read",a),r&&(r=!1,e.resume())},i},l._fromList=he;function he(e,t){if(t.length===0)return null;var r;return t.objectMode?r=t.buffer.shift():!e||e>=t.length?(t.decoder?r=t.buffer.join(""):t.buffer.length===1?r=t.buffer.head.data:r=t.buffer.concat(t.length),t.buffer.clear()):r=Ze(e,t.buffer,t.decoder),r}function Ze(e,t,r){var i;return e<t.head.data.length?(i=t.head.data.slice(0,e),t.head.data=t.head.data.slice(e)):e===t.head.data.length?i=t.shift():i=r?et(e,t):tt(e,t),i}function et(e,t){var r=t.head,i=1,n=r.data;for(e-=n.length;r=r.next;){var s=r.data,a=e>s.length?s.length:e;if(a===s.length?n+=s:n+=s.slice(0,e),e-=a,e===0){a===s.length?(++i,r.next?t.head=r.next:t.head=t.tail=null):(t.head=r,r.data=s.slice(a));break}++i}return t.length-=i,n}function tt(e,t){var r=d.allocUnsafe(e),i=t.head,n=1;for(i.data.copy(r),e-=i.data.length;i=i.next;){var s=i.data,a=e>s.length?s.length:e;if(s.copy(r,r.length-e,0,a),e-=a,e===0){a===s.length?(++n,i.next?t.head=i.next:t.head=t.tail=null):(t.head=i,i.data=s.slice(a));break}++n}return t.length-=n,r}function Y(e){var t=e._readableState;if(t.length>0)throw new Error('"endReadable()" called on non-empty stream');t.endEmitted||(t.ended=!0,O(rt,t,e))}function rt(e,t){!e.endEmitted&&e.length===0&&(e.endEmitted=!0,t.readable=!1,t.emit("end"))}function it(e,t){for(var r=0,i=e.length;r<i;r++)t(e[r],r)}function le(e,t){for(var r=0,i=e.length;r<i;r++)if(e[r]===t)return r;return-1}u.WritableState=X,q(u,x);function nt(){}function at(e,t,r){this.chunk=e,this.encoding=t,this.callback=r,this.next=null}function X(e,t){Object.defineProperty(this,"buffer",{get:ke(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.")}),e=e||{},this.objectMode=!!e.objectMode,t instanceof I&&(this.objectMode=this.objectMode||!!e.writableObjectMode);var r=e.highWaterMark,i=this.objectMode?16:16*1024;this.highWaterMark=r||r===0?r:i,this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var n=e.decodeStrings===!1;this.decodeStrings=!n,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(s){ut(t,s)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new ge(this)}X.prototype.getBuffer=function(){for(var t=this.bufferedRequest,r=[];t;)r.push(t),t=t.next;return r};function u(e){if(!(this instanceof u)&&!(this instanceof I))return new u(e);this._writableState=new X(e,this),this.writable=!0,e&&(typeof e.write=="function"&&(this._write=e.write),typeof e.writev=="function"&&(this._writev=e.writev)),x.call(this)}u.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))};function st(e,t){var r=new Error("write after end");e.emit("error",r),O(t,r)}function ot(e,t,r,i){var n=!0,s=!1;return r===null?s=new TypeError("May not write null values to stream"):!d.isBuffer(r)&&typeof r!="string"&&r!==void 0&&!t.objectMode&&(s=new TypeError("Invalid non-string/buffer chunk")),s&&(e.emit("error",s),O(i,s),n=!1),n}u.prototype.write=function(e,t,r){var i=this._writableState,n=!1;return typeof t=="function"&&(r=t,t=null),d.isBuffer(e)?t="buffer":t||(t=i.defaultEncoding),typeof r!="function"&&(r=nt),i.ended?st(this,r):ot(this,i,e,r)&&(i.pendingcb++,n=lt(this,i,e,t,r)),n},u.prototype.cork=function(){var e=this._writableState;e.corked++},u.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,!e.writing&&!e.corked&&!e.finished&&!e.bufferProcessing&&e.bufferedRequest&&de(this,e))},u.prototype.setDefaultEncoding=function(t){if(typeof t=="string"&&(t=t.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((t+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+t);return this._writableState.defaultEncoding=t,this};function ht(e,t,r){return!e.objectMode&&e.decodeStrings!==!1&&typeof t=="string"&&(t=d.from(t,r)),t}function lt(e,t,r,i,n){r=ht(t,r,i),d.isBuffer(r)&&(i="buffer");var s=t.objectMode?1:r.length;t.length+=s;var a=t.length<t.highWaterMark;if(a||(t.needDrain=!0),t.writing||t.corked){var c=t.lastBufferedRequest;t.lastBufferedRequest=new at(r,i,n),c?c.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else z(e,t,!1,s,r,i,n);return a}function z(e,t,r,i,n,s,a){t.writelen=i,t.writecb=a,t.writing=!0,t.sync=!0,r?e._writev(n,t.onwrite):e._write(n,s,t.onwrite),t.sync=!1}function ct(e,t,r,i,n){--t.pendingcb,r?O(n,i):n(i),e._writableState.errorEmitted=!0,e.emit("error",i)}function dt(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}function ut(e,t){var r=e._writableState,i=r.sync,n=r.writecb;if(dt(r),t)ct(e,r,i,t,n);else{var s=ue(r);!s&&!r.corked&&!r.bufferProcessing&&r.bufferedRequest&&de(e,r),i?O(ce,e,r,s,n):ce(e,r,s,n)}}function ce(e,t,r,i){r||ft(e,t),t.pendingcb--,i(),pe(e,t)}function ft(e,t){t.length===0&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}function de(e,t){t.bufferProcessing=!0;var r=t.bufferedRequest;if(e._writev&&r&&r.next){var i=t.bufferedRequestCount,n=new Array(i),s=t.corkedRequestsFree;s.entry=r;for(var a=0;r;)n[a]=r,r=r.next,a+=1;z(e,t,!0,t.length,n,"",s.finish),t.pendingcb++,t.lastBufferedRequest=null,s.next?(t.corkedRequestsFree=s.next,s.next=null):t.corkedRequestsFree=new ge(t)}else{for(;r;){var c=r.chunk,b=r.encoding,g=r.callback,k=t.objectMode?1:c.length;if(z(e,t,!1,k,c,b,g),r=r.next,t.writing)break}r===null&&(t.lastBufferedRequest=null)}t.bufferedRequestCount=0,t.bufferedRequest=r,t.bufferProcessing=!1}u.prototype._write=function(e,t,r){r(new Error("not implemented"))},u.prototype._writev=null,u.prototype.end=function(e,t,r){var i=this._writableState;typeof e=="function"?(r=e,e=null,t=null):typeof t=="function"&&(r=t,t=null),e!=null&&this.write(e,t),i.corked&&(i.corked=1,this.uncork()),!i.ending&&!i.finished&&pt(this,i,r)};function ue(e){return e.ending&&e.length===0&&e.bufferedRequest===null&&!e.finished&&!e.writing}function fe(e,t){t.prefinished||(t.prefinished=!0,e.emit("prefinish"))}function pe(e,t){var r=ue(t);return r&&(t.pendingcb===0?(fe(e,t),t.finished=!0,e.emit("finish")):fe(e,t)),r}function pt(e,t,r){t.ending=!0,pe(e,t),r&&(t.finished?O(r):e.once("finish",r)),t.ended=!0,e.writable=!1}function ge(e){var t=this;this.next=null,this.entry=null,this.finish=function(r){var i=t.entry;for(t.entry=null;i;){var n=i.callback;e.pendingcb--,n(r),i=i.next}e.corkedRequestsFree?e.corkedRequestsFree.next=t:e.corkedRequestsFree=t}}q(I,l);for(var me=Object.keys(u.prototype),V=0;V<me.length;V++){var K=me[V];I.prototype[K]||(I.prototype[K]=u.prototype[K])}function I(e){if(!(this instanceof I))return new I(e);l.call(this,e),u.call(this,e),e&&e.readable===!1&&(this.readable=!1),e&&e.writable===!1&&(this.writable=!1),this.allowHalfOpen=!0,e&&e.allowHalfOpen===!1&&(this.allowHalfOpen=!1),this.once("end",gt)}function gt(){if(this.allowHalfOpen||this._writableState.ended)return;O(mt,this)}function mt(e){e.end()}var M={UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4};function B(e,t,r){var i=this;l.call(i),i._mode=r,i.headers={},i.rawHeaders=[],i.trailers={},i.rawTrailers=[],i.on("end",function(){F.nextTick(function(){i.emit("close")})});var n;if(r==="fetch"){i._fetchResponse=t,i.url=t.url,i.statusCode=t.status,i.statusMessage=t.statusText;for(var s,a,c=t.headers[Symbol.iterator]();s=(a=c.next()).value,!a.done;)i.headers[s[0].toLowerCase()]=s[1],i.rawHeaders.push(s[0],s[1]);var b=t.body.getReader();n=function(){b.read().then(function(f){if(i._destroyed)return;if(f.done){i.push(null);return}i.push(new d(f.value)),n()})},n()}else{i._xhr=e,i._pos=0,i.url=e.responseURL,i.statusCode=e.status,i.statusMessage=e.statusText;var g=e.getAllResponseHeaders().split(/\r?\n/);if(g.forEach(function(f){var w=f.match(/^([^:]+):\s*(.*)/);if(w){var y=w[1].toLowerCase();y==="set-cookie"?(i.headers[y]===void 0&&(i.headers[y]=[]),i.headers[y].push(w[2])):i.headers[y]!==void 0?i.headers[y]+=", "+w[2]:i.headers[y]=w[2],i.rawHeaders.push(w[1],w[2])}}),i._charset="x-user-defined",!re){var k=i.rawHeaders["mime-type"];if(k){var _=k.match(/;\s*charset=([^;])(;|$)/);_&&(i._charset=_[1].toLowerCase())}i._charset||(i._charset="utf-8")}}}q(B,l),B.prototype._read=function(){},B.prototype._onXHRProgress=function(){var e=this,t=e._xhr,r=null;switch(e._mode){case"text:vbarray":if(t.readyState!==M.DONE)break;try{r=new R.VBArray(t.responseBody).toArray()}catch(c){}if(r!==null){e.push(new d(r));break}case"text":try{r=t.responseText}catch(c){e._mode="text:vbarray";break}if(r.length>e._pos){var i=r.substr(e._pos);if(e._charset==="x-user-defined"){for(var n=new d(i.length),s=0;s<i.length;s++)n[s]=i.charCodeAt(s)&255;e.push(n)}else e.push(i,e._charset);e._pos=r.length}break;case"arraybuffer":if(t.readyState!==M.DONE||!t.response)break;r=t.response,e.push(new d(new Uint8Array(r)));break;case"moz-chunked-arraybuffer":if(r=t.response,t.readyState!==M.LOADING||!r)break;e.push(new d(new Uint8Array(r)));break;case"ms-stream":if(r=t.response,t.readyState!==M.LOADING)break;var a=new R.MSStreamReader;a.onprogress=function(){a.result.byteLength>e._pos&&(e.push(new d(new Uint8Array(a.result.slice(e._pos)))),e._pos=a.result.byteLength)},a.onload=function(){e.push(null)},a.readAsArrayBuffer(r);break}e._xhr.readyState===M.DONE&&e._mode!=="ms-stream"&&e.push(null)};function bt(e){if(e instanceof Uint8Array){if(e.byteOffset===0&&e.byteLength===e.buffer.byteLength)return e.buffer;if(typeof e.buffer.slice=="function")return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}if(Ee(e)){for(var t=new Uint8Array(e.length),r=e.length,i=0;i<r;i++)t[i]=e[i];return t.buffer}else throw new Error("Argument must be a Buffer")}function wt(e,t){return U&&t?"fetch":qe?"moz-chunked-arraybuffer":xe?"ms-stream":Me&&e?"arraybuffer":Le&&e?"text:vbarray":"text"}function m(e){var t=this;u.call(t),t._opts=e,t._body=[],t._headers={},e.auth&&t.setHeader("Authorization","Basic "+new d(e.auth).toString("base64")),Object.keys(e.headers).forEach(function(n){t.setHeader(n,e.headers[n])});var r,i=!0;if(e.mode==="disable-fetch")i=!1,r=!0;else if(e.mode==="prefer-streaming")r=!1;else if(e.mode==="allow-wrong-content-type")r=!re;else if(!e.mode||e.mode==="default"||e.mode==="prefer-fast")r=!0;else throw new Error("Invalid value for opts.mode");t._mode=wt(r,i),t.on("finish",function(){t._onFinish()})}q(m,u);var yt=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","date","dnt","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","user-agent","via"];m.prototype.setHeader=function(e,t){var r=this,i=e.toLowerCase();if(yt.indexOf(i)!==-1)return;r._headers[i]={name:e,value:t}},m.prototype.getHeader=function(e){var t=this;return t._headers[e.toLowerCase()].value},m.prototype.removeHeader=function(e){var t=this;delete t._headers[e.toLowerCase()]},m.prototype._onFinish=function(){var e=this;if(e._destroyed)return;var t=e._opts,r=e._headers,i;if((t.method==="POST"||t.method==="PUT"||t.method==="PATCH")&&(Ce()?i=new R.Blob(e._body.map(function(a){return bt(a)}),{type:(r["content-type"]||{}).value||""}):i=d.concat(e._body).toString()),e._mode==="fetch"){var n=Object.keys(r).map(function(a){return[r[a].name,r[a].value]});R.fetch(e._opts.url,{method:e._opts.method,headers:n,body:i,mode:"cors",credentials:t.withCredentials?"include":"same-origin"}).then(function(a){e._fetchResponse=a,e._connect()},function(a){e.emit("error",a)})}else{var s=e._xhr=new R.XMLHttpRequest;try{s.open(e._opts.method,e._opts.url,!0)}catch(a){F.nextTick(function(){e.emit("error",a)});return}"responseType"in s&&(s.responseType=e._mode.split(":")[0]),"withCredentials"in s&&(s.withCredentials=!!t.withCredentials),e._mode==="text"&&"overrideMimeType"in s&&s.overrideMimeType("text/plain; charset=x-user-defined"),Object.keys(r).forEach(function(a){s.setRequestHeader(r[a].name,r[a].value)}),e._response=null,s.onreadystatechange=function(){switch(s.readyState){case M.LOADING:case M.DONE:e._onXHRProgress();break}},e._mode==="moz-chunked-arraybuffer"&&(s.onprogress=function(){e._onXHRProgress()}),s.onerror=function(){if(e._destroyed)return;e.emit("error",new Error("XHR error"))};try{s.send(i)}catch(a){F.nextTick(function(){e.emit("error",a)});return}}};function vt(e){try{var t=e.status;return t!==null&&t!==0}catch(r){return!1}}m.prototype._onXHRProgress=function(){var e=this;if(!vt(e._xhr)||e._destroyed)return;e._response||e._connect(),e._response._onXHRProgress()},m.prototype._connect=function(){var e=this;if(e._destroyed)return;e._response=new B(e._xhr,e._fetchResponse,e._mode),e.emit("response",e._response)},m.prototype._write=function(e,t,r){var i=this;i._body.push(e),r()},m.prototype.abort=m.prototype.destroy=function(){var e=this;e._destroyed=!0,e._response&&(e._response._destroyed=!0),e._xhr&&e._xhr.abort()},m.prototype.end=function(e,t,r){var i=this;typeof e=="function"&&(r=e,e=void 0),u.prototype.end.call(i,e,t,r)},m.prototype.flushHeaders=function(){},m.prototype.setTimeout=function(){},m.prototype.setNoDelay=function(){},m.prototype.setSocketKeepAlive=function(){};function J(e,t){typeof e=="string"&&(e=_e(e));var r=R.location.protocol.search(/^https?:$/)===-1?"http:":"",i=e.protocol||r,n=e.hostname||e.host,s=e.port,a=e.path||"/";n&&n.indexOf(":")!==-1&&(n="["+n+"]"),e.url=(n?i+"//"+n:"")+(s?":"+s:"")+a,e.method=(e.method||"GET").toUpperCase(),e.headers=e.headers||{};var c=new m(e);return t&&c.on("response",t),c}function be(e,t){var r=J(e,t);return r.end(),r}function Q(){}Q.defaultMaxSockets=4;var we=["CHECKOUT","CONNECT","COPY","DELETE","GET","HEAD","LOCK","M-SEARCH","MERGE","MKACTIVITY","MKCOL","MOVE","NOTIFY","OPTIONS","PATCH","POST","PROPFIND","PROPPATCH","PURGE","PUT","REPORT","SEARCH","SUBSCRIBE","TRACE","UNLOCK","UNSUBSCRIBE"],ye={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Time-out",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Large",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Unordered Collection",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Time-out",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",509:"Bandwidth Limit Exceeded",510:"Not Extended",511:"Network Authentication Required"},Tt={request:J,get:be,Agent:Q,METHODS:we,STATUS_CODES:ye},Rt=Object.freeze({__proto__:null,request:J,get:be,Agent:Q,METHODS:we,STATUS_CODES:ye,default:Tt});class St{constructor(e,t={latency:0}){this.limit=this.remaining=e,this.resetInterval=0,this.reset=0,this.processing=!1,this.latencyRef=t,this._queue=[]}queue(e,t){t?this._queue.unshift(e):this._queue.push(e),this.check()}check(e){if(this._queue.length===0){this.processing&&(clearTimeout(this.processing),this.processing=!1);return}if(this.processing&&!e)return;const t=Date.now(),r=this.latencyRef.latency+(this.latencyRef.offset||0);if(this.reset?this.reset<t-r&&(this.reset=t-r+(this.resetInterval||0),this.remaining=this.limit):(this.reset=t-r,this.remaining=this.limit),this.last=t,this.remaining<=0){this.processing=setTimeout(()=>{this.processing=!1,this.check(!0)},Math.max(0,(this.reset||0)-t)+r);return}--this.remaining,this.processing=!0,this._queue.shift()(()=>{this._queue.length>0?this.check(!0):this.processing=!1})}}var ve=St;const Et="discord-oauth2",Ot="2.6.0",kt="Easily interact with discord's oauth2 API",_t="index.js",It={lint:'eslint --ext .js ./ --no-error-on-unmatched-pattern && echo "[1m[32mOK - lint[39m[22m" || echo "[1m[31mNot OK - lint[39m[22m"'},At={lib:"lib"},Ct={type:"git",url:"git+https://github.com/reboxer/discord-oauth2.git"},Nt=["api","discord","discordapp","oauth2"],Mt="reboxer",xt="MIT",qt={url:"https://github.com/reboxer/discord-oauth2/issues"},Lt="https://github.com/reboxer/discord-oauth2#readme",Dt={eslint:"^7.13.0"};var Ht={name:Et,version:Ot,description:kt,main:_t,scripts:It,directories:At,repository:Ct,keywords:Nt,author:Mt,license:xt,bugs:qt,homepage:Lt,devDependencies:Dt};class jt extends Se{constructor(e){super();this.version=e.version,this.userAgent=`Discord-OAuth2 (https://github.com/reboxer/discord-oauth2, ${Ht.version})`,this.ratelimits={},this.requestTimeout=e.requestTimeout,this.latencyThreshold=e.latencyThreshold,this.latencyRef={latency:500,offset:e.ratelimiterOffset,raw:new Array(10).fill(500),timeOffset:0,timeOffsets:new Array(10).fill(0),lastTimeOffsetCheck:0},this.globalBlock=!1,this.readyQueue=[]}globalUnblock(){for(this.globalBlock=!1;this.readyQueue.length>0;)this.readyQueue.shift()()}routefy(e){return e.replace(/\/([a-z-]+)\/(?:[0-9]{17,19})/g,function(t,r){return r==="guilds"?t:`/${r}/:id`})}request(e,t,r,i,n,s){const a=n||this.routefy(t,e),c={};return Error.captureStackTrace(c),new Promise((b,g)=>{let k=0;const _=f=>{const w={"User-Agent":this.userAgent,"Content-Type":i.contentType};let y;try{i.auth&&(w.Authorization=`${i.auth.type} ${i.auth.creds}`),w["Content-Type"]==="application/json"?y=JSON.stringify(r):y=r}catch(o){f(),g(o);return}const v=Rt.request({method:e,host:"discord.com",path:`/api/${this.version}`+t,headers:w});let T;v.once("abort",()=>{f(),T=T||new Error(`Request aborted by client on ${e} ${t}`),T.req=v,g(T)}).once("error",o=>{T=o,v.abort()});let S=Date.now();v.once("response",o=>{S=Date.now()-S,this.latencyRef.raw.push(S),this.latencyRef.latency=this.latencyRef.latency-~~(this.latencyRef.raw.shift()/10)+~~(S/10);const Z=Date.parse(o.headers.date);if(this.latencyRef.lastTimeOffsetCheck<Date.now()-5e3){const p=~~((this.latencyRef.lastTimeOffsetCheck=Date.now())-Z);this.latencyRef.timeOffset-this.latencyRef.latency>=this.latencyThreshold&&p-this.latencyRef.latency>=this.latencyThreshold&&this.emit("warn",new Error(`Your clock is ${this.latencyRef.timeOffset}ms behind Discord's server clock. Please check your connection and system time.`)),this.latencyRef.timeOffset=~~(this.latencyRef.timeOffset-this.latencyRef.timeOffsets.shift()/10+p/10),this.latencyRef.timeOffsets.push(p)}o.once("aborted",()=>{f(),T=T||new Error(`Request aborted by server on ${e} ${t}`),T.req=v,g(T)});let E="";const Te=o;Te.on("data",p=>{E+=p}).on("error",p=>{T=p,v.abort()}).once("end",()=>{const p=Date.now();if(o.headers["x-ratelimit-limit"]&&(this.ratelimits[a].limit=+o.headers["x-ratelimit-limit"]),e!=="GET"&&(o.headers["x-ratelimit-remaining"]===void 0||o.headers["x-ratelimit-limit"]===void 0)&&this.ratelimits[a].limit!==1&&this.emit("debug",`Missing ratelimit headers for SequentialBucket(${this.ratelimits[a].remaining}/${this.ratelimits[a].limit}) with non-default limit
${o.statusCode} ${o.headers["content-type"]}: ${e} ${a} | ${o.headers["cf-ray"]}
content-type = 
x-ratelimit-remaining = `+o.headers["x-ratelimit-remaining"]+`
x-ratelimit-limit = `+o.headers["x-ratelimit-limit"]+`
x-ratelimit-reset = `+o.headers["x-ratelimit-reset"]+`
x-ratelimit-global = `+o.headers["x-ratelimit-global"]),this.ratelimits[a].remaining=o.headers["x-ratelimit-remaining"]===void 0?1:+o.headers["x-ratelimit-remaining"]||0,o.headers["retry-after"]?o.headers["x-ratelimit-global"]?(this.globalBlock=!0,setTimeout(()=>this.globalUnblock(),+o.headers["retry-after"]||1)):this.ratelimits[a].reset=(+o.headers["retry-after"]||1)+p:o.headers["x-ratelimit-reset"]?~a.lastIndexOf("/reactions/:id")&&+o.headers["x-ratelimit-reset"]*1e3-Z===1e3?this.ratelimits[a].reset=Math.max(p+250-this.latencyRef.timeOffset,p):this.ratelimits[a].reset=Math.max(+o.headers["x-ratelimit-reset"]*1e3-this.latencyRef.timeOffset,p):this.ratelimits[a].reset=p,o.statusCode!==429&&this.emit("debug",`${r&&r.content} ${p} ${a} ${o.statusCode}: ${S}ms (${this.latencyRef.latency}ms avg) | ${this.ratelimits[a].remaining}/${this.ratelimits[a].limit} left | Reset ${this.ratelimits[a].reset} (${this.ratelimits[a].reset-p}ms left)`),o.statusCode>=300){if(o.statusCode===429)if(this.emit("debug",`${o.headers["x-ratelimit-global"]?"Global":"Unexpected"} 429 (\u256F\xB0\u25A1\xB0\uFF09\u256F\uFE35 \u253B\u2501\u253B: ${E}
${r&&r.content} ${p} ${a} ${o.statusCode}: ${S}ms (${this.latencyRef.latency}ms avg) | ${this.ratelimits[a].remaining}/${this.ratelimits[a].limit} left | Reset ${this.ratelimits[a].reset} (${this.ratelimits[a].reset-p}ms left)`),o.headers["retry-after"]){setTimeout(()=>{f(),this.request(e,t,r,i,a,!0).then(b).catch(g)},+o.headers["retry-after"]);return}else{f(),this.request(e,t,r,i,a,!0).then(b).catch(g);return}else if(o.statusCode===502&&++k<4)return this.emit("debug","A wild 502 appeared! Thanks CloudFlare!"),setTimeout(()=>{this.request(e,t,r,i,a,!0).then(b).catch(g)},Math.floor(Math.random()*1900+100)),f();if(f(),E.length>0&&o.headers["content-type"]==="application/json")try{E=JSON.parse(E)}catch(Re){g(Re);return}let{stack:A}=c;A.startsWith(`Error
`)&&(A=A.substring(6));let P;E.code?P=new Ae(v,o,E,A):P=new Ie(v,o,E,A),g(P);return}if(E.length>0&&o.headers["content-type"]==="application/json")try{E=JSON.parse(E)}catch(A){f(),g(A);return}f(),b(E)})}),v.setTimeout(this.requestTimeout,()=>{T=new Error(`Request timed out (>${this.requestTimeout}ms) on ${e} ${t}`),v.abort()}),v.end(y)};this.globalBlock&&i.auth?this.readyQueue.push(()=>{this.ratelimits[a]||(this.ratelimits[a]=new ve(1,this.latencyRef)),this.ratelimits[a].queue(_,s)}):(this.ratelimits[a]||(this.ratelimits[a]=new ve(1,this.latencyRef)),this.ratelimits[a].queue(_,s))})}}var Bt=jt;class Pt extends Bt{constructor(e={}){super({version:e.version||"v7",requestTimeout:e.requestTimeout||15e3,latencyThreshold:e.latencyThreshold||3e4,ratelimiterOffset:e.ratelimiterOffset||0});this.client_id=e.clientId,this.client_secret=e.clientSecret,this.redirect_uri=e.redirectUri,this.credentials=e.credentials}_encode(e){let t="";for(const[r,i]of Object.entries(e)){if(!i)continue;t+=`&${encodeURIComponent(r)}=${encodeURIComponent(i)}`}return t.substring(1)}tokenRequest(e={}){const t={client_id:e.clientId||this.client_id,client_secret:e.clientSecret||this.client_secret,grant_type:void 0,code:void 0,refresh_token:void 0,redirect_uri:e.redirectUri||this.redirect_uri,scope:e.scope instanceof Array?e.scope.join(" "):e.scope};if(e.grantType==="authorization_code")t.code=e.code,t.grant_type=e.grantType;else if(e.grantType==="refresh_token")t.refresh_token=e.refreshToken,t.grant_type=e.grantType;else throw new Error("Invalid grant_type provided, it must be either authorization_code or refresh_token");const r=this._encode(t);return this.request("POST","/oauth2/token",r,{contentType:"application/x-www-form-urlencoded"})}revokeToken(e,t){if(!t&&!this.credentials)throw new Error("Missing credentials for revokeToken method");return this.request("POST","/oauth2/token/revoke",`token=${e}`,{auth:{type:"Basic",creds:t||this.credentials},contentType:"application/x-www-form-urlencoded"})}getUser(e){return this.request("GET","/users/@me",void 0,{auth:{type:"Bearer",creds:e},contentType:"application/json"})}getUserGuilds(e){return this.request("GET","/users/@me/guilds",void 0,{auth:{type:"Bearer",creds:e},contentType:"application/json"})}getUserConnections(e){return this.request("GET","/users/@me/connections",void 0,{auth:{type:"Bearer",creds:e},contentType:"application/json"})}addMember(e){return this.request("PUT",`/guilds/${e.guildId}/members/${e.userId}`,{deaf:e.deaf,mute:e.mute,nick:e.nickname,roles:e.roles,access_token:e.accessToken},{auth:{type:"Bot",creds:e.botToken},contentType:"application/json"})}generateAuthUrl(e={}){const t={client_id:e.clientId||this.client_id,prompt:e.prompt||void 0,redirect_uri:e.redirectUri||this.redirect_uri,response_type:e.responseType||"code",scope:e.scope instanceof Array?e.scope.join(" "):e.scope,permissions:e.permissions||void 0,guild_id:e.guildId||void 0,disable_guild_select:e.disableGuildSelect||void 0,state:e.state||void 0},r=this._encode(t);return`https://discord.com/api/oauth2/authorize?${r}`}}var Ft=Pt,Ut=Ft;export{Ut as __moduleExports};
