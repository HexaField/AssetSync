import o from"../../../../../../web_modules/discord-oauth2.js";export default class n{constructor(e){this.serviceHandler=e,this.userData=void 0,this.loggedIn=!1}async initialise(){this.clientId="719132345483132948",this.oauth=new o({clientId:this.clientId,redirectUri:window.location.origin+"/success.html"}),this.url=this.oauth.generateAuthUrl({scope:"identify guilds",responseType:"token",state:window.crypto.getRandomValues(new Uint32Array(16)).toString("hex")});const e=self.simpleStorage.get("discordAccessToken");return e?await this.getUser(e):!0}logOut(){if(!this.loggedIn)return;self.simpleStorage.del("discordAccessToken"),this.userData=void 0,this.setLoggedIn(!1)}logInToDiscord(){this.loggedIn?this.logOut():(window.addEventListener("message",function(e){if(e.data.message==="deliverResult"){let s=e.data.result.substr(1).split("&").map(t=>t.split("=")).reduce((t,[i,r])=>({...t,[i]:r}),{});this.getUser(s.access_token),e.source.close()}}.bind(this)),window.open(this.url,"Login"))}async getUser(e){if(!e)return!1;try{const s=await this.oauth.getUser(e);return console.log("Successfully logged into discord!"),self.simpleStorage.set("discordAccessToken",e),this.setLoggedIn(!0),console.log(s),this.userData=s,this.serviceHandler.setData({discordName:this.userData.username,discordID:this.userData.id}),!0}catch(s){console.log("Sorry, could not log you in. Your session may have expired."),self.simpleStorage.del("discordAccessToken"),this.userData=void 0,this.setLoggedIn(!1)}}async getUserGuilds(){return await new Promise((e,s)=>{try{const t=self.simpleStorage.get("discordAccessToken");this.oauth.getUserGuilds(t).then(i=>{e(i)})}catch(t){s(t)}})}setLoggedIn(e){this.loggedIn=e,this.serviceHandler.setAuthenticated(e)}}
