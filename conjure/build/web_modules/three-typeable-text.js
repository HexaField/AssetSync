import{M as b,D as w,G as y,V as x,C,R as v,P as T,b as m,O as I,c as M,d as H}from"./common/three.module-837575b2.js";class E{constructor(e={}){this.camera=e.camera,this.font=e.font,this.string=e.string||"",this.fontScale=e.fontScale===void 0?1:e.fontScale,this.material=e.material||new b({side:w}),this.useDocumentListeners=e.useDocumentListeners===void 0?!0:e.useDocumentListeners,this.align=e.align===void 0?"center":e.align.toLowerCase(),this.onChange=e.onChange,this.onFocus=e.onFocus,this.maxEditHistory=e.maxEditHistory||32,this._backgroundMaterial=new b({visible:!1}),this._midpoint=0,this._line_height=0,this._mouse={x:0,y:0},this._actionHistory=[],this._currentHistoryIndex=0,this._group=new y,this._letters=new y,this._backgroundGroup=new y,this._group.add(this._letters),this._group.add(this._backgroundGroup),this._vec3=new x,this._isTyping=!1,this._blinkingClock=new C,this._blinkingFrequency=.5,this._blinkingLastChange=0,this._cursorPosition=new x,this._cursorTextIndex=0,this._cursorVisible=!1,this._cursorGeometry=void 0,this._cursorMesh=void 0,this._createText(),this._createCursor(),this._makeCursorVisible(!1),this._refreshCursor(),this.useDocumentListeners&&this.addDocumentListeners()}addDocumentListeners(){this.raycaster=new v,this._onDocumentMouseDown=this._onDocumentMouseDown.bind(this),this._onDocumentMouseMove=this._onDocumentMouseMove.bind(this),this._onDocumentKeyPress=this._onDocumentKeyPress.bind(this),this._onDocumentKeyDown=this._onDocumentKeyDown.bind(this),document.addEventListener("mousedown",this._onDocumentMouseDown,!1),document.addEventListener("mousemove",this._onDocumentMouseMove,!1),document.addEventListener("keypress",this._onDocumentKeyPress,!1),document.addEventListener("keydown",this._onDocumentKeyDown,!1)}removeDocumentListeners(){this.raycaster=void 0,document.removeEventListener("mousedown",this._onDocumentMouseDown),document.removeEventListener("mousemove",this._onDocumentMouseMove),document.removeEventListener("keypress",this._onDocumentKeyPress),document.removeEventListener("keydown",this._onDocumentKeyDown)}setText(e){for(;this._currentHistoryIndex>0;)this._actionHistory.splice(0,1),this._currentHistoryIndex--;for(this._actionHistory.unshift(this.string);this._actionHistory.length>this.maxEditHistory;)this._actionHistory.splice(this._actionHistory.length-1,1);this.string=e,this._createText()}getText(){return this.string}getLineHeight(){return this._line_height}getCursorIndex(){return this._cursorTextIndex}updateCursor(){if(!this._isTyping)return;this._blinkingLastChange+this._blinkingFrequency<this._blinkingClock.getElapsedTime()&&this._makeCursorVisible(!this._cursorVisible)}actionType(e){if(!this._isTyping)return;let t=[this.string.slice(0,this._cursorTextIndex),e,this.string.slice(this._cursorTextIndex)].join("");this.onChange&&this.onChange(t,"Type",e,this._cursorTextIndex),this.setText(t),this._cursorTextIndex+=e.length,this._refreshCursor()}actionBackspace(){if(!this._isTyping)return;if(this._cursorTextIndex===0)return;let e=[this.string.slice(0,this._cursorTextIndex-1),this.string.slice(this._cursorTextIndex)].join("");this.onChange&&this.onChange(e,"Backspace",this.string[this._cursorTextIndex-1],this._cursorTextIndex),this.setText(e),this._cursorTextIndex-=1,this._refreshCursor()}actionDelete(){if(!this._isTyping)return;if(this._cursorTextIndex>=this._letters.children.length)return;let e=[this.string.slice(0,this._cursorTextIndex),this.string.slice(this._cursorTextIndex+1)].join("");this.onChange&&this.onChange(e,"Delete",this.string[this._cursorTextIndex],this._cursorTextIndex),this.setText(e),this._refreshCursor()}actionMoveCursor(e){if(!this._isTyping)return;this._cursorTextIndex+=e,this._refreshCursor(),this._makeCursorVisible(!0)}actionFocus(e){this._isTyping=e,this._makeCursorVisible(e)}actionClick(e){e instanceof x?(this._getCursorIndexByPoint(this._backgroundGroup.worldToLocal(e)),this._refreshCursor(),this._isTyping=!0,this._makeCursorVisible(!0),this.onFocus&&this.onFocus(!0)):(this._isTyping=!1,this._makeCursorVisible(!1),this.onFocus&&this.onFocus(!1))}actionUndo(e){if(!e)return;for(let t=0;t<e;t++){if(this._currentHistoryIndex>=this._actionHistory.length-1)return;this._currentHistoryIndex++,this.string=this._actionHistory[this._currentHistoryIndex]}this.onChange(this.string,"Undo",this._actionHistory[this._currentHistoryIndex+e],this._currentHistoryIndex),this._createText(),this._refreshCursor()}actionRedo(e){if(!e)return;for(let t=0;t<e;t++){if(this._currentHistoryIndex<=0)return;this._currentHistoryIndex--,this.string=this._actionHistory[this._currentHistoryIndex]}this.onChange(this.string,"Redo",this._actionHistory[this._currentHistoryIndex+e],this._currentHistoryIndex),this._createText(),this._refreshCursor()}getObject(){return this._group}_createText(){for(;this._letters.children.length>0;)this._letters.remove(this._letters.children[0]);for(;this._backgroundGroup.children.length>0;)this._backgroundGroup.remove(this._backgroundGroup.children[0]);this.string=String(this.string);const e=Array.from?Array.from(this.string):String(this.string).split(""),t=this.fontScale/this.font.data.resolution;this._line_height=(this.font.data.boundingBox.yMax-this.font.data.boundingBox.yMin+this.font.data.underlineThickness)*t;let s=0,n=0,l=0,o=[];for(let c of e)if(c===`
`){let h=new T(l,this._line_height);h.translate(0,n+this._line_height/2,0);let d=new m(h,this._backgroundMaterial);this._backgroundGroup.add(d);let f=new I;f.userData.offset={x:s,y:n,width:0,height:this._line_height},this._letters.add(f),o.push(s),s=0,n-=this._line_height}else{const h=this._createPath(c,t,s,n,this.font.data);let d=new M(h.path.toShapes()),f=new m(d,this.material);f.userData.offset={x:s,y:n,width:h.offsetX,height:this._line_height},this._letters.add(f),s+=h.offsetX,s>l&&(l=s)}let _=new T(l,this._line_height);_.translate(0,n+this._line_height/2,0);let g=new m(_,this._backgroundMaterial);this._backgroundGroup.add(g),o.push(s);let a=0,u=0;for(let c of e)this.align==="center"?(this._letters.children[u].position.setX(-o[a]/2),this._letters.children[u].userData.offset.x-=o[a]/2):this.align==="right"&&(this._letters.children[u].position.setX(-o[a]),this._letters.children[u].userData.offset.x-=o[a]),c===`
`&&a++,u++}_createCursor(){let e=this._line_height;this._cursorGeometry=new T(e*.1*.75,e*.75),this._cursorGeometry.translate(0,e*.5*.75,0),this._cursorMesh=new m(this._cursorGeometry,this.material),this._group.add(this._cursorMesh)}_refreshCursor(){if(this._cursorTextIndex<0&&(this._cursorTextIndex=0),this._cursorTextIndex>this._letters.children.length&&(this._cursorTextIndex=this._letters.children.length),!(this._letters.children.length===0))if(this._cursorTextIndex>=this._letters.children.length){let e=this._letters.children[this._letters.children.length-1];this._cursorMesh.position.set(e.userData.offset.x+e.userData.offset.width,e.userData.offset.y,0)}else{let e=this._letters.children[this._cursorTextIndex];this._cursorMesh.position.set(e.userData.offset.x,e.userData.offset.y,0)}}_makeCursorVisible(e){this._cursorVisible=e,this._cursorMesh.visible=this._cursorVisible,this._blinkingLastChange=this._blinkingClock.getElapsedTime()}_getCursorIndexByPoint(e){for(let t in this._letters.children){let s=this._letters.children[Number(t)];if(e.x>=s.userData.offset.x&&e.y>=s.userData.offset.y&&e.x<=s.userData.offset.x+s.userData.offset.width*.5&&e.y<=s.userData.offset.y+s.userData.offset.height){this._cursorTextIndex=Number(t);return}else if(e.x>=s.userData.offset.x+s.userData.offset.width*.5&&e.y>=s.userData.offset.y&&e.x<=s.userData.offset.x+s.userData.offset.width&&e.y<=s.userData.offset.y+s.userData.offset.height){this._cursorTextIndex=Number(t)+1;return}}}_onDocumentMouseDown(e){e.preventDefault(),this.raycaster.setFromCamera(this._mouse,this.camera);let t=this.raycaster.intersectObjects(this._backgroundGroup.children,!0);this.actionClick(t.length>0?t[0].point:!1)}_onDocumentMouseMove(e){this._mouse.x=2*(e.clientX/window.innerWidth-.5),this._mouse.y=-2*(e.clientY/window.innerHeight-.5)}_onDocumentKeyDown(e){var t=e.key;if(t==="Backspace")return this.actionBackspace(),!1;if(t==="Delete")return this.actionDelete(),!1;if(t==="Enter")return e.ctrlKey||e.metaKey?this.actionType(`
`):this.actionClick(),!1;if(t==="ArrowLeft")return this.actionMoveCursor(-1),!1;if(t==="ArrowRight")return this.actionMoveCursor(1),!1;if(t==="v"&&(e.ctrlKey||e.metaKey))return navigator.clipboard.readText().then(s=>this.actionType(s)),!1;if(t==="z"&&(e.ctrlKey||e.metaKey))return this.actionUndo(1),!1;if(t==="y"&&(e.ctrlKey||e.metaKey))return this.actionRedo(1),!1;if(t.length===1)return this.actionType(t),!1}_onDocumentKeyPress(e){}_createPath(e,t,s,n,l){const o=l.glyphs[e]||l.glyphs["?"];if(!o){console.error('FontExtension: character "'+e+'" does not exists in font family '+l.familyName+".");return}const _=new H;let g,a,u,c,h,d,f,D;if(o.o){const i=o._cachedOutline||(o._cachedOutline=o.o.split(" "));for(let r=0,p=i.length;r<p;){const k=i[r++];switch(k){case"m":g=i[r++]*t+s,a=i[r++]*t+n,_.moveTo(g,a);break;case"l":g=i[r++]*t+s,a=i[r++]*t+n,_.lineTo(g,a);break;case"q":u=i[r++]*t+s,c=i[r++]*t+n,h=i[r++]*t+s,d=i[r++]*t+n,_.quadraticCurveTo(h,d,u,c);break;case"b":u=i[r++]*t+s,c=i[r++]*t+n,h=i[r++]*t+s,d=i[r++]*t+n,f=i[r++]*t+s,D=i[r++]*t+n,_.bezierCurveTo(h,d,f,D,u,c);break}}}return{offsetX:o.ha*t,path:_}}}export default E;
