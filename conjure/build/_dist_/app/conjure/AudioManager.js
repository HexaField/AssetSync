import*as o from" https://cdn.skypack.dev/pin/three@v0.123.0-STd7XeVUbImsNuMmqKGL/min/three.js";import{number as u}from"./util/number.js";export class AudioManager{constructor(e){this.conjure=e,this.buffers={},this.sounds=[]}getSounds(){return this.sounds}getAudioContext(){return this.audioListener.context}getHasContext(){return this.audioListener!==void 0}async create(e){if(this.getHasContext())return;e&&(this.conjure.getLoadingScreen().setText(`WARNING!

This realm automatically plays audio.
Please click to continue.`),await this.conjure.getLoadingScreen().awaitInput()),this.audioListener=new o.AudioListener,await this.audioListener.context.resume(),this.conjure.camera.add(this.audioListener),this.setMasterVolume(1),this.audioLoader=new o.AudioLoader}async load(e,s){if(this.buffers[e])return;if(!s)return;await new Promise((i,t)=>{this.audioLoader.load(s,n=>(this.buffers[e]=n,i()))})}createFromMediaSource(e,s,i={}){if(!this.audioListener)return;let t=new o.PositionalAudio(this.audioListener);return typeof e===HTMLMediaElement?t.setMediaElementSource(e):t.setMediaStreamSource(e),t.setVolume(i.volume===void 0?1:i.volume),t.setRefDistance(i.refDistance===void 0?20:i.refDistance),s.userData.sound=t,s.add(t),t.destroy=()=>{this.sounds.includes(t)&&this.sounds.splice(this.sounds.indexOf(t),1),t.disconnect(),s.remove(t)},this.sounds.push(t),t}play(e,s={}){if(!this.audioListener||!this.buffers[e])return;let i=s.positional?new o.PositionalAudio(this.audioListener):new o.Audio(this.audioListener);return i.setBuffer(this.buffers[e]),i.setLoop(Boolean(s.loop)),i.setVolume(s.volume===void 0?1:s.volume),s.positional&&i.setRefDistance(s.refDistance===void 0?20:s.refDistance),i.play(),i.onEnded=()=>{for(let t in this.sounds)i===this.sounds[t]&&this.sounds.slice(t,1)},this.sounds.push(i),i}setMasterVolume(e){if(!this.audioListener)return;this.audioListener.setMasterVolume(u(e)),this.updateSounds()}async toggleMute(){return this.audioListener||await this.create(!1),this.audioListener.setMasterVolume(this.audioListener.getMasterVolume()===0?1:0),this.updateSounds(),this.audioListener.getMasterVolume()}updateSounds(){for(let e of this.sounds)e.setVolume(this.audioListener.getMasterVolume())}}
