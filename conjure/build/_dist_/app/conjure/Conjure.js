import*as t from" https://cdn.skypack.dev/pin/three@v0.123.0-STd7XeVUbImsNuMmqKGL/min/three.js";import d from"../../../web_modules/events.js";import{REALM_TYPES as c}from"../backend/realm/RealmData.js";import{getParams as l}from"../../../web_modules/@AssetSync/common.js";export const CONJURE_MODE={LOADING:"Loading",EXPLORE:"Explore",BUILD:"Build",SCREEN:"Screen"};export async function startConjure(e){new u(e)}class u extends d{constructor({assetSync:e,assets:s,profiles:a,realms:i}){super();this.assetSync=e,this.assets=s,this.profiles=a,this.realms=i,this.canvas=document.getElementById("canvas"),this.urlParams=l(),this.allowIncomingFeeds=!1,this.start()}async start(){await this.init(),await this.preload(),await this.create(),this.realms.on("update",e=>{this.resizeRendererToDisplaySize(this.renderer),this.update(e)})}resizeRendererToDisplaySize(e){const s=e.domElement,a=window.innerWidth,i=window.innerHeight,r=s.width!==a||s.height!==i;return r&&this.resizeCanvas(a,i),r}getWorld(){return this.world}getScreens(){return this.screenManager}getFonts(){return this.fonts}getFont(e){return this.getFonts().getFont(e)}getDefaultFont(){return this.fonts.getDefault()}getProfile(){return this.profile}getGlobalHUD(){return this.screenManager.hudGlobal}getAudioManager(){return this.audioManager}getLoadingScreen(){return this.loadingScreen}async init(){this.clock=new t.Clock,this.loadTimer=Date.now(),this.setConjureMode(CONJURE_MODE.LOADING);const{default:e}=await import("./screens/text/Fonts.js");this.fonts=new e(this),await this.fonts.addFont("Helvetiker","/assets/fonts/helvetiker.json"),await this.fonts.addFont("System","/assets/fonts/system.json"),this.fonts.setDefault("Helvetiker"),this.initScene();const{default:s}=await import("./LoadingScreen.js");this.loadingScreen=new s(this),this.loadingScreen.create(),this.loadingScreen.setText("Initialising..."),this.mouseRaycaster=new t.Raycaster,this.worldRaycaster=new t.Raycaster,this.vec3=new t.Vector3,this.vec2=new t.Vector2,this.quat=new t.Quaternion;const{default:a}=await import("./Input.js");this.input=new a(this)}initScene(){this.scene=new t.Scene,this.scene.fog=new t.FogExp2(3424834,.001);let e=new t.AmbientLight(13421772,.2);this.scene.add(e);let s=8.25;var a=Math.PI*(.3-.5),i=2*Math.PI*(.3-.5);this.sunPos=new t.Vector3,this.sunPos.x=Math.cos(i),this.sunPos.y=Math.sin(i)*Math.sin(a),this.sunPos.z=Math.sin(i)*Math.cos(a),this.dirLight=new t.DirectionalLight(16777215,.4),this.dirLight.position.copy(this.sunPos),this.dirLight.castShadow=!0,this.dirLight.shadow.mapSize=new t.Vector2(1024,1024),this.dirLight.shadow.camera.near=.1,this.dirLight.shadow.camera.far=1500,this.dirLight.shadow.camera.left=s*-1,this.dirLight.shadow.camera.right=s,this.dirLight.shadow.camera.top=s,this.dirLight.shadow.camera.bottom=s*-1,this.scene.add(this.dirLight),this.camera=new t.PerspectiveCamera(60,window.clientWidth/window.clientHeight,.1,1e4),this.cameraFollow=new t.Group,this.cameraFollow.position.setZ(-.35),this.debugBall=new t.Mesh(new t.SphereBufferGeometry(.1),new t.MeshBasicMaterial),this.debugBall.receiveShadow=!1,this.debugBall.castShadow=!1,this.cameraFollow.add(this.debugBall),this.camera.add(this.cameraFollow),this.cameraTrack=new t.Group,this.scene.add(this.cameraTrack),this.cameraScreenAttach=new t.Group,this.cameraScreenAttach.scale.set(.2,.2,.2),this.scene.add(this.cameraScreenAttach),this.renderer=new t.WebGLRenderer({antialias:!0,alpha:!0,canvas:this.canvas}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.clientWidth,window.clientHeight,!1),this.renderer.outputEncoding=t.sRGBEncoding,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=t.PCFSoftShadowMap,this.renderer.toneMapping=t.ReinhardToneMapping,this.renderer.setClearColor(0,1)}async preload(){t.Cache.enabled=!0,this.cache=t.Cache,this.textureAnisotropy=1;const{default:e}=await import("./util/loaders.js");this.load=new e(this.cache,this.textureAnisotropy),this.loadingScreen.setText("Downloading assets..."),await this.load.preload("playerModel","/assets/models/ybot_anims.glb"),await this.load.preload("default_realm","/assets/icons/default_realm.png"),await this.load.preload("pin_full","/assets/icons/pin_full.png"),await this.load.preload("pin_empty","/assets/icons/pin_empty.png"),await this.load.preload("speaker","/assets/icons/speaker.png"),await this.load.preload("speakermute","/assets/icons/speakermute.png"),await this.load.preload("global_icon","/assets/icons/global.png"),await this.load.preload("missing_texture","/assets/textures/missing_texture.png"),await this.load.preload("menger_texture","/assets/textures/menger_texture.png"),await this.load.preload("ponder_texture","/assets/textures/ponder_texture.png"),await this.load.preload("default_texture","/assets/textures/default_texture.png")}async create(){console.log("Took",(Date.now()-this.loadTimer)/1e3," seconds to preload.");const{default:e}=await import("./util/mixers.js");this.mixers=new e,this.animationMixers=this.mixers.mixers;const{default:s}=await import("./PostProcessing.js");this.postProcessing=new s(this),this.loadingScreen.setText("Loading default assets...");const{default:a}=await import("./AssetManager.js");this.assetManager=new a(this),await this.assetManager.createDefaultAssets();const{default:i}=await import("./profile/Profile.js");this.profile=new i(this);const{NetworkingSchemas:r}=await import("./world/realm/NetworkingSchemas.js");this.networkingSchemas=new r,this.input.addKey("FOCUS","f"),this.input.addKey("EDIT_CONTROLS","1"),this.input.addKey("FLY_CONTROLS","2"),this.input.addKey("AVATAR_CONTROLS","3"),this.input.addKey("FORWARD","w"),this.input.addKey("BACKWARD","s"),this.input.addKey("LEFT","a"),this.input.addKey("RIGHT","d"),this.input.addKey("JUMP","SPACEBAR");const{default:n}=await import("./world/World.js");this.world=new n(this);const{default:o}=await import("./screens/ScreenManager.js");this.screenManager=new o(this),this.screenManager.hudGlobal.showScreen(!0);const{AudioManager:h}=await import("./AudioManager.js");this.audioManager=new h(this),this.screenManager.hudGlobal.audioControls.setAudioManager(this.audioManager),this.loadingScreen.setText("Loading World..."),await this.profile.loadFromDatabase(),await this.profile.getServiceManager().initialiseServices(),await this.world.preloadRealms(),this.world.loadDefault(),window.CONSOLE.showNotification(`Press (R) to reset if your avatar gets stuck
Press escape to reveal the mouse and access settings.`,3),this.getGlobalHUD().log("Took "+(Date.now()-this.loadTimer)/1e3+" seconds to load."),this.getGlobalHUD().addWatchItem("Peers Online",this.assetSync.transportPlugin.peerInfo,"peersCount")}setConjureMode(e){if(this.conjureMode===e)return;this.lastConjureMode=this.conjureMode,this.conjureMode=e,this.emit("conjure:mode",e)}update(e){this.conjureMode===CONJURE_MODE.LOADING?this.loadingScreen.update(e):(this.updateConjure(e),this.animationMixers.update(e),this.postProcessing.render())}updateConjure(e){let s=e/1e3;s>.1&&(s=.1),this.input.update(),this.mouseRaycaster.setFromCamera(this.input.mouse,this.camera),this.worldRaycaster.setFromCamera(this.vec2,this.camera);let a={delta:s,input:this.input,mouseRaycaster:this.mouseRaycaster,worldRaycaster:this.worldRaycaster,conjure:this};this.getWorld().update(a),this.cameraScreenAttach.position.copy(this.cameraFollow.getWorldPosition(this.vec3)),this.cameraScreenAttach.quaternion.copy(this.cameraFollow.getWorldQuaternion(this.quat)),this.getScreens().update(a)}async updateIngoingMediaStream(){await this.audioManager.create(!1);for(let e of Object.values(this.world.remoteUsers))e.getIncomingMediaStreams()}async toggleMediaStream(){if(!this.hasMediaStream()){if(this.world.realm.realmData.type===c.GLOBAL&&this.world.realm.realmID!=="Campfire")return;const e=await this._getUserMediaStream();if(!e.ended&&e.active){for(let s of Object.values(this.world.remoteUsers))s.addMedia(e);return}}for(let e of Object.values(this.world.remoteUsers))e.removeMedia(),e.removeVideo();this.userMediaStream=void 0}hasMediaStream(){return this.userMediaStream!==void 0}async _getUserMediaStream(){if(!this.mediaStreamHandler){const{default:e}=await import("./mediastreams/MediaStream.js");this.mediaStreamHandler=e}if(console.log("Attempting to get media stream..."),!this.hasMediaStream())try{this.userMediaStream=await this.mediaStreamHandler(),console.log("Successfully got media streams!")}catch(e){console.log("Failed to get media streams!",e),this.userMediaStream=void 0}return this.userMediaStream}makeUrl(){const e=new URL(location.origin);return this.world.realm&&e.searchParams.append("r",this.world.realm.realmID),e.searchParams.append("network","true"),e}resizeCanvas(e,s){if(!e||!s)return;const a=e/s;this.camera.aspect=a,this.camera.updateProjectionMatrix(),this.loadingScreen.camera.aspect=a,this.loadingScreen.camera.updateProjectionMatrix(),this.renderer.setSize(e,s,!1),this.postProcessing.composer.setSize(e,s,!1),this.screenManager&&this.screenManager.resizeScreens(a)}}
