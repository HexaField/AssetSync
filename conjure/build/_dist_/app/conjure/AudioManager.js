import*as o from"https://cdn.skypack.dev/pin/three@v0.117.1-NetLzdTnw9ga3y6o633U/min/three.js";import{number as n}from"./util/number.js";export class AudioManager{constructor(e){this.conjure=e,this.buffers={},this.sounds=[],this.sources=[]}getSources(){return this.sources}getAudioContext(){return this.audioListener.context}getHasContext(){return this.audioListener!==void 0}async create(e){if(this.getHasContext())return;e&&(this.conjure.getLoadingScreen().setText(`WARNING!

This realm automatically plays audio.
Please click to continue.`),await this.conjure.getLoadingScreen().awaitInput()),this.audioListener=new o.AudioListener,await this.audioListener.context.resume(),this.conjure.camera.add(this.audioListener),this.setMasterVolume(1),this.audioLoader=new o.AudioLoader}async load(e,i){if(this.buffers[e])return;if(!i)return;await new Promise((t,s)=>{this.audioLoader.load(i,u=>(this.buffers[e]=u,t()))})}createFromMediaSource(e,i,t={}){if(!this.audioListener)return;let s=new o.PositionalAudio(this.audioListener);console.log(e,typeof e),typeof e===HTMLMediaElement?s.setMediaElementSource(e):s.setMediaStreamSource(e),s.setVolume(t.volume===void 0?1:t.volume),s.setRefDistance(t.refDistance===void 0?20:t.refDistance),i.userData.sound=s,i.add(s),console.log(s),this.sources.push(i)}play(e,i={}){if(!this.audioListener||!this.buffers[e])return;let t=i.positional?new o.PositionalAudio(this.audioListener):new o.Audio(this.audioListener);return t.setBuffer(this.buffers[e]),t.setLoop(Boolean(i.loop)),t.setVolume(i.volume===void 0?1:i.volume),i.positional&&t.setRefDistance(i.refDistance===void 0?20:i.refDistance),t.play(),t.onEnded=()=>{for(let s in this.sounds)t===this.sounds[s]&&this.sounds.slice(s,1)},this.sounds.push(t),t}setMasterVolume(e){if(!this.audioListener)return;this.audioListener.setMasterVolume(n(e)),this.updateSources()}async toggleMute(){return this.audioListener||await this.create(!1),this.audioListener.setMasterVolume(this.audioListener.getMasterVolume()===0?1:0),this.updateSources(),this.audioListener.getMasterVolume()}updateSources(){for(let e of this.sources)e.userData.media.volume=this.audioListener.getMasterVolume()}}
