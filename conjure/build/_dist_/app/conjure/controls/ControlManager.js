import*as r from" https://cdn.skypack.dev/pin/three@v0.123.0-STd7XeVUbImsNuMmqKGL/min/three.js";import{CONJURE_MODE as s}from"../Conjure.js";import{OrbitControls as o}from"./OrbitControls.js";import{TransformControls as n}from"./TransformControls.js";import i from"./FlyControls.js";import h from"./ObjectControls.js";import a from"./AvatarControls.js";export const CONTROL_SCHEME={NONE:"None",ORBIT:"Orbit",FLY:"Fly",AVATAR:"Avatar"};export default class c{constructor(t){this.conjure=t,this.world=t.world,this.scene=t.scene,this.camera=t.camera,this.domElement=t.canvas,this.controlsEnabled=!1,this.flyControls=new i(this.camera,this.domElement),this.avatarControls=new a(t,this.world.user,this.domElement),this.transformControls=this.buildTransformControls(),this.orbit=new o(this.camera,this.domElement),this.orbit.target.copy(this.world.user.focusPoint.position),this.orbit.enabled=!1,this.objectControls=new h(this,this.transformControls),this.transformObjects=[],this.lastTransformObject=void 0,this.objectGroups=[],this.vec3=new r.Vector3,this.hasPointerLock=!1,this.conjure.input.addKey("FOCUS","f"),this.conjure.input.addKey("EDIT_CONTROLS","1"),this.conjure.input.addKey("FLY_CONTROLS","2"),this.conjure.input.addKey("AVATAR_CONTROLS","3"),this.conjure.input.addKey("FORWARD","w"),this.conjure.input.addKey("BACKWARD","s"),this.conjure.input.addKey("LEFT","a"),this.conjure.input.addKey("RIGHT","d"),this.conjure.input.addKey("JUMP","SPACEBAR"),this.conjure.on("conjure:mode",e=>{switch(e){default:case s.LOADING:this.enableCurrentControls(!1);break;case s.WAITING:this.setControlScheme(CONTROL_SCHEME.NONE);break;case s.EXPLORE:this.setControlScheme(CONTROL_SCHEME.AVATAR);break;case s.CONJURE:this.setControlScheme(CONTROL_SCHEME.ORBIT);break}})}buildTransformControls(){const t=new n(this.camera,this.domElement);return t.addEventListener("dragging-changed",function(e){this.orbit.enabled=!e.value}.bind(this)),t.enabled=!1,this.scene.add(t),t}getPointerLock(){(this.conjure.getScreens().hudExplore.active||this.conjure.getScreens().hudConjure.active&&this.currentControlScheme===CONTROL_SCHEME.FLY)&&this.domElement.requestPointerLock()}getPointerLockState(){return this.hasPointerLock}toggleConjureControls(){this.currentControlScheme===CONTROL_SCHEME.ORBIT?this.setControlScheme(CONTROL_SCHEME.FLY):this.currentControlScheme===CONTROL_SCHEME.FLY&&this.setControlScheme(CONTROL_SCHEME.ORBIT)}enableControls(t){this.enableCurrentControls(t),t||document.exitPointerLock()}enableCurrentControls(t){this.controlsEnabled=t;switch(this.currentControlScheme){default:case CONTROL_SCHEME.NONE:break;case CONTROL_SCHEME.ORBIT:t?(this.transformControls.enabled=!0,this.orbit.enabled=!0,this.orbit.update()):(this.transformControls.objects!==[]&&(this.lastTransformObject=this.transformControls.object,this.objectControls.detachAll()),this.transformControls.enabled=!1,this.orbit.enabled=!1);break;case CONTROL_SCHEME.FLY:t?(this.flyControls.connect(),this.conjure.getScreens().hudConjure.showScreen(!1)):this.flyControls.disconnect();break;case CONTROL_SCHEME.AVATAR:t?this.avatarControls.connect():this.avatarControls.disconnect();break}}setControlScheme(t){switch(t){default:case CONTROL_SCHEME.NONE:this.enableCurrentControls(!1),document.exitPointerLock();break;case CONTROL_SCHEME.ORBIT:document.exitPointerLock(),this.enableCurrentControls(!1),this.currentControlScheme===CONTROL_SCHEME.FLY&&this.orbit.target.copy(this.flyControls.raycaster.ray.at(10,this.vec3)),this.currentControlScheme===CONTROL_SCHEME.AVATAR&&this.orbit.target.copy(this.avatarControls.raycaster.ray.at(10,this.vec3)),this.currentControlScheme=t,this.enableCurrentControls(!0);break;case CONTROL_SCHEME.FLY:this.enableCurrentControls(!1),this.currentControlScheme=t,this.enableCurrentControls(!0);break;case CONTROL_SCHEME.AVATAR:this.enableCurrentControls(!1),this.currentControlScheme=t,this.enableCurrentControls(!0);break}}lookAt(t){if(!t)return;let e=t.position.getWorldPosition(this.vec3);this.camera.lookAt(e.x,e.y,e.z),this.orbit.target.copy(e),this.orbit.update()}addTransformObject(t,e){this.transformObjects.push(t),this.transformControls.object&&(this.lastTransformObject=this.transformControls.object),e&&this.objectControls.attach(t,{detachOthers:!0})}update(t){if(this.controlsEnabled){if(!this.conjure.getScreens().controlsEnabled){this.enableControls(!1);return}}else if(this.conjure.getScreens().controlsEnabled)this.enableControls(!0);else return;t.input.isPressed("MOUSELEFT",!0)&&!window.CONSOLE.getIsMouseOverhudElement()&&this.getPointerLock(),this.currentControlScheme===CONTROL_SCHEME.ORBIT&&(this.conjure.getScreens().openScreens.length>0?(this.transformControls.enabled=!this.conjure.getScreens().mouseOver,this.orbit.enabled=!this.conjure.getScreens().mouseOver):(this.transformControls.enabled=!0,this.orbit.enabled=!0),this.objectControls.input(t)),this.currentControlScheme===CONTROL_SCHEME.FLY&&this.flyControls.input(t),this.currentControlScheme===CONTROL_SCHEME.AVATAR&&this.avatarControls.input(t),this.currentControlScheme===CONTROL_SCHEME.ORBIT&&this.objectControls.update(t),this.currentControlScheme===CONTROL_SCHEME.FLY&&this.flyControls.update(t),this.avatarControls.update(t)}}
