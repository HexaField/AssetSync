import{e as Ne}from"./events-18451fd5.js";import{e as B,b as dt}from"./index-f214b2ff.js";import{p as u}from"./process-e9e98960.js";import{b as Y}from"./buffer-es6-e6024076.js";import{a as Oe,c as ft}from"./_commonjsHelpers-c99fd594.js";import{d as X}from"./__node-resolve:empty-d7309c3b.js";import{e as c}from"./index-4f726977.js";import{b as ut,g as Me}from"./browser-343ae908.js";import{s as ct,b as Ie}from"./browser-f3be077b.js";var A=Ne.EventEmitter;function De(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function pt(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?De(Object(i),!0).forEach(function(r){gt(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):De(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function gt(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function bt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Le(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function mt(e,t,i){return t&&Le(e.prototype,t),i&&Le(e,i),e}var J=Y.Buffer,he=X.inspect,_t=he&&he.custom||"inspect";function wt(e,t,i){J.prototype.copy.call(e,t,i)}var yt=function(){function e(){bt(this,e),this.head=null,this.tail=null,this.length=0}return mt(e,[{key:"push",value:function(i){var r={data:i,next:null};this.length>0?this.tail.next=r:this.head=r,this.tail=r,++this.length}},{key:"unshift",value:function(i){var r={data:i,next:this.head};this.length===0&&(this.tail=r),this.head=r,++this.length}},{key:"shift",value:function(){if(this.length===0)return;var i=this.head.data;return this.length===1?this.head=this.tail=null:this.head=this.head.next,--this.length,i}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(i){if(this.length===0)return"";for(var r=this.head,n=""+r.data;r=r.next;)n+=i+r.data;return n}},{key:"concat",value:function(i){if(this.length===0)return J.alloc(0);for(var r=J.allocUnsafe(i>>>0),n=this.head,a=0;n;)wt(n.data,r,a),a+=n.data.length,n=n.next;return r}},{key:"consume",value:function(i,r){var n;return i<this.head.data.length?(n=this.head.data.slice(0,i),this.head.data=this.head.data.slice(i)):i===this.head.data.length?n=this.shift():n=r?this._getString(i):this._getBuffer(i),n}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(i){var r=this.head,n=1,a=r.data;for(i-=a.length;r=r.next;){var s=r.data,l=i>s.length?s.length:i;if(l===s.length?a+=s:a+=s.slice(0,i),i-=l,i===0){l===s.length?(++n,r.next?this.head=r.next:this.head=this.tail=null):(this.head=r,r.data=s.slice(l));break}++n}return this.length-=n,a}},{key:"_getBuffer",value:function(i){var r=J.allocUnsafe(i),n=this.head,a=1;for(n.data.copy(r),i-=n.data.length;n=n.next;){var s=n.data,l=i>s.length?s.length:i;if(s.copy(r,r.length-i,0,l),i-=l,i===0){l===s.length?(++a,n.next?this.head=n.next:this.head=this.tail=null):(this.head=n,n.data=s.slice(l));break}++a}return this.length-=a,r}},{key:_t,value:function(i,r){return he(this,pt({},r,{depth:0,customInspect:!1}))}}]),e}();function vt(e,t){var i=this,r=this._readableState&&this._readableState.destroyed,n=this._writableState&&this._writableState.destroyed;return r||n?(t?t(e):e&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,u.nextTick(de,this,e)):u.nextTick(de,this,e)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(e||null,function(a){!t&&a?i._writableState?i._writableState.errorEmitted?u.nextTick(Q,i):(i._writableState.errorEmitted=!0,u.nextTick(Pe,i,a)):u.nextTick(Pe,i,a):t?(u.nextTick(Q,i),t(a)):u.nextTick(Q,i)}),this)}function Pe(e,t){de(e,t),Q(e)}function Q(e){if(e._writableState&&!e._writableState.emitClose)return;if(e._readableState&&!e._readableState.emitClose)return;e.emit("close")}function Rt(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function de(e,t){e.emit("error",t)}function Et(e,t){var i=e._readableState,r=e._writableState;i&&i.autoDestroy||r&&r.autoDestroy?e.destroy(t):e.emit("error",t)}var L={destroy:vt,undestroy:Rt,errorOrDestroy:Et};function St(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var xe={};function b(e,t,i){i||(i=Error);function r(a,s,l){return typeof t=="string"?t:t(a,s,l)}var n=function(a){St(s,a);function s(l,o,f){return a.call(this,r(l,o,f))||this}return s}(i);n.prototype.name=i.name,n.prototype.code=e,xe[e]=n}function je(e,t){if(Array.isArray(e)){var i=e.length;return e=e.map(function(r){return String(r)}),i>2?"one of ".concat(t," ").concat(e.slice(0,i-1).join(", "),", or ")+e[i-1]:i===2?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}else return"of ".concat(t," ").concat(String(e))}function Tt(e,t,i){return e.substr(!i||i<0?0:+i,t.length)===t}function kt(e,t,i){return(i===void 0||i>e.length)&&(i=e.length),e.substring(i-t.length,i)===t}function Ct(e,t,i){return typeof i!="number"&&(i=0),i+t.length>e.length?!1:e.indexOf(t,i)!==-1}b("ERR_INVALID_OPT_VALUE",function(e,t){return'The value "'+t+'" is invalid for option "'+e+'"'},TypeError),b("ERR_INVALID_ARG_TYPE",function(e,t,i){var r;typeof t=="string"&&Tt(t,"not ")?(r="must not be",t=t.replace(/^not /,"")):r="must be";var n;if(kt(e," argument"))n="The ".concat(e," ").concat(r," ").concat(je(t,"type"));else{var a=Ct(e,".")?"property":"argument";n='The "'.concat(e,'" ').concat(a," ").concat(r," ").concat(je(t,"type"))}return n+=". Received type ".concat(typeof i),n},TypeError),b("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),b("ERR_METHOD_NOT_IMPLEMENTED",function(e){return"The "+e+" method is not implemented"}),b("ERR_STREAM_PREMATURE_CLOSE","Premature close"),b("ERR_STREAM_DESTROYED",function(e){return"Cannot call "+e+" after a stream was destroyed"}),b("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),b("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),b("ERR_STREAM_WRITE_AFTER_END","write after end"),b("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),b("ERR_UNKNOWN_ENCODING",function(e){return"Unknown encoding: "+e},TypeError),b("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event");var At=xe,P={codes:At},Nt=P.codes.ERR_INVALID_OPT_VALUE;function Ot(e,t,i){return e.highWaterMark!=null?e.highWaterMark:t?e[i]:null}function Mt(e,t,i,r){var n=Ot(t,r,i);if(n!=null){if(!(isFinite(n)&&Math.floor(n)===n)||n<0){var a=r?i:"highWaterMark";throw new Nt(a,n)}return Math.floor(n)}return e.objectMode?16:16*1024}var We={getHighWaterMark:Mt},Z=g;function Fe(e){var t=this;this.next=null,this.entry=null,this.finish=function(){ri(t,e)}}var x;g.WritableState=H;var It={deprecate:ut},ee=Y.Buffer,Dt=Oe.Uint8Array||function(){};function Lt(e){return ee.from(e)}function Pt(e){return ee.isBuffer(e)||e instanceof Dt}var xt=We.getHighWaterMark,E=P.codes,jt=E.ERR_INVALID_ARG_TYPE,Wt=E.ERR_METHOD_NOT_IMPLEMENTED,Ft=E.ERR_MULTIPLE_CALLBACK,Ut=E.ERR_STREAM_CANNOT_PIPE,qt=E.ERR_STREAM_DESTROYED,Bt=E.ERR_STREAM_NULL_VALUES,Ht=E.ERR_STREAM_WRITE_AFTER_END,$t=E.ERR_UNKNOWN_ENCODING,j=L.errorOrDestroy;B(g,A);function Gt(){}function H(e,t,i){x=x||v,e=e||{},typeof i!="boolean"&&(i=t instanceof x),this.objectMode=!!e.objectMode,i&&(this.objectMode=this.objectMode||!!e.writableObjectMode),this.highWaterMark=xt(this,e,"writableHighWaterMark",i),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var r=e.decodeStrings===!1;this.decodeStrings=!r,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(n){Qt(t,n)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=e.emitClose!==!1,this.autoDestroy=!!e.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new Fe(this)}H.prototype.getBuffer=function(){for(var t=this.bufferedRequest,i=[];t;)i.push(t),t=t.next;return i},function(){try{Object.defineProperty(H.prototype,"buffer",{get:It.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}();var te;typeof Symbol=="function"&&Symbol.hasInstance&&typeof Function.prototype[Symbol.hasInstance]=="function"?(te=Function.prototype[Symbol.hasInstance],Object.defineProperty(g,Symbol.hasInstance,{value:function(t){return te.call(this,t)?!0:this!==g?!1:t&&t._writableState instanceof H}})):te=function(t){return t instanceof this};function g(e){x=x||v;var t=this instanceof x;if(!t&&!te.call(g,this))return new g(e);this._writableState=new H(e,this,t),this.writable=!0,e&&(typeof e.write=="function"&&(this._write=e.write),typeof e.writev=="function"&&(this._writev=e.writev),typeof e.destroy=="function"&&(this._destroy=e.destroy),typeof e.final=="function"&&(this._final=e.final)),A.call(this)}g.prototype.pipe=function(){j(this,new Ut)};function Vt(e,t){var i=new Ht;j(e,i),u.nextTick(t,i)}function Kt(e,t,i,r){var n;return i===null?n=new Bt:typeof i!="string"&&!t.objectMode&&(n=new jt("chunk",["string","Buffer"],i)),n?(j(e,n),u.nextTick(r,n),!1):!0}g.prototype.write=function(e,t,i){var r=this._writableState,n=!1,a=!r.objectMode&&Pt(e);return a&&!ee.isBuffer(e)&&(e=Lt(e)),typeof t=="function"&&(i=t,t=null),a?t="buffer":t||(t=r.defaultEncoding),typeof i!="function"&&(i=Gt),r.ending?Vt(this,i):(a||Kt(this,r,e,i))&&(r.pendingcb++,n=Yt(this,r,a,e,t,i)),n},g.prototype.cork=function(){this._writableState.corked++},g.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,!e.writing&&!e.corked&&!e.bufferProcessing&&e.bufferedRequest&&qe(this,e))},g.prototype.setDefaultEncoding=function(t){if(typeof t=="string"&&(t=t.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((t+"").toLowerCase())>-1))throw new $t(t);return this._writableState.defaultEncoding=t,this},Object.defineProperty(g.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}});function zt(e,t,i){return!e.objectMode&&e.decodeStrings!==!1&&typeof t=="string"&&(t=ee.from(t,i)),t}Object.defineProperty(g.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}});function Yt(e,t,i,r,n,a){if(!i){var s=zt(t,r,n);r!==s&&(i=!0,n="buffer",r=s)}var l=t.objectMode?1:r.length;t.length+=l;var o=t.length<t.highWaterMark;if(o||(t.needDrain=!0),t.writing||t.corked){var f=t.lastBufferedRequest;t.lastBufferedRequest={chunk:r,encoding:n,isBuf:i,callback:a,next:null},f?f.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else fe(e,t,!1,l,r,n,a);return o}function fe(e,t,i,r,n,a,s){t.writelen=r,t.writecb=s,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new qt("write")):i?e._writev(n,t.onwrite):e._write(n,a,t.onwrite),t.sync=!1}function Xt(e,t,i,r,n){--t.pendingcb,i?(u.nextTick(n,r),u.nextTick($,e,t),e._writableState.errorEmitted=!0,j(e,r)):(n(r),e._writableState.errorEmitted=!0,j(e,r),$(e,t))}function Jt(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}function Qt(e,t){var i=e._writableState,r=i.sync,n=i.writecb;if(typeof n!="function")throw new Ft;if(Jt(i),t)Xt(e,i,r,t,n);else{var a=Be(i)||e.destroyed;!a&&!i.corked&&!i.bufferProcessing&&i.bufferedRequest&&qe(e,i),r?u.nextTick(Ue,e,i,a,n):Ue(e,i,a,n)}}function Ue(e,t,i,r){i||Zt(e,t),t.pendingcb--,r(),$(e,t)}function Zt(e,t){t.length===0&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}function qe(e,t){t.bufferProcessing=!0;var i=t.bufferedRequest;if(e._writev&&i&&i.next){var r=t.bufferedRequestCount,n=new Array(r),a=t.corkedRequestsFree;a.entry=i;for(var s=0,l=!0;i;)n[s]=i,i.isBuf||(l=!1),i=i.next,s+=1;n.allBuffers=l,fe(e,t,!0,t.length,n,"",a.finish),t.pendingcb++,t.lastBufferedRequest=null,a.next?(t.corkedRequestsFree=a.next,a.next=null):t.corkedRequestsFree=new Fe(t),t.bufferedRequestCount=0}else{for(;i;){var o=i.chunk,f=i.encoding,p=i.callback,w=t.objectMode?1:o.length;if(fe(e,t,!1,w,o,f,p),i=i.next,t.bufferedRequestCount--,t.writing)break}i===null&&(t.lastBufferedRequest=null)}t.bufferedRequest=i,t.bufferProcessing=!1}g.prototype._write=function(e,t,i){i(new Wt("_write()"))},g.prototype._writev=null,g.prototype.end=function(e,t,i){var r=this._writableState;return typeof e=="function"?(i=e,e=null,t=null):typeof t=="function"&&(i=t,t=null),e!=null&&this.write(e,t),r.corked&&(r.corked=1,this.uncork()),r.ending||ii(this,r,i),this},Object.defineProperty(g.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function Be(e){return e.ending&&e.length===0&&e.bufferedRequest===null&&!e.finished&&!e.writing}function ei(e,t){e._final(function(i){t.pendingcb--,i&&j(e,i),t.prefinished=!0,e.emit("prefinish"),$(e,t)})}function ti(e,t){!t.prefinished&&!t.finalCalled&&(typeof e._final=="function"&&!t.destroyed?(t.pendingcb++,t.finalCalled=!0,u.nextTick(ei,e,t)):(t.prefinished=!0,e.emit("prefinish")))}function $(e,t){var i=Be(t);if(i&&(ti(e,t),t.pendingcb===0&&(t.finished=!0,e.emit("finish"),t.autoDestroy))){var r=e._readableState;(!r||r.autoDestroy&&r.endEmitted)&&e.destroy()}return i}function ii(e,t,i){t.ending=!0,$(e,t),i&&(t.finished?u.nextTick(i):e.once("finish",i)),t.ended=!0,e.writable=!1}function ri(e,t,i){var r=e.entry;for(e.entry=null;r;){var n=r.callback;t.pendingcb--,n(i),r=r.next}t.corkedRequestsFree.next=e}Object.defineProperty(g.prototype,"destroyed",{enumerable:!1,get:function(){return this._writableState===void 0?!1:this._writableState.destroyed},set:function(t){if(!this._writableState)return;this._writableState.destroyed=t}}),g.prototype.destroy=L.destroy,g.prototype._undestroy=L.undestroy,g.prototype._destroy=function(e,t){t(e)};var ni=Object.keys||function(e){var t=[];for(var i in e)t.push(i);return t},v=_;B(_,_e);for(var He=ni(Z.prototype),ue=0;ue<He.length;ue++){var ce=He[ue];_.prototype[ce]||(_.prototype[ce]=Z.prototype[ce])}function _(e){if(!(this instanceof _))return new _(e);_e.call(this,e),Z.call(this,e),this.allowHalfOpen=!0,e&&(e.readable===!1&&(this.readable=!1),e.writable===!1&&(this.writable=!1),e.allowHalfOpen===!1&&(this.allowHalfOpen=!1,this.once("end",ai)))}Object.defineProperty(_.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(_.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(_.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function ai(){if(this._writableState.ended)return;u.nextTick(si,this)}function si(e){e.end()}Object.defineProperty(_.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0||this._writableState===void 0?!1:this._readableState.destroyed&&this._writableState.destroyed},set:function(t){if(this._readableState===void 0||this._writableState===void 0)return;this._readableState.destroyed=t,this._writableState.destroyed=t}});var pe=ct.Buffer,$e=pe.isEncoding||function(e){e=""+e;switch(e&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function oi(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}function li(e){var t=oi(e);if(typeof t!="string"&&(pe.isEncoding===$e||!$e(e)))throw new Error("Unknown encoding: "+e);return t||e}var hi=G;function G(e){this.encoding=li(e);var t;switch(this.encoding){case"utf16le":this.text=gi,this.end=bi,t=4;break;case"utf8":this.fillLast=ui,t=4;break;case"base64":this.text=mi,this.end=_i,t=3;break;default:this.write=wi,this.end=yi;return}this.lastNeed=0,this.lastTotal=0,this.lastChar=pe.allocUnsafe(t)}G.prototype.write=function(e){if(e.length===0)return"";var t,i;if(this.lastNeed){if(t=this.fillLast(e),t===void 0)return"";i=this.lastNeed,this.lastNeed=0}else i=0;return i<e.length?t?t+this.text(e,i):this.text(e,i):t||""},G.prototype.end=pi,G.prototype.text=ci,G.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length};function ge(e){return e<=127?0:e>>5===6?2:e>>4===14?3:e>>3===30?4:e>>6===2?-1:-2}function di(e,t,i){var r=t.length-1;if(r<i)return 0;var n=ge(t[r]);return n>=0?(n>0&&(e.lastNeed=n-1),n):--r<i||n===-2?0:(n=ge(t[r]),n>=0?(n>0&&(e.lastNeed=n-2),n):--r<i||n===-2?0:(n=ge(t[r]),n>=0?(n>0&&(n===2?n=0:e.lastNeed=n-3),n):0))}function fi(e,t,i){if((t[0]&192)!==128)return e.lastNeed=0,"\uFFFD";if(e.lastNeed>1&&t.length>1){if((t[1]&192)!==128)return e.lastNeed=1,"\uFFFD";if(e.lastNeed>2&&t.length>2&&(t[2]&192)!==128)return e.lastNeed=2,"\uFFFD"}}function ui(e){var t=this.lastTotal-this.lastNeed,i=fi(this,e);if(i!==void 0)return i;if(this.lastNeed<=e.length)return e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,t,0,e.length),this.lastNeed-=e.length}function ci(e,t){var i=di(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=i;var r=e.length-(i-this.lastNeed);return e.copy(this.lastChar,0,r),e.toString("utf8",t,r)}function pi(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"\uFFFD":t}function gi(e,t){if((e.length-t)%2===0){var i=e.toString("utf16le",t);if(i){var r=i.charCodeAt(i.length-1);if(r>=55296&&r<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],i.slice(0,-1)}return i}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function bi(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var i=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,i)}return t}function mi(e,t){var i=(e.length-t)%3;return i===0?e.toString("base64",t):(this.lastNeed=3-i,this.lastTotal=3,i===1?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-i))}function _i(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function wi(e){return e.toString(this.encoding)}function yi(e){return e&&e.length?this.write(e):""}var Ge={StringDecoder:hi},Ve=P.codes.ERR_STREAM_PREMATURE_CLOSE;function vi(e){var t=!1;return function(){if(t)return;t=!0;for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];e.apply(this,r)}}function Ri(){}function Ei(e){return e.setHeader&&typeof e.abort=="function"}function Ke(e,t,i){if(typeof t=="function")return Ke(e,null,t);t||(t={}),i=vi(i||Ri);var r=t.readable||t.readable!==!1&&e.readable,n=t.writable||t.writable!==!1&&e.writable,a=function(){e.writable||l()},s=e._writableState&&e._writableState.finished,l=function(){n=!1,s=!0,r||i.call(e)},o=e._readableState&&e._readableState.endEmitted,f=function(){r=!1,o=!0,n||i.call(e)},p=function(m){i.call(e,m)},w=function(){var m;if(r&&!o)return(!e._readableState||!e._readableState.ended)&&(m=new Ve),i.call(e,m);if(n&&!s)return(!e._writableState||!e._writableState.ended)&&(m=new Ve),i.call(e,m)},C=function(){e.req.on("finish",l)};return Ei(e)?(e.on("complete",l),e.on("abort",w),e.req?C():e.on("request",C)):n&&!e._writableState&&(e.on("end",a),e.on("close",a)),e.on("end",f),e.on("finish",l),t.error!==!1&&e.on("error",p),e.on("close",w),function(){e.removeListener("complete",l),e.removeListener("abort",w),e.removeListener("request",C),e.req&&e.req.removeListener("finish",l),e.removeListener("end",a),e.removeListener("close",a),e.removeListener("finish",l),e.removeListener("end",f),e.removeListener("error",p),e.removeListener("close",w)}}var be=Ke,ie;function S(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var T=Symbol("lastResolve"),N=Symbol("lastReject"),V=Symbol("error"),re=Symbol("ended"),O=Symbol("lastPromise"),me=Symbol("handlePromise"),M=Symbol("stream");function k(e,t){return{value:e,done:t}}function Si(e){var t=e[T];if(t!==null){var i=e[M].read();i!==null&&(e[O]=null,e[T]=null,e[N]=null,t(k(i,!1)))}}function Ti(e){u.nextTick(Si,e)}function ki(e,t){return function(i,r){e.then(function(){if(t[re]){i(k(void 0,!0));return}t[me](i,r)},r)}}var Ci=Object.getPrototypeOf(function(){}),Ai=Object.setPrototypeOf((ie={get stream(){return this[M]},next:function(){var t=this,i=this[V];if(i!==null)return Promise.reject(i);if(this[re])return Promise.resolve(k(void 0,!0));if(this[M].destroyed)return new Promise(function(s,l){u.nextTick(function(){t[V]?l(t[V]):s(k(void 0,!0))})});var r=this[O],n;if(r)n=new Promise(ki(r,this));else{var a=this[M].read();if(a!==null)return Promise.resolve(k(a,!1));n=new Promise(this[me])}return this[O]=n,n}},S(ie,Symbol.asyncIterator,function(){return this}),S(ie,"return",function(){var t=this;return new Promise(function(i,r){t[M].destroy(null,function(n){if(n){r(n);return}i(k(void 0,!0))})})}),ie),Ci),Ni=function(t){var i,r=Object.create(Ai,(i={},S(i,M,{value:t,writable:!0}),S(i,T,{value:null,writable:!0}),S(i,N,{value:null,writable:!0}),S(i,V,{value:null,writable:!0}),S(i,re,{value:t._readableState.endEmitted,writable:!0}),S(i,me,{value:function(a,s){var l=r[M].read();l?(r[O]=null,r[T]=null,r[N]=null,a(k(l,!1))):(r[T]=a,r[N]=s)},writable:!0}),i));return r[O]=null,be(t,function(n){if(n&&n.code!=="ERR_STREAM_PREMATURE_CLOSE"){var a=r[N];a!==null&&(r[O]=null,r[T]=null,r[N]=null,a(n)),r[V]=n;return}var s=r[T];s!==null&&(r[O]=null,r[T]=null,r[N]=null,s(k(void 0,!0))),r[re]=!0}),t.on("readable",Ti.bind(null,r)),r},Oi=Ni,Mi=function(){throw new Error("Readable.from is not available in the browser")},_e=d,W;d.ReadableState=Ye;var Ar=Ne.EventEmitter,ze=function(t,i){return t.listeners(i).length},ne=Y.Buffer,Ii=Oe.Uint8Array||function(){};function Di(e){return ne.from(e)}function Li(e){return ne.isBuffer(e)||e instanceof Ii}var h;X&&X.debuglog?h=X.debuglog("stream"):h=function(){};var Pi=We.getHighWaterMark,ae=P.codes,xi=ae.ERR_INVALID_ARG_TYPE,ji=ae.ERR_STREAM_PUSH_AFTER_EOF,Wi=ae.ERR_METHOD_NOT_IMPLEMENTED,Fi=ae.ERR_STREAM_UNSHIFT_AFTER_END_EVENT,F,we,ye;B(d,A);var K=L.errorOrDestroy,ve=["error","close","destroy","pause","resume"];function Ui(e,t,i){if(typeof e.prependListener=="function")return e.prependListener(t,i);!e._events||!e._events[t]?e.on(t,i):Array.isArray(e._events[t])?e._events[t].unshift(i):e._events[t]=[i,e._events[t]]}function Ye(e,t,i){W=W||v,e=e||{},typeof i!="boolean"&&(i=t instanceof W),this.objectMode=!!e.objectMode,i&&(this.objectMode=this.objectMode||!!e.readableObjectMode),this.highWaterMark=Pi(this,e,"readableHighWaterMark",i),this.buffer=new yt,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=e.emitClose!==!1,this.autoDestroy=!!e.autoDestroy,this.destroyed=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(F||(F=Ge.StringDecoder),this.decoder=new F(e.encoding),this.encoding=e.encoding)}function d(e){if(W=W||v,!(this instanceof d))return new d(e);var t=this instanceof W;this._readableState=new Ye(e,this,t),this.readable=!0,e&&(typeof e.read=="function"&&(this._read=e.read),typeof e.destroy=="function"&&(this._destroy=e.destroy)),A.call(this)}Object.defineProperty(d.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0?!1:this._readableState.destroyed},set:function(t){if(!this._readableState)return;this._readableState.destroyed=t}}),d.prototype.destroy=L.destroy,d.prototype._undestroy=L.undestroy,d.prototype._destroy=function(e,t){t(e)},d.prototype.push=function(e,t){var i=this._readableState,r;return i.objectMode?r=!0:typeof e=="string"&&(t=t||i.defaultEncoding,t!==i.encoding&&(e=ne.from(e,t),t=""),r=!0),Xe(this,e,t,!1,r)},d.prototype.unshift=function(e){return Xe(this,e,null,!0,!1)};function Xe(e,t,i,r,n){h("readableAddChunk",t);var a=e._readableState;if(t===null)a.reading=!1,Hi(e,a);else{var s;if(n||(s=qi(a,t)),s)K(e,s);else if(a.objectMode||t&&t.length>0)if(typeof t!="string"&&!a.objectMode&&Object.getPrototypeOf(t)!==ne.prototype&&(t=Di(t)),r)a.endEmitted?K(e,new Fi):Re(e,a,t,!0);else if(a.ended)K(e,new ji);else{if(a.destroyed)return!1;a.reading=!1,a.decoder&&!i?(t=a.decoder.write(t),a.objectMode||t.length!==0?Re(e,a,t,!1):Ee(e,a)):Re(e,a,t,!1)}else r||(a.reading=!1,Ee(e,a))}return!a.ended&&(a.length<a.highWaterMark||a.length===0)}function Re(e,t,i,r){t.flowing&&t.length===0&&!t.sync?(t.awaitDrain=0,e.emit("data",i)):(t.length+=t.objectMode?1:i.length,r?t.buffer.unshift(i):t.buffer.push(i),t.needReadable&&se(e)),Ee(e,t)}function qi(e,t){var i;return!Li(t)&&typeof t!="string"&&t!==void 0&&!e.objectMode&&(i=new xi("chunk",["string","Buffer","Uint8Array"],t)),i}d.prototype.isPaused=function(){return this._readableState.flowing===!1},d.prototype.setEncoding=function(e){F||(F=Ge.StringDecoder);var t=new F(e);this._readableState.decoder=t,this._readableState.encoding=this._readableState.decoder.encoding;for(var i=this._readableState.buffer.head,r="";i!==null;)r+=t.write(i.data),i=i.next;return this._readableState.buffer.clear(),r!==""&&this._readableState.buffer.push(r),this._readableState.length=r.length,this};var Je=1073741824;function Bi(e){return e>=Je?e=Je:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}function Qe(e,t){return e<=0||t.length===0&&t.ended?0:t.objectMode?1:e!==e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=Bi(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}d.prototype.read=function(e){h("read",e),e=parseInt(e,10);var t=this._readableState,i=e;if(e!==0&&(t.emittedReadable=!1),e===0&&t.needReadable&&((t.highWaterMark!==0?t.length>=t.highWaterMark:t.length>0)||t.ended))return h("read: emitReadable",t.length,t.ended),t.length===0&&t.ended?Te(this):se(this),null;if(e=Qe(e,t),e===0&&t.ended)return t.length===0&&Te(this),null;var r=t.needReadable;h("need readable",r),(t.length===0||t.length-e<t.highWaterMark)&&(r=!0,h("length less than watermark",r)),t.ended||t.reading?(r=!1,h("reading or ended",r)):r&&(h("do read"),t.reading=!0,t.sync=!0,t.length===0&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=Qe(i,t)));var n;return e>0?n=tt(e,t):n=null,n===null?(t.needReadable=t.length<=t.highWaterMark,e=0):(t.length-=e,t.awaitDrain=0),t.length===0&&(t.ended||(t.needReadable=!0),i!==e&&t.ended&&Te(this)),n!==null&&this.emit("data",n),n};function Hi(e,t){if(h("onEofChunk"),t.ended)return;if(t.decoder){var i=t.decoder.end();i&&i.length&&(t.buffer.push(i),t.length+=t.objectMode?1:i.length)}t.ended=!0,t.sync?se(e):(t.needReadable=!1,t.emittedReadable||(t.emittedReadable=!0,Ze(e)))}function se(e){var t=e._readableState;h("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(h("emitReadable",t.flowing),t.emittedReadable=!0,u.nextTick(Ze,e))}function Ze(e){var t=e._readableState;h("emitReadable_",t.destroyed,t.length,t.ended),!t.destroyed&&(t.length||t.ended)&&(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,Se(e)}function Ee(e,t){t.readingMore||(t.readingMore=!0,u.nextTick($i,e,t))}function $i(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&t.length===0);){var i=t.length;if(h("maybeReadMore read 0"),e.read(0),i===t.length)break}t.readingMore=!1}d.prototype._read=function(e){K(this,new Wi("_read()"))},d.prototype.pipe=function(e,t){var i=this,r=this._readableState;switch(r.pipesCount){case 0:r.pipes=e;break;case 1:r.pipes=[r.pipes,e];break;default:r.pipes.push(e);break}r.pipesCount+=1,h("pipe count=%d opts=%j",r.pipesCount,t);var n=(!t||t.end!==!1)&&e!==u.stdout&&e!==u.stderr,a=n?l:q;r.endEmitted?u.nextTick(a):i.once("end",a),e.on("unpipe",s);function s(I,D){h("onunpipe"),I===i&&(D&&D.hasUnpiped===!1&&(D.hasUnpiped=!0,p()))}function l(){h("onend"),e.end()}var o=Gi(i);e.on("drain",o);var f=!1;function p(){h("cleanup"),e.removeListener("close",y),e.removeListener("finish",m),e.removeListener("drain",o),e.removeListener("error",C),e.removeListener("unpipe",s),i.removeListener("end",l),i.removeListener("end",q),i.removeListener("data",w),f=!0,r.awaitDrain&&(!e._writableState||e._writableState.needDrain)&&o()}i.on("data",w);function w(I){h("ondata");var D=e.write(I);h("dest.write",D),D===!1&&((r.pipesCount===1&&r.pipes===e||r.pipesCount>1&&it(r.pipes,e)!==-1)&&!f&&(h("false write response, pause",r.awaitDrain),r.awaitDrain++),i.pause())}function C(I){h("onerror",I),q(),e.removeListener("error",C),ze(e,"error")===0&&K(e,I)}Ui(e,"error",C);function y(){e.removeListener("finish",m),q()}e.once("close",y);function m(){h("onfinish"),e.removeListener("close",y),q()}e.once("finish",m);function q(){h("unpipe"),i.unpipe(e)}return e.emit("pipe",i),r.flowing||(h("pipe resume"),i.resume()),e};function Gi(e){return function(){var i=e._readableState;h("pipeOnDrain",i.awaitDrain),i.awaitDrain&&i.awaitDrain--,i.awaitDrain===0&&ze(e,"data")&&(i.flowing=!0,Se(e))}}d.prototype.unpipe=function(e){var t=this._readableState,i={hasUnpiped:!1};if(t.pipesCount===0)return this;if(t.pipesCount===1)return e&&e!==t.pipes?this:(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,i),this);if(!e){var r=t.pipes,n=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var a=0;a<n;a++)r[a].emit("unpipe",this,{hasUnpiped:!1});return this}var s=it(t.pipes,e);return s===-1?this:(t.pipes.splice(s,1),t.pipesCount-=1,t.pipesCount===1&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,i),this)},d.prototype.on=function(e,t){var i=A.prototype.on.call(this,e,t),r=this._readableState;return e==="data"?(r.readableListening=this.listenerCount("readable")>0,r.flowing!==!1&&this.resume()):e==="readable"&&(!r.endEmitted&&!r.readableListening&&(r.readableListening=r.needReadable=!0,r.flowing=!1,r.emittedReadable=!1,h("on readable",r.length,r.reading),r.length?se(this):r.reading||u.nextTick(Vi,this))),i},d.prototype.addListener=d.prototype.on,d.prototype.removeListener=function(e,t){var i=A.prototype.removeListener.call(this,e,t);return e==="readable"&&u.nextTick(et,this),i},d.prototype.removeAllListeners=function(e){var t=A.prototype.removeAllListeners.apply(this,arguments);return(e==="readable"||e===void 0)&&u.nextTick(et,this),t};function et(e){var t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!t.paused?t.flowing=!0:e.listenerCount("data")>0&&e.resume()}function Vi(e){h("readable nexttick read 0"),e.read(0)}d.prototype.resume=function(){var e=this._readableState;return e.flowing||(h("resume"),e.flowing=!e.readableListening,Ki(this,e)),e.paused=!1,this};function Ki(e,t){t.resumeScheduled||(t.resumeScheduled=!0,u.nextTick(zi,e,t))}function zi(e,t){h("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),Se(e),t.flowing&&!t.reading&&e.read(0)}d.prototype.pause=function(){return h("call pause flowing=%j",this._readableState.flowing),this._readableState.flowing!==!1&&(h("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this};function Se(e){var t=e._readableState;for(h("flow",t.flowing);t.flowing&&e.read()!==null;);}d.prototype.wrap=function(e){var t=this,i=this._readableState,r=!1;e.on("end",function(){if(h("wrapped end"),i.decoder&&!i.ended){var s=i.decoder.end();s&&s.length&&t.push(s)}t.push(null)}),e.on("data",function(s){if(h("wrapped data"),i.decoder&&(s=i.decoder.write(s)),i.objectMode&&s==null)return;if(!i.objectMode&&(!s||!s.length))return;var l=t.push(s);l||(r=!0,e.pause())});for(var n in e)this[n]===void 0&&typeof e[n]=="function"&&(this[n]=function(l){return function(){return e[l].apply(e,arguments)}}(n));for(var a=0;a<ve.length;a++)e.on(ve[a],this.emit.bind(this,ve[a]));return this._read=function(s){h("wrapped _read",s),r&&(r=!1,e.resume())},this},typeof Symbol=="function"&&(d.prototype[Symbol.asyncIterator]=function(){return we===void 0&&(we=Oi),we(this)}),Object.defineProperty(d.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(d.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(d.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(t){this._readableState&&(this._readableState.flowing=t)}}),d._fromList=tt,Object.defineProperty(d.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}});function tt(e,t){if(t.length===0)return null;var i;return t.objectMode?i=t.buffer.shift():!e||e>=t.length?(t.decoder?i=t.buffer.join(""):t.buffer.length===1?i=t.buffer.first():i=t.buffer.concat(t.length),t.buffer.clear()):i=t.buffer.consume(e,t.decoder),i}function Te(e){var t=e._readableState;h("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,u.nextTick(Yi,t,e))}function Yi(e,t){if(h("endReadableNT",e.endEmitted,e.length),!e.endEmitted&&e.length===0&&(e.endEmitted=!0,t.readable=!1,t.emit("end"),e.autoDestroy)){var i=t._writableState;(!i||i.autoDestroy&&i.finished)&&t.destroy()}}typeof Symbol=="function"&&(d.from=function(e,t){return ye===void 0&&(ye=Mi),ye(d,e,t)});function it(e,t){for(var i=0,r=e.length;i<r;i++)if(e[i]===t)return i;return-1}var ke=R,oe=P.codes,Xi=oe.ERR_METHOD_NOT_IMPLEMENTED,Ji=oe.ERR_MULTIPLE_CALLBACK,Qi=oe.ERR_TRANSFORM_ALREADY_TRANSFORMING,Zi=oe.ERR_TRANSFORM_WITH_LENGTH_0;B(R,v);function er(e,t){var i=this._transformState;i.transforming=!1;var r=i.writecb;if(r===null)return this.emit("error",new Ji);i.writechunk=null,i.writecb=null,t!=null&&this.push(t),r(e);var n=this._readableState;n.reading=!1,(n.needReadable||n.length<n.highWaterMark)&&this._read(n.highWaterMark)}function R(e){if(!(this instanceof R))return new R(e);v.call(this,e),this._transformState={afterTransform:er.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&(typeof e.transform=="function"&&(this._transform=e.transform),typeof e.flush=="function"&&(this._flush=e.flush)),this.on("prefinish",tr)}function tr(){var e=this;typeof this._flush=="function"&&!this._readableState.destroyed?this._flush(function(t,i){rt(e,t,i)}):rt(this,null,null)}R.prototype.push=function(e,t){return this._transformState.needTransform=!1,v.prototype.push.call(this,e,t)},R.prototype._transform=function(e,t,i){i(new Xi("_transform()"))},R.prototype._write=function(e,t,i){var r=this._transformState;if(r.writecb=i,r.writechunk=e,r.writeencoding=t,!r.transforming){var n=this._readableState;(r.needTransform||n.needReadable||n.length<n.highWaterMark)&&this._read(n.highWaterMark)}},R.prototype._read=function(e){var t=this._transformState;t.writechunk!==null&&!t.transforming?(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform)):t.needTransform=!0},R.prototype._destroy=function(e,t){v.prototype._destroy.call(this,e,function(i){t(i)})};function rt(e,t,i){if(t)return e.emit("error",t);if(i!=null&&e.push(i),e._writableState.length)throw new Zi;if(e._transformState.transforming)throw new Qi;return e.push(null)}var ir=z;B(z,ke);function z(e){if(!(this instanceof z))return new z(e);ke.call(this,e)}z.prototype._transform=function(e,t,i){i(null,e)};var Ce;function rr(e){var t=!1;return function(){if(t)return;t=!0,e.apply(void 0,arguments)}}var nt=P.codes,nr=nt.ERR_MISSING_ARGS,ar=nt.ERR_STREAM_DESTROYED;function at(e){if(e)throw e}function sr(e){return e.setHeader&&typeof e.abort=="function"}function or(e,t,i,r){r=rr(r);var n=!1;e.on("close",function(){n=!0}),Ce===void 0&&(Ce=be),Ce(e,{readable:t,writable:i},function(s){if(s)return r(s);n=!0,r()});var a=!1;return function(s){if(n)return;if(a)return;if(a=!0,sr(e))return e.abort();if(typeof e.destroy=="function")return e.destroy();r(s||new ar("pipe"))}}function st(e){e()}function lr(e,t){return e.pipe(t)}function hr(e){return e.length?typeof e[e.length-1]!="function"?at:e.pop():at}function dr(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var r=hr(t);if(Array.isArray(t[0])&&(t=t[0]),t.length<2)throw new nr("streams");var n,a=t.map(function(s,l){var o=l<t.length-1,f=l>0;return or(s,o,f,function(p){if(n||(n=p),p&&a.forEach(st),o)return;a.forEach(st),r(n)})});return t.reduce(lr)}var fr=dr,ur=ft(function(e,t){t=e.exports=_e,t.Stream=t,t.Readable=t,t.Writable=Z,t.Duplex=v,t.Transform=ke,t.PassThrough=ir,t.finished=be,t.pipeline=fr});/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let ot;var le=typeof queueMicrotask=="function"?queueMicrotask.bind(globalThis):e=>(ot||(ot=Promise.resolve())).then(e).catch(t=>setTimeout(()=>{throw t},0));/*! simple-peer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */const cr=dt("simple-peer"),{Buffer:pr}=Y,Ae=64*1024,gr=5*1e3,br=5*1e3;function lt(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}function mr(e){console.warn(e)}class U extends ur.Duplex{constructor(e){if(e=Object.assign({allowHalfOpen:!1},e),super(e),this._id=Ie(4).toString("hex").slice(0,7),this._debug("new peer %o",e),this.channelName=e.initiator?e.channelName||Ie(20).toString("hex"):null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||U.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},U.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(t=>t),this.streams=e.streams||(e.stream?[e.stream]:[]),this.trickle=e.trickle!==void 0?e.trickle:!0,this.allowHalfTrickle=e.allowHalfTrickle!==void 0?e.allowHalfTrickle:!1,this.iceCompleteTimeout=e.iceCompleteTimeout||gr,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=e.wrtc&&typeof e.wrtc=="object"?e.wrtc:Me(),!this._wrtc)throw typeof window=="undefined"?c(new Error("No WebRTC support: Specify `opts.wrtc` option in this environment"),"ERR_WEBRTC_SUPPORT"):c(new Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(t){le(()=>this.destroy(c(t,"ERR_PC_CONSTRUCTOR")));return}this._isReactNativeWebrtc=typeof this._pc._peerConnectionId=="number",this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=t=>{this._onIceCandidate(t)},this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=t=>{this._setupData(t)},this.streams&&this.streams.forEach(t=>{this.addStream(t)}),this._pc.ontrack=t=>{this._onTrack(t)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&this._channel.readyState==="open"}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(e){if(this.destroyed)throw c(new Error("cannot signal after peer is destroyed"),"ERR_SIGNALING");if(typeof e=="string")try{e=JSON.parse(e)}catch(t){e={}}this._debug("signal()"),e.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),e.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(e.transceiverRequest.kind,e.transceiverRequest.init)),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e)).then(()=>{if(this.destroyed)return;this._pendingCandidates.forEach(t=>{this._addIceCandidate(t)}),this._pendingCandidates=[],this._pc.remoteDescription.type==="offer"&&this._createAnswer()}).catch(t=>{this.destroy(c(t,"ERR_SET_REMOTE_DESCRIPTION"))}),!e.sdp&&!e.candidate&&!e.renegotiate&&!e.transceiverRequest&&this.destroy(c(new Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}_addIceCandidate(e){const t=new this._wrtc.RTCIceCandidate(e);this._pc.addIceCandidate(t).catch(i=>{!t.address||t.address.endsWith(".local")?mr("Ignoring unsupported ICE candidate."):this.destroy(c(i,"ERR_ADD_ICE_CANDIDATE"))})}send(e){this._channel.send(e)}addTransceiver(e,t){if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(e,t),this._needsNegotiation()}catch(i){this.destroy(c(i,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:e,init:t}})}addStream(e){this._debug("addStream()"),e.getTracks().forEach(t=>{this.addTrack(t,e)})}addTrack(e,t){this._debug("addTrack()");const i=this._senderMap.get(e)||new Map;let r=i.get(t);if(!r)r=this._pc.addTrack(e,t),i.set(t,r),this._senderMap.set(e,i),this._needsNegotiation();else throw r.removed?c(new Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED"):c(new Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED")}replaceTrack(e,t,i){this._debug("replaceTrack()");const r=this._senderMap.get(e),n=r?r.get(i):null;if(!n)throw c(new Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");t&&this._senderMap.set(t,r),n.replaceTrack!=null?n.replaceTrack(t):this.destroy(c(new Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(e,t){this._debug("removeSender()");const i=this._senderMap.get(e),r=i?i.get(t):null;if(!r)throw c(new Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{r.removed=!0,this._pc.removeTrack(r)}catch(n){n.name==="NS_ERROR_UNEXPECTED"?this._sendersAwaitingStable.push(r):this.destroy(c(n,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(e){this._debug("removeSenders()"),e.getTracks().forEach(t=>{this.removeTrack(t,e)})}_needsNegotiation(){if(this._debug("_needsNegotiation"),this._batchedNegotiation)return;this._batchedNegotiation=!0,le(()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1})}negotiate(){this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout(()=>{this._createOffer()},0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}destroy(e){this._destroy(e,()=>{})}_destroy(e,t){if(this.destroyed||this.destroying)return;this.destroying=!0,this._debug("destroying (error: %s)",e&&(e.message||e)),le(()=>{if(this.destroyed=!0,this.destroying=!1,this._debug("destroy (error: %s)",e&&(e.message||e)),this.readable=this.writable=!1,this._readableState.ended||this.push(null),this._writableState.finished||this.end(),this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch(i){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(i){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close"),t()})}_setupData(e){if(!e.channel)return this.destroy(c(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer",typeof this._channel.bufferedAmountLowThreshold=="number"&&(this._channel.bufferedAmountLowThreshold=Ae),this.channelName=this._channel.label,this._channel.onmessage=i=>{this._onChannelMessage(i)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=i=>{this.destroy(c(i,"ERR_DATA_CHANNEL"))};let t=!1;this._closingInterval=setInterval(()=>{this._channel&&this._channel.readyState==="closing"?(t&&this._onChannelClose(),t=!0):t=!1},br)}_read(){}_write(e,t,i){if(this.destroyed)return i(c(new Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(e)}catch(r){return this.destroy(c(r,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>Ae?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=i):i(null)}else this._debug("write before connect"),this._chunk=e,this._cb=i}_onFinish(){if(this.destroyed)return;const e=()=>{setTimeout(()=>this.destroy(),1e3)};this._connected?e():this.once("connect",e)}_startIceCompleteTimeout(){if(this.destroyed)return;if(this._iceCompleteTimer)return;this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout(()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))},this.iceCompleteTimeout)}_createOffer(){if(this.destroyed)return;this._pc.createOffer(this.offerOptions).then(e=>{if(this.destroyed)return;!this.trickle&&!this.allowHalfTrickle&&(e.sdp=lt(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const n=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:n.type,sdp:n.sdp})},i=()=>{if(this._debug("createOffer success"),this.destroyed)return;this.trickle||this._iceComplete?t():this.once("_iceComplete",t)},r=n=>{this.destroy(c(n,"ERR_SET_LOCAL_DESCRIPTION"))};this._pc.setLocalDescription(e).then(i).catch(r)}).catch(e=>{this.destroy(c(e,"ERR_CREATE_OFFER"))})}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach(e=>{!e.mid&&e.sender.track&&!e.requested&&(e.requested=!0,this.addTransceiver(e.sender.track.kind))})}_createAnswer(){if(this.destroyed)return;this._pc.createAnswer(this.answerOptions).then(e=>{if(this.destroyed)return;!this.trickle&&!this.allowHalfTrickle&&(e.sdp=lt(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const n=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:n.type,sdp:n.sdp}),this.initiator||this._requestMissingTransceivers()},i=()=>{if(this.destroyed)return;this.trickle||this._iceComplete?t():this.once("_iceComplete",t)},r=n=>{this.destroy(c(n,"ERR_SET_LOCAL_DESCRIPTION"))};this._pc.setLocalDescription(e).then(i).catch(r)}).catch(e=>{this.destroy(c(e,"ERR_CREATE_ANSWER"))})}_onConnectionStateChange(){if(this.destroyed)return;this._pc.connectionState==="failed"&&this.destroy(c(new Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;const e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",e,t),this.emit("iceStateChange",e,t),(e==="connected"||e==="completed")&&(this._pcReady=!0,this._maybeReady()),e==="failed"&&this.destroy(c(new Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),e==="closed"&&this.destroy(c(new Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(e){const t=i=>(Object.prototype.toString.call(i.values)==="[object Array]"&&i.values.forEach(r=>{Object.assign(i,r)}),i);this._pc.getStats.length===0||this._isReactNativeWebrtc?this._pc.getStats().then(i=>{const r=[];i.forEach(n=>{r.push(t(n))}),e(null,r)},i=>e(i)):this._pc.getStats.length>0?this._pc.getStats(i=>{if(this.destroyed)return;const r=[];i.result().forEach(n=>{const a={};n.names().forEach(s=>{a[s]=n.stat(s)}),a.id=n.id,a.type=n.type,a.timestamp=n.timestamp,r.push(t(a))}),e(null,r)},i=>e(i)):e(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{if(this.destroyed)return;this.getStats((t,i)=>{if(this.destroyed)return;t&&(i=[]);const r={},n={},a={};let s=!1;i.forEach(o=>{(o.type==="remotecandidate"||o.type==="remote-candidate")&&(r[o.id]=o),(o.type==="localcandidate"||o.type==="local-candidate")&&(n[o.id]=o),(o.type==="candidatepair"||o.type==="candidate-pair")&&(a[o.id]=o)});const l=o=>{s=!0;let f=n[o.localCandidateId];f&&(f.ip||f.address)?(this.localAddress=f.ip||f.address,this.localPort=Number(f.port)):f&&f.ipAddress?(this.localAddress=f.ipAddress,this.localPort=Number(f.portNumber)):typeof o.googLocalAddress=="string"&&(f=o.googLocalAddress.split(":"),this.localAddress=f[0],this.localPort=Number(f[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let p=r[o.remoteCandidateId];p&&(p.ip||p.address)?(this.remoteAddress=p.ip||p.address,this.remotePort=Number(p.port)):p&&p.ipAddress?(this.remoteAddress=p.ipAddress,this.remotePort=Number(p.portNumber)):typeof o.googRemoteAddress=="string"&&(p=o.googRemoteAddress.split(":"),this.remoteAddress=p[0],this.remotePort=Number(p[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(i.forEach(o=>{o.type==="transport"&&o.selectedCandidatePairId&&l(a[o.selectedCandidatePairId]),(o.type==="googCandidatePair"&&o.googActiveConnection==="true"||(o.type==="candidatepair"||o.type==="candidate-pair")&&o.selected)&&l(o)}),!s&&(!Object.keys(a).length||Object.keys(n).length)){setTimeout(e,100);return}else this._connecting=!1,this._connected=!0;if(this._chunk){try{this.send(this._chunk)}catch(f){return this.destroy(c(f,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');const o=this._cb;this._cb=null,o(null)}typeof this._channel.bufferedAmountLowThreshold!="number"&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")})};e()}_onInterval(){if(!this._cb||!this._channel||this._channel.bufferedAmount>Ae)return;this._onChannelBufferedAmountLow()}_onSignalingStateChange(){if(this.destroyed)return;this._pc.signalingState==="stable"&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach(e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0}),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState)}_onIceCandidate(e){if(this.destroyed)return;e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):!e.candidate&&!this._iceComplete&&(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout()}_onChannelMessage(e){if(this.destroyed)return;let t=e.data;t instanceof ArrayBuffer&&(t=pr.from(t)),this.push(t)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);const e=this._cb;this._cb=null,e(null)}_onChannelOpen(){if(this._connected||this.destroyed)return;this._debug("on channel open"),this._channelReady=!0,this._maybeReady()}_onChannelClose(){if(this.destroyed)return;this._debug("on channel close"),this.destroy()}_onTrack(e){if(this.destroyed)return;e.streams.forEach(t=>{if(this._debug("on track"),this.emit("track",e.track,t),this._remoteTracks.push({track:e.track,stream:t}),this._remoteStreams.some(i=>i.id===t.id))return;this._remoteStreams.push(t),le(()=>{this._debug("on stream"),this.emit("stream",t)})})}_debug(){const e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],cr.apply(null,e)}}U.WEBRTC_SUPPORT=!!Me(),U.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},U.channelConfig={};var ht=U,_r=Object.freeze(Object.assign(Object.create(null),ht,{default:ht}));export{_r as i};
