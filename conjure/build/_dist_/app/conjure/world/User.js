import*as s from" https://cdn.skypack.dev/pin/three@v0.123.0-STd7XeVUbImsNuMmqKGL/min/three.js";import{ExtendedObject3D as o}from"../../../../web_modules/enable3d.js";import{NETWORKING_OPCODES as r}from"../../backend/Constants.js";export default class h{constructor(t,i){this.vec=new s.Vector3,this.quat=new s.Quaternion,this.euler=new s.Euler,this.isRemote=i,this.conjure=t,this.scene=t.scene,this.group=new o,this.group.name="user",this.group.position.y+=1,this.group.rotateY(Math.PI+.1),this.group.rotation.set(0,Math.PI*1.5,0),this.modelHeight=1.8,this.thirdPerson=!1,this.eyeHeight=1.75,this.focusLength=2,this.theta=0,this.phi=0,this.sensitivityX=1,this.sensitivityY=.8,this.yMinLimit=-20,this.yMaxLimit=80,this.radius=10,this.follow=!1,this.focusPoint=new o,this.focusPoint.position.y=this.eyeHeight,this.focusPoint.position.z=-2,this.group.add(this.focusPoint),this.previewMeshPoint=new o,this.previewMeshPoint.position.y=1,this.previewMeshPoint.position.z=-1.5,this.group.add(this.previewMeshPoint),this.scene.add(this.group),this.walkSpeed=1,this.runSpeed=5,this.loadModel()}async loadModel(){this.meshes=[],this.playerModel=await this.conjure.load.gltf("playerModel"),this.mesh=this.playerModel.scene,this.mesh.isSkinnedMesh=!0,this.mesh.rotation.y=s.MathUtils.DEG2RAD*180,this.mesh.traverse(t=>{t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0,t.material.transparent=!0,t.material.opacity=1,t.frustumCulled=!1,this.meshes.push(t)),t.name==="mixamorigRightHandMiddle1"&&(this.rightHand=t),t.name==="mixamorigLeftHandMiddle1"&&(this.leftHand=t),t.name==="mixamorigHips"&&(this.rootBone=t)}),this.group.add(this.mesh),this.conjure.animationMixers.add(this.group.animation.mixer),this.playerModel.animations.forEach(t=>{t.name&&this.group.animation.add(t.name,t)}),this.onGround=!1,this.animMovementLock=!0,this.group.animation.mixer.addEventListener("loop",function(t){if(!this.group)return;(this.currentAnimation==="land"||this.currentAnimation==="landHard"||this.currentAnimation==="landRoll"||this.currentAnimation==="unsheath"||this.currentAnimation==="swingOutward"||this.currentAnimation==="swingInward")&&(this.group.body&&this.group.body.setVelocity(0,0,0))}.bind(this)),this.group.animation.mixer.addEventListener("finished",function(t){(this.currentAnimation==="jump"||this.currentAnimation==="runningJump"||this.currentAnimation==="flip")&&this.setAction("falling",.1),(this.currentAnimation==="land"||this.currentAnimation==="landHard"||this.currentAnimation==="landRoll")&&this.setAction("idle",.2),(this.currentAnimation==="unsheath"||this.currentAnimation==="swingOutward"||this.currentAnimation==="swingInward"||this.currentAnimation==="idleSwordPlay")&&(this.swingAgain?(this.setAction("swingOutward",.1,!0,.1),this.swingAgain=!1):this.setAction("idle",.2))}.bind(this)),this.setAction("idle",.1),this.turnedTooMuch=!1,this.onCreate()}async addPhysics(t){if(this.group.body)throw new Error("USER.JS already has physics!");t.add.existing(this.group,{shape:"box",width:.6,depth:.4,height:this.modelHeight,offset:{x:0,y:-this.modelHeight/2,z:0},autoCenter:!1,mass:1}),this.group.body.setCollisionFlags(this.isRemote?1:2),this.group.body.setFriction(1.5),this.group.body.setBounciness(0),this.group.body.setAngularFactor(0,0,0),this.group.body.setLinearFactor(1,1,1)}removePhysics(t){this.group.body&&t.destroy(this.group.body)}attachToBone(t,i){this.rootBone.updateMatrixWorld(!0),i.updateMatrixWorld(!0),i.attach(t)}onCreate(){}jump(){if((this.currentAnimation==="jump"||this.currentAnimation==="runningJump"||this.currentAnimation==="falling"&&this.group.body.velocity.y>.5)&&(this.setAction("flip",.1,!0),this.group.body.applyForceY(3)),!this.onGround)return;this.currentAnimation==="run"?(this.setAction("runningJump",.1,!0),this.group.body.applyForceY(5)):(this.setAction("jump",.1,!0),this.group.body.applyForceY(5))}setTransparency(t){for(let i of this.meshes)i.visible=Boolean(t),i.material.opacity=t}update(t){if(!this.playerModel)return;if(this.isRemote)return;let i=this.getVelocity(!0);const e=this.conjure.physics.add.raycaster("allHits");e.setRayFromWorld(this.group.position.x,this.group.position.y+.5,this.group.position.z),e.setRayToWorld(this.group.position.x,this.group.position.y-.5,this.group.position.z),e.rayTest(),this.onGround=!1,e.hasHit()&&e.getCollisionObjects().forEach((n,a)=>{this.onGround=!0}),this.currentAnimation==="unsheath"||this.currentAnimation==="runSword"||this.currentAnimation==="swingOutward"||this.currentAnimation==="idleSwordPlay"||(this.currentAnimation==="swingInward"?t.input.isPressed("MOUSELEFT",!0)&&(this.swingAgain=!0,this.conjure.getAudioManager().play("sword")):this.currentAnimation==="land"||this.currentAnimation==="landHard"||this.currentAnimation==="landRoll"||(this.currentAnimation==="falling"?this.onGround&&(this.turnedTooMuch?(this.group.body.velocity.y<-1&&i>this.walkSpeed?this.setAction("landHard",.1,!0,0):this.setAction("land",.2,!0,.2),this.turnedTooMuch=!1):this.group.body.velocity.y<-5?this.turnedTooMuch?this.setAction("landHard",.1,!0,0):this.setAction("land",.2,!0,.2):i>this.runSpeed?this.setAction("run",.2):this.setAction("land",.2,!0,.2)):this.currentAnimation==="jump"||this.currentAnimation==="runningJump"||this.currentAnimation==="flip"||(this.onGround?(i>this.runSpeed?this.currentAnimation!=="run"&&this.setAction("run",.2):i>this.walkSpeed?this.currentAnimation!=="walk"&&this.setAction("walk",.2):this.currentAnimation!=="idle"&&this.setAction("idle",.25),this.hasSword&&(t.input.isPressed("MOUSELEFT",!0)&&(this.conjure.getAudioManager().play("sword"),this.setAction("swingInward",.1,!0)),t.input.isPressed("MOUSERIGHT",!0)&&this.setAction("idleSwordPlay",.1,!0))):this.currentAnimation!=="falling"&&this.setAction("falling",.1)))),t.input.isPressed("I",!0)&&console.log(this.group.getWorldPosition(this.vec)),(this.group.getWorldPosition(this.vec).y<-10||t.input.isPressed("R",!0))&&this.teleport(this.conjure.world.spawnLocation.x,this.conjure.world.spawnLocation.y,this.conjure.world.spawnLocation.z),e.destroy()}teleport(t,i,e){if(!this.group||!this.group.body)return;this.group.body.setCollisionFlags(2),this.group.position.set(t,i,e),this.group.body.needUpdate=!0,this.group.body.once.update(()=>{this.group.body.setCollisionFlags(0),this.group.body.setVelocity(0,0,0),this.group.body.setAngularVelocity(0,0,0)})}setAction(t,i,e=!1,n=0){if(!this.group)return;if(t===this.currentAnimation)return;this.currentAnimation=t,this.getMovementLock(),this.group.animation.play(t,i*1e3,!Boolean(e)),this.isRemote||this.conjure.getWorld().sendData(r.USER.ANIMATION,{name:t,fadeTime:i,once:e,startTime:n})}getMovementLock(){switch(this.currentAnimation){case"land":case"landHard":case"landRoll":case"jump":case"runningJump":case"falling":case"flip":case"swingInward":case"swingOutward":case"unsheath":case"idleSwordPlay":this.animMovementLock=!0;return;default:this.animMovementLock=!1;return}}getVelocity(t){return Math.sqrt(t?this.group.body.velocity.x*this.group.body.velocity.x+this.group.body.velocity.z*this.group.body.velocity.z:this.group.body.velocity.x*this.group.body.velocity.x+this.group.body.velocity.y*this.group.body.velocity.y+this.group.body.velocity.z*this.group.body.velocity.z)}}
