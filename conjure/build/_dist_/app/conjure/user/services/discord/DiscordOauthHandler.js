import r from"../../../../../../web_modules/discord-oauth2.js";export default class n{constructor(e){this.serviceHandler=e,this.userData=void 0,this.loggedIn=!1}async initialise(){this.clientId="719132345483132948",this.oauth=new r({clientId:this.clientId,redirectUri:window.location.origin+"/success.html"}),this.url=this.oauth.generateAuthUrl({scope:"identify guilds",responseType:"token",state:window.crypto.getRandomValues(new Uint32Array(16)).toString("hex")});const e=window.clientDatastore.get("discordAccessToken");return e?await this.getUser(e):!0}logOut(){if(!this.loggedIn)return;window.clientDatastore.del("discordAccessToken"),this.userData=void 0,this.setLoggedIn(!1)}logInToDiscord(){this.loggedIn?this.logOut():(window.addEventListener("message",function(e){if(e.data.message==="deliverResult"){let t=e.data.result.substr(1).split("&").map(s=>s.split("=")).reduce((s,[i,o])=>({...s,[i]:o}),{});this.getUser(t.access_token),e.source.close()}}.bind(this)),window.open(this.url,"Login"))}async getUser(e){if(!e)return!1;try{const t=await this.oauth.getUser(e);return console.log("Successfully logged into discord!"),window.clientDatastore.put("discordAccessToken",e),this.setLoggedIn(!0),console.log(t),this.userData=t,this.serviceHandler.setData({discordName:this.userData.username,discordID:this.userData.id}),!0}catch(t){console.log("Sorry, could not log you in. Your session may have expired."),window.clientDatastore.del("discordAccessToken"),this.userData=void 0,this.setLoggedIn(!1)}}async getUserGuilds(){return await new Promise((e,t)=>{try{const s=window.clientDatastore.get("discordAccessToken");this.oauth.getUserGuilds(s).then(i=>{e(i)})}catch(s){t(s)}})}setLoggedIn(e){this.loggedIn=e,this.serviceHandler.setAuthenticated(e)}}
